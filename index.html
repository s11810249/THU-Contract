<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>東海大學學生校外實習合約產生系統</title>
    <!-- 1. 引入必要的函式庫 (用於讀寫 Word) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/docxtemplater/3.37.11/docxtemplater.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pizzip/3.1.4/pizzip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/1.3.8/FileSaver.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip-utils/0.1.0/jszip-utils.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- 2. 東海大學配色設定 -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        thuBlue: '#002E5D',
                        thuGold: '#C6A87C',
                    }
                }
            }
        }
    </script>
    <style>
        body { background-color: #f3f4f6; font-family: 'Noto Sans TC', sans-serif; padding-bottom: 80px; }
        .input-field { background-color: white; border: 1px solid #d1d5db; border-radius: 0.375rem; padding: 0.5rem; width: 100%; }
        .input-field:focus { outline: none; border-color: #002E5D; ring: 2px solid #002E5D; }
        .card { background: white; border-radius: 0.5rem; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); overflow: hidden; margin-bottom: 1.5rem; }
        .card-header { padding: 1rem 1.5rem; border-bottom: 1px solid #e5e7eb; color: #002E5D; font-weight: 700; font-size: 1.125rem; display: flex; align-items: center; }
        .border-top-blue { border-top: 4px solid #002E5D; }
        .border-top-gold { border-top: 4px solid #C6A87C; }
        /* 隱藏/顯示控制 */
        .hidden { display: none; }
    </style>
</head>
<body>

    <!-- Header -->
    <div class="fixed top-0 left-0 w-full h-[70px] bg-thuBlue text-white z-50 flex items-center justify-between px-8 shadow-md">
        <div class="flex items-center gap-3">
            <div class="w-10 h-10 bg-white rounded-full flex items-center justify-center text-thuBlue font-bold text-xl">
                <i class="fa-solid fa-university"></i>
            </div>
            <div>
                <div class="text-xl font-bold tracking-wide">東海大學</div>
                <div class="text-xs text-thuGold opacity-90">學生校外實習合約產生系統</div>
            </div>
        </div>
        <div class="hidden md:block">
            <span class="text-sm bg-thuBlue border border-thuGold px-3 py-1 rounded-full text-thuGold">
                <i class="fa-solid fa-user-tie mr-1"></i> 承辦人員模式
            </span>
        </div>
    </div>

    <!-- 步驟條 -->
    <div class="mt-28 mb-8 px-8 max-w-5xl mx-auto flex justify-between items-center relative">
        <div class="flex flex-col items-center z-10">
            <div class="w-8 h-8 bg-thuBlue text-white rounded-full flex items-center justify-center font-bold mb-1">1</div>
            <span class="text-sm font-medium">機構資料</span>
        </div>
        <div class="flex-1 h-1 bg-gray-300 mx-4"></div>
        <div class="flex flex-col items-center z-10">
            <div class="w-8 h-8 bg-thuBlue text-white rounded-full flex items-center justify-center font-bold mb-1">2</div>
            <span class="text-sm font-medium">學生資料</span>
        </div>
        <div class="flex-1 h-1 bg-gray-300 mx-4"></div>
        <div class="flex flex-col items-center z-10">
            <div class="w-8 h-8 bg-thuBlue text-white rounded-full flex items-center justify-center font-bold mb-1">3</div>
            <span class="text-sm font-medium">條件設定</span>
        </div>
    </div>

    <!-- 主要表單 -->
    <main class="max-w-5xl mx-auto px-4">
        
        <!-- 卡片 1: 機構資料 -->
        <div class="card border-top-blue">
            <div class="card-header bg-gray-50"><i class="fa-regular fa-building mr-2"></i> 乙方：實習機構資料</div>
            <div class="p-6 grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="md:col-span-2">
                    <label class="block text-sm text-gray-500 mb-1">機構全銜 (法定名稱) *</label>
                    <input type="text" id="company_name" class="input-field" placeholder="例：國泰世華商業銀行股份有限公司">
                </div>
                <div>
                    <label class="block text-sm text-gray-500 mb-1">統一編號</label>
                    <input type="text" id="company_tax_id" class="input-field">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm text-gray-500 mb-1">代表人姓名</label>
                        <input type="text" id="company_rep" class="input-field">
                    </div>
                    <div>
                        <label class="block text-sm text-gray-500 mb-1">代表人職稱</label>
                        <input type="text" id="company_title" class="input-field" value="負責人">
                    </div>
                </div>
                <div class="md:col-span-2">
                    <label class="block text-sm text-gray-500 mb-1">公司登記地址</label>
                    <input type="text" id="reg_address" class="input-field">
                </div>
                
                <!-- 分公司 -->
                <div class="md:col-span-2 border-t pt-4">
                    <div class="flex items-center gap-2 mb-2">
                        <input type="checkbox" id="is_branch" onchange="toggleBranch()" class="w-4 h-4">
                        <label for="is_branch" class="text-sm font-bold text-gray-600">實習地點與登記地址不同 (如派駐分公司)</label>
                    </div>
                    <div id="branch_area" class="grid grid-cols-1 md:grid-cols-3 gap-4 hidden">
                        <div>
                            <input type="text" id="branch_name" class="input-field" placeholder="分公司名稱">
                        </div>
                        <div class="md:col-span-2">
                            <input type="text" id="branch_addr" class="input-field" placeholder="實際實習地址">
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 卡片 2: 學生資料 -->
        <div class="card border-top-blue">
            <div class="card-header bg-gray-50 flex justify-between">
                <div><i class="fa-solid fa-user-graduate mr-2"></i> 甲方：實習學生資料</div>
                <select id="student_count" onchange="renderStudents()" class="text-sm border rounded px-2 py-1">
                    <option value="1">1 位學生</option>
                    <option value="2">2 位學生</option>
                    <option value="3">3 位學生</option>
                </select>
            </div>
            <div id="student_container" class="p-6 space-y-4">
                <!-- JS 會自動產生輸入框 -->
            </div>
        </div>

        <!-- 卡片 3: 實習條件 -->
        <div class="card border-top-gold">
            <div class="card-header bg-gray-50"><i class="fa-solid fa-briefcase mr-2"></i> 實習條件設定</div>
            <div class="p-6 space-y-6">
                
                <!-- 類型 -->
                <div>
                    <label class="block text-lg font-bold text-thuBlue mb-2">1. 請選擇實習類型</label>
                    <div class="flex gap-4">
                        <label class="flex items-center gap-2 cursor-pointer p-3 border rounded-lg hover:bg-blue-50">
                            <input type="radio" name="contract_type" value="learn" checked onchange="toggleType()" class="w-5 h-5 text-thuBlue">
                            <span class="font-bold">一般型 (學習型)</span>
                        </label>
                        <label class="flex items-center gap-2 cursor-pointer p-3 border rounded-lg hover:bg-orange-50">
                            <input type="radio" name="contract_type" value="work" onchange="toggleType()" class="w-5 h-5 text-orange-600">
                            <span class="font-bold">工作型 (勞資型)</span>
                        </label>
                    </div>
                </div>

                <!-- 日期 -->
                <div>
                    <label class="block text-lg font-bold text-thuBlue mb-2">2. 實習期間</label>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <span class="text-sm text-gray-500">開始日期</span>
                            <input type="date" id="start_date" class="input-field">
                        </div>
                        <div>
                            <span class="text-sm text-gray-500">結束日期</span>
                            <input type="date" id="end_date" class="input-field">
                        </div>
                    </div>
                </div>

                <!-- 時間 -->
                <div>
                    <label class="block text-lg font-bold text-thuBlue mb-2">3. 每日實習時間</label>
                    <div class="grid grid-cols-3 gap-4 bg-gray-50 p-3 rounded">
                        <div>
                            <span class="text-sm text-gray-500">開始</span>
                            <input type="time" id="daily_start" value="09:00" class="input-field">
                        </div>
                        <div>
                            <span class="text-sm text-gray-500">結束</span>
                            <input type="time" id="daily_end" value="18:00" class="input-field">
                        </div>
                        <div>
                            <span class="text-sm text-gray-500">共計(小時)</span>
                            <input type="number" id="daily_hours" value="8" step="0.5" class="input-field">
                        </div>
                    </div>
                </div>

                <!-- 待遇 (動態變換) -->
                <div class="border-t pt-4">
                    <label class="block text-lg font-bold text-thuBlue mb-2">4. 實習待遇與給付</label>
                    
                    <!-- 學習型面板 -->
                    <div id="panel_learn" class="bg-green-50 p-4 rounded border border-green-200">
                        <span class="text-xs bg-green-600 text-white px-2 py-1 rounded">學習型適用</span>
                        <div class="mt-2 flex gap-4">
                            <label><input type="radio" name="pay_opt_learn" value="none" checked onchange="togglePayInputs()"> 無</label>
                            <label><input type="radio" name="pay_opt_learn" value="scholar" onchange="togglePayInputs()"> 獎學金</label>
                            <label><input type="radio" name="pay_opt_learn" value="allowance" onchange="togglePayInputs()"> 實習津貼</label>
                        </div>
                        <div id="learn_amt_box" class="mt-2 hidden">
                            <input type="number" id="learn_amount" placeholder="金額 (元)" class="input-field w-48">
                        </div>
                    </div>

                    <!-- 勞資型面板 -->
                    <div id="panel_work" class="bg-orange-50 p-4 rounded border border-orange-200 hidden">
                        <span class="text-xs bg-orange-600 text-white px-2 py-1 rounded">勞資型適用</span>
                        <div class="mt-2">
                            <label class="block text-sm text-orange-800 font-bold mb-1">薪資金額 (不得低於基本工資)</label>
                            <input type="number" id="work_amount" placeholder="27470" class="input-field w-48">
                        </div>
                    </div>
                </div>

                <!-- 福利 -->
                <div class="border-t pt-4">
                    <label class="block text-lg font-bold text-thuBlue mb-2">5. 福利項目</label>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <!-- 住宿 -->
                        <div>
                            <label class="text-sm font-bold">住宿</label>
                            <select id="dorm_opt" onchange="toggleCost('dorm')" class="input-field mb-2">
                                <option value="none">無</option>
                                <option value="free">免費提供</option>
                                <option value="paid">付費提供</option>
                            </select>
                            <input type="number" id="dorm_cost" placeholder="元/月" class="input-field hidden">
                        </div>
                        <!-- 膳食 -->
                        <div>
                            <label class="text-sm font-bold">膳食</label>
                            <select id="food_opt" onchange="toggleCost('food')" class="input-field mb-2">
                                <option value="none">無</option>
                                <option value="free">免費提供</option>
                                <option value="paid">付費提供</option>
                            </select>
                            <input type="number" id="food_cost" placeholder="元/餐" class="input-field hidden">
                        </div>
                        <!-- 交通 -->
                        <div>
                            <label class="text-sm font-bold">交通</label>
                            <select id="trans_opt" onchange="toggleCost('trans')" class="input-field mb-2">
                                <option value="none">無</option>
                                <option value="free">免費提供</option>
                                <option value="paid">付費提供</option>
                                <option value="subsidy">交通津貼</option>
                            </select>
                            <input type="number" id="trans_cost" placeholder="元/月" class="input-field hidden">
                        </div>
                    </div>
                </div>

            </div>
        </div>

        <!-- 產生按鈕 -->
        <div class="flex justify-end pb-10">
            <button onclick="generateDoc()" class="bg-thuBlue text-white px-8 py-3 rounded-md font-bold shadow-lg hover:bg-blue-900 transition flex items-center gap-2 text-lg">
                <i class="fa-regular fa-file-word"></i> 產生合約文件 (Word)
            </button>
        </div>

    </main>

    <!-- JS 邏輯區 -->
    <script>
        // 初始化：渲染學生欄位
        function renderStudents() {
            const count = document.getElementById('student_count').value;
            const container = document.getElementById('student_container');
            container.innerHTML = '';
            for(let i=0; i<count; i++) {
                container.innerHTML += `
                    <div class="p-3 bg-blue-50 border border-blue-100 rounded">
                        <div class="text-sm font-bold text-blue-800 mb-2">學生 ${i+1}</div>
                        <div class="grid grid-cols-2 gap-4">
                            <input type="text" id="s_name_${i}" placeholder="姓名" class="input-field">
                            <input type="text" id="s_id_${i}" placeholder="系級/學號" class="input-field">
                        </div>
                    </div>
                `;
            }
        }
        renderStudents(); // 執行一次

        // UI 切換邏輯
        function toggleBranch() {
            const isCheck = document.getElementById('is_branch').checked;
            document.getElementById('branch_area').classList.toggle('hidden', !isCheck);
        }

        function toggleType() {
            const type = document.querySelector('input[name="contract_type"]:checked').value;
            const pLearn = document.getElementById('panel_learn');
            const pWork = document.getElementById('panel_work');
            if (type === 'learn') {
                pLearn.classList.remove('hidden');
                pWork.classList.add('hidden');
            } else {
                pLearn.classList.add('hidden');
                pWork.classList.remove('hidden');
            }
        }

        function togglePayInputs() {
            const val = document.querySelector('input[name="pay_opt_learn"]:checked').value;
            document.getElementById('learn_amt_box').classList.toggle('hidden', val === 'none');
        }

        function toggleCost(prefix) {
            const val = document.getElementById(prefix + '_opt').value;
            const input = document.getElementById(prefix + '_cost');
            // 付費提供或交通津貼才顯示金額
            if (val === 'paid' || val === 'subsidy') {
                input.classList.remove('hidden');
            } else {
                input.classList.add('hidden');
            }
        }

        // --- 核心：產生 Word 檔案 ---
        function loadFile(url, callback) {
            JSZipUtils.getBinaryContent(url, callback);
        }

        function generateDoc() {
            // 1. 收集資料
            const data = {};
            
            // 機構
            data.company_name = document.getElementById('company_name').value;
            data.company_tax_id = document.getElementById('company_tax_id').value;
            data.company_rep = document.getElementById('company_rep').value;
            data.company_title = document.getElementById('company_title').value;
            
            // 地址處理
            const regAddr = document.getElementById('reg_address').value;
            if (document.getElementById('is_branch').checked) {
                const bName = document.getElementById('branch_name').value;
                const bAddr = document.getElementById('branch_addr').value;
                data.company_address = `${regAddr} (實習地點：${bName} - ${bAddr})`;
            } else {
                data.company_address = regAddr;
            }

            // 學生 (多位)
            const sCount = document.getElementById('student_count').value;
            const sList = [];
            for(let i=0; i<sCount; i++) {
                const n = document.getElementById(`s_name_${i}`).value;
                const id = document.getElementById(`s_id_${i}`).value;
                sList.push({name: n, id: id});
            }
            // 補足3位空值
            while(sList.length < 3) sList.push({name: "", id: ""});
            
            data.s1_name = sList[0].name; data.s1_id = sList[0].id;
            data.s2_name = sList[1].name; data.s2_id = sList[1].id;
            data.s3_name = sList[2].name; data.s3_id = sList[2].id;
            data.student_name = sList[0].name + (sCount > 1 ? " 等" : "");

            // 日期 (轉民國年)
            const sDate = new Date(document.getElementById('start_date').value);
            const eDate = new Date(document.getElementById('end_date').value);
            
            if(!isNaN(sDate)) {
                data.s_y = sDate.getFullYear() - 1911;
                data.s_m = sDate.getMonth() + 1;
                data.s_d = sDate.getDate();
            }
            if(!isNaN(eDate)) {
                data.e_y = eDate.getFullYear() - 1911;
                data.e_m = eDate.getMonth() + 1;
                data.e_d = eDate.getDate();
            }

            // 時間
            data.daily_start = document.getElementById('daily_start').value;
            data.daily_end = document.getElementById('daily_end').value;
            data.daily_hours = document.getElementById('daily_hours').value;

            // 條件與待遇邏輯 (Checkbox 轉 ☑/□)
            const type = document.querySelector('input[name="contract_type"]:checked').value;
            
            // 預設全空
            data.type_learn_check = '□'; data.type_work_check = '□';
            data.chk_pay_none = '□'; data.chk_pay_scholar = '□'; data.chk_pay_allowance = '□';
            data.pay_learn_amount = ""; data.pay_work_amount = "";

            if (type === 'learn') {
                data.type_learn_check = '☑';
                const pOpt = document.querySelector('input[name="pay_opt_learn"]:checked').value;
                if(pOpt === 'none') {
                    data.chk_pay_none = '☑';
                    data.pay_learn_amount = "0";
                } else if(pOpt === 'scholar') {
                    data.chk_pay_scholar = '☑';
                    data.pay_learn_amount = Number(document.getElementById('learn_amount').value).toLocaleString();
                } else {
                    data.chk_pay_allowance = '☑';
                    data.pay_learn_amount = Number(document.getElementById('learn_amount').value).toLocaleString();
                }
            } else {
                data.type_work_check = '☑';
                data.pay_work_amount = Number(document.getElementById('work_amount').value).toLocaleString();
            }

            // 福利邏輯
            function setWelfare(prefix) {
                const opt = document.getElementById(prefix + '_opt').value;
                data[`chk_${prefix}_none`] = '□';
                data[`chk_${prefix}_free`] = '□';
                data[`chk_${prefix}_paid`] = '□';
                
                if(opt === 'none') data[`chk_${prefix}_none`] = '☑';
                else if(opt === 'free') data[`chk_${prefix}_free`] = '☑';
                else {
                    data[`chk_${prefix}_paid`] = '☑';
                    data[`${prefix}_cost`] = Number(document.getElementById(prefix + '_cost').value).toLocaleString();
                }
            }
            setWelfare('dorm');
            setWelfare('food');
            setWelfare('trans');

            // 2. 讀取 Template 並渲染
            loadFile("template.docx", function(error, content) {
                if (error) { throw error; }
                const zip = new PizZip(content);
                const doc = new window.docxtemplater(zip, {
                    paragraphLoop: true,
                    linebreaks: true,
                });

                // 填入資料
                doc.render(data);

                // 輸出檔案
                const out = doc.getZip().generate({
                    type: "blob",
                    mimeType: "application/vnd.openxmlformats-officedocument.wordprocessingml.document",
                });
                saveAs(out, `東海大學實習合約_${data.s1_name}.docx`);
            });
        }
    </script>
</body>
</html>