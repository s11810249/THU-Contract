<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>東海大學學生校外實習文件產生器 (V1.0.66 UI Polish)</title>

    <!-- 核心函式庫 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/pizzip@3.1.4/dist/pizzip.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/docxtemplater/3.37.11/docxtemplater.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/1.3.8/FileSaver.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>

    <!-- 東海配色 -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        thuBlue: '#002E5D',
                        thuGold: '#C6A87C',
                    },
                    fontFamily: {
                        sans: ['"Noto Sans TC"', 'sans-serif'],
                    }
                }
            }
        }
    </script>

    <style>
        body {
            background-color: #f3f4f6;
            font-family: 'Noto Sans TC', sans-serif;
            padding-bottom: 100px; 
            color: #374151;
            scroll-behavior: smooth;
        }
        
        /* 通用輸入框 */
        .input-field {
            background-color: white; border: 1px solid #d1d5db; border-radius: 0.375rem; padding: 0.6rem 0.8rem; width: 100%; font-size: 1rem; transition: all 0.2s ease;
        }
        .input-field:focus { outline: none; border-color: #002E5D; box-shadow: 0 0 0 3px rgba(0, 46, 93, 0.1); }
        .input-error { border-color: #ef4444 !important; background-color: #fef2f2 !important; }
        
        .proposal-textarea { resize: vertical; min-height: 4.5rem; line-height: 1.5rem; padding: 0.5rem 0.75rem; font-size: 0.95rem; }
        
        /* 移除數字輸入框箭頭 */
        input[type=number]::-webkit-inner-spin-button, input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        input[type=number] { -moz-appearance: textfield; }

        /* 日期群組 (移除 AutoJump 後簡化樣式) */
        .date-group, .grade-input-group {
            display: flex; align-items: center; justify-content: center;
            background: white; border: 1px solid #d1d5db; border-radius: 0.5rem;
            padding: 0.4rem; transition: all 0.2s ease; overflow: hidden; height: 42px;
        }
        .date-group:focus-within, .grade-input-group:focus-within { border-color: #002E5D; box-shadow: 0 0 0 3px rgba(0, 46, 93, 0.1); }
        .date-input, .grade-input-field { border: none; text-align: center !important; width: 100%; outline: none; font-size: 1rem; color: #374151; background: transparent; padding: 0; height: 100%; }
        .date-input { min-width: 2.5rem; }
        .grade-input-field { padding: 0 0.1rem; flex-grow: 1; }
        .date-sep { color: #9ca3af; font-weight: bold; padding: 0 0.1rem; user-select: none; flex-shrink: 0; }
        .grade-suffix { color: #374151; padding-right: 0.8rem; font-size: 1rem; font-weight: 500; flex-shrink: 0; }

        .delete-student-btn { position: absolute; top: -12px; right: -12px; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; border-radius: 9999px; background-color: #fef2f2; color: #ef4444; transition: all 0.2s ease-out; z-index: 10; opacity: 0; cursor: pointer; }
        .student-wrapper:hover .delete-student-btn { opacity: 1; background-color: #ef4444; color: white; transform: scale(1.1); }

        .card { background: white; border-radius: 0.75rem; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05); border: 1px solid #e5e7eb; overflow: hidden; margin-bottom: 2rem; transition: border-color 0.3s; }
        .card-header { padding: 1.25rem 2rem; background-color: #ffffff; border-bottom: 1px solid #f3f4f6; color: #002E5D; font-weight: 700; font-size: 1.125rem; display: flex; align-items: center; justify-content: space-between; }
        .card-header-title { display: flex; align-items: center; }
        .card-header-title::before { content: ''; display: inline-block; width: 5px; height: 1.2rem; background-color: #C6A87C; margin-right: 0.75rem; border-radius: 2px; }
        .hidden { display: none; }
        
        #status-bar { display: none; position: fixed; bottom: 80px; right: 20px; background: #333; color: white; padding: 8px 16px; border-radius: 6px; z-index: 9999; box-shadow: 0 4px 12px rgba(0,0,0,0.3); font-size: 0.9rem; }
        #lib-error { display: none; position: fixed; top: 0; left: 0; width: 100%; background: #ef4444; color: white; text-align: center; padding: 10px; z-index: 9999; font-weight: bold; }
        #error-modal, #confirm-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10000; align-items: center; justify-content: center; }
        #error-content, #confirm-content { background: white; padding: 2rem; border-radius: 1rem; max-width: 600px; width: 90%; max-height: 80%; overflow-y: auto; }
        pre { white-space: pre-wrap; word-break: break-word; }

        footer { position: fixed; bottom: 0; left: 0; width: 100%; background-color: #1f2937; color: #9ca3af; text-align: center; padding: 1rem 0; font-size: 0.75rem; z-index: 50; border-top: 3px solid #C6A87C; }
        .fade-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        
        .btn-query { background-color: #C6A87C; color: #002E5D; font-weight: bold; border-radius: 0.375rem; padding: 0.6rem 1.25rem; transition: all 0.2s ease; box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); }
        .btn-query:hover:not(:disabled) { background-color: #b3976e; transform: translateY(-1px); box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        .btn-query-loading { background: linear-gradient(135deg, #002E5D30 0%, #00408030 100%) !important; color: #002E5D !important; cursor: not-allowed !important; box-shadow: none !important; }

        .nav-button { background-color: #f0f4ff; color: #002E5D; border: none; transition: all 0.2s; height: 48px; font-weight: 600; box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1); }
        .nav-button:hover:not(:disabled) { background-color: #e3e9ff; color: #002E5D; transform: translateY(-1px); box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        
        .btn-generate { height: 64px; background: linear-gradient(135deg, #002E5D 0%, #004080 100%); box-shadow: 0 4px 6px -1px rgba(0, 46, 93, 0.3), 0 2px 4px -1px rgba(0, 46, 93, 0.1); transition: all 0.3s ease; color: white; }
        .btn-generate:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 10px 15px -3px rgba(0, 46, 93, 0.3), 0 4px 6px -2px rgba(0, 46, 93, 0.1); background: linear-gradient(135deg, #003366 0%, #0055aa 100%); }
        .btn-generate:active:not(:disabled) { transform: translateY(0); }
        .btn-generate:disabled { background: #9ca3af; cursor: not-allowed; transform: none; box-shadow: none; }

        /* 頁籤 */
        .tab-button { padding: 0.75rem 1.5rem; font-weight: 700; border-radius: 0.5rem 0.5rem 0 0; transition: all 0.3s; border-bottom: 3px solid transparent; color: #9ca3af; background-color: transparent; margin-right: 0.25rem; flex-grow: 1; text-align: center; }
        .tab-button.active { color: #002E5D; background-color: white; border-color: #002E5D; box-shadow: 0 -4px 6px -1px rgba(0, 0, 0, 0.05); }

        /* 選項卡片通用樣式 */
        .option-card-label { position: relative; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 1rem; border: 1px solid #e5e7eb; border-radius: 0.5rem; cursor: pointer; transition: all 0.2s; background-color: white; height: 100%; min-height: 80px; }
        .option-card-label:hover { background-color: #f9fafb; border-color: #94a3b8; }
        .option-card-label:has(input:checked) { border-color: #002E5D; background-color: #eff6ff; box-shadow: 0 0 0 1px #002E5D; }
        .option-card-label:has(input:checked) .option-icon { color: #002E5D; }
        .option-card-label:has(input:checked) .option-text { color: #002E5D; }
        .option-icon { font-size: 1.5rem; margin-bottom: 0.25rem; color: #94a3b8; transition: color 0.2s; }
        .option-text { font-size: 0.875rem; font-weight: bold; color: #64748b; }
        .radio-card-input, .radio-hidden { position: absolute; opacity: 0; width: 0; height: 0; }

        /* 福利選項 (較小) */
        .welfare-option { padding: 0.6rem 1rem; flex-direction: row; gap: 0.5rem; min-height: auto; width: auto; flex: 1; }
        .welfare-option .option-icon { font-size: 1rem; margin-bottom: 0; }
        
        /* Pay Type Specific Colors */
        .opt-learn:has(input:checked) { border-color: #16a34a; background-color: #f0fdf4; box-shadow: 0 0 0 1px #16a34a; }
        .opt-learn:has(input:checked) .option-icon, .opt-learn:has(input:checked) .option-text { color: #15803d; }
        .opt-work:has(input:checked) { border-color: #ea580c; background-color: #fff7ed; box-shadow: 0 0 0 1px #ea580c; }
        .opt-work:has(input:checked) .option-icon, .opt-work:has(input:checked) .option-text { color: #c2410c; }

        /* Sub-option Card (Small) */
        .sub-option-label { display: flex; align-items: center; justify-content: center; padding: 0.75rem; border: 1px solid #e5e7eb; border-radius: 0.5rem; cursor: pointer; transition: all 0.2s; background: white; height: 100%; gap: 0.5rem; }
        .sub-option-label:hover { background-color: #f9fafb; }
        .sub-option-label:has(input:checked) { border-color: #002E5D; background-color: #f0f9ff; color: #002E5D; font-weight: bold; box-shadow: 0 0 0 1px #002E5D; }

        /* Multi-Select */
        .multi-select-dropdown { position: relative; }
        .multi-select-trigger { cursor: pointer; background-color: white; border: 1px solid #d1d5db; border-radius: 0.375rem; padding: 0.6rem 0.8rem; min-height: 42px; display: flex; align-items: center; justify-content: space-between; }
        .multi-select-content { position: absolute; top: 100%; left: 0; width: 100%; background-color: white; border: 1px solid #d1d5db; border-radius: 0.375rem; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); z-index: 50; margin-top: 4px; max-height: 250px; overflow-y: auto; display: none; }
        .multi-select-content.open { display: block; }
        .course-checkbox-item { padding: 0.5rem 0.75rem; display: flex; align-items: flex-start; cursor: pointer; transition: background 0.1s; border-bottom: 1px solid #f3f4f6; }
        .course-checkbox-item:last-child { border-bottom: none; }
        .course-checkbox-item:hover { background-color: #f9fafb; }
        .course-checkbox-item input { margin-top: 0.3rem; margin-right: 0.75rem; }

        .debug-upload-label { display: inline-flex; align-items: center; gap: 0.5rem; font-size: 0.85rem; color: #6b7280; cursor: pointer; transition: color 0.2s; margin-left: 1rem; }
        .debug-upload-label:hover { color: #002E5D; }
        .debug-status { font-size: 0.75rem; font-weight: bold; color: #16a34a; margin-left: 0.5rem; display: none; }
        .debug-status.show { display: inline; }
        .student-proposal-card { transition: all 0.3s ease; }
        .student-proposal-card:hover { box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); }
    </style>
</head>
<body>

    <div id="lib-error">⚠️ 系統偵測到核心元件未載入成功！可能是網路阻擋了 CDN。</div>
    <div id="status-bar">準備就緒</div>

    <div id="error-modal">
        <div id="error-content">
            <h3 id="modal-header-title" class="text-xl font-bold text-red-600 mb-4 flex items-center gap-2"><i id="modal-header-icon" class="fa-solid fa-circle-exclamation"></i> 發生錯誤</h3>
            <div class="bg-gray-50 p-4 rounded border border-gray-200 mb-6"><pre id="error-details" class="text-sm text-gray-800 font-mono"></pre></div>
            <div class="flex justify-end"><button id="err-close" class="bg-gray-200 text-gray-700 px-6 py-2 rounded font-bold hover:bg-gray-300 transition">關閉</button></div>
        </div>
    </div>

    <div id="confirm-modal">
        <div id="confirm-content">
            <h3 class="text-xl font-bold text-thuBlue mb-4 flex items-center gap-2"><i class="fa-solid fa-circle-question"></i> 操作確認</h3>
            <div class="bg-blue-50 p-4 rounded border border-blue-200 mb-6"><pre id="confirm-details" class="text-sm text-gray-800 font-mono whitespace-pre-wrap"></pre></div>
            <div class="flex justify-end gap-3">
                <button id="confirm-cancel" class="bg-gray-200 text-gray-700 px-5 py-2 rounded-lg font-bold hover:bg-gray-300 transition">取消</button>
                <button id="confirm-ok" class="bg-thuBlue text-white px-5 py-2 rounded-lg font-bold hover:bg-blue-800 transition shadow-md">確定執行</button>
            </div>
        </div>
    </div>

    <div class="fixed top-0 left-0 w-full bg-thuBlue z-50 shadow-md">
        <div class="w-full px-4 md:px-8 h-[80px] flex items-center justify-between">
            <div class="flex items-center gap-4">
                <img src="https://www.thu.edu.tw/upload/pagepic_upload/logo_w.svg" alt="THU Logo" class="h-10 w-auto">
                <div class="flex flex-col justify-center text-white">
                    <div class="text-lg md:text-xl font-bold tracking-wide leading-tight">學生校外實習文件產生器</div>
                    <div class="text-xs text-thuGold opacity-90 font-sans leading-tight mt-0.5">Internship Document Generation System (Debug Mode)</div>
                </div>
            </div>
            <div class="hidden md:flex gap-3 text-sm">
                <a href="https://aca.thu.edu.tw/web/isac/page.php?scid=112&sid=103" target="_blank" class="flex items-center gap-2 px-4 py-2 border border-thuGold text-thuGold rounded-full hover:bg-thuGold hover:text-thuBlue transition-all duration-200 font-medium"><i class="fa-solid fa-link"></i> 實習中心網頁</a>
                <a href="https://www.thu.edu.tw/" target="_blank" class="flex items-center gap-2 px-4 py-2 bg-white text-thuBlue rounded-full hover:bg-gray-100 shadow-sm transition-all duration-200 font-medium"><i class="fa-solid fa-house"></i> 東海大學首頁</a>
            </div>
        </div>
    </div>

    <main class="mx-auto mb-20 pt-24">
        <div class="sticky top-[80px] z-40 bg-[#f3f4f6] w-full border-b border-gray-300 pt-4 mb-10 shadow-sm">
            <div class="max-w-7xl mx-auto px-4">
                <div class="flex -mb-px">
                    <button class="tab-button active" data-page="page-1" onclick="showPage('page-1')"><i class="fa-solid fa-circle-info mr-2"></i> 1. 使用須知</button>
                    <button class="tab-button" data-page="page-2" onclick="showPage('page-2')"><i class="fa-solid fa-users mr-2"></i> 2. 實習學生資料</button>
                    <button class="tab-button" data-page="page-3" onclick="showPage('page-3')"><i class="fa-solid fa-file-contract mr-2"></i> 3. 實習合約內容</button>
                    <button class="tab-button" data-page="page-4" onclick="showPage('page-4')"><i class="fa-solid fa-book mr-2"></i> 4. 學生實習計畫書</button>
                </div>
            </div>
        </div>

        <div class="max-w-7xl mx-auto px-4">
            <form id="contractForm">
                <!-- Page 1 -->
                <div id="page-1" class="page-content mt-4">
                    <div class="bg-white border border-blue-100 rounded-xl p-8 shadow-sm">
                        <div class="flex items-start gap-4">
                            <div class="w-12 h-12 rounded-full bg-blue-50 flex items-center justify-center text-blue-600 shrink-0"><i class="fa-solid fa-lightbulb text-xl"></i></div>
                            <div class="flex-1">
                                <h3 class="text-lg font-bold text-gray-800 mb-3">系統操作流程與說明</h3>
                                <ol class="text-base text-gray-600 leading-relaxed list-decimal list-outside ml-4 space-y-3">
                                    <li>請依序完成步驟 1~3 的資料填寫。</li>
                                    <li>所有運算皆在您的瀏覽器完成，不會上傳任何個資。</li>
                                </ol>
                            </div>
                        </div>
                    </div>
                    <div class="flex justify-end mt-6"><button type="button" onclick="showPage('page-2')" class="nav-button w-40 px-6 py-3 rounded-full font-bold flex items-center justify-center gap-2">下一步 <i class="fa-solid fa-arrow-right"></i></button></div>
                </div>

                <!-- Page 2 -->
                <div id="page-2" class="page-content hidden">
                    <div class="card">
                        <div class="card-header">
                            <span class="card-header-title mr-4">實習學生資料</span>
                            <div class="flex items-center bg-gray-100 rounded-lg p-1 border border-gray-200">
                                <button type="button" onclick="changeStudentCount(-1)" class="w-8 h-8 flex items-center justify-center rounded-md text-gray-600 hover:bg-white hover:shadow-sm hover:text-thuBlue transition-all"><i class="fa-solid fa-minus"></i></button>
                                <div class="w-16 text-center text-sm font-bold text-thuBlue" id="student_count_display">1 人</div>
                                <button type="button" onclick="changeStudentCount(1)" class="w-8 h-8 flex items-center justify-center rounded-md text-gray-600 hover:bg-white hover:shadow-sm hover:text-thuBlue transition-all"><i class="fa-solid fa-plus"></i></button>
                            </div>
                            <input type="hidden" id="student_count" value="1">
                        </div>
                        <div class="px-8 pt-4 flex justify-end">
                             <input type="file" id="upload_excel" accept=".xlsx, .xls" class="hidden" onchange="handleExcelUpload(event)">
                             <div class="flex gap-2">
                                 <button type="button" onclick="downloadExcelTemplate()" class="text-sm text-gray-500 hover:text-thuBlue underline mr-2"><i class="fa-solid fa-download"></i> 下載範本</button>
                                 <button type="button" onclick="document.getElementById('upload_excel').click()" class="bg-green-600 text-white px-3 py-1.5 rounded text-sm font-bold hover:bg-green-700 transition flex items-center gap-1"><i class="fa-solid fa-file-excel"></i> 匯入 Excel</button>
                             </div>
                        </div>
                        <div class="p-8"><div id="student_container" class="space-y-6"></div></div>
                    </div>
                    <div class="flex justify-between mt-6">
                        <button type="button" onclick="showPage('page-1')" class="nav-button w-40 px-6 py-3 rounded-full font-bold flex items-center justify-center gap-2"><i class="fa-solid fa-arrow-left"></i> 上一步</button>
                        <button type="button" onclick="showPage('page-3')" class="nav-button w-40 px-6 py-3 rounded-full font-bold flex items-center justify-center gap-2">下一步 <i class="fa-solid fa-arrow-right"></i></button>
                    </div>
                </div>

                <!-- Page 3 -->
                <div id="page-3" class="page-content hidden">
                    <div class="card">
                        <div class="card-header">
                            <div class="flex items-center"><span class="card-header-title">乙方：實習機構資料</span><label class="debug-upload-label"><i class="fa-solid fa-wrench"></i> 測試合約範本<input type="file" accept=".docx" class="hidden" onchange="handleDebugUpload(event, 'contract')"></label><span id="debug_contract_status" class="debug-status"><i class="fa-solid fa-check"></i> 已載入</span></div>
                        </div>
                        <div class="p-8 grid grid-cols-1 md:grid-cols-4 gap-x-6 gap-y-6">
                            <div class="md:col-span-4 flex flex-col md:flex-row gap-x-6 gap-y-4">
                                <div class="w-full md:w-[65%]"><label class="block text-sm font-bold text-gray-700 mb-2">統一編號</label><div id="tax_id_input_group" class="flex gap-2 items-center transition-opacity duration-300"><input type="text" id="company_tax_id" class="input-field flex-grow" placeholder="04231910" maxlength="15" onkeydown="handleTaxIdKey(event)"><button type="button" id="queryBtn" class="btn-query flex items-center gap-2 opacity-50 cursor-not-allowed whitespace-nowrap" disabled><i class="fa-solid fa-magnifying-glass"></i> 自動查詢</button></div></div>
                                <div class="w-full md:w-[35%] self-end"><label class="flex items-center p-3 h-[42px] border-2 rounded-lg cursor-pointer transition-all hover:bg-gray-100 has-[:checked]:border-red-500 has-[:checked]:bg-red-50/50"><input type="checkbox" id="no_tax_id" onchange="toggleTaxIdFields()" class="w-4 h-4 text-red-600 bg-gray-100 border-gray-300 rounded focus:ring-red-500"><span class="ml-2 text-base font-medium text-gray-800 select-none whitespace-normal">實習機構未申請設立字號</span></label></div>
                            </div>
                            <div class="md:col-span-4"><label class="block text-sm font-bold text-gray-700 mb-2">機構全銜 (法定名稱) <span class="text-red-500">*</span></label><input type="text" id="company_name" class="input-field" placeholder="例：國泰世華商業銀行股份有限公司"></div>
                            <div class="md:col-span-2"><label class="block text-sm font-bold text-gray-700 mb-2">代表人姓名 <span class="text-red-500">*</span></label><input type="text" id="company_rep" class="input-field"></div>
                            <div class="md:col-span-2"><label class="block text-sm font-bold text-gray-700 mb-2">代表人職稱 <span class="text-red-500">*</span></label><input type="text" id="company_title" class="input-field" placeholder=""></div>
                            <div class="md:col-span-4"><label class="block text-sm font-bold text-gray-700 mb-2">公司登記地址 (總公司) <span class="text-red-500">*</span></label><input type="text" id="reg_address" class="input-field" placeholder="例：臺北市信義區松仁路7號1樓"></div>
                            <div class="md:col-span-4 pt-6 border-t border-gray-200 mt-2">
                                <div class="text-sm font-bold text-thuBlue mb-4 flex items-center gap-2 bg-blue-50 p-2 rounded"><i class="fa-solid fa-location-dot"></i> 實習地點</div>
                                <div class="mb-4 flex items-center"><input type="checkbox" id="is_head_office" class="w-4 h-4 text-thuBlue bg-gray-100 border-gray-300 rounded focus:ring-thuBlue" onchange="toggleBranchFields()"><label for="is_head_office" class="ml-2 text-sm font-medium text-gray-700 select-none">學生於總公司實習 (或實習機構無分公司)</label></div>
                                <div id="branch_fields_wrapper" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <div><label class="block text-xs font-bold text-gray-500 mb-2">實習單位/分公司名稱 <span class="text-red-500">*</span></label><input type="text" id="branch_name" class="input-field" placeholder="例：淡水分公司"></div>
                                    <div><label class="block text-xs font-bold text-gray-500 mb-2">實際實習地址 <span class="text-red-500">*</span></label><input type="text" id="branch_addr" class="input-field" placeholder="例：新北市淡水區中山路106號"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header"><span class="card-header-title">實習期間與時間</span></div>
                        <div class="p-8 space-y-8">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div><span class="text-xs font-bold text-gray-500 mb-2 block uppercase tracking-wide text-center">實習開始</span><div class="date-group"><input type="number" id="start_y" class="date-input w-16 text-thuBlue" placeholder="113"><span class="date-sep">/</span><input type="number" id="start_m" class="date-input w-12" placeholder="07"><span class="date-sep">/</span><input type="number" id="start_d" class="date-input w-12" placeholder="01"></div></div>
                                <div><span class="text-xs font-bold text-gray-500 mb-2 block uppercase tracking-wide text-center">實習結束</span><div class="date-group"><input type="number" id="end_y" class="date-input w-16 text-thuBlue" placeholder="114"><span class="date-sep">/</span><input type="number" id="end_m" class="date-input w-12" placeholder="06"><span class="date-sep">/</span><input type="number" id="end_d" class="date-input w-12" placeholder="30"></div></div>
                            </div>
                            <div class="border-t border-gray-200 pt-8"><div class="grid grid-cols-1 md:grid-cols-3 gap-6 bg-gray-50 p-6 rounded-lg border border-gray-200"><div><span class="text-xs font-bold text-gray-400 uppercase mb-1 block">每日開始</span><input type="time" id="daily_start" class="input-field"></div><div><span class="text-xs font-bold text-gray-400 uppercase mb-1 block">每日結束</span><input type="time" id="daily_end" class="input-field"></div><div><span class="text-xs font-bold text-gray-400 uppercase mb-1 block">共計(小時)</span><input type="number" id="daily_hours" step="0.5" class="input-field"></div></div></div>
                        </div>
                    </div>

                    <div class="card" id="card-conditions">
                        <div class="card-header"><span class="card-header-title">實習類型與待遇福利</span></div>
                        <div class="p-8 space-y-10">
                            <div>
                                <label class="block text-lg font-bold text-thuBlue mb-4">1. 實習類型 <span class="text-red-500 text-sm">*</span></label>
                                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                    <label class="option-card-label"><input type="radio" name="contract_type" value="learn" onchange="toggleType()" class="radio-card-input"><i class="fa-solid fa-book option-icon"></i><span class="option-text text-lg">一般型 (學習型)</span><span class="text-xs text-gray-400 mt-1">單純學習訓練</span></label>
                                    <label class="option-card-label"><input type="radio" name="contract_type" value="work" onchange="toggleType()" class="radio-card-input"><i class="fa-solid fa-briefcase option-icon"></i><span class="option-text text-lg">工作型 (勞資型)</span><span class="text-xs text-gray-400 mt-1">具僱傭關係</span></label>
                                </div>
                            </div>
                            <div id="pay-section" class="border-t border-gray-200 pt-8">
                                <label class="block text-lg font-bold text-thuBlue mb-4">2. 待遇給付 <span class="text-red-500 text-sm">*</span></label>
                                <div id="panel_initial" class="p-8 bg-yellow-50 rounded-xl border-2 border-dashed border-yellow-200 text-center text-yellow-700 font-bold">請先選擇上方「實習類型」</div>
                                <div id="panel_learn" class="hidden space-y-6">
                                    <span class="text-[10px] font-black text-green-700 bg-green-200 px-2 py-1 rounded uppercase tracking-wider mb-4 inline-block">學習型</span>
                                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-6">
                                        <label class="option-card-label opt-learn"><input type="radio" name="pay_opt_learn" value="none" onchange="togglePayInputs()" class="radio-card-input"><i class="fa-solid fa-ban option-icon"></i><span class="option-text">無</span></label>
                                        <label class="option-card-label opt-learn"><input type="radio" name="pay_opt_learn" value="scholar" onchange="togglePayInputs()" class="radio-card-input"><i class="fa-solid fa-graduation-cap option-icon"></i><span class="option-text">獎學金</span></label>
                                        <label class="option-card-label opt-learn"><input type="radio" name="pay_opt_learn" value="allowance" onchange="togglePayInputs()" class="radio-card-input"><i class="fa-solid fa-hand-holding-dollar option-icon"></i><span class="option-text">實習津貼</span></label>
                                    </div>
                                    <div id="learn_pay_details" class="hidden bg-green-50 p-5 rounded-lg border border-green-200">
                                        <div class="flex flex-col md:flex-row gap-6">
                                            <div class="w-full md:w-1/2">
                                                <label class="block text-xs font-bold text-green-800 mb-2 uppercase">給付方式</label>
                                                <div class="grid grid-cols-2 gap-3">
                                                    <label class="sub-option-label"><input type="radio" name="pay_method_learn" value="total" class="radio-hidden" onchange="togglePayInputs()" checked><i class="fa-solid fa-sack-dollar"></i> <span>總額給付</span></label>
                                                    <label class="sub-option-label"><input type="radio" name="pay_method_learn" value="monthly" class="radio-hidden" onchange="togglePayInputs()"><i class="fa-regular fa-calendar-check"></i> <span>按月給付</span></label>
                                                </div>
                                            </div>
                                            <div class="w-full md:w-1/2">
                                                <label id="learn_amt_label" class="block text-xs font-bold text-green-800 mb-2 uppercase">給付金額 (總額)</label>
                                                <div class="relative"><div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none text-gray-500 font-bold">NT$</div><input type="number" id="learn_amount" placeholder="0" class="input-field pl-12 pr-8 text-right border-green-300 focus:border-green-600 font-mono text-lg"><div class="absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none text-gray-500 font-bold">元</div></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div id="panel_work" class="hidden space-y-6">
                                    <span class="text-[10px] font-black text-orange-700 bg-orange-200 px-2 py-1 rounded uppercase tracking-wider w-fit">勞資型</span>
                                    <!-- 法規公告 (改為置頂顯示全部) -->
                                    <div class="bg-white p-4 rounded-lg border-l-4 border-orange-400 shadow-sm text-xs text-gray-600 leading-relaxed mb-4">
                                        <div class="font-bold text-orange-600 mb-2 flex items-center gap-1 text-sm"><i class="fa-solid fa-scale-balanced"></i> 勞動部基本工資調整公告</div>
                                        <ul class="list-disc list-inside space-y-1.5">
                                            <li><span class="font-bold text-gray-800">115年1月1日起：</span>月薪 <span class="text-red-600 font-bold">29,500</span> 元 / 時薪 <span class="text-red-600 font-bold">196</span> 元。</li>
                                            <li><span class="font-bold text-gray-800">114年1月1日起：</span>月薪 <span class="text-red-600 font-bold">28,590</span> 元 / 時薪 <span class="text-red-600 font-bold">190</span> 元。</li>
                                        </ul>
                                    </div>
                                    <div class="bg-orange-50 p-6 rounded-xl border border-orange-200 flex flex-col md:flex-row gap-6">
                                        <div class="w-full md:w-1/2">
                                            <label class="block text-xs font-bold text-orange-800 mb-2 uppercase">計薪方式</label>
                                            <div class="grid grid-cols-2 gap-3">
                                                <label class="sub-option-label"><input type="radio" name="wage_type_work" value="monthly" class="radio-hidden" onchange="toggleWorkWageType()" checked><i class="fa-solid fa-calendar-days"></i> <span>月薪</span></label>
                                                <label class="sub-option-label"><input type="radio" name="wage_type_work" value="hourly" class="radio-hidden" onchange="toggleWorkWageType()"><i class="fa-regular fa-clock"></i> <span>時薪</span></label>
                                            </div>
                                        </div>
                                        <div class="w-full md:w-1/2">
                                            <label id="work_amt_label" class="block text-xs font-bold text-orange-800 mb-2 uppercase">薪資金額 (月薪)</label>
                                            <div class="relative"><div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none text-gray-500 font-bold">NT$</div><input type="number" id="work_amount" placeholder="28590" class="input-field pl-12 pr-8 text-right border-orange-300 focus:border-orange-500 font-mono text-lg"><div class="absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none text-gray-500 font-bold">元</div></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- 3. 福利項目 (重新設計) -->
                            <div id="welfare-section" class="border-t border-gray-200 pt-8">
                                <label class="block text-lg font-bold text-thuBlue mb-6">3. 福利項目 <span class="text-red-500 text-sm">*必填</span></label>
                                <div class="space-y-8">
                                    <!-- 住宿 -->
                                    <div class="flex flex-col md:flex-row gap-4 items-start md:items-center border-b border-gray-100 pb-6">
                                        <div class="w-28 font-bold text-gray-700 shrink-0 flex items-center gap-2 text-base"><i class="fa-solid fa-bed text-thuGold text-lg"></i> 住宿</div>
                                        <div class="flex flex-wrap gap-3 grow">
                                            <label class="option-card-label welfare-option"><input type="radio" name="dorm_opt" value="none" onchange="toggleWelfare()" class="radio-card-input"><i class="fa-solid fa-circle-xmark option-icon"></i><span class="option-text text-sm">無</span></label>
                                            <label class="option-card-label welfare-option"><input type="radio" name="dorm_opt" value="free" onchange="toggleWelfare()" class="radio-card-input"><i class="fa-solid fa-gift option-icon"></i><span class="option-text text-sm">免費提供</span></label>
                                            <label class="option-card-label welfare-option"><input type="radio" name="dorm_opt" value="paid" onchange="toggleWelfare()" class="radio-card-input"><i class="fa-solid fa-file-invoice-dollar option-icon"></i><span class="option-text text-sm">付費提供</span></label>
                                        </div>
                                        <div id="dorm_cost_box" class="hidden w-full md:w-48 relative"><div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none text-gray-500 text-xs font-bold">NT$</div><input type="number" id="dorm_cost" placeholder="金額/月" class="input-field h-12 pl-10 text-right font-mono"></div>
                                    </div>
                                    <!-- 膳食 -->
                                    <div class="flex flex-col md:flex-row gap-4 items-start md:items-center border-b border-gray-100 pb-6">
                                        <div class="w-28 font-bold text-gray-700 shrink-0 flex items-center gap-2 text-base"><i class="fa-solid fa-utensils text-thuGold text-lg"></i> 膳食</div>
                                        <div class="flex flex-wrap gap-3 grow">
                                            <label class="option-card-label welfare-option"><input type="radio" name="food_opt" value="none" onchange="toggleWelfare()" class="radio-card-input"><i class="fa-solid fa-circle-xmark option-icon"></i><span class="option-text text-sm">無</span></label>
                                            <label class="option-card-label welfare-option"><input type="radio" name="food_opt" value="free" onchange="toggleWelfare()" class="radio-card-input"><i class="fa-solid fa-gift option-icon"></i><span class="option-text text-sm">免費提供</span></label>
                                            <label class="option-card-label welfare-option"><input type="radio" name="food_opt" value="paid" onchange="toggleWelfare()" class="radio-card-input"><i class="fa-solid fa-file-invoice-dollar option-icon"></i><span class="option-text text-sm">付費提供</span></label>
                                        </div>
                                        <div id="food_cost_box" class="hidden w-full md:w-48 relative"><div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none text-gray-500 text-xs font-bold">NT$</div><input type="number" id="food_cost" placeholder="金額/餐" class="input-field h-12 pl-10 text-right font-mono"></div>
                                    </div>
                                    <!-- 交通 -->
                                    <div class="flex flex-col md:flex-row gap-4 items-start md:items-center">
                                        <div class="w-28 font-bold text-gray-700 shrink-0 flex items-center gap-2 text-base"><i class="fa-solid fa-bus text-thuGold text-lg"></i> 交通</div>
                                        <div class="grid grid-cols-2 md:flex flex-wrap gap-3 grow w-full">
                                            <label class="option-card-label welfare-option"><input type="radio" name="trans_opt" value="none" onchange="toggleWelfare()" class="radio-card-input"><i class="fa-solid fa-circle-xmark option-icon"></i><span class="option-text text-sm">無</span></label>
                                            <label class="option-card-label welfare-option"><input type="radio" name="trans_opt" value="free" onchange="toggleWelfare()" class="radio-card-input"><i class="fa-solid fa-bus option-icon"></i><span class="option-text text-sm">交通車(免費)</span></label>
                                            <label class="option-card-label welfare-option"><input type="radio" name="trans_opt" value="paid" onchange="toggleWelfare()" class="radio-card-input"><i class="fa-solid fa-ticket option-icon"></i><span class="option-text text-sm">交通車(付費)</span></label>
                                            <label class="option-card-label welfare-option"><input type="radio" name="trans_opt" value="subsidy" onchange="toggleWelfare()" class="radio-card-input"><i class="fa-solid fa-coins option-icon"></i><span class="option-text text-sm">交通津貼</span></label>
                                        </div>
                                        <div id="trans_cost_box" class="hidden w-full md:w-48"><div class="relative"><div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none text-gray-500 text-xs font-bold">NT$</div><input type="number" id="trans_cost" placeholder="金額" class="input-field h-12 pl-10 text-right font-mono"></div><div id="trans_hint" class="text-xs text-gray-400 mt-1 text-right"></div></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="flex justify-between items-center mt-12">
                        <button type="button" onclick="showPage('page-2')" class="nav-button w-40 px-6 py-3 rounded-full font-bold flex items-center justify-center gap-2"><i class="fa-solid fa-arrow-left"></i> 上一步</button>
                        <button type="button" onclick="generateDoc()" id="genContractBtn" disabled class="btn-generate w-64 px-6 py-5 rounded-full font-bold text-lg flex items-center justify-center gap-3 opacity-75 cursor-not-allowed"><span class="animate-pulse">系統載入中...</span></button>
                    </div>
                </div>

                <!-- Page 4 -->
                <div id="page-4" class="page-content hidden">
                    <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
                        <div class="lg:col-span-4 lg:sticky lg:top-24 h-fit">
                            <div class="card bg-white border border-blue-200 shadow-sm">
                                <div class="card-header bg-blue-50 py-3"><span class="card-header-title text-thuBlue text-base"><i class="fa-solid fa-book mr-2"></i> 課程資料庫</span></div>
                                <div class="p-4">
                                    <div class="grid grid-cols-2 gap-3 mb-3">
                                        <div><label class="block text-xs font-bold text-gray-500 mb-1">開課學年</label><input type="number" id="new_course_year" class="input-field text-sm h-9" placeholder="113"></div>
                                        <div><label class="block text-xs font-bold text-gray-500 mb-1">開課學期</label><select id="new_course_sem" class="input-field text-sm h-9 py-1"><option value="" disabled selected>請選擇</option><option value="1">1 (上)</option><option value="2">2 (下)</option><option value="3">暑期</option></select></div>
                                        <div class="col-span-2"><label class="block text-xs font-bold text-gray-500 mb-1">課程名稱</label><input type="text" id="new_course_name" class="input-field text-sm h-9" placeholder="例：企業實習(一)"></div>
                                        <div class="col-span-2 flex items-end gap-2">
                                            <div class="w-1/2"><label class="block text-xs font-bold text-gray-500 mb-1">學分</label><input type="number" id="new_course_credits" class="input-field text-sm h-9" placeholder="3"></div>
                                            <button type="button" onclick="addCourse()" class="w-1/2 bg-blue-600 text-white font-bold h-9 rounded-lg hover:bg-blue-700 transition shadow-md hover:shadow-lg flex items-center justify-center gap-1 text-sm"><i class="fa-solid fa-plus-circle"></i> 新增</button>
                                        </div>
                                    </div>
                                    <div id="course_list_display" class="space-y-2 max-h-[60vh] overflow-y-auto pr-1"><div class="text-center text-gray-400 text-xs py-4 border border-dashed border-gray-300 rounded">請輸入上方資料並新增</div></div>
                                </div>
                            </div>
                        </div>
                        <div class="lg:col-span-8">
                            <div class="card">
                                <div class="card-header py-3">
                                    <div class="flex items-center justify-between w-full">
                                        <span class="card-header-title text-base">學生實習計畫書</span>
                                        <div class="flex items-center gap-2">
                                            <label class="debug-upload-label text-xs"><i class="fa-solid fa-wrench"></i> 測試範本<input type="file" accept=".docx" class="hidden" onchange="handleDebugUpload(event, 'proposal')"></label>
                                            <span id="debug_proposal_status" class="debug-status"><i class="fa-solid fa-check"></i></span>
                                            <div class="text-xs font-medium text-gray-500 ml-2">共 <span id="proposal_student_count">1</span> 人</div>
                                        </div>
                                    </div>
                                </div>
                                <div class="p-4 bg-gray-50 min-h-[200px]">
                                    <div class="flex items-center justify-between mb-3 px-1">
                                        <div class="flex items-center"><input type="checkbox" id="select_all_proposals" onclick="toggleSelectAll(this)" class="w-4 h-4 text-thuBlue bg-white border-gray-300 rounded focus:ring-thuBlue cursor-pointer"><label for="select_all_proposals" class="ml-2 text-sm font-bold text-gray-600 cursor-pointer select-none">全選</label></div>
                                        <div class="text-xs text-gray-400"><i class="fa-regular fa-lightbulb mr-1"></i> 點擊卡片展開</div>
                                    </div>
                                    <div id="proposal_list_container" class="space-y-3"></div>
                                </div>
                                <div id="proposal_empty_msg" class="p-8 text-center text-gray-500 hidden">請先返回 Page 2 填寫學生資料。</div>
                            </div>
                        </div>
                    </div>
                    <div class="flex flex-col md:flex-row justify-between items-center mt-8 gap-4">
                        <button type="button" onclick="showPage('page-3')" class="nav-button w-40 px-6 py-3 rounded-full font-bold flex items-center justify-center gap-2"><i class="fa-solid fa-arrow-left"></i> 上一步</button>
                        <button type="button" onclick="downloadSelectedProposals()" id="bulkDownloadBtn" class="btn-generate w-full md:w-80 px-6 py-5 rounded-full font-bold text-lg flex items-center justify-center gap-3"><i class="fa-solid fa-file-zipper"></i> 打包下載選取計畫書 (ZIP)</button>
                    </div>
                </div>
            </form>
        </div>
    </main>

    <footer><div class="container mx-auto px-4"><div class="flex flex-col items-center justify-center gap-1"><p class="font-bold text-white tracking-wide text-[10px]">&copy; 2025 東海大學實習與學生成就中心 Internship and Student Achievement Center, Tunghai University. All Rights Reserved.</p><p class="text-[9px] text-gray-500">系統版本 V1.0.66 (Final Polish) | 網頁製作：張博堯 | Powered by Google Gemini</p></div></div></footer>

    <script>
        let studentDataState = []; let courseListState = [];
        let debugContractBuffer = null; let debugProposalBuffer = null;

        function cleanXML(xml) { if (!xml) return ""; const pattern = /%%%[^%]+%%%/g; return xml.replace(pattern, function(match) { return match.replace(/<\/?[^>]+(>|$)/g, ""); }); }
        function handleDebugUpload(event, type) { const file = event.target.files[0]; if(!file) return; const reader = new FileReader(); reader.onload = function(e) { if(type === 'contract') { debugContractBuffer = e.target.result; document.getElementById('debug_contract_status').classList.add('show'); } else { debugProposalBuffer = e.target.result; document.getElementById('debug_proposal_status').classList.add('show'); } showMsg("測試範本載入成功"); }; reader.readAsArrayBuffer(file); }
        async function getTemplateBuffer(type) { if (type === 'contract' && debugContractBuffer) return debugContractBuffer; if (type === 'proposal' && debugProposalBuffer) return debugProposalBuffer; const url = type === 'contract' ? './template.docx' : './template_plan.docx'; const resp = await fetch(url); if (!resp.ok) throw new Error(`找不到 ${url}`); return await resp.arrayBuffer(); }
        function showMsg(msg) { const el = document.getElementById('status-bar'); el.innerText = msg; el.style.display = 'block'; setTimeout(() => { el.style.display = 'none'; }, 4000); }
        function showModal(title, message, style = 'error') { const m=document.getElementById('error-modal'), c=document.getElementById('error-details'), h=document.getElementById('modal-header-title'), i=document.getElementById('modal-header-icon'); h.className='text-xl font-bold mb-4 flex items-center gap-2 '+(style==='error'?'text-red-600':(style==='info'?'text-blue-600':'text-yellow-600')); i.className='fa-solid '+(style==='error'?'fa-circle-exclamation':(style==='info'?'fa-circle-info':'fa-triangle-exclamation')); h.innerHTML=`<i class="${i.className}"></i> ${title}`; c.textContent = message; m.style.display = 'flex'; }
        function showConfirm(title, message, onConfirm) { const m=document.getElementById('confirm-modal'), c=document.getElementById('confirm-details'), ok=document.getElementById('confirm-ok'), ca=document.getElementById('confirm-cancel'); c.textContent=message; m.style.display='flex'; const nok=ok.cloneNode(true), nca=ca.cloneNode(true); ok.parentNode.replaceChild(nok, ok); ca.parentNode.replaceChild(nca, ca); nok.addEventListener('click', ()=>{m.style.display='none'; if(typeof onConfirm==='function') onConfirm();}); nca.addEventListener('click', ()=>m.style.display='none'); }
        function showError(details) { showModal('發生錯誤', details, 'error'); }
        function showQueryInfo(message) { showModal('提示', message, 'warning'); }
        document.getElementById('err-close').addEventListener('click', () => { document.getElementById('error-modal').style.display = 'none'; });
        
        function showPage(pageId) { document.querySelectorAll('.page-content').forEach(p => p.classList.add('hidden')); document.querySelectorAll('.tab-button').forEach(t => t.classList.remove('active')); document.getElementById(pageId).classList.remove('hidden'); document.querySelector(`[data-page="${pageId}"]`).classList.add('active'); if (pageId === 'page-4') { collectStudentDataFromPage2(); renderProposalList(); renderCourseList(); } }
        
        // UI Toggles
        function toggleType() {
            const t = document.querySelector('input[name="contract_type"]:checked')?.value;
            const init = document.getElementById('panel_initial'), learn = document.getElementById('panel_learn'), work = document.getElementById('panel_work');
            if (t === 'learn') { init.classList.add('hidden'); learn.classList.remove('hidden'); work.classList.add('hidden'); togglePayInputs(); }
            else if (t === 'work') { init.classList.add('hidden'); learn.classList.add('hidden'); work.classList.remove('hidden'); toggleWorkWageType(); }
            else { init.classList.remove('hidden'); learn.classList.add('hidden'); work.classList.add('hidden'); }
        }

        function togglePayInputs() { 
            try { 
                const sel = document.querySelector('input[name="pay_opt_learn"]:checked'); 
                const v = sel ? sel.value : 'none';
                const payDetails = document.getElementById('learn_pay_details');
                if (v === 'none') { payDetails.classList.add('hidden'); } 
                else {
                     payDetails.classList.remove('hidden');
                     const subOpt = document.querySelector('input[name="pay_method_learn"]:checked')?.value;
                     document.getElementById('learn_amt_label').innerText = subOpt === 'monthly' ? '給付金額 (按月)' : '給付金額 (總額)';
                }
            } catch (e) { console.warn(e); }
        }

        function toggleWorkWageType() {
             const wageType = document.querySelector('input[name="wage_type_work"]:checked')?.value;
             const label = document.getElementById('work_amt_label'), input = document.getElementById('work_amount');
             if (wageType === 'hourly') { label.innerText = '薪資金額 (時薪)'; input.placeholder = '190'; } 
             else { label.innerText = '薪資金額 (月薪)'; input.placeholder = '28590'; }
        }

        function toggleWelfare() {
            const dorm = document.querySelector('input[name="dorm_opt"]:checked')?.value;
            document.getElementById('dorm_cost_box').classList.toggle('hidden', dorm !== 'paid');
            const food = document.querySelector('input[name="food_opt"]:checked')?.value;
            document.getElementById('food_cost_box').classList.toggle('hidden', food !== 'paid');
            const trans = document.querySelector('input[name="trans_opt"]:checked')?.value;
            document.getElementById('trans_cost_box').classList.toggle('hidden', !(trans === 'paid' || trans === 'subsidy'));
            if (trans) {
                const hint = document.getElementById('trans_hint');
                if (trans === 'paid') hint.innerText = '請輸入學生需負擔費用';
                if (trans === 'subsidy') hint.innerText = '請輸入公司補助金額';
            }
        }

        function toggleBranchFields() {
            const isHead = document.getElementById('is_head_office').checked;
            const wrap = document.getElementById('branch_fields_wrapper'), bn = document.getElementById('branch_name'), ba = document.getElementById('branch_addr');
            if(isHead) { wrap.classList.add('opacity-50','pointer-events-none'); bn.disabled=true; ba.disabled=true; bn.value=''; ba.value=''; }
            else { wrap.classList.remove('opacity-50','pointer-events-none'); bn.disabled=false; ba.disabled=false; }
        }
        
        function toggleTaxIdFields() {
             const noTax = document.getElementById('no_tax_id').checked;
             const taxIn = document.getElementById('company_tax_id'), qBtn = document.getElementById('queryBtn'), grp = document.getElementById('tax_id_input_group');
             if(noTax) { grp.classList.add('opacity-50','pointer-events-none'); taxIn.disabled=true; qBtn.disabled=true; taxIn.value=''; }
             else { grp.classList.remove('opacity-50','pointer-events-none'); taxIn.disabled=false; updateQueryButtonState(); }
        }

        function updateQueryButtonState() {
            const tax = document.getElementById('company_tax_id').value.trim();
            const btn = document.getElementById('queryBtn');
            if(!document.getElementById('no_tax_id').checked && /^\d{8}$/.test(tax)) { btn.disabled=false; btn.classList.remove('opacity-50','cursor-not-allowed'); }
            else { btn.disabled=true; btn.classList.add('opacity-50','cursor-not-allowed'); }
        }
        
        function handleTaxIdKey(e) { if (e.key === 'Enter') { e.preventDefault(); getCompanyInfo(); } }

        async function getCompanyInfo() {
            const taxId = document.getElementById('company_tax_id').value.trim();
            const btn = document.getElementById('queryBtn'); const orgHtml = btn.innerHTML;
            try {
                btn.disabled=true; btn.classList.add('btn-query-loading'); btn.innerHTML='<i class="fa-solid fa-spinner fa-spin"></i> 查詢中...';
                const res = await fetch(`https://corsproxy.io/?https://data.gcis.nat.gov.tw/od/data/api/5F64D864-61CB-4D0D-8AD9-492047CC1EA6?$format=json&$filter=Business_Accounting_NO eq ${taxId}&$skip=0&$top=1`);
                if(!res.ok) throw new Error('API_ERR');
                const data = await res.json();
                if(!data || data.length===0) throw new Error('NO_DATA');
                const c = data[0];
                document.getElementById('company_name').value = c.Company_Name || "";
                document.getElementById('company_rep').value = c.Responsible_Name || "";
                document.getElementById('reg_address').value = c.Company_Location || "";
                document.getElementById('branch_name').value = ""; document.getElementById('branch_addr').value = "";
                document.getElementById('no_tax_id').checked = false; toggleTaxIdFields();
                showMsg(`「 ${c.Company_Name} 」公司資料已自動填入。`);
            } catch(e) {
                showQueryInfo("查無資料，請手動填入相關欄位。");
            } finally {
                btn.classList.remove('btn-query-loading'); btn.innerHTML = orgHtml; updateQueryButtonState();
            }
        }

        function collectStudentDataFromPage2() {
            const sCount = Number(document.getElementById('student_count').value) || 1;
            const tempData = [];
            for(let i=0; i<sCount; i++) {
                const exist = studentDataState.find(s => s.index === i) || {};
                const gIn = document.getElementById(`s_grade_${i}`)?.value || "";
                tempData.push({
                    index: i,
                    name: document.getElementById(`s_name_${i}`)?.value || "",
                    dept: document.getElementById(`s_dept_${i}`)?.value || "",
                    grade: gIn.trim() ? `${gIn}年級` : "", raw_grade: gIn,
                    id: document.getElementById(`s_id_${i}`)?.value || "",
                    isSelected: exist.isSelected===undefined?true:exist.isSelected,
                    selectedCourses: exist.selectedCourses||[],
                    teacher_name: exist.teacher_name||"", teacher_contact: exist.teacher_contact||"",
                    industry_teacher: exist.industry_teacher||"", industry_contact: exist.industry_contact||"",
                    hours_exceeded_desc: exist.hours_exceeded_desc||"", intern_type_select: exist.intern_type_select||""
                });
            }
            studentDataState = tempData;
        }
        
        function renderStudents() {
            const count = Number(document.getElementById('student_count').value)||1;
            const c = document.getElementById('student_container');
            collectStudentDataFromPage2();
            while(c.children.length > count) c.removeChild(c.lastChild);
            if(count > c.children.length) {
                for(let i=c.children.length; i<count; i++) {
                    const d = document.createElement('div');
                    d.className = "student-wrapper p-5 bg-gray-50 rounded-lg border border-gray-200 mb-4 relative fade-in";
                    d.setAttribute('data-index', i);
                    d.innerHTML = `<div class="absolute -top-3 -left-2 bg-white border border-gray-200 px-3 py-1 rounded text-xs font-bold text-thuBlue shadow-sm">學生 ${i+1}</div><button type="button" onclick="deleteStudent(${i})" class="delete-student-btn"><i class="fa-solid fa-xmark text-sm"></i></button><div class="grid grid-cols-1 md:grid-cols-4 gap-x-5 gap-y-4 mt-2"><div><label class="block text-xs font-bold text-gray-500 uppercase mb-1">姓名 *</label><input type="text" id="s_name_${i}" class="input-field" oninput="collectStudentDataFromPage2()" value="${studentDataState[i]?.name||''}"></div><div><label class="block text-xs font-bold text-gray-500 uppercase mb-1">學號 *</label><input type="text" id="s_id_${i}" class="input-field" oninput="collectStudentDataFromPage2()" value="${studentDataState[i]?.id||''}"></div><div><label class="block text-xs font-bold text-gray-500 uppercase mb-1">系所 *</label><input type="text" id="s_dept_${i}" class="input-field" oninput="collectStudentDataFromPage2()" value="${studentDataState[i]?.dept||''}"></div><div><label class="block text-xs font-bold text-gray-500 uppercase mb-1">年級 *</label><div class="grade-input-group"><input type="text" id="s_grade_${i}" class="grade-input-field" oninput="collectStudentDataFromPage2()" value="${studentDataState[i]?.raw_grade||''}"><span class="grade-suffix">年級</span></div></div></div>`;
                    c.appendChild(d);
                }
            }
            Array.from(c.children).forEach((el, i) => {
               el.querySelector('.absolute').innerText = `學生 ${i+1}`;
               el.querySelector('.delete-student-btn').setAttribute('onclick', `deleteStudent(${i})`);
               if(studentDataState[i]) {
                   document.getElementById(`s_name_${i}`).value = studentDataState[i].name;
                   document.getElementById(`s_id_${i}`).value = studentDataState[i].id;
                   document.getElementById(`s_dept_${i}`).value = studentDataState[i].dept;
                   document.getElementById(`s_grade_${i}`).value = studentDataState[i].raw_grade;
               }
            });
        }

        function changeStudentCount(delta) { const el=document.getElementById('student_count'); let v=parseInt(el.value)||1; v+=delta; if(v<1)v=1; el.value=v; document.getElementById('student_count_display').innerText=v+" 人"; renderStudents(); renderProposalList(); }
        function deleteStudent(idx) { let v=parseInt(document.getElementById('student_count').value); if(v<=1) return showModal('提示', '至少需保留一位學生', 'warning'); studentDataState.splice(idx, 1); document.getElementById('student_count').value=v-1; document.getElementById('student_count_display').innerText=(v-1)+" 人"; renderStudents(); renderProposalList(); }
        
        function addCourse() {
            const n = document.getElementById('new_course_name').value.trim();
            const y = document.getElementById('new_course_year').value.trim();
            const s = document.getElementById('new_course_sem').value;
            const c = parseFloat(document.getElementById('new_course_credits').value);
            if(!n||!y||!s||isNaN(c)) return showModal("欄位不完整", "請填寫完整課程資訊", 'warning');
            courseListState.push({ id: Date.now(), name: n, year: y, semester: s, credits: c });
            document.getElementById('new_course_name').value=''; document.getElementById('new_course_credits').value='';
            renderCourseList(); renderProposalList(false);
        }
        function removeCourse(id) { courseListState = courseListState.filter(x => x.id !== id); studentDataState.forEach(s => { if(s.selectedCourses) s.selectedCourses = s.selectedCourses.filter(cid => cid !== id); }); renderCourseList(); renderProposalList(false); }
        function renderCourseList() {
            const div = document.getElementById('course_list_display');
            if(courseListState.length === 0) { div.innerHTML = '<div class="text-center text-gray-400 text-xs py-4 border border-dashed border-gray-300 rounded">尚未建立任何課程</div>'; return; }
            div.innerHTML = courseListState.map(c => `<div class="flex items-center justify-between bg-white p-2 border border-gray-200 rounded shadow-sm"><div class="text-xs"><span class="font-bold text-gray-700">${c.year}-${c.semester}</span><span class="mx-1 text-gray-300">|</span><span class="font-bold text-thuBlue">${c.name}</span><span class="mx-1 text-gray-300">|</span><span class="font-mono bg-yellow-100 px-1.5 py-0.5 rounded text-yellow-800">${c.credits}學分</span></div><button onclick="removeCourse(${c.id})" class="text-red-400 hover:text-red-600 text-xs px-1"><i class="fa-solid fa-trash"></i></button></div>`).join('');
        }

        window.toggleDropdown = function(i) { document.getElementById(`dropdown_content_${i}`).classList.toggle('open'); }
        document.addEventListener('click', e => { if(!e.target.closest('.multi-select-dropdown')) document.querySelectorAll('.multi-select-content').forEach(el => el.classList.remove('open')); });
        window.updateSelectedCourses = function(idx, cid, chk) { const s = studentDataState[idx]; if(!s.selectedCourses) s.selectedCourses=[]; if(chk && !s.selectedCourses.includes(cid)) s.selectedCourses.push(cid); else if(!chk) s.selectedCourses = s.selectedCourses.filter(x => x !== cid); updateCourseSummary(idx); }
        function updateCourseSummary(idx) {
            const s = studentDataState[idx], div = document.getElementById(`course_summary_${idx}`), txt = document.getElementById(`dropdown_trigger_text_${idx}`);
            if(!s.selectedCourses || s.selectedCourses.length === 0) { div.innerHTML = '<span class="text-gray-400 text-xs">尚未選擇課程</span>'; txt.textContent = '請選擇課程...'; return; }
            const sels = courseListState.filter(c => s.selectedCourses.includes(c.id));
            const tot = sels.reduce((a,b) => a + b.credits, 0);
            txt.textContent = `已選 ${sels.length} 門 (${tot} 學分)`;
            div.innerHTML = `<div class="bg-gray-50 p-2 rounded border border-gray-200 text-xs"><div class="space-y-1 mb-2 border-b border-gray-200 pb-1">${sels.map(c => `<div class="flex justify-between"><span>${c.year}-${c.semester} ${c.name}</span><span class="font-mono text-gray-600">${c.credits}</span></div>`).join('')}</div><div class="flex justify-between font-bold text-thuBlue"><span>總學分</span><span>${tot}</span></div></div>`;
        }

        window.toggleExpand = function(i) {
            const b = document.getElementById(`proposal_body_${i}`), c = document.getElementById(`chevron_${i}`);
            if(b.classList.contains('hidden')) { b.classList.remove('hidden'); c.classList.add('rotate-180'); } else { b.classList.add('hidden'); c.classList.remove('rotate-180'); }
        }

        function renderProposalList(restore=true) {
            if(restore) collectStudentDataFromPage2();
            const div = document.getElementById('proposal_list_container'); div.innerHTML = '';
            const count = studentDataState.length;
            document.getElementById('proposal_student_count').textContent = count;
            if(count === 0 || studentDataState.every(s => !s.name.trim() && !s.id.trim())) {
                document.getElementById('proposal_empty_msg').classList.remove('hidden'); document.getElementById('select_all_proposals').disabled = true; return;
            }
            document.getElementById('proposal_empty_msg').classList.add('hidden'); document.getElementById('select_all_proposals').disabled = false;
            const selCount = studentDataState.filter(s => s.isSelected).length;

            studentDataState.forEach((s, i) => {
                const copyTxt = selCount > 0 ? `複製給勾選的 ${s.isSelected ? selCount - 1 : selCount} 位` : `複製資料給...`;
                let dd = courseListState.length > 0 ? courseListState.map(c => `<div class="course-checkbox-item" onclick="event.stopPropagation()"><input type="checkbox" id="c_${i}_${c.id}" ${s.selectedCourses?.includes(c.id)?'checked':''} onchange="updateSelectedCourses(${i}, ${c.id}, this.checked)"><label for="c_${i}_${c.id}" class="text-sm cursor-pointer w-full ml-2"><span class="font-bold text-gray-700">${c.year}-${c.semester}</span> | <span class="font-bold text-thuBlue">${c.name}</span> | ${c.credits}學分</label></div>`).join('') : '<div class="p-3 text-xs text-gray-400 text-center">請先在左側建立課程</div>';
                
                const card = document.createElement('div');
                card.className = "student-proposal-card bg-white border border-gray-200 rounded-lg overflow-hidden mb-4";
                card.id = `proposal_row_${i}`;
                card.innerHTML = `
                    <div class="flex items-center justify-between p-4 bg-gray-50 cursor-pointer select-none hover:bg-blue-50/30 transition-colors" onclick="toggleExpand(${i})">
                        <div class="flex items-center gap-4 flex-grow overflow-hidden">
                            <div class="flex items-center justify-center w-8 shrink-0" onclick="event.stopPropagation()"><input type="checkbox" onchange="toggleStudentSelection(${i})" class="w-5 h-5 text-thuBlue rounded focus:ring-thuBlue" ${s.isSelected?'checked':''}></div>
                            <div class="flex flex-col truncate"><div class="text-base font-bold text-gray-800 flex items-center gap-2">${s.name||'<span class="text-gray-400 italic">未命名</span>'} <span class="text-xs bg-gray-200 text-gray-600 px-2 py-0.5 rounded-full font-mono">${s.id}</span></div><div class="text-xs text-gray-500 truncate">${s.dept} | ${s.grade}</div></div>
                        </div>
                        <div class="flex items-center gap-2 shrink-0" onclick="event.stopPropagation()">
                             <button type="button" onclick="copyPlanToSelected(${i})" class="hidden md:flex bg-indigo-100 text-indigo-700 px-3 py-1.5 rounded-md text-xs font-bold hover:bg-indigo-200 transition items-center gap-1 border border-indigo-200"><i class="fa-regular fa-copy"></i> ${copyTxt}</button>
                             <div class="w-8 h-8 flex items-center justify-center text-gray-400 hover:text-thuBlue transition-colors cursor-pointer" onclick="toggleExpand(${i})"><i class="fa-solid fa-chevron-down transition-transform duration-300" id="chevron_${i}"></i></div>
                        </div>
                    </div>
                    <div id="proposal_body_${i}" class="hidden border-t border-gray-100 p-6 bg-white">
                        <div class="grid grid-cols-1 gap-6">
                            <div><label class="block text-xs font-bold text-gray-500 mb-1">實習課程選擇 (可複選) *</label><div class="multi-select-dropdown"><div class="multi-select-trigger" onclick="toggleDropdown(${i})"><span id="dropdown_trigger_text_${i}" class="text-sm text-gray-700">請選擇...</span><i class="fa-solid fa-chevron-down text-xs text-gray-400"></i></div><div class="multi-select-content" id="dropdown_content_${i}">${dd}</div></div><div id="course_summary_${i}" class="mt-2"></div></div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div><label class="block text-xs font-bold text-gray-500 mb-1">實習類別 *</label><select id="p_intern_type_select_${i}" class="input-field text-sm h-[42px]"><option value="" disabled selected>請選擇</option><option value="full" ${s.intern_type_select==='full'?'selected':''}>整學年</option><option value="sem" ${s.intern_type_select==='sem'?'selected':''}>整學期</option><option value="winter" ${s.intern_type_select==='winter'?'selected':''}>寒假實習</option><option value="summer" ${s.intern_type_select==='summer'?'selected':''}>暑假實習</option><option value="term" ${s.intern_type_select==='term'?'selected':''}>學期期間實習</option></select></div>
                                <div><label class="block text-xs font-bold text-gray-500 mb-1">時數說明 (特殊情況)</label><input type="text" id="p_hours_exceeded_desc_${i}" class="input-field text-sm h-[42px]" value="${s.hours_exceeded_desc}" placeholder="若時數有特殊安排請說明"></div>
                            </div>
                            <div class="bg-blue-50/60 p-4 rounded-lg border border-blue-100"><h4 class="text-sm font-bold text-thuBlue mb-3 flex items-center gap-2"><span class="w-1 h-4 bg-thuBlue rounded-full"></span> 指導老師資訊</h4><div class="grid grid-cols-1 md:grid-cols-2 gap-3"><div><label class="block text-xs font-bold text-gray-500 mb-1">校方輔導老師姓名 *</label><input type="text" id="p_teacher_name_${i}" class="input-field text-sm" value="${s.teacher_name}" placeholder="姓名"></div><div><label class="block text-xs font-bold text-gray-500 mb-1">校方輔導老師聯絡方式</label><input type="text" id="p_teacher_contact_${i}" class="input-field text-sm" value="${s.teacher_contact}" placeholder="電話或分機"></div><div><label class="block text-xs font-bold text-gray-500 mb-1">業界老師姓名</label><input type="text" id="p_industry_teacher_${i}" class="input-field text-sm" value="${s.industry_teacher}" placeholder="姓名 (選填)"></div><div><label class="block text-xs font-bold text-gray-500 mb-1">業界老師聯絡方式</label><input type="text" id="p_industry_contact_${i}" class="input-field text-sm" value="${s.industry_contact}" placeholder="電話或分機 (選填)"></div></div></div>
                        </div>
                    </div>`;
                div.appendChild(card);
                updateCourseSummary(i);
                ['teacher_name','teacher_contact','industry_teacher','industry_contact','hours_exceeded_desc'].forEach(f => document.getElementById(`p_${f}_${i}`)?.addEventListener('input', updateProposalDataState));
                document.getElementById(`p_intern_type_select_${i}`)?.addEventListener('change', updateProposalDataState);
            });
            updateSelectAllCheckbox();
        }

        function toggleStudentSelection(i) { studentDataState[i].isSelected = !studentDataState[i].isSelected; updateSelectAllCheckbox(); renderProposalList(false); }
        function toggleSelectAll(cb) { studentDataState.forEach(s => s.isSelected = cb.checked); renderProposalList(false); }
        function updateSelectAllCheckbox() { const cb=document.getElementById('select_all_proposals'); if(!cb) return; const all=studentDataState.length, sel=studentDataState.filter(s=>s.isSelected).length; cb.checked = all>0 && all===sel; }

        function updateProposalDataState() {
            studentDataState.forEach((s, i) => {
                if(!document.getElementById(`proposal_row_${i}`)) return;
                s.teacher_name = document.getElementById(`p_teacher_name_${i}`).value;
                s.teacher_contact = document.getElementById(`p_teacher_contact_${i}`).value;
                s.industry_teacher = document.getElementById(`p_industry_teacher_${i}`).value;
                s.industry_contact = document.getElementById(`p_industry_contact_${i}`).value;
                s.hours_exceeded_desc = document.getElementById(`p_hours_exceeded_desc_${i}`).value;
                s.intern_type_select = document.getElementById(`p_intern_type_select_${i}`).value;
            });
        }

        function copyPlanToSelected(idx) {
            updateProposalDataState(); const src = studentDataState[idx], targets = studentDataState.filter(s => s.isSelected && s.index !== idx);
            if(targets.length===0) return showModal('提示', '請先勾選其他目標學生', 'info');
            showConfirm('複製確認', `確定將「${src.name}」的資料複製給勾選的 ${targets.length} 位學生嗎？`, () => {
                targets.forEach(t => { t.selectedCourses=[...src.selectedCourses]; t.teacher_name=src.teacher_name; t.teacher_contact=src.teacher_contact; t.industry_teacher=src.industry_teacher; t.industry_contact=src.industry_contact; t.intern_type_select=src.intern_type_select; t.hours_exceeded_desc=src.hours_exceeded_desc; });
                renderProposalList(false); showMsg(`已複製給 ${targets.length} 位學生`);
            });
        }

        function validateForm(isProp=false) {
            let ok=true, err=""; document.querySelectorAll('.input-error').forEach(e=>e.classList.remove('input-error'));
            const sl = studentDataState;
            sl.forEach((s, i) => { if(!s.name || !s.id || !s.dept || !s.raw_grade) { ok=false; } }); // Simple check
            if(!ok) err += "• 學生資料有缺漏\n";
            
            if(!isProp) {
                if(!document.getElementById('company_name').value) { document.getElementById('company_name').classList.add('input-error'); ok=false; }
                // Check Pay
                const cType = document.querySelector('input[name="contract_type"]:checked');
                if(!cType) { ok=false; err+="• 未選擇實習類型\n"; } else {
                    if(cType.value==='learn') {
                        const lOpt = document.querySelector('input[name="pay_opt_learn"]:checked');
                        if(!lOpt) ok=false; else if(lOpt.value!=='none' && !document.getElementById('learn_amount').value) { document.getElementById('learn_amount').classList.add('input-error'); ok=false; }
                    } else {
                         if(!document.getElementById('work_amount').value) { document.getElementById('work_amount').classList.add('input-error'); ok=false; }
                    }
                }
                // Check Welfare
                ['dorm','food','trans'].forEach(k => { if(!document.querySelector(`input[name="${k}_opt"]:checked`)) ok=false; });
            }
            if(isProp) {
                sl.filter(s=>s.isSelected).forEach((s, i) => {
                    if(!s.selectedCourses.length || !s.teacher_name || !s.intern_type_select) {
                         if(!s.teacher_name) document.getElementById(`p_teacher_name_${i}`).classList.add('input-error');
                         ok=false; 
                    }
                });
                if(!ok) err += "• 選取學生的計畫書資料有缺漏\n";
            }
            if(!ok && err) showError(err || "請檢查必填欄位");
            return ok;
        }

        async function generateDoc() {
            if(!validateForm(false)) return;
            const btn=document.getElementById('genContractBtn'); btn.disabled=true; btn.classList.add('opacity-50');
            try {
                collectStudentDataFromPage2(); updateProposalDataState();
                const buf = await getTemplateBuffer('contract');
                const zip = new PizZip(buf);
                const doc = new window.docxtemplater(zip, { paragraphLoop:true, linebreaks:true, nullGetter:()=>"" });

                // Prepare Data
                const cType = document.querySelector('input[name="contract_type"]:checked').value;
                const data = {
                    company_name: document.getElementById('company_name').value,
                    company_rep: document.getElementById('company_rep').value,
                    company_title: document.getElementById('company_title').value,
                    company_address: document.getElementById('reg_address').value,
                    company_tax_id: document.getElementById('no_tax_id').checked ? "實習機構未申請設立字號" : document.getElementById('company_tax_id').value,
                    intern_location: document.getElementById('is_head_office').checked ? document.getElementById('reg_address').value : document.getElementById('branch_addr').value,
                    s_y: document.getElementById('start_y').value, s_m: document.getElementById('start_m').value, s_d: document.getElementById('start_d').value,
                    e_y: document.getElementById('end_y').value, e_m: document.getElementById('end_m').value, e_d: document.getElementById('end_d').value,
                    daily_start: document.getElementById('daily_start').value, daily_end: document.getElementById('daily_end').value, daily_hours: document.getElementById('daily_hours').value,
                    
                    type_learn_check: cType==='learn'?'■':'□', type_work_check: cType==='work'?'■':'□',
                    chk_pay_none:'□', chk_pay_scholar:'□', chk_pay_allowance:'□', pay_learn_amount:'', pay_work_amount:''
                };

                if(cType==='learn') {
                    const opt = document.querySelector('input[name="pay_opt_learn"]:checked').value;
                    if(opt==='none') data.chk_pay_none='■';
                    else {
                        data[opt==='scholar'?'chk_pay_scholar':'chk_pay_allowance'] = '■';
                        const cycle = document.querySelector('input[name="pay_method_learn"]:checked').value;
                        const amt = document.getElementById('learn_amount').value;
                        data.pay_learn_amount = `${amt} ${cycle==='monthly'?'(按月給付) ':'(總額給付)'}`;
                    }
                } else {
                    const wType = document.querySelector('input[name="wage_type_work"]:checked').value;
                    const amt = document.getElementById('work_amount').value;
                    data.pay_work_amount = `${amt} ${wType==='hourly'?'(時薪) ':''}`;
                }

                // Welfare
                ['dorm','food','trans'].forEach(k => {
                    const v = document.querySelector(`input[name="${k}_opt"]:checked`)?.value;
                    data[`chk_${k}_none`] = v==='none'?'■':'□';
                    data[`chk_${k}_free`] = (v==='free'||v==='shuttle')?'■':'□';
                    data[`chk_${k}_paid`] = (v==='paid'||v==='subsidy')?'■':'□';
                    if(v==='paid'||v==='subsidy') data[`${k}_desc`] = document.getElementById(`${k}_cost`).value;
                });
                // Special handling for new trans types mapping to legacy template
                const tOpt = document.querySelector('input[name="trans_opt"]:checked')?.value;
                if(tOpt === 'free') { data.chk_trans_free='■'; data.chk_trans_paid='□'; }
                else if(tOpt === 'paid') { data.chk_trans_free='□'; data.chk_trans_paid='■'; }

                // Students
                data.students = studentDataState.map((s, i) => {
                    const cd = getStudentCourseData(s);
                    return {
                         letter: String.fromCharCode(65+i), name: s.name, dept: s.dept, grade: s.grade, id: s.id,
                         teacher_name: s.teacher_name, course_name: cd.name, semester: cd.semester, credits: cd.credits, hours_exceeded_desc: s.hours_exceeded_desc,
                         intern_type_full: s.intern_type_select==='full'?'■':'□', intern_type_sem: s.intern_type_select==='sem'?'■':'□',
                         intern_type_winter: s.intern_type_select==='winter'?'■':'□', intern_type_summer: s.intern_type_select==='summer'?'■':'□', intern_type_term: s.intern_type_select==='term'?'■':'□'
                    };
                });
                data.student_name = data.students.map(s=>s.name).join('、');

                doc.render(data);
                const out = doc.getZip().generate({type:"blob", mimeType:"application/vnd.openxmlformats-officedocument.wordprocessingml.document"});
                saveAs(out, "實習合約書.docx"); showMsg("合約書產生成功");

            } catch(e) { showError(e.message); } finally { btn.disabled=false; btn.classList.remove('opacity-50'); }
        }

        async function downloadSelectedProposals() {
            if(!validateForm(true)) return;
            const btn = document.getElementById('bulkDownloadBtn'); btn.disabled=true; btn.innerHTML='處理中...';
            try {
                const buf = await getTemplateBuffer('proposal');
                const zip = new JSZip();
                const targets = studentDataState.filter(s => s.isSelected);
                
                const common = {
                    company_name: document.getElementById('company_name').value,
                    plan_intern_location: document.getElementById('is_head_office').checked ? document.getElementById('company_name').value : `${document.getElementById('company_name').value} (${document.getElementById('branch_name').value})`,
                    s_y: document.getElementById('start_y').value, s_m: document.getElementById('start_m').value, s_d: document.getElementById('start_d').value,
                    e_y: document.getElementById('end_y').value, e_m: document.getElementById('end_m').value, e_d: document.getElementById('end_d').value
                };

                for(const s of targets) {
                    const cd = getStudentCourseData(s);
                    const data = {
                        ...common,
                        student_name: s.name, id: s.id, dept: s.dept, grade: s.grade,
                        teacher_name: s.teacher_name, teacher_contact: s.teacher_contact,
                        industry_teacher: s.industry_teacher, industry_contact: s.industry_contact,
                        course_name: cd.name, semester: cd.semester, credits: cd.credits,
                        hours_exceeded_desc: s.hours_exceeded_desc,
                        intern_type_full: s.intern_type_select==='full'?'■':'□', intern_type_sem: s.intern_type_select==='sem'?'■':'□',
                        intern_type_winter: s.intern_type_select==='winter'?'■':'□', intern_type_summer: s.intern_type_select==='summer'?'■':'□', intern_type_term: s.intern_type_select==='term'?'■':'□'
                    };
                    const pzip = new PizZip(buf);
                    const doc = new window.docxtemplater(pzip, { paragraphLoop:true, linebreaks:true, nullGetter:()=>"" });
                    doc.render(data);
                    zip.file(`實習計畫書_${s.name}.docx`, doc.getZip().generate({type:"uint8array"}));
                }
                const content = await zip.generateAsync({type:"blob"});
                saveAs(content, "實習計畫書_打包.zip"); showMsg("打包下載成功");

            } catch(e) { showError(e.message); } finally { btn.disabled=false; btn.innerHTML='<i class="fa-solid fa-file-zipper"></i> 打包下載選取計畫書 (ZIP)'; }
        }

        window.onload = function() {
            renderStudents();
            toggleType(); toggleWelfare(); document.getElementById('is_head_office').checked=false; toggleBranchFields();
            document.getElementById('no_tax_id').checked=false; toggleTaxIdFields();
            document.getElementById('queryBtn').addEventListener('click', getCompanyInfo);
            document.getElementById('student_container').addEventListener('input', collectStudentDataFromPage2);
            showPage('page-1');
        };
    </script>
</body>
</html>
