<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>東海大學學生校外實習文件產生器</title>

    <!-- 核心函式庫 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/pizzip@3.1.4/dist/pizzip.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/docxtemplater/3.37.11/docxtemplater.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/1.3.8/FileSaver.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>

    <!-- 東海配色 -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        thuBlue: '#002E5D',
                        thuGold: '#C6A87C',
                    },
                    fontFamily: {
                        sans: ['"Noto Sans TC"', 'sans-serif'],
                    }
                }
            }
        }
    </script>

    <style>
        body {
            background-color: #f3f4f6;
            font-family: 'Noto Sans TC', sans-serif;
            padding-bottom: 100px; 
            color: #374151;
            scroll-behavior: smooth;
        }
        
        /* 通用輸入框樣式 */
        .input-field {
            background-color: white;
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            padding: 0.6rem 0.8rem;
            width: 100%;
            font-size: 1rem;
            transition: all 0.2s ease;
        }
        .input-field:focus {
            outline: none;
            border-color: #002E5D;
            box-shadow: 0 0 0 3px rgba(0, 46, 93, 0.1);
        }
        .input-error {
            border-color: #ef4444 !important;
            background-color: #fef2f2 !important;
        }
        
        .proposal-textarea {
            resize: vertical;
            min-height: 4.5rem;
            line-height: 1.5rem;
            padding: 0.5rem 0.75rem;
            font-size: 0.95rem;
        }

        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        input[type=number] { -moz-appearance: textfield; }

        /* 日期群組 */
        .date-group, .grade-input-group {
            display: flex; align-items: center; justify-content: center;
            background: white; border: 1px solid #d1d5db; border-radius: 0.5rem;
            padding: 0.4rem; transition: all 0.2s ease; overflow: hidden; height: 42px;
        }
        .date-group:focus-within, .grade-input-group:focus-within {
            border-color: #002E5D; box-shadow: 0 0 0 3px rgba(0, 46, 93, 0.1);
        }
        .date-input, .grade-input-field {
            border: none; text-align: center !important; width: 100%; outline: none;
            font-size: 1rem; color: #374151; background: transparent; padding: 0; height: 100%;
        }
        .date-input { min-width: 2.5rem; }
        .grade-input-field { padding: 0 0.1rem; flex-grow: 1; }
        .date-sep { color: #9ca3af; font-weight: bold; padding: 0 0.1rem; user-select: none; flex-shrink: 0; }
        .grade-suffix { color: #374151; padding-right: 0.8rem; font-size: 1rem; font-weight: 500; flex-shrink: 0; }
        
        /* 時間輸入框樣式 */
        .time-input-container {
             position: relative; 
             display: flex; 
             align-items: center; 
             background-color: white; 
             border: 1px solid #d1d5db; 
             border-radius: 0.375rem;
             height: 42px; 
             padding: 0 0.8rem;
             transition: all 0.2s ease;
        }
        .time-input-container:focus-within {
            outline: none;
            border-color: #002E5D;
            box-shadow: 0 0 0 3px rgba(0, 46, 93, 0.1);
        }
        .time-input-field {
            border: none;
            background: transparent;
            outline: none;
            width: 100%;
            text-align: center;
            font-size: 1rem;
            color: #374151;
        }
        .time-input-hint {
            display: inline-block;
            font-size: 0.75rem;
            font-weight: bold;
            letter-spacing: 0.05em;
            background-color: #ef4444; 
            color: white; 
            padding: 2px 6px;
            border-radius: 4px;
            margin-left: 0.5rem; 
        }

        /* 學生刪除按鈕 */
        .delete-student-btn {
            position: absolute; top: -12px; right: -12px; width: 32px; height: 32px;
            display: flex; align-items: center; justify-content: center; border-radius: 9999px; 
            background-color: #fef2f2; color: #ef4444; transition: all 0.2s ease-out;
            z-index: 10; opacity: 0; cursor: pointer;
        }
        .student-wrapper:hover .delete-student-btn { opacity: 1; background-color: #ef4444; color: white; transform: scale(1.1); }

        /* 卡片樣式 */
        .card { 
            background: white; border-radius: 0.75rem; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05); 
            border: 1px solid #e5e7eb; overflow: hidden; margin-bottom: 2rem; transition: border-color 0.3s;
        }
        .card-header { 
            padding: 1.25rem 2rem; background-color: #ffffff; border-bottom: 1px solid #f3f4f6; 
            color: #002E5D; font-weight: 700; font-size: 1.125rem; display: flex; align-items: center; justify-content: space-between; 
        }
        .card-header-title { display: flex; align-items: center; }
        .card-header-title::before {
            content: ''; display: inline-block; width: 5px; height: 1.2rem; background-color: #C6A87C; margin-right: 0.75rem; border-radius: 2px;
        }
        .hidden { display: none; }
        
        /* 狀態/錯誤訊息 */
        #status-bar { display: none; position: fixed; bottom: 80px; right: 20px; background: #333; color: white; padding: 8px 16px; border-radius: 6px; z-index: 9999; box-shadow: 0 4px 12px rgba(0,0,0,0.3); font-size: 0.9rem; }
        #lib-error { display: none; position: fixed; top: 0; left: 0; width: 100%; background: #ef4444; color: white; text-align: center; padding: 10px; z-index: 9999; font-weight: bold; }
        #error-modal, #confirm-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10000; align-items: center; justify-content: center; }
        #error-content, #confirm-content { background: white; padding: 2rem; border-radius: 1rem; max-width: 600px; width: 90%; max-height: 80%; overflow-y: auto; }
        pre { white-space: pre-wrap; word-break: break-word; }

        footer {
            position: fixed; bottom: 0; left: 0; width: 100%; background-color: #1f2937; color: #9ca3af; text-align: center; padding: 1rem 0; font-size: 0.75rem; z-index: 50; border-top: 3px solid #C6A87C;
        }
        .fade-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* 按鈕樣式 */
        .btn-query {
            background-color: #C6A87C; color: #002E5D; font-weight: bold; border-radius: 0.375rem;
            padding: 0.6rem 1.25rem; transition: all 0.2s ease; box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
        }
        .btn-query:hover:not(:disabled) { background-color: #b3976e; transform: translateY(-1px); box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        .btn-query-loading { background: linear-gradient(135deg, #002E5D30 0%, #00408030 100%) !important; color: #002E5D !important; cursor: not-allowed !important; box-shadow: none !important; }

        .nav-button {
            background-color: #f0f4ff; color: #002E5D; border: none; transition: all 0.2s; height: 48px; font-weight: 600; box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
        }
        .nav-button:hover:not(:disabled) { background-color: #e3e9ff; color: #002E5D; transform: translateY(-1px); box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        
        .btn-generate {
            height: 64px; background: linear-gradient(135deg, #002E5D 0%, #004080 100%); box-shadow: 0 4px 6px -1px rgba(0, 46, 93, 0.3), 0 2px 4px -1px rgba(0, 46, 93, 0.1); transition: all 0.3s ease; color: white;
        }
        .btn-generate:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 10px 15px -3px rgba(0, 46, 93, 0.3), 0 4px 6px -2px rgba(0, 46, 93, 0.1); background: linear-gradient(135deg, #003366 0%, #0055aa 100%); }
        .btn-generate:active:not(:disabled) { transform: translateY(0); }
        .btn-generate:disabled { background: #9ca3af; cursor: not-allowed; transform: none; box-shadow: none; }

        /* 頁籤 */
        .tab-button { 
            padding: 0.75rem 1.5rem; 
            font-weight: 700; 
            border-radius: 0.5rem 0.5rem 0 0; 
            transition: all 0.3s; 
            border-bottom: 3px solid transparent; 
            color: #9ca3af; 
            background-color: transparent; 
            margin-right: 0.25rem; 
            flex-grow: 1; 
            text-align: center; 
        }
        .tab-button.active { 
            color: #002E5D; 
            background-color: white; 
            border-color: #002E5D; 
            box-shadow: 0 -4px 6px -1px rgba(0, 0, 0, 0.05); 
        }

        /* 多選下拉框 */
        .multi-select-dropdown { position: relative; }
        .multi-select-trigger {
            cursor: pointer; background-color: white; border: 1px solid #d1d5db; border-radius: 0.375rem; padding: 0.6rem 0.8rem; min-height: 42px; display: flex; align-items: center; justify-content: space-between;
        }
        .multi-select-content {
            position: absolute; top: 100%; left: 0; width: 100%; background-color: white; border: 1px solid #d1d5db; border-radius: 0.375rem; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); z-index: 50; margin-top: 4px; max-height: 250px; overflow-y: auto; display: none;
        }
        .multi-select-content.open { display: block; }
        .course-checkbox-item { padding: 0.5rem 0.75rem; display: flex; align-items: flex-start; cursor: pointer; transition: background 0.1s; border-bottom: 1px solid #f3f4f6; }
        .course-checkbox-item:last-child { border-bottom: none; }
        .course-checkbox-item:hover { background-color: #f9fafb; }
        .course-checkbox-item input { margin-top: 0.3rem; margin-right: 0.75rem; }

        /* Debug Button */
        .debug-upload-label { 
            display: inline-flex; align-items: center; gap: 0.5rem; font-size: 0.85rem; color: #6b7280; 
            cursor: pointer; transition: color 0.2s; margin-left: 1rem; 
            display: none; 
        }
        .debug-upload-label.show { display: inline-flex; }
        .debug-status { font-size: 0.75rem; font-weight: bold; color: #16a34a; margin-left: 0.5rem; display: none; }
        .debug-status.show { display: inline; }
        
        /* Radio Styles & Cards */
        .student-proposal-card { transition: all 0.3s ease; }
        .student-proposal-card:hover { box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); }
        
        .pay-option-label { position: relative; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 1.5rem; border: 1px solid #e5e7eb; border-radius: 0.75rem; cursor: pointer; transition: all 0.2s; background-color: white; height: 100%; box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); }
        .pay-option-label:hover { background-color: #f9fafb; border-color: #cbd5e1; transform: translateY(-2px); box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05); }
        .radio-card-input { position: absolute; opacity: 0; width: 0; height: 0; }
        .pay-option-none:has(input:checked) { border-color: #475569; background-color: #f1f5f9; }
        .pay-option-none:has(input:checked) .pay-option-icon { color: #475569; }
        .pay-option-scholar:has(input:checked) { border-color: #b45309; background-color: #fffbeb; }
        .pay-option-scholar:has(input:checked) .pay-option-icon { color: #b45309; }
        .pay-option-allowance:has(input:checked) { border-color: #002E5D; background-color: #f0f9ff; }
        .pay-option-allowance:has(input:checked) .pay-option-icon { color: #002E5D; }
        .pay-option-icon { font-size: 2rem; margin-bottom: 0.5rem; transition: color 0.2s; color: #94a3b8; }
        
        .sub-option-label { display: flex; align-items: center; justify-content: center; padding: 0.75rem; border: 1px solid #e5e7eb; border-radius: 0.5rem; cursor: pointer; transition: all 0.2s; background: white; height: 100%; gap: 0.5rem; }
        .sub-option-label:hover { background-color: #f9fafb; }
        .sub-option-label-container { display: flex; flex-direction: column; height: 100%; justify-content: flex-start; }
        .sub-option-label-group { height: 52px; display: flex; gap: 1rem; }
        .sub-option-label:has(input:checked) { border-color: #002E5D; background-color: #f0f9ff; color: #002E5D; font-weight: bold; box-shadow: 0 0 0 1px #002E5D; }
        
        .welfare-card {
            border: 1px solid #e5e7eb; border-radius: 0.75rem; padding: 1.5rem; background-color: #fff;
            display: flex; flex-direction: column; height: 100%; min-height: 180px; transition: all 0.2s ease;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.05);
        }
        .welfare-card-header { display: flex; align-items: center; margin-bottom: 1rem; }
        .welfare-icon-box { width: 40px; height: 40px; border-radius: 9999px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; margin-right: 0.75rem; }
        .welfare-card-title { font-weight: bold; font-size: 1.1rem; color: #002E5D; }
        .welfare-select-field { background-color: #f9fafb; }
        
        .icon-box-dorm { background-color: #fef2f2; color: #ef4444; }
        .icon-box-food { background-color: #fffbeb; color: #b45309; }
        .icon-box-trans { background-color: #ecfdf5; color: #059669; }

        /* 修正: 福利輸入框 CSS，防止文字擠壓 */
        .cost-input-group {
            position: relative; display: flex; align-items: center; border: 1px solid #d1d5db;
            border-radius: 0.375rem; background-color: white; padding: 0.4rem 0.6rem; height: 42px;
            font-size: 1rem; transition: all 0.2s ease;
            flex-wrap: nowrap; /* 確保不換行 */
        }
        .cost-input-group:focus-within { border-color: #002E5D; box-shadow: 0 0 0 3px rgba(0, 46, 93, 0.1); }
        .cost-input-field { 
            border: none; background: transparent; outline: none; 
            text-align: right; padding: 0 0.3rem; color: #002E5D; font-weight: 600; 
            flex: 1; /* 自動填滿剩餘空間 */
            min-width: 0; /* 允許縮小 */
            width: auto; /* 覆蓋可能的 100% */
        }
        .cost-nt, .cost-unit-suffix { 
            color: #6b7280; font-weight: bold; font-size: 0.9rem; 
            flex-shrink: 0; /* 防止前後單位文字被擠壓 */
            white-space: nowrap; /* 強制不換行 */
        }
        
        .work-amount-input {
             border: 1px solid #d1d5db !important; border-radius: 0.375rem !important; padding: 0.6rem 0.8rem !important;
             display: flex; align-items: center; background-color: white; height: 52px !important; transition: all 0.2s ease;
        }
        .work-amount-input:focus-within { border-color: #002E5D; box-shadow: 0 0 0 3px rgba(0, 46, 93, 0.1); }
        .work-amount-field { border: none; outline: none; text-align: right; background-color: transparent; font-size: 1.25rem; font-weight: 600; color: #002E5D; flex-grow: 1; padding-right: 0.5rem; height: 100%; }
        
        #learn_amt_box .input-field { height: 52px !important; font-size: 1.25rem; padding: 0.6rem 2.8rem 0.6rem 3rem !important; font-weight: bold; }
        #learn_amt_box .relative.w-full.sub-option-label-group { height: 52px; }
        #learn_amt_box .relative.w-full.sub-option-label-group .absolute { height: 52px; font-size: 1rem; font-weight: bold; display: flex; align-items: center; }
    </style>
</head>
<body>

    <div id="lib-error">
        ⚠️ 系統偵測到核心元件未載入成功！<br>
        請嘗試使用手機網路或更換瀏覽器。錯誤元件：<span id="missing-lib"></span>
    </div>

    <div id="status-bar">準備就緒</div>

    <!-- 錯誤訊息彈窗 -->
    <div id="error-modal">
        <div id="error-content">
            <h3 id="modal-header-title" class="text-xl font-bold text-red-600 mb-4 flex items-center gap-2">
                <i id="modal-header-icon" class="fa-solid fa-circle-exclamation"></i> 發生錯誤
            </h3>
            <div class="bg-gray-50 p-4 rounded border border-gray-200 mb-6">
                <pre id="error-details" class="text-sm text-gray-800 font-mono"></pre>
            </div>
            <div class="flex justify-end">
                <button id="err-close" class="bg-gray-200 text-gray-700 px-6 py-2 rounded font-bold hover:bg-gray-300 transition">關閉</button>
            </div>
        </div>
    </div>

    <!-- 確認視窗 -->
    <div id="confirm-modal">
        <div id="confirm-content">
            <h3 class="text-xl font-bold text-thuBlue mb-4 flex items-center gap-2">
                <i class="fa-solid fa-circle-question"></i> 操作確認
            </h3>
            <div class="bg-blue-50 p-4 rounded border border-blue-200 mb-6">
                <pre id="confirm-details" class="text-sm text-gray-800 font-mono whitespace-pre-wrap"></pre>
            </div>
            <div class="flex justify-end gap-3">
                <button id="confirm-cancel" class="bg-gray-200 text-gray-700 px-5 py-2 rounded-lg font-bold hover:bg-gray-300 transition">取消</button>
                <button id="confirm-ok" class="bg-thuBlue text-white px-5 py-2 rounded-lg font-bold hover:bg-blue-800 transition shadow-md">確定執行</button>
            </div>
        </div>
    </div>

    <!-- Header -->
    <div class="fixed top-0 left-0 w-full bg-thuBlue z-50 shadow-md">
        <div class="w-full px-4 md:px-8 h-[80px] flex items-center justify-between">
            <div class="flex items-center gap-4">
                <img src="https://www.thu.edu.tw/upload/pagepic_upload/logo_w.svg" alt="THU Logo" class="h-10 w-auto">
                <div class="flex flex-col justify-center text-white">
                    <div id="version-trigger" class="text-lg md:text-xl font-bold tracking-wide leading-tight">學生校外實習文件產生器</div>
                    <div class="text-xs text-thuGold opacity-90 font-sans leading-tight mt-0.5">Internship Document Generation System</div>
                </div>
            </div>
            
            <div class="hidden md:flex gap-3 text-sm">
                <a href="./空白合約範本.docx" download="空白合約範本.docx" class="flex items-center gap-2 px-4 py-2 border border-thuGold text-thuGold rounded-full hover:bg-thuGold hover:text-thuBlue transition-all duration-200 font-medium">
                    <i class="fa-solid fa-file-contract"></i> 合約書下載
                </a>
                <a href="./空白計畫書範本.docx" download="空白計畫書範本.docx" class="flex items-center gap-2 px-4 py-2 border border-thuGold text-thuGold rounded-full hover:bg-thuGold hover:text-thuBlue transition-all duration-200 font-medium">
                    <i class="fa-regular fa-file-lines"></i> 計劃書下載
                </a>
                <!-- 修正: 補回實習中心網頁連結 -->
                <a href="https://aca.thu.edu.tw/web/isac/page.php?scid=112&sid=103" target="_blank" class="flex items-center gap-2 px-4 py-2 bg-white text-thuBlue rounded-full hover:bg-gray-100 shadow-sm transition-all duration-200 font-medium">
                    <i class="fa-solid fa-link"></i> 實習中心網頁
                </a>
                <a href="https://www.thu.edu.tw/" target="_blank" class="flex items-center gap-2 px-4 py-2 bg-white text-thuBlue rounded-full hover:bg-gray-100 shadow-sm transition-all duration-200 font-medium">
                    <i class="fa-solid fa-house"></i> 東海大學首頁
                </a>
            </div>
        </div>
    </div>

    <main class="mx-auto mb-20 pt-24">
        
        <!-- 頁籤容器 -->
        <div class="sticky top-[80px] z-40 bg-[#f3f4f6] w-full border-b border-gray-300 pt-4 mb-6 shadow-sm">
            <div class="max-w-7xl mx-auto px-4">
                <div class="flex -mb-px">
                    <button class="tab-button active" data-page="page-1" onclick="showPage('page-1')">
                        <i class="fa-solid fa-circle-info mr-2"></i> 使用須知
                    </button>
                    <button class="tab-button" data-page="page-2" onclick="showPage('page-2')">
                        <i class="fa-solid fa-users mr-2"></i> 實習學生資料
                    </button>
                    <button class="tab-button" data-page="page-3" onclick="showPage('page-3')">
                        <i class="fa-solid fa-file-contract mr-2"></i> 實習合約內容
                    </button>
                    <button class="tab-button" data-page="page-4" onclick="showPage('page-4')">
                        <i class="fa-regular fa-file-lines mr-2"></i> 學生實習計畫書
                    </button>
                </div>
            </div>
        </div>

        <div class="max-w-7xl mx-auto px-4">
            <form id="contractForm">
                
                <!-- ========== Page 1 ========== -->
                <div id="page-1" class="page-content mt-4">
                    <div class="bg-white border border-blue-100 rounded-xl p-8 shadow-sm">
                        <div class="flex items-start gap-4">
                            <div class="w-12 h-12 rounded-full bg-blue-50 flex items-center justify-center text-blue-600 shrink-0">
                                <i class="fa-solid fa-lightbulb text-xl"></i>
                            </div>
                            <div class="flex-1">
                                <h3 class="text-lg font-bold text-gray-800 mb-3">系統操作流程與說明</h3>
                                <ol class="text-base text-gray-600 leading-relaxed list-decimal list-outside ml-4 space-y-3">
                                    <li><span class="font-bold text-thuBlue">目的與聲明</span>
                                        <p class="text-sm mt-1 text-gray-500">本系統旨在協助本校各院系(學程)實習承辦人員快速產製符合規範之「校外實習合約書」及「學生個別實習計畫書」。</p>
                                    </li>
                                    <li><span class="font-bold text-thuBlue">文件生成流程</span>
                                        <ul class="list-decimal list-outside ml-4 mt-1 space-y-1 text-sm">
                                            <li>填寫學生基本資料：請完成實習學生之姓名、學號、系所、年級等基本資訊輸入或匯入。</li>
                                            <li>輸入實習機構資訊：請提供機構名稱、統一編號、實習期間、每日實習時段、實習類型及相關待遇福利。</li>
                                            <li>設定課程及學生對應資訊：建立實習課程項目，並為每位學生指定選課、指導教師及實習類別。</li>
                                            <li>輸出文件：檢查資料無誤後，即可下載個別或打包文件。</li>
                                        </ul>
                                    </li>
                                </ol>
                            </div>
                        </div>
                    </div>
                    <button type="button" onclick="showPage('page-2')" class="nav-button w-40 px-6 py-3 rounded-full font-bold flex items-center justify-center gap-2 mt-6 ml-auto">
                        下一步 <i class="fa-solid fa-arrow-right"></i>
                    </button>
                </div>

                <!-- ========== Page 2 ========== -->
                <div id="page-2" class="page-content hidden">
                    <div class="card">
                        <div class="card-header">
                            <span class="card-header-title mr-4">實習學生資料</span>
                            <div class="flex items-center bg-gray-100 rounded-lg p-1 border border-gray-200">
                                <button type="button" onclick="changeStudentCount(-1)" class="w-8 h-8 flex items-center justify-center rounded-md text-gray-600 hover:bg-white hover:shadow-sm hover:text-thuBlue transition-all"><i class="fa-solid fa-minus"></i></button>
                                <div class="w-16 text-center text-sm font-bold text-thuBlue" id="student_count_display">1 人</div>
                                <button type="button" onclick="changeStudentCount(1)" class="w-8 h-8 flex items-center justify-center rounded-md text-gray-600 hover:bg-white hover:shadow-sm hover:text-thuBlue transition-all"><i class="fa-solid fa-plus"></i></button>
                            </div>
                            <input type="hidden" id="student_count" value="1">
                        </div>
                        <div class="px-8 pt-4 flex justify-end">
                             <input type="file" id="upload_excel" accept=".xlsx, .xls" class="hidden" onchange="handleExcelUpload(event)">
                             <div class="flex gap-2">
                                 <button type="button" onclick="downloadExcelTemplate()" class="text-sm text-gray-500 hover:text-thuBlue underline mr-2"><i class="fa-solid fa-download"></i> 下載範本</button>
                                 <button type="button" onclick="document.getElementById('upload_excel').click()" class="bg-green-600 text-white px-3 py-1.5 rounded text-sm font-bold hover:bg-green-700 transition flex items-center gap-1"><i class="fa-solid fa-file-excel"></i> 匯入 Excel</button>
                             </div>
                        </div>
                        <div class="p-8">
                            <div id="student_container" class="space-y-6"></div>
                        </div>
                    </div>
                    <div class="flex justify-between mt-6">
                        <button type="button" onclick="showPage('page-1')" class="nav-button w-40 px-6 py-3 rounded-full font-bold flex items-center justify-center gap-2"><i class="fa-solid fa-arrow-left"></i> 上一步</button>
                        <button type="button" onclick="showPage('page-3')" class="nav-button w-40 px-6 py-3 rounded-full font-bold flex items-center justify-center gap-2">下一步 <i class="fa-solid fa-arrow-right"></i></button>
                    </div>
                </div>

                <!-- ========== Page 3 ========== -->
                <div id="page-3" class="page-content hidden">
                    <div class="card">
                        <div class="card-header">
                            <div class="flex items-center">
                                 <span class="card-header-title">乙方：實習機構資料</span>
                                 <label id="debug-contract-label" class="debug-upload-label"><i class="fa-solid fa-wrench"></i> 測試合約範本<input type="file" accept=".docx" class="hidden" onchange="handleDebugUpload(event, 'contract')"></label>
                                 <span id="debug_contract_status" class="debug-status"><i class="fa-solid fa-check"></i> 已載入</span>
                            </div>
                        </div>
                        <div class="p-8 grid grid-cols-1 md:grid-cols-4 gap-x-6 gap-y-6">
                            <div class="md:col-span-4 mb-2"><span class="text-sm text-red-500 flex items-center">您可輸入統一編號後，按下 Enter 鍵或點擊查詢按鈕，系統將自動帶入公司名稱、負責人與登記地址。</span></div>
                            <div class="md:col-span-4 flex flex-col md:flex-row gap-x-6 gap-y-4">
                                <div class="w-full md:w-[65%]">
                                    <label class="block text-sm font-bold text-gray-700 mb-2">統一編號 <span class="text-red-500">*</span></label>
                                    <div id="tax_id_input_group" class="flex gap-2 items-center transition-opacity duration-300">
                                        <input type="text" id="company_tax_id" class="input-field flex-grow" placeholder="04231910" maxlength="15" onkeydown="handleTaxIdKey(event)">
                                        <button type="button" id="queryBtn" class="btn-query flex items-center gap-2 opacity-50 cursor-not-allowed whitespace-nowrap" disabled><i class="fa-solid fa-magnifying-glass"></i> 自動查詢</button>
                                    </div>
                                </div>
                                <div class="w-full md:w-[35%] self-end">
                                    <label for="no_tax_id" class="flex items-center p-3 h-[42px] border-2 rounded-lg cursor-pointer transition-all hover:bg-gray-100 has-[:checked]:border-red-500 has-[:checked]:bg-red-50/50">
                                        <input type="checkbox" id="no_tax_id" onchange="toggleTaxIdFields()" class="w-4 h-4 text-red-600 bg-gray-100 border-gray-300 rounded focus:ring-red-500">
                                        <span class="ml-2 text-base font-medium text-gray-800 select-none whitespace-normal">實習機構未申請設立字號</span>
                                    </label>
                                </div>
                            </div>
                            <div class="md:col-span-4"><label class="block text-sm font-bold text-gray-700 mb-2">機構全銜 (法定名稱) <span class="text-red-500">*</span></label><input type="text" id="company_name" class="input-field" placeholder="例：國泰世華商業銀行股份有限公司"></div>
                            <div class="md:col-span-2"><label class="block text-sm font-bold text-gray-700 mb-2">代表人姓名 <span class="text-red-500">*</span></label><input type="text" id="company_rep" class="input-field"></div>
                            <div class="md:col-span-2"><label class="block text-sm font-bold text-gray-700 mb-2">代表人職稱 <span class="text-red-500">*</span></label><input type="text" id="company_title" class="input-field" placeholder=""></div>
                            <div class="md:col-span-4"><label class="block text-sm font-bold text-gray-700 mb-2">公司登記地址 (總公司) <span class="text-red-500">*</span></label><input type="text" id="reg_address" class="input-field" placeholder="例：臺北市信義區松仁路7號1樓"></div>
                            <div class="md:col-span-4 pt-6 border-t border-gray-200 mt-2">
                                <div class="text-sm font-bold text-thuBlue mb-4 flex items-center gap-2 bg-blue-50 p-2 rounded"><i class="fa-solid fa-location-dot"></i> 實習地點</div>
                                <div class="mb-4 flex items-center"><input type="checkbox" id="is_head_office" class="w-4 h-4 text-thuBlue bg-gray-100 border-gray-300 rounded focus:ring-thuBlue" onchange="toggleBranchFields()"><label for="is_head_office" class="ml-2 text-sm font-medium text-gray-700 select-none">學生於總公司實習 (或實習機構無分公司)</label></div>
                                <div id="branch_fields_wrapper" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <div><label class="block text-xs font-bold text-gray-500 mb-2">實習單位/分公司名稱 <span class="text-red-500">*</span></label><input type="text" id="branch_name" class="input-field" placeholder="例：淡水分公司"></div>
                                    <div><label class="block text-xs font-bold text-gray-500 mb-2">實際實習地址 <span class="text-red-500">*</span></label><input type="text" id="branch_addr" class="input-field" placeholder="例：新北市淡水區中山路106號"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header"><span class="card-header-title">實習期間與時間</span></div>
                        <div class="p-8 space-y-8">
                            <div>
                                <label class="block text-sm font-bold text-gray-700 mb-3">1. 實習期間 <span class="text-red-500">*</span></label>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <div>
                                        <span class="text-xs font-bold text-gray-500 mb-2 block uppercase tracking-wide text-center">實習開始 (民國年/月/日)</span>
                                        <div class="date-group">
                                            <input type="number" id="start_y" class="date-input w-16 text-thuBlue" placeholder="113" oninput="autoJump(this, 3, 'start_m')" onkeydown="handleDateKey(event, 'start_y', 3)"><span class="date-sep">/</span>
                                            <input type="number" id="start_m" class="date-input w-12" placeholder="07" oninput="autoJump(this, 2, 'start_d')" onkeydown="handleDateKey(event, 'start_m', 2)"><span class="date-sep">/</span>
                                            <input type="number" id="start_d" class="date-input w-12" placeholder="01" oninput="autoJump(this, 2, 'end_y')" onkeydown="handleDateKey(event, 'start_d', 2)"> 
                                        </div>
                                    </div>
                                    <div>
                                        <span class="text-xs font-bold text-gray-500 mb-2 block uppercase tracking-wide text-center">實習結束 (民國年/月/日)</span>
                                        <div class="date-group">
                                            <input type="number" id="end_y" class="date-input w-16 text-thuBlue" placeholder="114" oninput="autoJump(this, 3, 'end_m')" onkeydown="handleDateKey(event, 'end_y', 3)"><span class="date-sep">/</span>
                                            <input type="number" id="end_m" class="date-input w-12" placeholder="06" oninput="autoJump(this, 2, 'end_d')" onkeydown="handleDateKey(event, 'end_m', 2)"><span class="date-sep">/</span>
                                            <input type="number" id="end_d" class="date-input w-12" placeholder="30" onkeydown="handleDateKey(event, 'end_d', 2)">
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="border-t border-gray-200 pt-8">
                                <label class="block text-sm font-bold text-gray-700 mb-3 relative">
                                    2. 每日實習時間 <span class="text-red-500">*</span>
                                    <span class="time-input-hint">(24時制 HH:mm)</span>
                                </label>
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 bg-gray-50 p-6 rounded-lg border border-gray-200">
                                    <div class="relative text-center">
                                        <span class="text-xs font-bold text-gray-400 uppercase mb-1 block">每日開始時間</span>
                                        <div class="time-input-container">
                                            <input type="text" id="daily_start" class="time-input-field" placeholder="HH:mm" maxlength="5" oninput="validateTime(this)">
                                        </div>
                                    </div>
                                    <div class="relative text-center">
                                        <span class="text-xs font-bold text-gray-400 uppercase mb-1 block">每日結束時間</span>
                                        <div class="time-input-container">
                                            <input type="text" id="daily_end" class="time-input-field" placeholder="HH:mm" maxlength="5" oninput="validateTime(this)">
                                        </div>
                                    </div>
                                    <div class="text-center">
                                        <span class="text-xs font-bold text-gray-400 uppercase mb-1 block">共計(小時)</span>
                                        <input type="number" id="daily_hours" value="8" step="0.5" class="input-field bg-white border-gray-300 text-center">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card" id="card-conditions">
                        <div class="card-header"><span class="card-header-title">實習類型與待遇福利</span></div>
                        <div class="p-8 space-y-8">
                            <div id="type-section" class="p-4 rounded-lg border border-transparent transition-all">
                                <label class="block text-lg font-bold text-thuBlue mb-3">1. 請選擇實習類型 <span class="text-red-500 text-sm">*必填</span></label>
                                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                    <label class="relative flex items-center p-5 border-2 rounded-xl cursor-pointer transition-all hover:bg-gray-50 has-[:checked]:border-thuBlue has-[:checked]:bg-blue-50/50 has-[:checked]:ring-1 has-[:checked]:ring-thuBlue h-full">
                                        <input type="radio" name="contract_type" value="learn" onchange="toggleType()" class="w-5 h-5 text-thuBlue border-gray-300 focus:ring-thuBlue">
                                        <div class="ml-4">
                                            <i class="fa-solid fa-book-open text-2xl text-thuBlue opacity-30 absolute right-4 top-4"></i>
                                            <span class="block text-base font-bold text-gray-900">一般型 (學習型)</span>
                                            <span class="block text-xs text-gray-500 mt-1">單純學習訓練，無僱傭關係</span>
                                        </div>
                                    </label>
                                    <label class="relative flex items-center p-5 border-2 rounded-xl cursor-pointer transition-all hover:bg-gray-50 has-[:checked]:border-orange-500 has-[:checked]:bg-orange-50/50 has-[:checked]:ring-1 has-[:checked]:ring-orange-500 h-full">
                                        <input type="radio" name="contract_type" value="work" onchange="toggleType()" class="w-5 h-5 text-orange-600 border-gray-300 focus:ring-orange-500">
                                        <div class="ml-4">
                                            <i class="fa-solid fa-briefcase text-2xl text-orange-600 opacity-30 absolute right-4 top-4"></i>
                                            <span class="block text-base font-bold text-gray-900">工作型 (勞資型)</span>
                                            <span class="block text-xs text-gray-500 mt-1">具僱傭關係，適用勞基法</span>
                                        </div>
                                    </label>
                                </div>
                            </div>

                            <div id="pay-section" class="border-t border-gray-200 pt-6 p-4 rounded-lg border border-transparent transition-all">
                                <label class="block text-lg font-bold text-thuBlue mb-3">2. 實習待遇與給付 <span class="text-red-500 text-sm">*必填</span></label>
                                <div id="panel_initial" class="flex items-center justify-center p-8 bg-yellow-50 rounded-xl border-2 border-dashed border-yellow-200 text-yellow-700 font-bold shadow-sm">
                                    <i class="fa-solid fa-arrow-up mr-2 animate-bounce"></i> 請先選擇上方「實習類型」以解鎖此區塊
                                </div>
                                
                                <div id="panel_learn" class="bg-green-50 p-6 rounded-xl border border-green-200 hidden fade-in">
                                    <span class="text-[10px] font-black text-green-700 bg-green-200 px-2 py-1 rounded uppercase tracking-wider mb-4 inline-block">學習型</span>
                                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-6">
                                        <label class="pay-option-label pay-option-none">
                                            <input type="radio" name="pay_opt_learn" value="none" onchange="togglePayInputs()" class="radio-card-input">
                                            <i class="fa-regular fa-circle-xmark pay-option-icon"></i><span class="pay-option-text text-sm">無</span>
                                        </label>
                                        <label class="pay-option-label pay-option-scholar">
                                            <input type="radio" name="pay_opt_learn" value="scholar" onchange="togglePayInputs()" class="radio-card-input">
                                            <i class="fa-solid fa-graduation-cap pay-option-icon"></i><span class="pay-option-text text-sm">獎學金</span>
                                        </label>
                                        <label class="pay-option-label pay-option-allowance">
                                            <input type="radio" name="pay_opt_learn" value="allowance" onchange="togglePayInputs()" class="radio-card-input">
                                            <i class="fa-solid fa-hand-holding-dollar pay-option-icon"></i><span class="pay-option-text text-sm">實習津貼</span>
                                        </label>
                                    </div>
                                    <div id="learn_pay_details" class="hidden grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div class="sub-option-label-container">
                                            <label class="block text-xs font-bold text-green-800 mb-2 uppercase">給付方式</label>
                                            <div class="grid grid-cols-2 gap-4 sub-option-label-group">
                                                <label class="sub-option-label">
                                                    <input type="radio" name="pay_method_learn" value="total" class="hidden" onchange="togglePayInputs()" checked>
                                                    <i class="fa-solid fa-sack-dollar"></i> <span>一次性給付</span>
                                                </label>
                                                <label class="sub-option-label">
                                                    <input type="radio" name="pay_method_learn" value="monthly" class="hidden" onchange="togglePayInputs()">
                                                    <i class="fa-regular fa-calendar-check"></i> <span>每月給付</span>
                                                </label>
                                            </div>
                                        </div>
                                        <div id="learn_amt_box" class="transition-all sub-option-label-container">
                                            <label id="learn_amt_label" class="block text-xs font-bold text-green-800 mb-2 uppercase">給付金額 (一次性給付)</label>
                                            <div class="relative w-full sub-option-label-group flex items-center">
                                                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none text-gray-500 font-bold text-base">NT$</div>
                                                <input type="text" id="learn_amount" placeholder="0" class="input-field text-right border-green-300 focus:border-green-600 focus:ring-green-600 font-mono text-xl font-bold h-full" oninput="formatCurrency(this)">
                                                <div class="absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none text-gray-500 font-bold text-base">元</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div id="panel_work" class="bg-orange-50 p-6 rounded-xl border border-orange-200 hidden fade-in">
                                    <span class="text-[10px] font-black text-orange-700 bg-orange-200 px-2 py-1 rounded uppercase tracking-wider mb-4 inline-block">勞資型</span>
                                    <div class="bg-white p-4 rounded-lg border-l-4 border-orange-400 shadow-sm text-xs text-gray-600 leading-relaxed mb-6" id="work_legal_notice"></div>
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-6">
                                        <div class="sub-option-label-container">
                                            <label class="block text-xs font-bold text-orange-800 mb-2 uppercase">計薪方式</label>
                                            <div class="grid grid-cols-2 gap-4 sub-option-label-group">
                                                <label class="sub-option-label bg-white">
                                                    <input type="radio" name="wage_type_work" value="monthly" class="hidden" onchange="toggleWorkWageType()" checked>
                                                    <i class="fa-solid fa-calendar-days"></i> <span>月薪</span>
                                                </label>
                                                <label class="sub-option-label bg-white">
                                                    <input type="radio" name="wage_type_work" value="hourly" class="hidden" onchange="toggleWorkWageType()">
                                                    <i class="fa-regular fa-clock"></i> <span>時薪</span>
                                                </label>
                                            </div>
                                        </div>
                                        <div class="sub-option-label-container">
                                            <label id="work_amt_label" class="block text-xs font-bold text-orange-800 mb-2 uppercase">薪資金額 (月薪)</label>
                                            <div class="work-amount-input">
                                                <span class="work-amount-nt">NT$</span>
                                                <input type="text" id="work_amount" placeholder="28,590" class="work-amount-field font-mono text-xl font-bold text-thuBlue" oninput="formatCurrency(this)">
                                                <span class="work-amount-unit">元</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div id="welfare-section" class="border-t border-gray-200 pt-6 p-4 rounded-lg border border-transparent transition-all">
                                <label class="block text-lg font-bold text-thuBlue mb-3">3. 福利項目 <span class="text-red-500 text-sm">*必填</span></label>
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                                    <div class="welfare-card">
                                        <div class="welfare-card-header">
                                            <div class="welfare-icon-box icon-box-dorm"><i class="fa-solid fa-house text-lg"></i></div>
                                            <span class="welfare-card-title">住宿</span>
                                        </div>
                                        <select id="dorm_opt" onchange="toggleCost('dorm')" class="input-field welfare-select-field mb-2">
                                            <option value="" disabled selected>請選擇</option>
                                            <option value="none">無</option>
                                            <option value="free">免費提供</option>
                                            <option value="paid">付費提供</option>
                                        </select>
                                        <div id="dorm_cost_wrapper" class="hidden relative mt-auto flex flex-col">
                                            <div class="cost-input-group">
                                                <span class="cost-nt">NT$</span>
                                                <input id="dorm_cost" type="text" placeholder="0" class="cost-input-field" oninput="formatCurrency(this)">
                                                <span class="cost-unit-suffix">/月</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="welfare-card">
                                        <div class="welfare-card-header">
                                            <div class="welfare-icon-box icon-box-food"><i class="fa-solid fa-utensils text-lg"></i></div>
                                            <span class="welfare-card-title">膳食</span>
                                        </div>
                                        <select id="food_opt" onchange="toggleCost('food')" class="input-field welfare-select-field mb-2">
                                            <option value="" disabled selected>請選擇</option>
                                            <option value="none">無</option>
                                            <option value="free">免費提供</option>
                                            <option value="paid">付費提供</option>
                                        </select>
                                        <div id="food_cost_wrapper" class="hidden relative mt-auto flex flex-col">
                                            <div class="cost-input-group">
                                                <span class="cost-nt">NT$</span>
                                                <input id="food_cost" type="text" placeholder="0" class="cost-input-field" oninput="formatCurrency(this)">
                                                <span class="cost-unit-suffix">/餐</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="welfare-card">
                                        <div class="welfare-card-header">
                                            <div class="welfare-icon-box icon-box-trans"><i class="fa-solid fa-bus text-lg"></i></div>
                                            <span class="welfare-card-title">交通</span>
                                        </div>
                                        <select id="trans_opt" onchange="toggleCost('trans')" class="input-field welfare-select-field mb-2">
                                            <option value="" disabled selected>請選擇</option>
                                            <option value="none">無</option>
                                            <option value="free">交通車（免費提供）</option>
                                            <option value="paid">交通車（付費提供）</option>
                                            <option value="subsidy">交通津貼</option>
                                        </select>
                                        <div id="trans_cost_wrapper" class="hidden relative mt-auto flex flex-col">
                                            <div class="cost-input-group">
                                                <span class="cost-nt">NT$</span>
                                                <input id="trans_cost" type="text" placeholder="0" class="cost-input-field" oninput="formatCurrency(this)">
                                                <span class="cost-unit-suffix">/月</span>
                                            </div>
                                            <div id="trans_hint" class="text-xs text-gray-400 mt-1 text-right"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="flex justify-between items-center mt-12">
                        <button type="button" onclick="showPage('page-2')" class="nav-button w-40 px-6 py-3 rounded-full font-bold flex items-center justify-center gap-2"><i class="fa-solid fa-arrow-left"></i> 上一步</button>
                        <button type="button" onclick="generateDoc()" id="genContractBtn" class="btn-generate w-64 px-6 py-5 rounded-full font-bold text-lg flex items-center justify-center gap-3"><span class="animate-pulse">系統載入中...</span></button>
                    </div>
                </div>

                <!-- ========== Page 4 ========== -->
                <div id="page-4" class="page-content hidden">
                    <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
                        <div class="lg:col-span-4 lg:sticky lg:top-24 h-fit">
                            <div class="card bg-white border border-blue-200 shadow-sm">
                                <div class="card-header bg-blue-50 py-3">
                                    <span class="card-header-title text-thuBlue text-base"><i class="fa-solid fa-book mr-2"></i> 實習課程列表</span>
                                </div>
                                <div class="p-4">
                                    <div class="flex justify-end mb-4">
                                         <input type="file" id="upload_course_excel" accept=".xlsx, .xls" class="hidden" onchange="handleCourseExcelUpload(event)">
                                         <div class="flex gap-2">
                                             <button type="button" onclick="downloadCourseExcelTemplate()" class="text-sm text-gray-500 hover:text-thuBlue underline mr-2"><i class="fa-solid fa-download"></i> 下載範本</button>
                                             <button type="button" onclick="document.getElementById('upload_course_excel').click()" class="bg-green-600 text-white px-3 py-1.5 rounded text-sm font-bold hover:bg-green-700 transition flex items-center gap-1"><i class="fa-solid fa-file-excel"></i> Excel 匯入</button>
                                         </div>
                                    </div>
                                    
                                    <div class="grid grid-cols-2 gap-3 mb-3">
                                        <div>
                                            <label class="block text-xs font-bold text-gray-500 mb-1">開課學年</label>
                                            <input type="number" id="new_course_year" class="input-field text-sm h-9" placeholder="113">
                                        </div>
                                        <div>
                                            <label class="block text-xs font-bold text-gray-500 mb-1">開課學期</label>
                                            <select id="new_course_sem" class="input-field text-sm h-9 py-1">
                                                <option value="" disabled selected>請選擇</option>
                                                <option value="1">1 (上)</option>
                                                <option value="2">2 (下)</option>
                                            </select>
                                        </div>
                                        <div class="col-span-2">
                                            <label class="block text-xs font-bold text-gray-500 mb-1">課程名稱</label>
                                            <input type="text" id="new_course_name" class="input-field text-sm h-9" placeholder="例：企業實習(一)">
                                        </div>
                                        <div class="col-span-2 flex items-end gap-2">
                                            <div class="w-1/2">
                                                <label class="block text-xs font-bold text-gray-500 mb-1">學分</label>
                                                <input type="number" id="new_course_credits" class="input-field text-sm h-9" placeholder="3">
                                            </div>
                                            <button type="button" onclick="addCourse()" class="w-1/2 bg-blue-600 text-white font-bold h-9 rounded-lg hover:bg-blue-700 transition shadow-md hover:shadow-lg flex items-center justify-center gap-1 text-sm">
                                                <i class="fa-solid fa-plus-circle"></i> 新增
                                            </button>
                                        </div>
                                    </div>
                                    
                                    <div id="course_list_display" class="space-y-2 max-h-[60vh] overflow-y-auto pr-1">
                                        <div class="text-center text-gray-400 text-xs py-4 border border-dashed border-gray-300 rounded">請輸入上方資料並新增</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="lg:col-span-8">
                            <div class="card">
                                <div class="card-header py-3">
                                    <div class="flex items-center justify-between w-full">
                                        <span class="card-header-title text-base">學生實習計畫書</span>
                                        <div class="flex items-center gap-2">
                                            <label class="debug-upload-label"><i class="fa-solid fa-wrench"></i> 測試範本<input type="file" accept=".docx" class="hidden" onchange="handleDebugUpload(event, 'proposal')"></label>
                                            <div class="flex gap-2 ml-2">
                                                <input type="file" id="upload_proposal_excel" accept=".xlsx, .xls" class="hidden" onchange="handleProposalExcelUpload(event)">
                                                <button type="button" onclick="downloadProposalExcelTemplate()" class="text-xs text-gray-500 hover:text-thuBlue underline" title="下載學生計畫書設定範本"><i class="fa-solid fa-download"></i> 下載範本</button>
                                                <button type="button" onclick="document.getElementById('upload_proposal_excel').click()" class="text-xs bg-green-600 text-white px-3 py-1.5 rounded hover:bg-green-700 transition font-bold flex items-center gap-1" title="匯入學生計畫書設定"><i class="fa-solid fa-file-excel"></i> Excel 匯入</button>
                                            </div>
                                            <span id="debug_proposal_status" class="debug-status"><i class="fa-solid fa-check"></i></span>
                                            <div class="text-xs font-medium text-gray-500 ml-2">共 <span id="proposal_student_count">1</span> 人</div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="p-4 bg-gray-50 min-h-[200px]">
                                    <div id="proposal_list_message" class="text-center text-red-500 font-bold mb-3"></div>
                                    <div class="flex items-center justify-between mb-3 px-1" id="proposal_header_controls">
                                        <div class="flex items-center">
                                            <input type="checkbox" id="select_all_proposals" onclick="toggleSelectAll(this)" class="w-4 h-4 text-thuBlue bg-white border-gray-300 rounded focus:ring-thuBlue cursor-pointer">
                                            <label for="select_all_proposals" class="ml-2 text-sm font-bold text-gray-600 cursor-pointer select-none">全選</label>
                                        </div>
                                        <div class="text-xs text-gray-400"><i class="fa-regular fa-lightbulb mr-1"></i> 點擊卡片即可展開編輯</div>
                                    </div>
                                    <div id="proposal_list_container" class="space-y-3"></div>
                                </div>
                                <div id="proposal_empty_msg" class="p-8 text-center text-gray-500 hidden">尚無學生名單，請前往"實習學生資料"建立學生名單</div>
                            </div>
                        </div>

                    </div>
                    
                    <div class="flex flex-col md:flex-row justify-between items-center mt-8 gap-4">
                        <button type="button" onclick="showPage('page-3')" class="nav-button w-40 px-6 py-3 rounded-full font-bold flex items-center justify-center gap-2"><i class="fa-solid fa-arrow-left"></i> 上一步</button>
                        <button type="button" onclick="downloadSelectedProposals()" id="bulkDownloadBtn" class="btn-generate w-full md:w-80 px-6 py-5 rounded-full font-bold text-lg flex items-center justify-center gap-3"><i class="fa-solid fa-file-zipper"></i> 打包下載選取計畫書 (ZIP)</button>
                        <button type="button" onclick="generateProposalDoc()" id="genProposalBtn" class="hidden"></button>
                    </div>
                </div>
            </form>
        </div>
    </main>

    <footer>
        <div class="container mx-auto px-4">
            <div class="flex flex-col items-center justify-center gap-1">
                <p class="font-bold text-white tracking-wide text-[10px]">
                    Copyright <i class="fa-regular fa-copyright"></i> 2025 東海大學實習與學生成就中心 Internship and Student Achievement Center, Tunghai University. All Rights Reserved.
                </p>
                <p id="footer-version-trigger" class="text-[9px] text-gray-500 cursor-pointer">系統版本 V1.0.0 | 網頁製作：張博堯 | Assisted by Google Gemini</p>
            </div>
        </div>
    </footer>

    <script>
        let studentDataState = [];
        let courseListState = []; 
        const fullWidthSpaceFive = '　　　　　'; 
        const maxCourses = 8; 

        // 點擊計數器和計時器
        let clickCount = 0;
        let lastClickTime = 0;
        const clickThreshold = 5;
        const timeWindow = 1000; 

        function showPage(pageId) {
            const pages = document.querySelectorAll('.page-content');
            pages.forEach(page => {
                page.classList.add('hidden');
                page.classList.remove('fade-in');
            });

            const targetPage = document.getElementById(pageId);
            if (targetPage) {
                targetPage.classList.remove('hidden');
                targetPage.classList.add('fade-in');
            }

            const buttons = document.querySelectorAll('.tab-button');
            buttons.forEach(btn => {
                btn.classList.remove('active');
                if (btn.getAttribute('data-page') === pageId) {
                    btn.classList.add('active');
                }
            });

            window.scrollTo({ top: 0, behavior: 'smooth' });
            
            if(pageId === 'page-4') {
                renderProposalList();
            }
        }

        function checkDebugToggle() {
            const now = Date.now();
            if (now - lastClickTime < timeWindow) {
                clickCount++;
            } else {
                clickCount = 1;
            }
            lastClickTime = now;

            if (clickCount >= clickThreshold) {
                const debugLabel = document.getElementById('debug-contract-label');
                const debugProposalLabel = document.querySelector('#page-4 .debug-upload-label');
                if (debugLabel) {
                    debugLabel.classList.toggle('show');
                    if (debugProposalLabel) debugProposalLabel.classList.toggle('show');
                    showMsg(debugLabel.classList.contains('show') ? "偵錯模式已啟用 (顯示測試範本上傳按鈕)" : "偵錯模式已關閉");
                }
                clickCount = 0;
            }
        }

        function cleanXML(xml) {
            if (!xml) return "";
            const pattern = /%%%[^%]+%%%/g;
            return xml.replace(pattern, function(match) { return match.replace(/<\/?[^>]+(>|$)/g, ""); });
        }

        let debugContractBuffer = null;
        let debugProposalBuffer = null;
        
        function handleDebugUpload(event, type) {
            const file = event.target.files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                const header = new Uint8Array(e.target.result.slice(0, 4));
                if (header[0] !== 0x50 || header[1] !== 0x4b) {
                     showError("檔案錯誤", "載入的檔案不是有效的 DOCX (ZIP) 檔案，請確認是否為 Word 文件。");
                     return;
                }

                if(type === 'contract') {
                    debugContractBuffer = e.target.result;
                    document.getElementById('debug_contract_status').classList.add('show');
                } else {
                    debugProposalBuffer = e.target.result;
                    document.getElementById('debug_proposal_status').classList.add('show');
                }
                showMsg("測試範本載入成功，請進行文件產出");
            };
            reader.readAsArrayBuffer(file);
        }
        
        async function getTemplateBuffer(type) {
            if (type === 'contract' && debugContractBuffer) return debugContractBuffer;
            if (type === 'proposal' && debugProposalBuffer) return debugProposalBuffer;
            const url = type === 'contract' ? './template.docx' : './template_plan.docx';
            const resp = await fetch(url);
            if (!resp.ok) throw new Error(`找不到 ${url}（請確認檔案是否存在於根目錄）`);
            return await resp.arrayBuffer();
        }

        function autoJump(current, maxLen, nextId) {
            if (current.value.length >= maxLen) { 
                const next = document.getElementById(nextId); 
                if (next) next.focus(); 
            }
        }
        
        function formatAmount(amount, useFullWidthSpaces = false) {
             const fullWidthSpace = '　　　　　'; 
             let cleanAmount = amount ? String(amount).replace(/,/g, '') : 0;
             let num = Number(cleanAmount);
             
             if (useFullWidthSpaces || !num || num <= 0) {
                 return fullWidthSpace;
             }
             return ' ' + num.toLocaleString() + ' '; 
        }
        
        function formatTime(time, isHours = false) {
            if (!time || !/^(?:[01]\d|2[0-3]):[0-5]\d$/.test(time)) {
                if (!isHours) return ' ○○：○○ '; 
                return ' ○○ '; 
            }
            return ' ' + time.replace(':', '：') + ' '; 
        }
        
        function formatCurrency(input) {
            let value = input.value.replace(/[^0-9]/g, '');
            if (value === '') {
                input.value = '';
                return;
            }
            let formattedValue = Number(value).toLocaleString();
            input.value = formattedValue;
        }

        function validateTime(input) {
            let value = input.value.replace(/[^0-9]/g, '');
            if (value.length > 4) value = value.substring(0, 4);
            let display = value;
            if (value.length >= 2) {
                const hour = parseInt(value.substring(0, 2));
                if (hour > 23) value = '23' + value.substring(2);
                display = value.substring(0, 2) + (value.length > 2 ? ':' + value.substring(2, 4) : '');
            }
            input.value = display;
        }

        function handleDateKey(event, currentId, maxLen) {
            const current = document.getElementById(currentId);
            if (!current) return;
            const fields = ['start_y', 'start_m', 'start_d', 'end_y', 'end_m', 'end_d'];
            const currentIndex = fields.indexOf(currentId);

            if (event.key === 'Backspace' || event.key === 'Delete') {
                if ((current.value.length === 0 || current.selectionStart === 0) && currentIndex > 0) {
                    event.preventDefault(); 
                    const prevId = fields[currentIndex - 1];
                    const prev = document.getElementById(prevId);
                    if (prev) {
                        prev.focus();
                        setTimeout(() => { prev.selectionStart = prev.selectionEnd = prev.value.length; }, 0);
                    }
                }
            }
            if (current.value.length >= maxLen && event.key.length === 1 && !event.ctrlKey && !event.metaKey) {
                if (event.key !== 'Backspace' && event.key !== 'Delete') event.preventDefault();
            }
        }

        function handleTaxIdKey(event) {
            if (event.key === 'Enter') {
                event.preventDefault();
                getCompanyInfo();
            }
            updateQueryButtonState();
        }

        function showMsg(msg) {
            const el = document.getElementById('status-bar'); el.innerText = msg; el.style.display = 'block'; setTimeout(() => { el.style.display = 'none'; }, 4000);
        }

        function showModal(title, message, style = 'error') { 
            const modal = document.getElementById('error-modal');
            const content = document.getElementById('error-details');
            const header = document.getElementById('modal-header-title');
            const icon = document.getElementById('modal-header-icon');
            header.classList.remove('text-red-600', 'text-yellow-600', 'text-blue-600', 'text-gray-600');
            let iconClass = 'fa-solid ';
            if (style === 'error') { header.classList.add('text-red-600'); iconClass += 'fa-circle-exclamation'; }
            else if (style === 'info') { header.classList.add('text-blue-600'); iconClass += 'fa-circle-info'; }
            else if (style === 'warning') { header.classList.add('text-yellow-600'); iconClass += 'fa-triangle-exclamation'; }
            else { header.classList.add('text-gray-600'); iconClass += 'fa-circle-info'; }
            if (icon) icon.className = iconClass;
            if (header) header.innerHTML = `<i class="${iconClass}"></i> ${title}`;
            content.textContent = message; modal.style.display = 'flex';
        }

        function showConfirm(title, message, onConfirm) {
            const modal = document.getElementById('confirm-modal');
            const content = document.getElementById('confirm-details');
            content.textContent = message;
            modal.style.display = 'flex';
            
            const okBtn = document.getElementById('confirm-ok');
            const cancelBtn = document.getElementById('confirm-cancel');
            
            const newOk = okBtn.cloneNode(true);
            const newCancel = cancelBtn.cloneNode(true);
            okBtn.parentNode.replaceChild(newOk, okBtn);
            cancelBtn.parentNode.replaceChild(newCancel, cancelBtn);
            
            newOk.addEventListener('click', () => {
                modal.style.display = 'none';
                if (typeof onConfirm === 'function') onConfirm();
            });
            newCancel.addEventListener('click', () => { modal.style.display = 'none'; });
        }
        
        function showConfirmAsync(title, message) {
            return new Promise((resolve) => {
                const modal = document.getElementById('confirm-modal');
                const content = document.getElementById('confirm-details');
                content.textContent = message;
                modal.style.display = 'flex';
                
                const okBtn = document.getElementById('confirm-ok');
                const cancelBtn = document.getElementById('confirm-cancel');
                
                const newOk = okBtn.cloneNode(true);
                const newCancel = cancelBtn.cloneNode(true);
                okBtn.parentNode.replaceChild(newOk, okBtn);
                cancelBtn.parentNode.replaceChild(newCancel, cancelBtn);
                
                newOk.addEventListener('click', () => {
                    modal.style.display = 'none';
                    resolve(true);
                });
                newCancel.addEventListener('click', () => {
                    modal.style.display = 'none';
                    resolve(false);
                });
            });
        }

        function showError(title, details) { showModal(title, details, 'error'); }
        function showQueryInfo(message) { showModal('提示', message, 'warning'); }
        
        function isStudentDataComplete(student) {
            if (!student.name.trim() || !student.id.trim() || !student.dept.trim() || !student.raw_grade.trim()) {
                return false;
            }
            return true;
        }

        function isStudentProposalComplete(student) {
            if (!student.selectedCourses || student.selectedCourses.length === 0) return false;
            if (!student.teacher_name.trim()) return false;
            if (!student.intern_type_select.trim()) return false;
            if (!student.teacher_contact.trim()) return false; 
            return true;
        }

        function collectStudentDataFromPage2() {
            const sCount = Number(document.getElementById('student_count').value) || 1;
            const tempStudentData = [];
            for (let i = 0; i < sCount; i++) {
                const existingState = studentDataState.find(s => s.index === i) || {};
                const gradeInput = document.getElementById(`s_grade_${i}`)?.value || "";
                const gradeText = gradeInput.trim() ? `${['一','二','三','四','五'][parseInt(gradeInput) - 1]}年級` : "";

                tempStudentData.push({
                    index: i,
                    name: document.getElementById(`s_name_${i}`)?.value || "",
                    dept: document.getElementById(`s_dept_${i}`)?.value || "",
                    grade: gradeText,
                    raw_grade: gradeInput,
                    id: document.getElementById(`s_id_${i}`)?.value.trim().substring(0, 10) || "", 
                    isSelected: existingState.isSelected === undefined ? true : existingState.isSelected,
                    selectedCourses: existingState.selectedCourses || [], 
                    teacher_name: existingState.teacher_name || "",
                    teacher_contact: existingState.teacher_contact || "",
                    industry_teacher: existingState.industry_teacher || "", 
                    industry_contact: existingState.industry_contact || "", 
                    hours_exceeded_desc: existingState.hours_exceeded_desc || "",
                    intern_type_select: existingState.intern_type_select || "",
                    isDataComplete: isStudentDataComplete({
                         name: document.getElementById(`s_name_${i}`)?.value || "",
                         id: document.getElementById(`s_id_${i}`)?.value || "",
                         dept: document.getElementById(`s_dept_${i}`)?.value || "",
                         raw_grade: gradeInput,
                    }),
                    isProposalComplete: existingState.isProposalComplete || false 
                });
            }
            studentDataState = tempStudentData;
        }

        function renderStudents() {
            const count = Number(document.getElementById('student_count').value) || 1;
            const c = document.getElementById('student_container');
            collectStudentDataFromPage2();
            while (c.children.length > count) c.removeChild(c.lastChild);
            const currentChildren = c.children.length;
            if (count > currentChildren) {
                for (let i = currentChildren; i < count; i++) {
                    const existingGrade = studentDataState[i]?.raw_grade || '';
                    const chineseGrades = ['一', '二', '三', '四', '五'];
                    const gradeOptions = [1, 2, 3, 4, 5].map((g, index) => 
                        `<option value="${g}" ${existingGrade == g ? 'selected' : ''}>${chineseGrades[index]}</option>`
                    ).join('');

                    const wrapper = document.createElement('div');
                    wrapper.className = "student-wrapper p-5 bg-gray-50 rounded-lg border border-gray-200 mb-4 relative fade-in";
                    wrapper.setAttribute('data-index', i);
                    wrapper.innerHTML = `
                        <div class="absolute -top-3 -left-2 bg-white border border-gray-200 px-3 py-1 rounded text-xs font-bold text-thuBlue shadow-sm">學生 ${i+1}</div>
                        <button type="button" onclick="deleteStudent(${i})" class="delete-student-btn" aria-label="刪除學生 ${i+1}"><i class="fa-solid fa-xmark text-sm"></i></button>
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-x-5 gap-y-4 mt-2">
                            <div><label class="block text-xs font-bold text-gray-500 uppercase mb-1">姓名 <span class="text-red-500">*</span></label><input type="text" id="s_name_${i}" class="input-field" oninput="collectStudentDataFromPage2()" value="${studentDataState[i]?.name || ''}"></div>
                            <div><label class="block text-xs font-bold text-gray-500 uppercase mb-1">學號 <span class="text-red-500">*</span></label><input type="text" id="s_id_${i}" class="input-field" placeholder="S118100000" maxlength="10" oninput="collectStudentDataFromPage2()" value="${studentDataState[i]?.id || ''}"></div>
                            <div><label class="block text-xs font-bold text-gray-500 uppercase mb-1">系所 <span class="text-red-500">*</span></label><input type="text" id="s_dept_${i}" class="input-field" placeholder="例：法律系" oninput="collectStudentDataFromPage2()" value="${studentDataState[i]?.dept || ''}"></div>
                            <div>
                                <label class="block text-xs font-bold text-gray-500 uppercase mb-1">年級 <span class="text-red-500">*</span></label>
                                <div class="grade-input-group w-full">
                                    <select id="s_grade_${i}" class="grade-input-field text-center py-0" onchange="collectStudentDataFromPage2()">
                                        <option value="" disabled ${!existingGrade ? 'selected' : ''}>請選擇</option>
                                        ${gradeOptions}
                                    </select>
                                    <span class="grade-suffix">年級</span>
                                </div>
                            </div>
                        </div>`;
                    c.appendChild(wrapper);
                }
            } 
            const currentWrappers = c.querySelectorAll('.student-wrapper');
            currentWrappers.forEach((wrapper, index) => {
                const existingGrade = studentDataState[index]?.raw_grade || '';
                const gradeSelect = wrapper.querySelector(`#s_grade_${index}`);
                if (gradeSelect) gradeSelect.value = existingGrade;

                wrapper.setAttribute('data-index', index);
                wrapper.querySelector('.absolute').innerHTML = `學生 ${index + 1}`;
                wrapper.querySelector('.delete-student-btn').setAttribute('onclick', `deleteStudent(${index})`);
                document.getElementById(`s_name_${index}`).value = studentDataState[index]?.name || '';
                document.getElementById(`s_id_${index}`).value = studentDataState[index]?.id || '';
                document.getElementById(`s_dept_${index}`).value = studentDataState[index]?.dept || '';
            });
            collectStudentDataFromPage2();
        }

        function changeStudentCount(delta) {
            const input = document.getElementById('student_count'); let val = parseInt(input.value) || 1; val += delta; if (val < 1) val = 1; input.value = val; document.getElementById('student_count_display').innerText = val + " 人";
            renderStudents(); renderProposalList();
        }
        
        function deleteStudent(indexToDelete) {
            let currentCount = Number(document.getElementById('student_count').value);
            if (currentCount <= 1) { showModal("無法刪除", "至少需要保留一位學生。", 'warning'); return; }
            studentDataState.splice(indexToDelete, 1); currentCount -= 1;
            document.getElementById('student_count').value = currentCount; document.getElementById('student_count_display').innerText = currentCount + " 人";
            renderStudents(); renderProposalList();
        }

        function downloadExcelTemplate() {
            const data = [['姓名', '學號', '系所', '年級'], ['王小明', 'S118100000', '法律系', '一'], ['陳小華', 'S118100100', '社會系', '三']]; 
            const ws = XLSX.utils.aoa_to_sheet(data); const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "學生名單"); XLSX.writeFile(wb, "學生名單範本.xlsx");
        }

        function downloadCourseExcelTemplate() {
            try {
                const courseTemplateHeader = ['課程學年', '課程學期', '課程名稱', '學分'];
                const courseTemplateRow = ['113', '1', '企業實習(一)', '3'];
                
                const data = [courseTemplateHeader, courseTemplateRow];
                const ws = XLSX.utils.aoa_to_sheet(data); 
                const wb = XLSX.utils.book_new(); 
                XLSX.utils.book_append_sheet(wb, ws, "課程名單"); 
                XLSX.writeFile(wb, "課程名單範本.xlsx");
            } catch (e) {
                showError("下載失敗", "無法建立範本檔案，請確認頁面已完全載入。\n" + e.message);
            }
        }

        function downloadProposalExcelTemplate() {
             try {
                 const header = ['姓名', '學號', '實習類別', '超時說明', '校方老師姓名', '校方老師聯絡方式', '業界老師姓名', '業界老師聯絡方式'];
                 for(let i=1; i<=maxCourses; i++) {
                     header.push(`課程${i}_學年`, `課程${i}_學期`, `課程${i}_名稱`, `課程${i}_學分`);
                 }
                 const row = ['王小明', 'S118100000', '學期實習', '無', '李大同', '0912345678', '陳經理', '04-23590121', '113', '1', '企業實習(一)', '3', '', '', '', ''];
                 
                 const ws = XLSX.utils.aoa_to_sheet([header, row]); 
                 const wb = XLSX.utils.book_new(); 
                 XLSX.utils.book_append_sheet(wb, ws, "學生計畫書設定"); 
                 XLSX.writeFile(wb, "學生計畫書設定範本.xlsx");
             } catch (e) {
                showError("下載失敗", "無法建立範本檔案，請確認頁面已完全載入。\n" + e.message);
            }
        }

        function handleExcelUpload(event) {
            const file = event.target.files[0]; if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result); const workbook = XLSX.read(data, {type: 'array'});
                    const worksheet = workbook.Sheets[workbook.SheetNames[0]]; const jsonData = XLSX.utils.sheet_to_json(worksheet, {header: 1});
                    if (jsonData.length > 0) jsonData.shift();
                    const validStudents = jsonData.filter(row => row.length > 0 && row[0]).map(row => ({ name: row[0] || "", id: row[1] || "", dept: row[2] || "", grade: row[3] || "" }));
                    if (validStudents.length === 0) { showError("Excel 檔案中沒有有效的學生資料。"); return; }
                    document.getElementById('student_count').value = validStudents.length; document.getElementById('student_count_display').innerText = validStudents.length + " 人";
                    renderStudents();
                    
                    const chineseGradeMap = { '一': 1, '二': 2, '三': 3, '四': 4, '五': 5, 1: 1, 2: 2, 3: 3, 4: 4, 5: 5 }; 

                    validStudents.forEach((s, i) => {
                        document.getElementById(`s_name_${i}`).value = s.name; 
                        document.getElementById(`s_id_${i}`).value = s.id ? String(s.id).trim().substring(0, 10) : ''; 
                        document.getElementById(`s_dept_${i}`).value = s.dept; 
                        
                        let gradeValue = s.grade.toString().trim();
                        let gradeNum = 0;
                        if (chineseGradeMap[gradeValue]) {
                            gradeNum = chineseGradeMap[gradeValue];
                        } else if (!isNaN(parseInt(gradeValue))) {
                            gradeNum = parseInt(gradeValue);
                        }
                        document.getElementById(`s_grade_${i}`).value = gradeNum >= 1 && gradeNum <= 5 ? gradeNum : '';
                    });
                    collectStudentDataFromPage2(); renderProposalList(); showMsg(`成功匯入 ${validStudents.length} 筆學生資料！`); event.target.value = '';
                } catch (error) { showError("Excel 解析失敗，請確認格式是否正確。\n" + error.message); }
            };
            reader.readAsArrayBuffer(file);
        }
        
        function togglePayInputs() { 
            try { 
                const box = document.getElementById('learn_amt_box'); 
                const sel = document.querySelector('input[name="pay_opt_learn"]:checked'); 
                const v = sel ? sel.value : 'none';
                const payDetails = document.getElementById('learn_pay_details');
                
                if (v === 'none') {
                     payDetails.classList.add('hidden');
                } else {
                     payDetails.classList.remove('hidden');
                     const subOpt = document.querySelector('input[name="pay_method_learn"]:checked')?.value;
                     const amtLabel = document.getElementById('learn_amt_label');
                     if (subOpt === 'monthly') {
                         amtLabel.innerText = '給付金額 (每月給付)';
                     } else {
                         amtLabel.innerText = '給付金額 (一次性給付)';
                     }
                }
            } catch (e) { console.warn(e); }
        }

        function toggleWorkWageType() {
            const wageType = document.querySelector('input[name="wage_type_work"]:checked')?.value;
            const label = document.getElementById('work_amt_label');
            const input = document.getElementById('work_amount');
            const notice = document.getElementById('work_legal_notice');
            
            notice.innerHTML = `
                <div class="font-bold text-orange-600 mb-2 flex items-center gap-1 text-sm"><i class="fa-solid fa-scale-balanced"></i> 勞動部基本工資調整公告</div>
                <ul class="list-disc list-inside space-y-1.5">
                    <li><span class="font-bold text-gray-800">115年1月1日起：</span>每月最低工資調整為 <span class="text-red-600 font-bold">29,500</span> 元，每小時最低工資調整為 <span class="text-red-600 font-bold">196</span> 元。</li>
                    <li><span class="font-bold text-gray-800">114年1月1日起：</span>每月最低工資調整為 <span class="text-red-600 font-bold">28,590</span> 元，每小時最低工資調整為 <span class="text-red-600 font-bold">190</span> 元。</li>
                </ul>
            `;

            if (wageType === 'hourly') {
                label.innerText = '薪資金額 (時薪)';
                input.placeholder = '190';
            } else {
                label.innerText = '薪資金額 (月薪)';
                input.placeholder = '28,590';
            }
        }

        function toggleType() {
            const tEl = document.querySelector('input[name="contract_type"]:checked'); const t = tEl ? tEl.value : null;
            const panelInit = document.getElementById('panel_initial'); const panelLearn = document.getElementById('panel_learn'); const panelWork = document.getElementById('panel_work');
            if (t === 'learn') { 
                panelInit.classList.add('hidden'); 
                panelLearn.classList.remove('hidden'); 
                panelWork.classList.add('hidden'); 
                document.querySelector('input[name="pay_opt_learn"][value="none"]').checked = true;
            }
            else if (t === 'work') { 
                panelInit.classList.add('hidden'); 
                panelLearn.classList.add('hidden'); 
                panelWork.classList.remove('hidden'); 
                toggleWorkWageType(); 
            }
            else { 
                panelInit.classList.remove('hidden'); 
                panelLearn.classList.add('hidden'); 
                panelWork.classList.add('hidden'); 
            }
            togglePayInputs();
        }
        
        function toggleCost(prefix) { 
            try { 
                const optEl = document.getElementById(prefix + '_opt'); 
                const wrapperEl = document.getElementById(prefix + '_cost_wrapper'); 
                const unitSuffixEl = wrapperEl.querySelector('.cost-unit-suffix');
                const v = optEl ? optEl.value : 'none'; 
                
                if (unitSuffixEl) {
                    if (prefix === 'dorm') unitSuffixEl.textContent = '/月';
                    else if (prefix === 'food') unitSuffixEl.textContent = '/餐';
                    else if (prefix === 'trans') {
                        unitSuffixEl.textContent = (v === 'subsidy' || v === 'paid') ? '/月' : '';
                    }
                }
                
                if (v === 'paid' || v === 'subsidy') {
                    wrapperEl.classList.remove('hidden');
                    const hint = document.getElementById('trans_hint');
                    if (prefix === 'trans' && hint) {
                         if (v === 'paid') hint.innerText = '請輸入學生需負擔費用';
                         if (v === 'subsidy') hint.innerText = '請輸入公司補助金額';
                    }
                }
                else wrapperEl.classList.add('hidden'); 
            } catch (e) { console.warn(e); }
        }

        function toggleBranchFields() {
            const isHeadOffice = document.getElementById('is_head_office').checked;
            const wrapper = document.getElementById('branch_fields_wrapper'); const branchName = document.getElementById('branch_name'); const branchAddr = document.getElementById('branch_addr');
            if (isHeadOffice) { wrapper.classList.add('opacity-50', 'pointer-events-none'); branchName.disabled = true; branchAddr.disabled = true; branchName.value = ''; branchAddr.value = ''; branchName.classList.remove('input-error'); branchAddr.classList.remove('input-error'); }
            else { wrapper.classList.remove('opacity-50', 'pointer-events-none'); branchName.disabled = false; branchAddr.disabled = false; }
        }

        function toggleTaxIdFields() {
            const noTaxIdChecked = document.getElementById('no_tax_id').checked;
            const taxIdInput = document.getElementById('company_tax_id'); const queryBtn = document.getElementById('queryBtn'); const inputGroup = document.getElementById('tax_id_input_group');
            if (noTaxIdChecked) { 
                inputGroup.classList.add('opacity-50', 'pointer-events-none'); 
                taxIdInput.disabled = true; 
                queryBtn.disabled = true; 
                taxIdInput.value = ''; 
                taxIdInput.classList.remove('input-error');
            }
            else { 
                inputGroup.classList.remove('opacity-50', 'pointer-events-none'); 
                taxIdInput.disabled = false; 
                updateQueryButtonState(); 
            }
        }

        // --- 恢復統編查詢功能 ---
        function updateQueryButtonState() {
            const taxIdInput = document.getElementById('company_tax_id'); 
            const queryBtn = document.getElementById('queryBtn'); 
            const noTaxIdChecked = document.getElementById('no_tax_id').checked;
            if (noTaxIdChecked) { 
                queryBtn.disabled = true; 
                queryBtn.classList.add('opacity-50', 'cursor-not-allowed'); 
                return; 
            }
            const taxId = taxIdInput.value.trim(); 
            const isTaxId = /^\d{8}$/.test(taxId);
            if (isTaxId) { 
                queryBtn.disabled = false; 
                queryBtn.classList.remove('opacity-50', 'cursor-not-allowed'); 
            } else { 
                queryBtn.disabled = true; 
                queryBtn.classList.add('opacity-50', 'cursor-not-allowed'); 
            }
        }

        async function getCompanyInfo() {
            const taxIdInput = document.getElementById('company_tax_id');
            const taxId = taxIdInput.value.trim();
            // 使用 CORS Proxy 解決前端跨域問題 (恢復舊版功能)
            const originalApiURL = `https://data.gcis.nat.gov.tw/od/data/api/5F64D864-61CB-4D0D-8AD9-492047CC1EA6?$format=json&$filter=Business_Accounting_NO eq ${taxId}&$skip=0&$top=1`;
            const apiURL = `https://corsproxy.io/?${encodeURIComponent(originalApiURL)}`;
            
            const queryBtn = document.getElementById('queryBtn');
            const originalQueryBtnHtml = queryBtn.innerHTML;

            try {
                queryBtn.disabled = true; queryBtn.classList.add('btn-query-loading');
                queryBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> 查詢中...';
                let response; const maxRetries = 3; const timeoutDuration = 10000;
                
                for (let i = 0; i < maxRetries; i++) {
                    try {
                        const controller = new AbortController();
                        const timeoutId = setTimeout(() => controller.abort(), timeoutDuration);
                        response = await fetch(apiURL, { signal: controller.signal });
                        clearTimeout(timeoutId);
                        if (response.ok) break; 
                    } catch (error) { if (i === maxRetries - 1) throw new Error("API_NETWORK_ERROR"); await new Promise(resolve => setTimeout(resolve, Math.pow(2, i) * 1000)); }
                }

                if (!response || !response.ok) throw new Error("API_REQUEST_FAILED");
                const data = await response.json();
                if (!data || data.length === 0) throw new Error("NO_DATA_FOUND");

                const company = data[0];
                document.getElementById('company_name').value = company.Company_Name || "";
                document.getElementById('company_rep').value = company.Responsible_Name || "";
                document.getElementById('reg_address').value = company.Company_Location || "";
                // 清空分公司欄位
                document.getElementById('branch_name').value = ""; 
                document.getElementById('branch_addr').value = "";
                
                document.getElementById('no_tax_id').checked = false; 
                toggleTaxIdFields(); 
                showMsg(`「 ${company.Company_Name} 」公司資料已自動填入。`);

            } catch (e) {
                console.error(e);
                showQueryInfo("查無資料或連線逾時，請手動填入相關欄位。"); 
            } finally {
                queryBtn.classList.remove('btn-query-loading'); 
                queryBtn.innerHTML = originalQueryBtnHtml; 
                updateQueryButtonState();
            }
        }

        // --- Data Collection Logic (統一資料收集函數) ---
        function getContractRenderData() {
             const data = {};
             
             // 1. 基本公司與日期資料
             data.company_name = (document.getElementById('company_name')?.value || "未填寫");
             data.company_rep = (document.getElementById('company_rep')?.value || "");
             data.company_title = (document.getElementById('company_title')?.value || "");
             const regAddr = document.getElementById('reg_address')?.value || "";
             data.company_address = regAddr;
             const noTaxIdChecked = document.getElementById('no_tax_id').checked;
             data.company_tax_id = noTaxIdChecked ? "實習機構未申請設立字號" : (document.getElementById('company_tax_id')?.value || "").trim();
             
             const isHeadOffice = document.getElementById('is_head_office').checked;
             const bname = isHeadOffice ? "" : document.getElementById('branch_name')?.value || "";
             const baddr = isHeadOffice ? "" : document.getElementById('branch_addr')?.value || "";
             data.intern_location = (bname && baddr) ? `${bname}（${baddr}）` : (baddr || regAddr);

             data.s_y = ' ' + (document.getElementById('start_y')?.value || "　") + ' '; 
             data.s_m = ' ' + (document.getElementById('start_m')?.value || "　") + ' '; 
             data.s_d = ' ' + (document.getElementById('start_d')?.value || "　") + ' ';
             data.e_y = ' ' + (document.getElementById('end_y')?.value || "　") + ' '; 
             data.e_m = ' ' + (document.getElementById('end_m')?.value || "　") + ' '; 
             data.e_d = ' ' + (document.getElementById('end_d')?.value || "　") + ' ';

             // 2. 實習時間
             const daily_start = document.getElementById('daily_start')?.value;
             const daily_end = document.getElementById('daily_end')?.value;
             const daily_hours = document.getElementById('daily_hours')?.value;
             const type = document.querySelector('input[name="contract_type"]:checked')?.value;
             
             // 初始化 Checkbox 預設值
             data.type_learn_check='□'; data.type_work_check='□';
             
             if (type === 'learn') {
                 data.type_learn_check = '■';
                 data.learn_start_time = formatTime(daily_start);
                 data.learn_end_time = formatTime(daily_end);
                 data.learn_daily_hours = formatTime(daily_hours, true);
                 data.work_start_time = formatTime(null);
                 data.work_end_time = formatTime(null);
                 data.work_daily_hours = formatTime(null, true);
             } else if (type === 'work') {
                 data.type_work_check = '■';
                 data.work_start_time = formatTime(daily_start);
                 data.work_end_time = formatTime(daily_end);
                 data.work_daily_hours = formatTime(daily_hours, true);
                 data.learn_start_time = formatTime(null);
                 data.learn_end_time = formatTime(null);
                 data.learn_daily_hours = formatTime(null, true);
             }
             
             // 3. 實習待遇
             data.chk_pay_none='□'; data.chk_pay_scholar='□'; data.chk_pay_allowance='□'; 
             data.chk_pay_total='□'; data.chk_pay_monthly='□';
             data.pay_total_amount = fullWidthSpaceFive; 
             data.pay_monthly_amount = fullWidthSpaceFive;
             data.pay_amount_final = fullWidthSpaceFive;

             data.chk_wage_monthly='□'; data.chk_wage_hourly='□';
             data.wage_monthly_amount = fullWidthSpaceFive; 
             data.wage_hourly_amount = fullWidthSpaceFive; 
             data.wage_amount_final = fullWidthSpaceFive; 

             const lam = document.getElementById('learn_amount')?.value || 0;
             const wam = document.getElementById('work_amount')?.value || 0;

             if (type === 'learn') {
                 const pOpt = document.querySelector('input[name="pay_opt_learn"]:checked')?.value;
                 const payMethod = document.querySelector('input[name="pay_method_learn"]:checked')?.value;
                 const formattedLam = formatAmount(lam);

                 if (pOpt === 'none') {
                     data.chk_pay_none = '■';
                 } else {
                     if (pOpt === 'scholar') data.chk_pay_scholar = '■'; else data.chk_pay_allowance = '■';
                     
                     if (payMethod === 'monthly') {
                          data.chk_pay_monthly = '■';
                          data.pay_amount_final = formattedLam; 
                     } else {
                          data.chk_pay_total = '■';
                          data.pay_total_amount = formattedLam; // 舊版範本相容
                          data.pay_amount_final = formattedLam; // 新版邏輯
                     }
                 }
             } else if (type === 'work') {
                 const formattedWam = formatAmount(wam);
                 const wageType = document.querySelector('input[name="wage_type_work"]:checked')?.value;
                 
                 if (wageType === 'monthly') {
                     data.chk_wage_monthly = '■';
                     data.wage_amount_final = formattedWam;
                 } else {
                     data.chk_wage_hourly = '■';
                     data.wage_amount_final = formattedWam;
                 }
             }

             // 4. 福利
             function setWelfare(prefix) {
                 const opt = document.getElementById(prefix + '_opt')?.value || 'none';
                 const costInput = document.getElementById(prefix + '_cost')?.value;
                 const costVal = costInput ? Number(costInput.replace(/,/g, '')) : 0; 
                 
                 data[`chk_${prefix}_none`] = '□'; data[`chk_${prefix}_free`] = '□'; data[`chk_${prefix}_paid`] = '□';
                 data[`${prefix}_desc`] = fullWidthSpaceFive; 
                 
                 data.chk_trans_subsidy = '□';
                 data.trans_paid_desc = fullWidthSpaceFive;
                 data.trans_subsidy_desc = fullWidthSpaceFive;
                 
                 if (opt === 'none') data[`chk_${prefix}_none`] = '■'; 
                 else if (opt === 'free') { data[`chk_${prefix}_free`] = '■'; }
                 else if (prefix === 'trans' && opt === 'subsidy') {
                      data.chk_trans_subsidy = '■'; 
                      if (costVal > 0) data.trans_subsidy_desc = ` ${costVal.toLocaleString()} `;
                 } 
                 else if (opt === 'paid') { 
                     data[`chk_${prefix}_paid`] = '■'; 
                     if (costVal > 0) {
                          if (prefix === 'trans') { data.trans_paid_desc = ` ${costVal.toLocaleString()} `; }
                          else { data[`${prefix}_desc`] = ` ${costVal.toLocaleString()} `; }
                     }
                 }
             }
             setWelfare('dorm'); setWelfare('food'); setWelfare('trans');
             
             return data;
        }
        
        function getProposalRenderData(student) {
             // 取得基本合約資料 (與合約共用)
             const baseData = getContractRenderData(); 
             
             // 覆蓋/增加個別學生資料
             const courseData = getStudentCourseData(student);
             
             // 與 template_plan.docx 的標籤對應
             return {
                 ...baseData, // 包含公司名稱、地址、實習日期等
                 plan_intern_location: baseData.intern_location, // 計畫書的標籤名稱可能不同
                 s_y: document.getElementById('start_y').value,
                 s_m: document.getElementById('start_m').value,
                 s_d: document.getElementById('start_d').value,
                 e_y: document.getElementById('end_y').value,
                 e_m: document.getElementById('end_m').value,
                 e_d: document.getElementById('end_d').value,
                 
                 student_name: student.name, 
                 id: student.id, 
                 dept: student.dept, 
                 grade: student.grade,
                 
                 teacher_name: student.teacher_name, 
                 teacher_contact: student.teacher_contact, 
                 
                 // 修正: 計畫書使用的是 industry_teacher_name 而非 industry_teacher
                 industry_teacher_name: student.industry_teacher, 
                 industry_teacher_contact: student.industry_contact,
                 
                 course_name: courseData.name, 
                 semester: courseData.semester, 
                 credits: courseData.credits, 
                 
                 hours_exceeded_desc: student.hours_exceeded_desc,
                 
                 intern_type_full: student.intern_type_select === 'full' ? '■' : '□', 
                 intern_type_sem: student.intern_type_select === 'sem' ? '■' : '□', 
                 intern_type_winter: student.intern_type_select === 'winter' ? '■' : '□', 
                 intern_type_summer: student.intern_type_select === 'summer' ? '■' : '□', 
                 intern_type_term: student.intern_type_select === 'term' ? '■' : '□',
                 
                 // 確保 students 陣列存在 (雖然計畫書通常是單人的，但若範本使用 Loop 則需要)
                 students: [{...student}]
             };
        }

        function validateForm(isProposal = false) {
            let isValid = true; 
            let errorMsg = "";
            let studentErrors = []; 

            document.querySelectorAll('.bg-red-50').forEach(el => el.classList.remove('bg-red-50', 'border-red-200')); 
            document.querySelectorAll('.input-error').forEach(el => el.classList.remove('input-error')); 
            document.querySelectorAll('.text-red-500.font-bold.text-xs').forEach(el => el.textContent = '');
            
            // --- Page 2 學生資料驗證 ---
            collectStudentDataFromPage2(); // 確保數據最新
            const students = studentDataState; 
            
            students.forEach((s, i) => {
                const prefix = `s_`;
                const requiredFields = [];
                const fields = [
                    { id: `${prefix}name_${i}`, name: '姓名' }, 
                    { id: `${prefix}id_${i}`, name: '學號' }, 
                    { id: `${prefix}dept_${i}`, name: '系所' }, 
                    { id: `${prefix}grade_${i}`, name: '年級' }
                ];
                
                fields.forEach(field => {
                    const el = document.getElementById(field.id);
                    let value = el ? el.value.trim() : '';
                    if (!value) {
                        el?.classList.add('input-error');
                        isValid = false;
                        requiredFields.push(field.name);
                    }
                });

                if (requiredFields.length > 0) {
                    studentErrors.push(`• 學生 ${i + 1} (${s.name || '未命名'}): 缺少 ${requiredFields.join('、')}`);
                }
            });
            
            if (studentErrors.length > 0) {
                errorMsg += `[Page 2 學生資料]\n`;
                errorMsg += studentErrors.join('\n') + '\n\n';
            }

            // --- Page 3 合約資料驗證 (如果是下載合約) ---
            if (!isProposal) {
                let contractErrors = [];
                const requiredFields = [
                    { id: 'company_name', name: '機構全銜' }, 
                    { id: 'company_rep', name: '代表人姓名' }, 
                    { id: 'company_title', name: '代表人職稱' }, 
                    { id: 'reg_address', name: '公司登記地址' }
                ];
                
                const taxIdInput = document.getElementById('company_tax_id');
                const taxId = taxIdInput?.value.trim();
                const noTaxIdChecked = document.getElementById('no_tax_id').checked;
                if (!noTaxIdChecked && !taxId) {
                     taxIdInput?.classList.add('input-error');
                     isValid = false;
                     contractErrors.push(`機構: 請填寫 統一編號 或 勾選「未申請設立字號」`);
                }

                requiredFields.forEach(field => { 
                    const el = document.getElementById(field.id); 
                    if (!el || !el.value.trim()) { 
                        el.classList.add('input-error'); 
                        isValid = false; 
                        contractErrors.push(`機構: 請填寫 ${field.name}`); 
                    } 
                });
                
                if (!document.getElementById('is_head_office').checked) { 
                    const branchFields = [{ id: 'branch_name', name: '實習單位/分公司名稱' }, { id: 'branch_addr', name: '實際實習地址' }]; 
                    branchFields.forEach(field => { 
                        const el = document.getElementById(field.id); 
                        if (!el || !el.value.trim()) { 
                            el.classList.add('input-error'); 
                            isValid = false; 
                            contractErrors.push(`地點: 請填寫 ${field.name}`); 
                        } 
                    }); 
                }
                
                const dateFields = ['start_y', 'start_m', 'start_d', 'end_y', 'end_m', 'end_d']; 
                let dateError = false;
                dateFields.forEach(id => { 
                    const el = document.getElementById(id); 
                    if (!el || !el.value.trim()) { el.classList.add('input-error'); isValid = false; dateError = true; } 
                });
                if (dateError) { contractErrors.push(`期間: 請填寫完整的實習期間`); }
                
                const timeFields = ['daily_start', 'daily_end'];
                const timeRegex = /^(?:[01]\d|2[0-3]):[0-5]\d$/;
                let timeError = false;
                timeFields.forEach(id => {
                    const el = document.getElementById(id);
                    if (!el || !timeRegex.test(el.value.trim())) {
                        el?.parentElement.classList.add('input-error'); 
                        isValid = false; 
                        timeError = true;
                    }
                });
                if (timeError) { contractErrors.push(`時間: 請輸入正確的每日實習時間 (HH:mm 24時制)`); }

                const contractType = document.querySelector('input[name="contract_type"]:checked');
                if (!contractType) { 
                    document.getElementById('type-section').classList.add('bg-red-50', 'border-red-200'); 
                    isValid = false; 
                    contractErrors.push("類型: 請選擇實習類型"); 
                } else {
                    if (contractType.value === 'learn') { 
                        const payOpt = document.querySelector('input[name="pay_opt_learn"]:checked'); 
                        if (!payOpt) { 
                            document.getElementById('pay-section').classList.add('bg-red-50', 'border-red-200'); 
                            isValid = false; 
                            contractErrors.push("待遇: 請選擇學習型給付項目"); 
                        } 
                    }
                    const isPayRequired = (contractType.value === 'work') || (contractType.value === 'learn' && document.querySelector('input[name="pay_opt_learn"]:checked')?.value !== 'none');
                    if (isPayRequired) {
                         const targetId = contractType.value === 'work' ? 'work_amount' : 'learn_amount';
                         const amt = document.getElementById(targetId);
                         const cleanValue = amt?.value ? Number(amt.value.replace(/,/g, '')) : 0;
                         if (!amt || !cleanValue || cleanValue <= 0) { 
                             document.getElementById(targetId)?.classList.add('input-error'); 
                             isValid = false; 
                             contractErrors.push("待遇: 請輸入實習待遇金額 (須大於 0)"); 
                         }
                    }
                }
                
                ['dorm', 'food', 'trans'].forEach(p => { 
                    const selectEl = document.getElementById(p + '_opt'); 
                    const val = selectEl?.value; 
                    if (!val) { 
                        document.getElementById('welfare-section').classList.add('bg-red-50', 'border-red-200'); 
                        selectEl.classList.add('input-error');
                        isValid = false; 
                        contractErrors.push(`福利: 請選擇${p==='dorm'?'住宿':p==='food'?'膳食':'交通'}福利`); 
                    }
                });

                if (contractErrors.length > 0) {
                    errorMsg += `[Page 3 實習合約內容]\n` + contractErrors.map(e => `• ${e}`).join('\n') + '\n\n';
                }
            }

            // --- Page 4 計畫書驗證 (如果是下載計畫書，或者驗證單一學生) ---
            // 這裡需要區分是「個別下載」還是「打包下載」
            // 但為了簡化，我們檢查所有「已選取」或「傳入的特定學生」
            
            // 注意：downloadIndividualProposal 會自己再檢查一次特定學生
            // 這裡的 validateForm 主要服務於 "打包下載" 和 "生成合約" 的全域檢查
            
            if (isProposal) {
                let proposalErrors = [];
                // 檢查所有勾選的學生
                const selectedStudents = students.filter(s => s.isSelected);
                
                selectedStudents.forEach((s) => {
                    let currentStudentErrors = [];
                    const index = s.index;
                    const studentName = s.name || `學生 ${index+1}`;

                    if (!s.selectedCourses || s.selectedCourses.length === 0) currentStudentErrors.push('課程選擇');
                    if (!s.teacher_name) currentStudentErrors.push('校方老師姓名');
                    if (!s.teacher_contact) currentStudentErrors.push('校方老師聯絡方式');
                    if (!s.intern_type_select) currentStudentErrors.push('實習類別');
                    
                    if(currentStudentErrors.length > 0) {
                        isValid = false;
                        proposalErrors.push(`• ${studentName} (${s.id}): 缺少 ${currentStudentErrors.join('、')}`);
                    }
                });
                
                if (proposalErrors.length > 0) {
                     errorMsg += `[Page 4 實習計畫書 - 已選學生]\n` + proposalErrors.join('\n');
                }
            }
            
            if (!isValid) {
                 showError("資料未完整，無法產生文件", errorMsg.trim());
                 return false;
            }
            return true;
        }

        async function generateDoc() {
            const btn = document.getElementById('genContractBtn');
            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> 處理中...';

            // 呼叫驗證函數，傳入 false 表示這是合約書驗證
            if (!validateForm(false)) {
                btn.disabled = false;
                btn.innerHTML = originalText;
                return;
            }

            try {
                const templateBuf = await getTemplateBuffer('contract');
                const zip = new PizZip(templateBuf);
                // 修正: 加上 delimiters 設定，確保可以讀取 %%% 標籤
                const doc = new window.docxtemplater(zip, { paragraphLoop: true, linebreaks: true, delimiters: { start: '%%%', end: '%%%' } });

                // 收集資料
                const data = getContractRenderData();
                const sList = studentDataState.filter(s => s.name.trim());
                
                // 1. 處理學生名稱與計數 (等X人)
                data.s1_name = sList[0]?.name || "";
                if (sList.length > 1) {
                    data.student_name_count = `${sList[0].name}　等${sList.length}人`; // 全形空格
                } else {
                    data.student_name_count = data.s1_name || "______________________"; 
                }
                
                // 學生列表
                const alphabet = ['A', 'B', 'C', 'D', 'E', 'F', 'G', 'H', 'I', 'J', 'K', 'L', 'M', 'N', 'O', 'P', 'Q', 'R', 'S', 'T', 'U', 'V', 'W', 'X', 'Y', 'Z'];
                data.students = sList.map((s, index) => {
                    const courseData = getStudentCourseData(s);
                    return {
                        letter: alphabet[index] || (index + 1), name: s.name, dept: s.dept, grade: s.grade, raw_grade: s.raw_grade, id: s.id,
                        teacher_name: s.teacher_name || "", teacher_contact: s.teacher_contact, 
                        industry_teacher: s.industry_teacher, industry_contact: s.industry_contact, 
                        course_name: courseData.name, semester: courseData.semester, credits: courseData.credits, 
                        hours_exceeded_desc: s.hours_exceeded_desc,
                        intern_type_full: s.intern_type_select === 'full' ? '■' : '□', intern_type_sem: s.intern_type_select === 'sem' ? '■' : '□', intern_type_winter: s.intern_type_select === 'winter' ? '■' : '□', intern_type_summer: s.intern_type_select === 'summer' ? '■' : '□', intern_type_term: s.intern_type_select === 'term' ? '■' : '□',
                    };
                });

                // 處理單一學生簽章修正
                let xmlContent = zip.file("word/document.xml").asText();
                if (sList.length === 1) {
                    const targetRegex = /甲方%%%letter%%%學生：,\(%%%name%%%\)簽章/g;
                    const replacement = '甲方學生：,(%%%name%%%)簽章';
                    xmlContent = xmlContent.replace(targetRegex, replacement);
                    zip = new PizZip(xmlContent); 
                }
                
                const docFile = zip.file("word/document.xml");
                if (docFile) zip.file("word/document.xml", cleanXML(docFile.asText()));
                
                // 重新建構 doc 因為 zip 可能被修改過，並確保 delimiters 設定存在
                const docFinal = new window.docxtemplater(zip, { paragraphLoop: true, linebreaks: true, delimiters: { start: '%%%', end: '%%%' } });
                docFinal.render(data);
                const out = docFinal.getZip().generate({ type: "blob", mimeType: "application/vnd.openxmlformats-officedocument.wordprocessingml.document" });
                saveAs(out, `東海大學實習合約_${(data.s1_name || '學生')}.docx`);
                showMsg("合約書產生成功！");

            } catch (error) {
                showError("產生失敗", error.message);
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        }
        
        // --- 修復：補上 addCourse ---
        function addCourse() {
            const y = document.getElementById('new_course_year').value.trim();
            const s = document.getElementById('new_course_sem').value;
            const n = document.getElementById('new_course_name').value.trim();
            const c = document.getElementById('new_course_credits').value.trim();

            if (!y || !s || !n || !c) {
                showModal("資料不全", "請填寫所有課程欄位。", "warning");
                return;
            }

            const newCourse = {
                id: Date.now(),
                year: y,
                semester: s,
                name: n,
                credits: parseFloat(c)
            };
            
            courseListState.push(newCourse);
            
            // 清空輸入
            document.getElementById('new_course_name').value = '';
            document.getElementById('new_course_credits').value = '';
            
            renderCourseList();
            // 修正: 改為 renderProposalList() 強制刷新DOM，解決更新慢的問題
            renderProposalList(); 
        }

        function renderCourseList() {
            const container = document.getElementById('course_list_display');
            if (courseListState.length === 0) {
                container.innerHTML = '<div class="text-center text-gray-400 text-xs py-4 border border-dashed border-gray-300 rounded">請輸入上方資料並新增</div>';
                return;
            }

            container.innerHTML = courseListState.map((c, idx) => `
                <div class="flex items-center justify-between p-2 bg-gray-50 rounded border border-gray-100 text-sm">
                    <div>
                        <span class="font-bold text-thuBlue">${c.year}-${c.semester}</span>
                        <span class="mx-1 font-bold text-gray-700">${c.name}</span>
                        <span class="text-gray-500 text-xs">(${c.credits}學分)</span>
                    </div>
                    <!-- 修正: 加入 type="button" 防止刪除課程時提交表單導致頁面刷新 -->
                    <button type="button" onclick="deleteCourse(${idx})" class="text-red-400 hover:text-red-600"><i class="fa-solid fa-trash-can"></i></button>
                </div>
            `).join('');
        }

        function deleteCourse(idx) {
            courseListState.splice(idx, 1);
            renderCourseList();
            renderProposalList(); // 這裡也改為強制刷新
        }

        // --- 恢復 toggleExpand 函式 ---
        function toggleExpand(index) {
            const body = document.getElementById(`proposal_body_${index}`);
            const chevron = document.getElementById(`chevron_${index}`);
            if (body.classList.contains('hidden')) {
                body.classList.remove('hidden'); 
                chevron.classList.add('rotate-180');
            } else {
                body.classList.add('hidden'); 
                chevron.classList.remove('rotate-180');
            }
        }

        function updateCourseSummary(index) {
            const student = studentDataState.find(s => s.index === index);
            const summaryDiv = document.getElementById(`course_summary_${index}`);
            const triggerText = document.getElementById(`dropdown_trigger_text_${index}`);
            
            if (!student || !student.selectedCourses || student.selectedCourses.length === 0) {
                if(summaryDiv) summaryDiv.innerHTML = '<span class="text-gray-400 text-xs">尚未選擇課程</span>';
                if(triggerText) triggerText.textContent = '請選擇課程...';
                return;
            }

            const selectedObjs = courseListState.filter(c => student.selectedCourses.includes(c.id));
            const totalCredits = selectedObjs.reduce((sum, c) => sum + c.credits, 0);
            
            if(triggerText) triggerText.textContent = `已選 ${selectedObjs.length} 門 (${totalCredits} 學分)`;

            if(summaryDiv) {
                summaryDiv.innerHTML = `
                    <div class="bg-gray-50 p-2 rounded border border-gray-200 text-xs">
                        <div class="space-y-1 mb-2 border-b border-gray-200 pb-1">
                            ${selectedObjs.map(c => `
                                <div class="flex justify-between">
                                    <span>${c.year}-${c.semester} ${c.name}</span>
                                    <span class="font-mono text-gray-600">${c.credits}</span>
                                </div>
                            `).join('')}
                        </div>
                        <div class="flex justify-between font-bold text-thuBlue">
                            <span>總學分</span>
                            <span>${totalCredits}</span>
                        </div>
                    </div>
                `;
            }
        }

        // --- 修復：恢復 renderProposalList 為舊版卡片樣式，並移除 Page 2 阻擋訊息 ---
        function renderProposalList(refreshDOM = true) {
            if (!refreshDOM) return;
            const container = document.getElementById('proposal_list_container');
            const listMessage = document.getElementById('proposal_list_message'); // 恢復訊息顯示
            const headerControls = document.getElementById('proposal_header_controls');
            const emptyMsg = document.getElementById('proposal_empty_msg');
            
            // 確保取得最新數據
            collectStudentDataFromPage2(); 
            
            const validStudents = studentDataState.filter(s => s.isDataComplete); // 只顯示資料完整的學生
            // 這裡移除對 incompleteDataCount 的嚴格檢查與顯示
            
            // 更新每個學生的完成狀態
            validStudents.forEach(s => {
                s.isProposalComplete = isStudentProposalComplete(s);
            });
            
            const completedProposalCount = validStudents.filter(s => s.isProposalComplete).length;
            const totalValidStudents = validStudents.length;
            
            document.getElementById('proposal_student_count').innerText = totalValidStudents;

            if (studentDataState.length === 0) {
                emptyMsg.classList.remove('hidden');
                headerControls.classList.add('hidden');
                container.innerHTML = '';
                listMessage.textContent = '';
                return;
            }
            emptyMsg.classList.add('hidden');
            headerControls.classList.remove('hidden');
            
            // 修正: 僅顯示計畫書完成狀態統計，不再顯示 Page 2 未完成警告
            if (totalValidStudents > 0) {
                if (completedProposalCount === totalValidStudents) {
                     listMessage.innerHTML = `<span class="font-bold text-green-600">(${totalValidStudents} 人皆已完成實習計畫書設定)</span>`;
                } else {
                     listMessage.innerHTML = `<span class="font-bold text-red-500">(${totalValidStudents - completedProposalCount} 人尚未完成實習計畫書設定)</span>`;
                }
            } else {
                 listMessage.innerHTML = `<span class="font-bold text-gray-500">尚無有效學生資料。</span>`;
            }
            
            // 保持展開狀態
            const expandedStates = {};
            document.querySelectorAll('[id^="proposal_body_"]').forEach((el) => {
                if (!el.classList.contains('hidden')) {
                    const index = el.id.split('_')[2];
                    expandedStates[index] = true; 
                }
            });

            container.innerHTML = validStudents.map(s => {
                // 恢復完成狀態檢查邏輯
                s.isProposalComplete = isStudentProposalComplete(s);

                // 產生課程選項 (Dropdown Items)
                let dropdownItems = '';
                if (courseListState.length > 0) {
                    dropdownItems = courseListState.map(c => `
                        <div class="course-checkbox-item" onclick="event.stopPropagation()">
                            <input type="checkbox" id="course_${s.index}_${c.id}" value="${c.id}" 
                                   ${s.selectedCourses && s.selectedCourses.includes(c.id) ? 'checked' : ''}
                                   onchange="updateSelectedCourses(${s.index}, ${c.id}, this.checked)">
                            <label for="course_${s.index}_${c.id}" class="text-sm cursor-pointer w-full ml-2">
                                <span class="font-bold text-gray-700">${c.year}-${c.semester}</span>
                                <span class="mx-1">|</span>
                                <span class="font-bold text-thuBlue">${c.name}</span>
                                <span class="mx-1">|</span>
                                <span class="text-gray-500">${c.credits}學分</span>
                            </label>
                        </div>
                    `).join('');
                } else {
                    dropdownItems = '<div class="p-3 text-xs text-gray-400 text-center">請先在左側建立課程</div>';
                }

                const isExpanded = expandedStates[s.index] === true;
                const hiddenClass = isExpanded ? '' : 'hidden';
                const chevronClass = isExpanded ? 'rotate-180' : '';
                
                // 複製按鈕文字
                const selectedCount = validStudents.filter(vs => vs.isSelected && vs.index !== s.index).length;
                const copyBtnText = selectedCount > 0 ? `複製給勾選的 ${selectedCount} 位` : `複製資料給...`;

                return `
                <div class="student-proposal-card bg-white border border-gray-200 rounded-lg overflow-hidden mb-4" id="proposal_row_${s.index}">
                    <!-- Card Header -->
                    <div class="flex items-center justify-between p-4 bg-gray-50 cursor-pointer select-none border-b border-transparent hover:bg-blue-50/30 transition-colors" onclick="toggleExpand(${s.index})">
                        <div class="flex items-center gap-4 flex-grow overflow-hidden">
                            <div class="flex items-center justify-center w-8 shrink-0" onclick="event.stopPropagation()">
                                <input type="checkbox" data-index="${s.index}" onchange="toggleStudentSelection(${s.index})" class="w-5 h-5 text-thuBlue bg-white border-gray-300 rounded focus:ring-thuBlue cursor-pointer" ${s.isSelected ? 'checked' : ''}>
                            </div>
                            <div class="flex flex-col truncate">
                                <div class="text-base font-bold text-gray-800 flex items-center gap-2">
                                    ${s.name || '<span class="text-gray-400 italic">未命名</span>'} 
                                    <span class="text-xs bg-gray-200 text-gray-600 px-2 py-0.5 rounded-full font-mono">${s.id}</span>
                                    <!-- 恢復狀態 Icon -->
                                    <i class="fa-solid fa-${s.isProposalComplete ? 'circle-check text-green-600' : 'triangle-exclamation text-yellow-600'}" title="${s.isProposalComplete ? '已完成計畫書設定' : '尚未完成計畫書設定'}"></i>
                                </div>
                                <div class="text-xs text-gray-500 truncate">${s.dept} | ${s.grade}</div>
                            </div>
                        </div>
                        
                        <div class="flex items-center gap-2 shrink-0" onclick="event.stopPropagation()">
                             <button type="button" onclick="copyPlanToSelected(${s.index})" class="hidden md:flex bg-indigo-100 text-indigo-700 px-3 py-1.5 rounded-md text-xs font-bold hover:bg-indigo-200 transition items-center gap-1 border border-indigo-200" title="將此學生的資料複製給勾選的同學">
                                <i class="fa-regular fa-copy"></i> ${copyBtnText}
                             </button>
                             <!-- 下載按鈕: 加入 type="button"，並移除 disabled，改用點擊驗證 -->
                             <button type="button" onclick="downloadIndividualProposal(${s.index})" class="bg-blue-600 text-white px-3 py-1.5 rounded-md text-xs font-bold hover:bg-blue-700 transition shadow-sm flex items-center gap-1">
                                <i class="fa-solid fa-file-word"></i> 下載個人計畫書
                             </button>
                             <div class="w-8 h-8 flex items-center justify-center text-gray-400 hover:text-thuBlue transition-colors cursor-pointer" onclick="toggleExpand(${s.index})">
                                 <i class="fa-solid fa-chevron-down transition-transform duration-300 ${chevronClass}" id="chevron_${s.index}"></i>
                             </div>
                        </div>
                    </div>

                    <!-- Card Body (Details Area) -->
                    <div id="proposal_body_${s.index}" class="${hiddenClass} border-t border-gray-100 p-6 bg-white">
                        <div class="grid grid-cols-1 gap-6">
                            
                            <!-- 課程選擇區塊 -->
                            <div>
                                <label class="block text-xs font-bold text-gray-500 mb-1">實習課程選擇 (可複選) <span class="text-red-500">*</span></label>
                                <div class="multi-select-dropdown">
                                    <div class="multi-select-trigger" onclick="toggleDropdown(${s.index})">
                                        <span id="dropdown_trigger_text_${s.index}" class="text-sm text-gray-700">請選擇課程...</span>
                                        <i class="fa-solid fa-chevron-down text-xs text-gray-400"></i>
                                    </div>
                                    <div class="multi-select-content" id="dropdown_content_${s.index}">
                                        ${dropdownItems}
                                    </div>
                                </div>
                                <div id="course_summary_${s.index}" class="mt-2"></div>
                            </div>

                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-xs font-bold text-gray-500 mb-1">實習類別 <span class="text-red-500">*</span></label>
                                    <select id="p_intern_type_select_${s.index}" class="input-field text-sm h-[42px]" onchange="updateProposalField(${s.index}, 'intern_type_select', this.value)">
                                        <option value="" disabled ${!s.intern_type_select ? 'selected' : ''}>請選擇</option>
                                        <option value="full" ${s.intern_type_select === 'full' ? 'selected' : ''}>整學年</option>
                                        <option value="sem" ${s.intern_type_select === 'sem' ? 'selected' : ''}>整學期</option>
                                        <option value="winter" ${s.intern_type_select === 'winter' ? 'selected' : ''}>寒假實習</option>
                                        <option value="summer" ${s.intern_type_select === 'summer' ? 'selected' : ''}>暑假實習</option>
                                        <option value="term" ${s.intern_type_select === 'term' ? 'selected' : ''}>學期期間實習</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-xs font-bold text-gray-500 mb-1">實習時數超時說明 (特殊情況)</label>
                                    <input type="text" id="p_hours_exceeded_desc_${s.index}" class="input-field text-sm h-[42px]" placeholder="請說明超過法定上限原因" value="${s.hours_exceeded_desc || ''}" oninput="updateProposalField(${s.index}, 'hours_exceeded_desc', this.value)">
                                </div>
                            </div>

                            <div class="bg-blue-50/60 p-4 rounded-lg border border-blue-100">
                                <h4 class="text-sm font-bold text-thuBlue mb-3 flex items-center gap-2"><span class="w-1 h-4 bg-thuBlue rounded-full"></span> 指導老師資訊</h4>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                                    <div><label class="block text-xs font-bold text-gray-500 mb-1">校方輔導老師姓名 <span class="text-red-500">*</span></label><input type="text" id="p_teacher_name_${s.index}" class="input-field text-sm" value="${s.teacher_name||''}" placeholder="姓名" oninput="updateProposalField(${s.index}, 'teacher_name', this.value)"></div>
                                    <div><label class="block text-xs font-bold text-gray-500 mb-1">校方輔導老師聯絡方式 <span class="text-red-500">*</span></label><input type="text" id="p_teacher_contact_${s.index}" class="input-field text-sm" value="${s.teacher_contact||''}" placeholder="電話或電子郵件" oninput="updateProposalField(${s.index}, 'teacher_contact', this.value)"></div>
                                    <div><label class="block text-xs font-bold text-gray-500 mb-1">業界輔導老師姓名</label><input type="text" id="p_industry_teacher_${s.index}" class="input-field text-sm" value="${s.industry_teacher||''}" placeholder="姓名 (選填)" oninput="updateProposalField(${s.index}, 'industry_teacher', this.value)"></div>
                                    <div><label class="block text-xs font-bold text-gray-500 mb-1">業界輔導老師聯絡方式</label><input type="text" id="p_industry_contact_${s.index}" class="input-field text-sm" value="${s.industry_contact||''}" placeholder="電話或電子郵件 (選填)" oninput="updateProposalField(${s.index}, 'industry_contact', this.value)"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>`;
            }).join('');

            // 渲染完畢後，觸發每個卡片的摘要更新
            validStudents.forEach(s => updateCourseSummary(s.index));
        }

        function updateProposalField(index, field, value) {
            const s = studentDataState.find(item => item.index === index);
            if (s) {
                s[field] = value;
                s.isProposalComplete = isStudentProposalComplete(s);
                renderProposalList(false); // 更新UI但不重置展開狀態
            }
        }
        
        function updateSelectedCourses(studentIndex, courseId, isChecked) {
            const student = studentDataState.find(s => s.index === studentIndex);
            if (!student) return;
            if (!student.selectedCourses) student.selectedCourses = [];
            
            if (isChecked) {
                if (!student.selectedCourses.includes(courseId)) student.selectedCourses.push(courseId);
            } else {
                student.selectedCourses = student.selectedCourses.filter(id => id !== courseId);
            }
            
            updateCourseSummary(studentIndex);
            student.isProposalComplete = isStudentProposalComplete(student);
            // 不重新渲染整個列表，避免選單關閉，只更新摘要
        }

        function toggleDropdown(index) {
            const content = document.getElementById(`dropdown_content_${index}`);
            document.querySelectorAll('.multi-select-content').forEach(el => {
                if(el !== content) el.classList.remove('open');
            });
            if (content) content.classList.toggle('open');
        }

        document.addEventListener('click', function(e) {
            if (!e.target.closest('.multi-select-dropdown')) {
                document.querySelectorAll('.multi-select-content').forEach(el => el.classList.remove('open'));
            }
        });

        // --- 輔助函式 ---
        function downloadSelectedProposals() {
             if (typeof JSZip === 'undefined') { showError("核心元件未載入"); return; }
             
             // 先驗證所有選取的學生
             if (!validateForm(true)) {
                 return; // validateForm 已經會顯示錯誤 Modal
             }

             const completedStudents = studentDataState.filter(s => s.isDataComplete && s.isProposalComplete && s.isSelected);
             
             if (completedStudents.length === 0) {
                 showModal("提示", "請至少選取一位已完成設定的學生。", 'warning');
                 return;
             }

             // ... (以下是正常的打包下載邏輯)
             const zip = new JSZip();
             const bulkDownloadBtn = document.getElementById('bulkDownloadBtn');
             const originalBtnHtml = bulkDownloadBtn.innerHTML;
             bulkDownloadBtn.disabled = true; bulkDownloadBtn.innerHTML = `<i class="fa-solid fa-spinner fa-spin"></i> 正在打包 (${completedStudents.length} 份)...`; showMsg("正在打包計畫書...");

             // ... (保留原有的 getTemplateBuffer 與 generate 邏輯)
             performZipGeneration(completedStudents, zip, bulkDownloadBtn, originalBtnHtml);
        }
        
        // 將複雜的 ZIP 生成邏輯拆分出來，保持代碼整潔
        async function performZipGeneration(students, zip, btn, originalHtml) {
            try {
                const arrayBuffer = await getTemplateBuffer('proposal');
                const commonData = getContractRenderData(); // 使用共用資料綁定

                const Docxtemplater = window.docxtemplater || docxtemplater;

                for (const student of students) {
                    const renderData = getProposalRenderData(student);
                    // 重新載入 ZIP 以避免汙染
                    let docZip = new PizZip(arrayBuffer.slice(0));
                    const docFile = docZip.file("word/document.xml");
                    if (docFile) docZip.file("word/document.xml", cleanXML(docFile.asText()));

                    // 修正: 加上 delimiters 設定，確保可以讀取 %%% 標籤
                    const doc = new Docxtemplater(docZip, { paragraphLoop: true, linebreaks: true, delimiters: { start: '%%%', end: '%%%' }, nullGetter: function(part) { return ""; } });
                    doc.render(renderData);
                    const out = doc.getZip().generate({ type: "uint8array" });
                    zip.file(`實習計畫書_${student.name}.docx`, out);
                }

                zip.generateAsync({ type: "blob" }).then(function(content) { saveAs(content, "學生實習計畫書_打包.zip"); showMsg(`成功打包 ${students.length} 份計畫書。`); });

            } catch (error) {
                showError("打包失敗", error.message);
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalHtml;
            }
        }

        function generateProposalDoc() {
             showMsg("請選擇一位學生進行下載，或使用打包功能。");
        }
        
        function getStudentCourseData(student) {
            // 用於產生文件的 helper
            if(!student.selectedCourses || student.selectedCourses.length === 0) return { name: "", semester: "", credits: "" };
            const courses = student.selectedCourses.map(id => courseListState.find(c => c.id === id)).filter(c => c);
            return {
                name: courses.map(c => c.name).join("、"),
                semester: courses.map(c => `${c.year}-${c.semester}`).join("、"),
                credits: courses.map(c => c.credits).reduce((a,b)=>a+b, 0)
            };
        }

        // --- 核心邏輯：綁定與初始化 ---
        function updateProposalDataState() {
            // 此函式在 input change 時已透過 updateProposalField 即時更新，可留空或做最後確認
        }

        function toggleStudentSelection(index) {
            const s = studentDataState.find(item => item.index === index);
            if (s) s.isSelected = !s.isSelected;
            updateSelectAllCheckbox();
        }
        
        function updateSelectAllCheckbox() {
            const selectAll = document.getElementById('select_all_proposals');
            const visibleStudents = studentDataState.filter(s => s.isDataComplete);
            const selectedCount = visibleStudents.filter(s => s.isSelected).length;
            selectAll.checked = visibleStudents.length > 0 && selectedCount === visibleStudents.length;
        }

        function toggleSelectAll(checkbox) {
            const checked = checkbox.checked;
            studentDataState.forEach(s => {
                if(s.isDataComplete) s.isSelected = checked;
            });
            renderProposalList(); // 簡單重繪以更新 checkbox 狀態
        }

        function copyPlanToSelected(sourceIndex) {
            const source = studentDataState.find(s => s.index === sourceIndex);
            if(!source) return;
            
            const targets = studentDataState.filter(s => s.isDataComplete && s.isSelected && s.index !== sourceIndex);
            if(targets.length === 0) {
                showModal("提示", "請先勾選要套用的其他學生", "info");
                return;
            }
            
            showConfirm("確認複製", `確定將 ${source.name} 的設定複製給其他 ${targets.length} 位學生？`, () => {
                targets.forEach(t => {
                    t.intern_type_select = source.intern_type_select;
                    t.teacher_name = source.teacher_name;
                    t.teacher_contact = source.teacher_contact;
                    t.selectedCourses = [...source.selectedCourses];
                    t.isProposalComplete = isStudentProposalComplete(t);
                });
                renderProposalList();
                showMsg("複製完成");
            });
        }
        
        async function downloadIndividualProposal(index) {
            const s = studentDataState.find(item => item.index === index);
            if(!s) return;
            
            // 修正 16: 點擊時檢查該學生的資料完整性
            let errors = [];
            if (!s.selectedCourses || s.selectedCourses.length === 0) errors.push('課程選擇');
            if (!s.teacher_name) errors.push('校方老師姓名');
            if (!s.teacher_contact) errors.push('校方老師聯絡方式');
            if (!s.intern_type_select) errors.push('實習類別');
            
            if (errors.length > 0) {
                showModal("資料不全", `學生 ${s.name} 尚未完成計畫書設定，缺少：\n${errors.join('、')}`, 'warning');
                // 觸發介面重繪以顯示錯誤紅框
                renderProposalList(false); // false 表示不重置展開狀態
                // 強制加上 input-error class (雖然 render 會重繪，但為了即時反饋)
                setTimeout(() => {
                    if(!s.selectedCourses.length) document.getElementById(`dropdown_trigger_text_${index}`)?.parentElement.classList.add('input-error');
                    if(!s.teacher_name) document.getElementById(`p_teacher_name_${index}`)?.classList.add('input-error');
                    if(!s.teacher_contact) document.getElementById(`p_teacher_contact_${index}`)?.classList.add('input-error');
                    if(!s.intern_type_select) document.getElementById(`p_intern_type_select_${index}`)?.classList.add('input-error');
                }, 50);
                return;
            }
            
            await generateProposalFile(s);
        }

        async function generateProposalFile(studentData) {
            try {
                const templateBuf = await getTemplateBuffer('proposal');
                const zip = new PizZip(templateBuf);
                
                // 修正: 加上 delimiters 設定，確保可以讀取 %%% 標籤
                const doc = new window.docxtemplater(zip, { paragraphLoop: true, linebreaks: true, delimiters: { start: '%%%', end: '%%%' }, nullGetter: function(part) { return ""; } });
                
                // 使用統一的資料收集邏輯
                const renderData = getProposalRenderData(studentData);
                
                doc.render(renderData);
                
                const blob = doc.getZip().generate({ type: "blob", mimeType: "application/vnd.openxmlformats-officedocument.wordprocessingml.document" });
                saveAs(blob, `實習計畫書_${studentData.name}.docx`);
                showMsg(`成功生成 ${studentData.name} 的計畫書。`);
            } catch(e) {
                showError("產生失敗", e.message);
            }
        }
        
        // 修正 4. handleCourseExcelUpload / handleProposalExcelUpload (這些函數在之前已定義，此處為了完整性確保它們存在)
        function handleCourseExcelUpload(event) {
            const file = event.target.files[0]; if (!file) return;
            showConfirm('匯入確認', '確定要將 Excel 中的課程匯入「實習課程列表」嗎？', () => {
                 const reader = new FileReader();
                 reader.onload = function(e) {
                     try {
                         const data = new Uint8Array(e.target.result); 
                         const workbook = XLSX.read(data, {type: 'array'});
                         const worksheet = workbook.Sheets[workbook.SheetNames[0]]; 
                         const jsonData = XLSX.utils.sheet_to_json(worksheet, {header: 1});

                         if (jsonData.length < 2) { showError("Excel 檔案中沒有有效的課程資料。"); return; }
                         const dataRows = jsonData.slice(1);
                         
                         dataRows.forEach(row => {
                             const year = String(row[0] || '').trim();
                             const sem = String(row[1] || '').trim();
                             const name = String(row[2] || '').trim();
                             const credits = parseFloat(row[3] || 0);
                             
                             if (year && sem && name && !isNaN(credits)) {
                                 const courseKey = `${year}-${sem}-${name}`;
                                 if (!courseListState.some(c => `${c.year}-${c.semester}-${c.name}` === courseKey)) {
                                     courseListState.push({ id: Date.now() + Math.random(), name: name, year: year, semester: sem, credits: credits });
                                 }
                             }
                         });
                         renderCourseList();
                         renderProposalList(); // 修正: 確保列表更新
                         showMsg(`課程匯入完成`);
                         event.target.value = '';
                     } catch (error) { showError("匯入失敗", error.message); }
                 };
                 reader.readAsArrayBuffer(file);
            });
        }
        
        // 修正 強化版 handleProposalExcelUpload
        async function handleProposalExcelUpload(event) {
            const file = event.target.files[0]; if (!file) return;
            
            // 確認是否開始匯入
            const confirmStart = await showConfirmAsync('匯入確認', '即將匯入學生計畫書設定。系統將會分析 Excel 中的資料，並詢問如何處理新增或衝突的項目。\n\n確定要繼續嗎？');
            if (!confirmStart) { event.target.value = ''; return; }

            const reader = new FileReader();
            reader.onload = async function(e) {
                try {
                    const data = new Uint8Array(e.target.result); 
                    const workbook = XLSX.read(data, {type: 'array'});
                    const worksheet = workbook.Sheets[workbook.SheetNames[0]]; 
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, {header: 1});

                    if (jsonData.length < 2) { showError("Excel 檔案無資料。"); return; }
                    const dataRows = jsonData.slice(1);
                    
                    let newStudentsAdded = 0;
                    let existingUpdated = 0;
                    let coursesAdded = 0;
                    
                    // Step 1: 分析 Excel 中的所有課程
                    // 先收集所有用到的課程
                    let excelCourses = [];
                    dataRows.forEach(row => {
                        for(let i=0; i<maxCourses; i++) {
                            const baseIdx = 8 + (i * 4); // 修正: 課程資料現在從第 8 欄開始
                            const cYear = String(row[baseIdx] || '').trim();
                            const cSem = String(row[baseIdx+1] || '').trim();
                            const cName = String(row[baseIdx+2] || '').trim();
                            const cCredits = parseFloat(row[baseIdx+3]);
                            if (cYear && cSem && cName && !isNaN(cCredits)) {
                                // 檢查是否已存在於 app
                                const exists = courseListState.some(c => c.year === cYear && c.semester === cSem && c.name === cName);
                                if (!exists) {
                                    // 檢查是否已加入待處理清單 (避免重複詢問)
                                    const pending = excelCourses.some(c => c.year === cYear && c.semester === cSem && c.name === cName);
                                    if (!pending) {
                                        excelCourses.push({ year: cYear, semester: cSem, name: cName, credits: cCredits });
                                    }
                                }
                            }
                        }
                    });

                    // 詢問新增課程
                    for (const ec of excelCourses) {
                        const doAdd = await showConfirmAsync('發現新課程', `Excel 中包含系統尚未建立的課程：\n[${ec.year}-${ec.semester}] ${ec.name} (${ec.credits}學分)\n\n是否要新增此課程？(若選擇「取消」，該課程將被略過)`);
                        if (doAdd) {
                            courseListState.push({ id: Date.now() + Math.random(), ...ec });
                            coursesAdded++;
                        }
                    }
                    if (coursesAdded > 0) renderCourseList(); // 更新介面

                    // Step 2: 處理每一行學生資料
                    const processedStudentIds = new Set();
                    const typeMap = {
                        '整學年': 'full', '整學期': 'sem', '寒假實習': 'winter', 
                        '暑假實習': 'summer', '學期期間實習': 'term',
                        '學期實習': 'sem', '學年實習': 'full' // 容錯
                    };

                    for (const row of dataRows) {
                        const name = String(row[0] || '').trim();
                        const id = String(row[1] || '').trim();
                        if (!name || !id) continue;

                        processedStudentIds.add(id);

                        // 讀取新欄位
                        const internTypeText = String(row[2] || '').trim();
                        const internType = typeMap[internTypeText] || "";
                        const exceededDesc = String(row[3] || '').trim();
                        const teacherName = String(row[4] || '').trim();
                        const teacherContact = String(row[5] || '').trim();
                        const indTeacherName = String(row[6] || '').trim();
                        const indTeacherContact = String(row[7] || '').trim();

                        let student = studentDataState.find(s => s.id === id);
                        let isNewStudent = false;

                        if (!student) {
                            // 學生不存在，詢問是否新增
                            const doAddStudent = await showConfirmAsync('發現新學生', `Excel 中的學生「${name} (${id})」不在目前的學生名單中。\n\n是否要新增此學生？`);
                            if (doAddStudent) {
                                const newIdx = studentDataState.length;
                                studentDataState.push({
                                    index: newIdx, name: name, id: id, dept: "", grade: "", raw_grade: "", 
                                    selectedCourses: [], 
                                    teacher_name: teacherName, teacher_contact: teacherContact, 
                                    industry_teacher: indTeacherName, industry_contact: indTeacherContact, 
                                    hours_exceeded_desc: exceededDesc, intern_type_select: internType,
                                    isDataComplete: false, isProposalComplete: false, isSelected: true
                                });
                                student = studentDataState[newIdx];
                                isNewStudent = true;
                                newStudentsAdded++;
                                
                                document.getElementById('student_count').value = studentDataState.length;
                                document.getElementById('student_count_display').innerText = studentDataState.length + " 人";
                                renderStudents(); 
                            } else {
                                continue; // 略過此學生
                            }
                        }

                        // 準備 Excel 中的課程 ID 列表
                        const newSelectedCourses = [];
                        for(let i=0; i<maxCourses; i++) {
                            const baseIdx = 8 + (i * 4); // 修正: 課程資料現在從第 8 欄開始
                            const cYear = String(row[baseIdx] || '').trim();
                            const cSem = String(row[baseIdx+1] || '').trim();
                            const cName = String(row[baseIdx+2] || '').trim();
                            if (cYear && cSem && cName) {
                                const match = courseListState.find(c => c.year === cYear && c.semester === cSem && c.name === cName);
                                if (match) newSelectedCourses.push(match.id);
                            }
                        }

                        // 如果是舊學生，檢查是否有差異 (包含新欄位)
                        if (!isNewStudent) {
                            const oldCourses = student.selectedCourses || [];
                            // 檢查課程是否不同
                            const isCourseDiff = oldCourses.length !== newSelectedCourses.length || 
                                                !oldCourses.every(cId => newSelectedCourses.includes(cId));
                            
                            // 檢查其他欄位是否不同
                            const isMetaDiff = student.teacher_name !== teacherName ||
                                               student.teacher_contact !== teacherContact ||
                                               student.intern_type_select !== internType;

                            if (isCourseDiff || isMetaDiff) {
                                const doOverwrite = await showConfirmAsync('資料衝突', `學生「${name}」的計畫書資料 (課程/老師/類別) 與目前系統中不同。\n\n是否要使用 Excel 的資料覆蓋？`);
                                if (!doOverwrite) continue; 
                            }
                        }

                        // 更新資料
                        student.selectedCourses = newSelectedCourses;
                        if (!isNewStudent || isNewStudent) { // 無論是否新學生，都要填入這些資料
                            student.teacher_name = teacherName;
                            student.teacher_contact = teacherContact;
                            student.industry_teacher = indTeacherName;
                            student.industry_contact = indTeacherContact;
                            student.hours_exceeded_desc = exceededDesc;
                            student.intern_type_select = internType;
                        }
                        
                        student.isProposalComplete = isStudentProposalComplete(student);
                        if (!isNewStudent) existingUpdated++;
                    }

                    // Step 3: 檢查缺漏學生 (在系統中但不在 Excel 中)
                    const missingStudents = studentDataState
                        .filter(s => s.id && !processedStudentIds.has(s.id))
                        .map(s => `${s.name} (${s.id})`);

                    renderProposalList();
                    
                    let resultMsg = `匯入完成！\n- 新增課程: ${coursesAdded}\n- 新增學生: ${newStudentsAdded}\n- 更新資料: ${existingUpdated}`;
                    if (missingStudents.length > 0) {
                        resultMsg += `\n\n[注意] 以下學生存在於系統中，但 Excel 內沒有對應資料 (未更新)：\n${missingStudents.join('、')}`;
                    }
                    
                    showMsg("處理完畢");
                    showModal("匯入報告", resultMsg, 'info');
                    event.target.value = '';

                } catch (error) { showError("匯入失敗", error.message); }
            };
            reader.readAsArrayBuffer(file);
        }

        window.onload = function() {
            showPage('page-1');
            renderStudents();
            
            if (typeof PizZip === 'undefined' || typeof window.docxtemplater === 'undefined') {
                document.getElementById('lib-error').style.display = 'block'; document.getElementById('missing-lib').innerText = "核心元件";
            } else {
                const btn = document.getElementById('genContractBtn'); btn.disabled = false; btn.classList.remove('bg-gray-400', 'cursor-not-allowed', 'opacity-75'); btn.classList.add('btn-generate'); btn.innerHTML = '<i class="fa-regular fa-file-word"></i> 產生合約文件 (Word)';
                const btn2 = document.getElementById('genProposalBtn'); const bulkBtn = document.getElementById('bulkDownloadBtn');
                btn2.disabled = false; btn2.classList.add('btn-generate'); btn2.innerHTML = '<i class="fa-regular fa-file-word"></i> 產生實習計畫書 (Word)';
                bulkBtn.disabled = false; bulkBtn.classList.add('btn-generate');
            }
            toggleType(); togglePayInputs(); 
            document.getElementById('dorm_opt').value = ''; 
            document.getElementById('food_opt').value = ''; 
            document.getElementById('trans_opt').value = '';
            toggleCost('dorm'); toggleCost('food'); toggleCost('trans');

            document.getElementById('is_head_office').checked = false; toggleBranchFields(); 
            const taxIdInput = document.getElementById('company_tax_id'); if (taxIdInput) taxIdInput.addEventListener('input', updateQueryButtonState);
            document.getElementById('no_tax_id').checked = false; toggleTaxIdFields(); 
            const queryBtn = document.getElementById('queryBtn'); if (queryBtn) queryBtn.addEventListener('click', getCompanyInfo);
            
            document.getElementById('footer-version-trigger').addEventListener('click', checkDebugToggle); 
            document.getElementById('student_container').addEventListener('input', collectStudentDataFromPage2);
            document.getElementById('err-close').addEventListener('click', () => { document.getElementById('error-modal').style.display = 'none'; });
        };
    </script>
</body>
</html>
