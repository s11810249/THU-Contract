<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>東海大學學生校外實習合約產生器 (V1.0.3)</title>

    <!-- 核心函式庫 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/pizzip@3.1.4/dist/pizzip.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/docxtemplater/3.37.11/docxtemplater.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/1.3.8/FileSaver.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>

    <!-- 東海配色 -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        thuBlue: '#002E5D',
                        thuGold: '#C6A87C',
                    },
                    fontFamily: {
                        sans: ['"Noto Sans TC"', 'sans-serif'],
                    }
                }
            }
        }
    </script>

    <style>
        body {
            background-color: #f3f4f6;
            font-family: 'Noto Sans TC', sans-serif;
            padding-bottom: 100px; 
            color: #374151;
            scroll-behavior: smooth;
        }
        
        /* 通用輸入框樣式 */
        .input-field {
            background-color: white;
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            padding: 0.6rem 0.8rem;
            width: 100%;
            font-size: 1rem;
            transition: all 0.2s ease;
        }
        .input-field:focus {
            outline: none;
            border-color: #002E5D;
            box-shadow: 0 0 0 3px rgba(0, 46, 93, 0.1);
        }
        .input-error {
            border-color: #ef4444 !important;
            background-color: #fef2f2 !important;
        }

        /* 移除數字輸入框的上下箭頭 */
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { 
            -webkit-appearance: none; 
            margin: 0; 
        }
        input[type=number] { -moz-appearance: textfield; }

        /* 日期群組 - 強化置中 */
        .date-group {
            display: flex;
            align-items: center;
            justify-content: center; /* 水平置中 */
            background: white;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            padding: 0.4rem;
            transition: all 0.2s ease;
            overflow: hidden;
        }
        .date-group:focus-within {
            border-color: #002E5D;
            box-shadow: 0 0 0 3px rgba(0, 46, 93, 0.1);
        }
        .date-input {
            border: none;
            text-align: center !important; /* 文字置中 */
            width: 100%;
            min-width: 2.5rem;
            outline: none;
            font-size: 1rem;
            color: #374151;
            background: transparent;
            padding: 0;
        }
        .date-sep { color: #9ca3af; font-weight: bold; padding: 0 0.1rem; user-select: none; flex-shrink: 0; }

        /* 卡片樣式 */
        .card { 
            background: white; 
            border-radius: 0.75rem; 
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05); 
            border: 1px solid #e5e7eb;
            overflow: hidden; 
            margin-bottom: 2rem; 
            transition: border-color 0.3s;
        }
        .card-header { 
            padding: 1.25rem 2rem; 
            background-color: #ffffff;
            border-bottom: 1px solid #f3f4f6; 
            color: #002E5D; 
            font-weight: 700; 
            font-size: 1.125rem; 
            display: flex; 
            align-items: center;
            justify-content: space-between; 
        }
        .card-header-title {
            display: flex;
            align-items: center;
        }
        .card-header-title::before {
            content: '';
            display: inline-block;
            width: 5px;
            height: 1.2rem;
            background-color: #C6A87C;
            margin-right: 0.75rem;
            border-radius: 2px;
        }

        .hidden { display: none; }
        
        #status-bar { display: none; position: fixed; bottom: 80px; right: 20px; background: #333; color: white; padding: 8px 16px; border-radius: 6px; z-index: 9999; box-shadow: 0 4px 12px rgba(0,0,0,0.3); font-size: 0.9rem; }
        #lib-error { display: none; position: fixed; top: 0; left: 0; width: 100%; background: #ef4444; color: white; text-align: center; padding: 10px; z-index: 9999; font-weight: bold; }
        #error-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10000; align-items: center; justify-content: center; }
        #error-content { background: white; padding: 2rem; border-radius: 1rem; max-width: 600px; width: 90%; max-height: 80%; overflow-y: auto; }
        pre { white-space: pre-wrap; word-break: break-word; }

        footer {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background-color: #1f2937;
            color: #9ca3af;
            text-align: center;
            padding: 1rem 0;
            font-size: 0.75rem;
            z-index: 50;
            border-top: 3px solid #C6A87C;
        }
        
        /* 提示框動畫 */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .fade-in { animation: fadeIn 0.3s ease-out; }
        
        /* 卡片式 Radio 樣式 (顏色區分版) */
        .pay-option-label {
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 1.5rem;
            border: 1px solid #e5e7eb; /* 修正: 使用 1px 邊框 */
            border-radius: 0.75rem;
            cursor: pointer;
            transition: all 0.2s;
            background-color: white;
            height: 100%;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
        }
        .pay-option-label:hover {
            background-color: #f9fafb; /* gray-50 */
            border-color: #cbd5e1; /* gray-300 */
            transform: translateY(-2px);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
        }
        
        .radio-card-input {
            position: absolute;
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        /* 1. 無 (灰色系) */
        .pay-option-none:has(input:checked) { border-color: #475569; background-color: #f1f5f9; box-shadow: 0 0 0 1px #475569; }
        .pay-option-none .pay-option-icon { color: #94a3b8; }
        .pay-option-none:has(input:checked) .pay-option-icon { color: #475569; }
        .pay-option-none:has(input:checked) .pay-option-text { color: #0f172a; }

        /* 2. 獎學金 (金色系) */
        .pay-option-scholar:has(input:checked) { border-color: #b45309; background-color: #fffbeb; box-shadow: 0 0 0 1px #b45309; }
        .pay-option-scholar .pay-option-icon { color: #d97706; }
        .pay-option-scholar:has(input:checked) .pay-option-icon { color: #b45309; }
        .pay-option-scholar:has(input:checked) .pay-option-text { color: #78350f; }

        /* 3. 實習津貼 (綠色系) */
        .pay-option-allowance:has(input:checked) { border-color: #15803d; background-color: #f0fdf4; box-shadow: 0 0 0 1px #15803d; }
        .pay-option-allowance .pay-option-icon { color: #16a34a; }
        .pay-option-allowance:has(input:checked) .pay-option-icon { color: #15803d; }
        .pay-option-allowance:has(input:checked) .pay-option-text { color: #14532d; }

        .pay-option-icon {
            font-size: 2rem;
            margin-bottom: 0.5rem;
            transition: color 0.2s;
        }
        .pay-option-text {
            font-weight: bold;
            color: #64748b;
        }

        /* 產生按鈕特效 */
        .btn-generate {
            background: linear-gradient(135deg, #002E5D 0%, #004080 100%);
            box-shadow: 0 4px 6px -1px rgba(0, 46, 93, 0.3), 0 2px 4px -1px rgba(0, 46, 93, 0.1);
            transition: all 0.3s ease;
            color: white;
        }
        .btn-generate:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0, 46, 93, 0.3), 0 4px 6px -2px rgba(0, 46, 93, 0.1);
            background: linear-gradient(135deg, #003366 0%, #0055aa 100%);
        }
        .btn-generate:active:not(:disabled) {
            transform: translateY(0);
        }
        .btn-generate:disabled {
            background: #9ca3af;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        /* 清除按鈕特效 */
        .btn-reset {
            background-color: white;
            border: 2px solid #e5e7eb;
            color: #6b7280;
            transition: all 0.2s ease;
        }
        .btn-reset:hover {
            background-color: #f3f4f6;
            border-color: #d1d5db;
            color: #374151;
            transform: translateY(-2px);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
        }
        .btn-reset:active {
            transform: translateY(0);
        }

        /* 查詢按鈕樣式 */
        .btn-query {
            background-color: #C6A87C; /* thuGold */
            color: #002E5D; /* thuBlue */
            font-weight: bold;
            border-radius: 0.375rem;
            padding: 0.6rem 1.25rem;
            transition: all 0.2s ease;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
        }
        .btn-query:hover {
            background-color: #b3976e; /* 稍深一點 */
            transform: translateY(-1px);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
    </style>
</head>
<body>

    <div id="lib-error">
        ⚠️ 系統偵測到核心元件未載入成功！可能是網路阻擋了 CDN。<br>
        請嘗試使用手機網路或更換瀏覽器。錯誤元件：<span id="missing-lib"></span>
    </div>

    <div id="status-bar">準備就緒</div>

    <!-- 錯誤訊息彈窗 -->
    <div id="error-modal">
        <div id="error-content">
            <h3 class="text-xl font-bold text-red-600 mb-4 flex items-center gap-2">
                <i class="fa-solid fa-circle-exclamation"></i> 發生錯誤
            </h3>
            <div class="bg-gray-50 p-4 rounded border border-gray-200 mb-6">
                <pre id="error-details" class="text-sm text-gray-800 font-mono"></pre>
            </div>
            <div class="flex justify-end">
                <button id="err-close" class="bg-gray-200 text-gray-700 px-6 py-2 rounded font-bold hover:bg-gray-300 transition">關閉</button>
            </div>
        </div>
    </div>

    <!-- Header (深色背景) -->
    <div class="fixed top-0 left-0 w-full bg-thuBlue z-50 shadow-md">
        <div class="max-w-7xl mx-auto px-4 md:px-8 h-[80px] flex items-center justify-between">
            <div class="flex items-center gap-4">
                <img src="https://www.thu.edu.tw/upload/pagepic_upload/logo_w.svg" alt="THU Logo" class="h-10 w-auto">
                <div class="flex flex-col justify-center text-white">
                    <!-- 標題修改為 合約產生器 -->
                    <div class="text-lg md:text-xl font-bold tracking-wide leading-tight">學生校外實習合約產生器</div>
                    <div class="text-xs text-thuGold opacity-90 font-sans leading-tight mt-0.5">Internship Contract Generation System</div>
                </div>
            </div>
            
            <!-- 右上角連結區 -->
            <div class="hidden md:flex gap-3 text-sm">
                <a href="https://aca.thu.edu.tw/web/isac/page.php?scid=112&sid=103" target="_blank" class="flex items-center gap-2 px-4 py-2 border border-thuGold text-thuGold rounded-full hover:bg-thuGold hover:text-thuBlue transition-all duration-200 font-medium">
                    <i class="fa-solid fa-link"></i> 實習中心網頁
                </a>
                <a href="https://www.thu.edu.tw/" target="_blank" class="flex items-center gap-2 px-4 py-2 bg-white text-thuBlue rounded-full hover:bg-gray-100 shadow-sm transition-all duration-200 font-medium">
                    <i class="fa-solid fa-house"></i> 東海大學首頁
                </a>
            </div>
        </div>
    </div>

    <!-- 主要表單 -->
    <main class="max-w-4xl mx-auto px-4 mb-20 pt-28">
        
        <!-- 使用須知 -->
        <div class="bg-white border border-blue-100 rounded-xl p-6 mb-8 shadow-sm">
            <div class="flex items-start gap-4">
                <div class="w-10 h-10 rounded-full bg-blue-50 flex items-center justify-center text-blue-600 shrink-0">
                    <i class="fa-solid fa-circle-info text-xl"></i>
                </div>
                <div class="flex-1">
                    <h3 class="text-base font-bold text-gray-800 mb-2">使用須知</h3>
                    <ol class="text-sm text-gray-600 leading-relaxed list-decimal list-outside ml-4 space-y-1">
                        <li>本系統將協助您快速產出符合規範的實習合約書。請依序填寫下方資料，系統將自動帶入公版 Word 範本中。所有運算皆在您的瀏覽器完成，不會上傳任何個資。</li>
                        <li>本系統於上線初期僅提供中文版本，適用範圍限於國內實習；後續將推出外語版本並擴大適用於國外實習。</li>
                        <li>因實習計畫書樣態多元，故目前版本不包含實習計畫書，合約用印前請務必完成實習計畫書填寫。</li>
                        <li>如有任何系統反饋，歡迎寄信至 <a href="mailto:s11810249@thu.edu.tw" class="text-blue-600 hover:underline">s11810249@thu.edu.tw</a>！</li>
                    </ol>
                </div>
            </div>
        </div>

        <form id="contractForm">
            <!-- 卡片 1: 機構資料 -->
            <div class="card">
                <div class="card-header">
                    <span class="card-header-title">乙方：實習機構資料</span>
                </div>
                <div class="p-8 grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-6">
                    <!-- 說明文字 (移動到卡片內容頂部) -->
                    <div class="md:col-span-2 mb-4">
                        <span class="text-sm text-red-500 flex items-center">您可輸入統一編號後，點擊查詢按鈕，系統將自動帶入公司名稱、負責人與登記地址。資料來源為介接經濟部商工行政資料開放平台API，公示資料可能非最新，簽約前請再次確認所有資訊是否正確。</span>
                    </div>
                    
                    <!-- Row 1: 統一編號 + 機構全銜 (並排，統編輸入框加寬) -->
                    <div class="md:col-span-1">
                        <label class="block text-sm font-bold text-gray-700 mb-2">統一編號 <span class="text-red-500">*</span></label>
                        <div class="flex gap-2 items-center">
                            <input type="text" id="company_tax_id" class="input-field w-32 md:w-48 flex-grow-0" placeholder="04231910" maxlength="8">
                            <button type="button" id="queryBtn" class="btn-query flex items-center gap-2">
                                <i class="fa-solid fa-magnifying-glass"></i> 自動查詢
                            </button>
                        </div>
                    </div>

                    <div class="md:col-span-1">
                        <label class="block text-sm font-bold text-gray-700 mb-2">機構全銜 (法定名稱) <span class="text-red-500">*</span></label>
                        <input type="text" id="company_name" class="input-field" placeholder="例：國泰世華商業銀行股份有限公司">
                    </div>

                    <!-- Row 2: 代表人姓名 + 代表人職稱 (平均等寬) -->
                    <div class="md:col-span-1">
                        <label class="block text-sm font-bold text-gray-700 mb-2">代表人姓名 <span class="text-red-500">*</span></label>
                        <input type="text" id="company_rep" class="input-field">
                    </div>
                    
                    <div class="md:col-span-1">
                        <label class="block text-sm font-bold text-gray-700 mb-2">代表人職稱 <span class="text-red-500">*</span></label>
                        <input type="text" id="company_title" class="input-field" placeholder="">
                    </div>

                    <!-- Row 3: 公司登記地址 (佔滿兩欄) -->
                    <div class="md:col-span-2">
                        <label class="block text-sm font-bold text-gray-700 mb-2">公司登記地址 (總公司) <span class="text-red-500">*</span></label>
                        <input type="text" id="reg_address" class="input-field" placeholder="例：臺北市信義區松仁路7號1樓">
                    </div>
                    
                    <!-- 分公司 (固定欄位) -->
                    <div class="md:col-span-2 pt-6 border-t border-gray-200 mt-2">
                        <div class="text-sm font-bold text-thuBlue mb-4 flex items-center gap-2 bg-blue-50 p-2 rounded">
                            <i class="fa-solid fa-location-dot"></i> 
                            實習地點 (若與登記地址不同，如派駐分公司，請填寫以下欄位)
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label class="block text-xs font-bold text-gray-500 mb-2">實習單位/分公司名稱</label>
                                <input type="text" id="branch_name" class="input-field" placeholder="例：淡水分公司">
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-gray-500 mb-2">實際實習地址</label>
                                <input type="text" id="branch_addr" class="input-field" placeholder="例：新北市淡水區中山路106號">
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 卡片 2: 學生資料 (人數增減按鈕 + 標題靠左) -->
            <div class="card">
                <div class="card-header">
                    <span class="card-header-title mr-4">甲方：實習學生資料</span>
                    <!-- 人數控制 -->
                    <div class="flex items-center bg-gray-100 rounded-lg p-1 border border-gray-200">
                        <button type="button" onclick="changeStudentCount(-1)" class="w-8 h-8 flex items-center justify-center rounded-md text-gray-600 hover:bg-white hover:shadow-sm hover:text-thuBlue transition-all">
                            <i class="fa-solid fa-minus"></i>
                        </button>
                        <div class="w-16 text-center text-sm font-bold text-thuBlue" id="student_count_display">1 人</div>
                        <button type="button" onclick="changeStudentCount(1)" class="w-8 h-8 flex items-center justify-center rounded-md text-gray-600 hover:bg-white hover:shadow-sm hover:text-thuBlue transition-all">
                            <i class="fa-solid fa-plus"></i>
                        </button>
                    </div>
                    <input type="hidden" id="student_count" value="1">
                </div>
                <div class="p-8">
                    <div id="student_container" class="space-y-6"></div>
                </div>
            </div>

            <!-- 卡片 3: 實習期間與時間 -->
            <div class="card">
                <div class="card-header">
                    <span class="card-header-title">實習期間與時間</span>
                </div>
                <div class="p-8 space-y-8">
                    <!-- 日期 -->
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-3">1. 實習期間</label>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <!-- 開始時間 -->
                            <div>
                                <span class="text-xs font-bold text-gray-500 mb-2 block uppercase tracking-wide text-center">實習開始 (民國年/月/日)</span>
                                <div class="date-group">
                                    <input type="number" id="start_y" class="date-input w-16 text-thuBlue" placeholder="113" oninput="autoJump(this, 3, 'start_m')">
                                    <span class="date-sep">/</span>
                                    <input type="number" id="start_m" class="date-input w-12" placeholder="07" oninput="autoJump(this, 2, 'start_d')">
                                    <span class="date-sep">/</span>
                                    <input type="number" id="start_d" class="date-input w-12" placeholder="01" oninput="autoJump(this, 2, 'end_y')"> 
                                </div>
                            </div>
                            <!-- 結束時間 -->
                            <div>
                                <span class="text-xs font-bold text-gray-500 mb-2 block uppercase tracking-wide text-center">實習結束 (民國年/月/日)</span>
                                <div class="date-group">
                                    <input type="number" id="end_y" class="date-input w-16 text-thuBlue" placeholder="114" oninput="autoJump(this, 3, 'end_m')">
                                    <span class="date-sep">/</span>
                                    <input type="number" id="end_m" class="date-input w-12" placeholder="06" oninput="autoJump(this, 2, 'end_d')">
                                    <span class="date-sep">/</span>
                                    <input type="number" id="end_d" class="date-input w-12" placeholder="30">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 時間 -->
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-3">2. 每日實習時間</label>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 bg-gray-50 p-6 rounded-lg border border-gray-200">
                            <div><span class="text-xs font-bold text-gray-400 uppercase mb-1 block">每日開始</span><input type="time" id="daily_start" value="09:00" class="input-field bg-white border-gray-300"></div>
                            <div><span class="text-xs font-bold text-gray-400 uppercase mb-1 block">每日結束</span><input type="time" id="daily_end" value="18:00" class="input-field bg-white border-gray-300"></div>
                            <div><span class="text-xs font-bold text-gray-400 uppercase mb-1 block">共計(小時)</span><input type="number" id="daily_hours" value="8" step="0.5" class="input-field bg-white border-gray-300"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 卡片 4: 類型、待遇與福利 -->
            <div class="card" id="card-conditions">
                <div class="card-header">
                    <span class="card-header-title">實習類型與待遇福利</span>
                </div>
                <div class="p-8 space-y-8">
                    
                    <!-- 類型 (必填 - 50% 等寬) -->
                    <div id="type-section" class="p-4 rounded-lg border border-transparent transition-all">
                        <label class="block text-lg font-bold text-thuBlue mb-3">1. 請選擇實習類型 <span class="text-red-500 text-sm">*必填</span></label>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <label class="relative flex items-center p-5 border-2 rounded-xl cursor-pointer transition-all hover:bg-gray-50 has-[:checked]:border-thuBlue has-[:checked]:bg-blue-50/50 has-[:checked]:ring-1 has-[:checked]:ring-thuBlue h-full">
                                <input type="radio" name="contract_type" value="learn" onchange="toggleType()" class="w-5 h-5 text-thuBlue border-gray-300 focus:ring-thuBlue">
                                <div class="ml-4">
                                    <i class="fa-solid fa-book-open text-2xl text-thuBlue opacity-30 absolute right-4 top-4"></i>
                                    <span class="block text-base font-bold text-gray-900">一般型 (學習型)</span>
                                    <span class="block text-xs text-gray-500 mt-1">單純學習訓練，無僱傭關係</span>
                                </div>
                            </label>
                            <label class="relative flex items-center p-5 border-2 rounded-xl cursor-pointer transition-all hover:bg-gray-50 has-[:checked]:border-orange-500 has-[:checked]:bg-orange-50/50 has-[:checked]:ring-1 has-[:checked]:ring-orange-500 h-full">
                                <input type="radio" name="contract_type" value="work" onchange="toggleType()" class="w-5 h-5 text-orange-600 border-gray-300 focus:ring-orange-500">
                                <div class="ml-4">
                                    <i class="fa-solid fa-briefcase text-2xl text-orange-600 opacity-30 absolute right-4 top-4"></i>
                                    <span class="block text-base font-bold text-gray-900">工作型 (勞資型)</span>
                                    <span class="block text-xs text-gray-500 mt-1">具僱傭關係，適用勞基法</span>
                                </div>
                            </label>
                        </div>
                    </div>

                    <!-- 待遇 (必填) -->
                    <div id="pay-section" class="border-t border-gray-200 pt-6 p-4 rounded-lg border border-transparent transition-all">
                        <label class="block text-lg font-bold text-thuBlue mb-3">2. 實習待遇與給付 <span class="text-red-500 text-sm">*必填</span></label>
                        
                        <!-- 未選擇類型的提醒方塊 (預設顯示) -->
                        <div id="panel_initial" class="flex items-center justify-center p-8 bg-yellow-50 rounded-xl border-2 border-dashed border-yellow-200 text-yellow-700 font-bold shadow-sm">
                            <i class="fa-solid fa-arrow-up mr-2 animate-bounce"></i> 請先選擇上方「實習類型」以解鎖此區塊
                        </div>

                        <div id="panel_learn" class="bg-green-50 p-6 rounded-xl border border-green-200 hidden fade-in">
                            <span class="text-[10px] font-black text-green-700 bg-green-200 px-2 py-1 rounded uppercase tracking-wider mb-4 inline-block">學習型</span>
                            
                            <!-- 新版卡片式選項 -->
                            <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-6">
                                <label class="pay-option-label pay-option-none">
                                    <input type="radio" name="pay_opt_learn" value="none" onchange="togglePayInputs()" class="radio-card-input">
                                    <i class="fa-regular fa-circle-xmark pay-option-icon"></i>
                                    <span class="pay-option-text text-sm">無</span>
                                </label>
                                <label class="pay-option-label pay-option-scholar">
                                    <input type="radio" name="pay_opt_learn" value="scholar" onchange="togglePayInputs()" class="radio-card-input">
                                    <i class="fa-solid fa-graduation-cap pay-option-icon"></i>
                                    <span class="pay-option-text text-sm">獎學金</span>
                                </label>
                                <label class="pay-option-label pay-option-allowance">
                                    <input type="radio" name="pay_opt_learn" value="allowance" onchange="togglePayInputs()" class="radio-card-input">
                                    <i class="fa-solid fa-hand-holding-dollar pay-option-icon"></i>
                                    <span class="pay-option-text text-sm">實習津貼</span>
                                </label>
                            </div>

                            <div id="learn_amt_box" class="hidden transition-all">
                                <label class="block text-xs font-bold text-green-800 mb-2 uppercase">每月給付總額</label>
                                <div class="relative w-full md:w-64">
                                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none text-gray-500 font-bold">NT$</div>
                                    <input type="number" id="learn_amount" placeholder="0" class="input-field pl-12 pr-8 text-right border-green-300 focus:border-green-600 focus:ring-green-600 font-mono text-lg">
                                    <div class="absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none text-gray-500 font-bold">元</div>
                                </div>
                            </div>
                        </div>

                        <div id="panel_work" class="bg-orange-50 p-6 rounded-xl border border-orange-200 hidden flex flex-col gap-6 fade-in">
                            <span class="text-[10px] font-black text-orange-700 bg-orange-200 px-2 py-1 rounded uppercase tracking-wider w-fit">勞資型</span>
                            
                            <div>
                                <label class="block text-xs font-bold text-orange-800 mb-2 uppercase">薪資金額 (月薪)</label>
                                <div class="relative w-full md:w-64">
                                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none text-gray-500 font-bold">NT$</div>
                                    <input type="number" id="work_amount" placeholder="27470" class="input-field pl-12 pr-8 text-right border-orange-300 focus:border-orange-500 focus:ring-orange-500 font-mono text-lg">
                                    <div class="absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none text-gray-500 font-bold">元</div>
                                </div>
                            </div>
                            
                            <!-- 勞資型法規提示 (醒目設計) -->
                            <div class="bg-white p-4 rounded-lg border-l-4 border-orange-400 shadow-sm text-xs text-gray-600 leading-relaxed">
                                <div class="font-bold text-orange-600 mb-2 flex items-center gap-1 text-sm">
                                    <i class="fa-solid fa-scale-balanced"></i> 勞動部基本工資公告
                                </div>
                                <ul class="list-disc list-inside space-y-1.5">
                                    <li><span class="font-bold text-gray-800">115年1月1日起：</span>每月最低工資調整為 <span class="text-red-600 font-bold">29,500</span> 元，每小時最低工資調整為 <span class="text-red-600 font-bold">196</span> 元。(勞動部114年10月21日公告)</li>
                                    <li><span class="font-bold text-gray-800">114年1月1日起：</span>每月最低工資調整為 <span class="text-red-600 font-bold">28,590</span> 元，每小時最低工資調整為 <span class="text-red-600 font-bold">190</span> 元。(勞動部113年9月19日公告)</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <!-- 福利 (必填) -->
                    <div id="welfare-section" class="border-t border-gray-200 pt-6 p-4 rounded-lg border border-transparent transition-all">
                        <label class="block text-lg font-bold text-thuBlue mb-3">3. 福利項目 <span class="text-red-500 text-sm">*必填</span></label>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <div>
                                <label class="text-sm font-bold text-gray-600 mb-1 block">住宿</label>
                                <select id="dorm_opt" onchange="toggleCost('dorm')" class="input-field mb-2">
                                    <option value="" disabled selected>請選擇</option>
                                    <option value="none">無</option>
                                    <option value="free">免費提供</option>
                                    <option value="paid">付費提供</option>
                                </select>
                                <div id="dorm_cost_wrapper" class="hidden relative">
                                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none text-gray-500 text-sm font-bold">NT$</div>
                                    <input id="dorm_cost" type="number" placeholder="0" class="input-field pl-10 pr-8 text-right mt-1 font-mono">
                                    <div class="absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none text-gray-500 text-sm">/月</div>
                                </div>
                            </div>
                            <div>
                                <label class="text-sm font-bold text-gray-600 mb-1 block">膳食</label>
                                <select id="food_opt" onchange="toggleCost('food')" class="input-field mb-2">
                                    <option value="" disabled selected>請選擇</option>
                                    <option value="none">無</option>
                                    <option value="free">免費提供</option>
                                    <option value="paid">付費提供</option>
                                </select>
                                <div id="food_cost_wrapper" class="hidden relative">
                                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none text-gray-500 text-sm font-bold">NT$</div>
                                    <input id="food_cost" type="number" placeholder="0" class="input-field pl-10 pr-8 text-right mt-1 font-mono">
                                    <div class="absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none text-gray-500 text-sm">/餐</div>
                                </div>
                            </div>
                            <div>
                                <label class="text-sm font-bold text-gray-600 mb-1 block">交通</label>
                                <select id="trans_opt" onchange="toggleCost('trans')" class="input-field mb-2">
                                    <option value="" disabled selected>請選擇</option>
                                    <option value="none">無</option>
                                    <option value="free">免費提供</option>
                                    <option value="paid">付費提供</option>
                                    <option value="subsidy">交通津貼</option>
                                </select>
                                <div id="trans_cost_wrapper" class="hidden relative">
                                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none text-gray-500 text-sm font-bold">NT$</div>
                                    <input id="trans_cost" type="number" placeholder="0" class="input-field pl-10 pr-8 text-right mt-1 font-mono">
                                    <div class="absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none text-gray-500 text-sm">/月</div>
                                </div>
                            </div>
                        </div>
                    </div>

                </div>
            </div>


            <!-- 底部操作區 (兩個按鈕等寬) -->
            <div class="grid grid-cols-2 gap-6 mt-12 max-w-4xl mx-auto">
                <button type="button" onclick="resetForm()" class="btn-reset w-full px-6 py-5 rounded-full font-bold text-lg flex items-center justify-center gap-2">
                    <i class="fa-solid fa-rotate-right"></i> 清除重填
                </button>
                
                <button type="button" onclick="generateDoc()" id="genBtn" disabled class="btn-generate w-full px-6 py-5 rounded-full font-bold text-lg flex items-center justify-center gap-3 opacity-75 cursor-not-allowed">
                    <span class="animate-pulse">系統載入中...</span>
                </button>
            </div>
        </form>
    </main>

    <!-- 頁尾版權宣告 (縮小字級) -->
    <footer>
        <div class="container mx-auto px-4">
            <div class="flex flex-col items-center justify-center gap-1">
                <p class="font-bold text-white tracking-wide text-[10px]">&copy; 2025 東海大學實習與學生成就中心 Internship and Student Achievement Center, Tunghai University. All Rights Reserved.</p>
                <p class="text-[9px] text-gray-500">
                    系統版本 V1.0.3 | 網頁製作：張博堯 | Powered by Google Gemini
                </p>
            </div>
        </div>
    </footer>

    <!-- JS 邏輯 -->
    <script>
        function autoJump(current, maxLen, nextId) {
            if (current.value.length >= maxLen) {
                const next = document.getElementById(nextId);
                if (next) next.focus();
            }
        }

        function showMsg(msg) {
            const el = document.getElementById('status-bar');
            el.innerText = msg;
            el.style.display = 'block';
            setTimeout(() => { el.style.display = 'none'; }, 4000);
        }
        function showError(details) {
            const modal = document.getElementById('error-modal');
            const content = document.getElementById('error-details');
            content.textContent = details;
            modal.style.display = 'flex';
        }
        document.getElementById('err-close').addEventListener('click', () => {
            document.getElementById('error-modal').style.display = 'none';
        });

        // 重置表單 (移除 window.confirm)
        function resetForm() {
            // 強制重置表單元素
            document.getElementById('contractForm').reset();
            
            // 1. 重置實習類型 -> 回到初始狀態
            const panelInit = document.getElementById('panel_initial');
            const panelLearn = document.getElementById('panel_learn');
            const panelWork = document.getElementById('panel_work');
            panelInit.classList.remove('hidden');
            panelLearn.classList.add('hidden');
            panelWork.classList.add('hidden');

            // 2. 重置待遇輸入框
            document.getElementById('learn_amt_box').classList.add('hidden');
            
            // 3. 重置福利金額輸入框
            document.getElementById('dorm_cost_wrapper').classList.add('hidden');
            document.getElementById('food_cost_wrapper').classList.add('hidden');
            document.getElementById('trans_cost_wrapper').classList.add('hidden');
            
            // 4. 重置學生人數
            document.getElementById('student_count').value = 1;
            document.getElementById('student_count_display').innerText = "1 人";
            renderStudents();
            
            // 5. 回到頂部
            window.scrollTo(0, 0);
            showMsg("已清除所有表單資料。");
        }

        // 學生人數控制 (無上限)
        function changeStudentCount(delta) {
            const input = document.getElementById('student_count');
            let val = parseInt(input.value) || 1;
            val += delta;
            if (val < 1) val = 1;
            input.value = val;
            document.getElementById('student_count_display').innerText = val + " 人";
            renderStudents();
        }

        // 渲染學生欄位
        function renderStudents() {
            const count = Number(document.getElementById('student_count').value) || 1;
            const c = document.getElementById('student_container');
            
            const currentChildren = c.children.length;
            if (count > currentChildren) {
                for (let i = currentChildren; i < count; i++) {
                    const wrapper = document.createElement('div');
                    wrapper.className = "p-5 bg-gray-50 rounded-lg border border-gray-200 mb-4 relative fade-in";
                    wrapper.innerHTML = `
                        <div class="absolute -top-3 -left-2 bg-white border border-gray-200 px-3 py-1 rounded text-xs font-bold text-thuBlue shadow-sm">
                            學生 ${i+1}
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-5 mt-2">
                            <div>
                                <label class="block text-xs font-bold text-gray-500 uppercase mb-1">姓名</label>
                                <input type="text" id="s_name_${i}" class="input-field">
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-gray-500 uppercase mb-1">系級 / 學號</label>
                                <input type="text" id="s_id_${i}" class="input-field">
                            </div>
                        </div>
                    `;
                    c.appendChild(wrapper);
                }
            } else if (count < currentChildren) {
                while (c.children.length > count) {
                    c.removeChild(c.lastChild);
                }
            }
        }

        function toggleType() {
            const tEl = document.querySelector('input[name="contract_type"]:checked');
            const t = tEl ? tEl.value : null;
            
            const panelInit = document.getElementById('panel_initial');
            const panelLearn = document.getElementById('panel_learn');
            const panelWork = document.getElementById('panel_work');
            
            if (t === 'learn') {
                panelInit.classList.add('hidden');
                panelLearn.classList.remove('hidden');
                panelWork.classList.add('hidden');
            } else if (t === 'work') {
                panelInit.classList.add('hidden');
                panelLearn.classList.add('hidden');
                panelWork.classList.remove('hidden');
            } else {
                panelInit.classList.remove('hidden');
                panelLearn.classList.add('hidden');
                panelWork.classList.add('hidden');
            }
            togglePayInputs();
        }

        function togglePayInputs() {
            try {
                const box = document.getElementById('learn_amt_box');
                const sel = document.querySelector('input[name="pay_opt_learn"]:checked');
                const v = sel ? sel.value : 'none';
                if (box) box.classList.toggle('hidden', v === 'none');
            } catch (e) { console.warn(e); }
        }

        function toggleCost(prefix) {
            try {
                const optEl = document.getElementById(prefix + '_opt');
                const wrapperEl = document.getElementById(prefix + '_cost_wrapper');
                const v = optEl ? optEl.value : 'none';
                
                if (v === 'paid' || v === 'subsidy') wrapperEl.classList.remove('hidden');
                else wrapperEl.classList.add('hidden');
            } catch (e) { console.warn(e); }
        }

        // 驗證表單 (必填檢查)
        function validateForm() {
            let isValid = true;
            let errorMsg = "";
            
            // 清除上次的錯誤標記
            document.querySelectorAll('.bg-red-50').forEach(el => el.classList.remove('bg-red-50', 'border-red-200'));
            document.querySelectorAll('.input-error').forEach(el => el.classList.remove('input-error'));

            // 檢查機構必填欄位
            const requiredFields = [
                { id: 'company_tax_id', name: '統一編號' },
                { id: 'company_name', name: '機構全銜' },
                { id: 'company_rep', name: '代表人姓名' },
                { id: 'company_title', name: '代表人職稱' },
                { id: 'reg_address', name: '公司登記地址' }
            ];

            requiredFields.forEach(field => {
                const el = document.getElementById(field.id);
                if (!el || !el.value.trim()) {
                    el.classList.add('input-error');
                    isValid = false;
                    errorMsg += `• 請填寫 ${field.name}\n`;
                }
            });

            // 檢查實習類型 (卡片 4)
            const contractType = document.querySelector('input[name="contract_type"]:checked');
            if (!contractType) {
                document.getElementById('type-section').classList.add('bg-red-50', 'border-red-200');
                isValid = false;
                errorMsg += "• 請選擇實習類型\n";
            } else {
                if (contractType.value === 'learn') {
                    const payOpt = document.querySelector('input[name="pay_opt_learn"]:checked');
                    if (!payOpt) {
                        document.getElementById('pay-section').classList.add('bg-red-50', 'border-red-200');
                        isValid = false;
                        errorMsg += "• 請選擇學習型給付項目\n";
                    } else if (payOpt.value !== 'none') {
                        const amt = document.getElementById('learn_amount');
                        if (!amt.value) {
                            amt.classList.add('input-error');
                            isValid = false;
                            errorMsg += "• 請輸入獎學金/津貼金額\n";
                        }
                    }
                } else if (contractType.value === 'work') {
                    const amt = document.getElementById('work_amount');
                    if (!amt.value) {
                        amt.classList.add('input-error');
                        isValid = false;
                        errorMsg += "• 請輸入薪資金額\n";
                    }
                }
            }

            // 檢查福利項目 (卡片 4)
            ['dorm', 'food', 'trans'].forEach(p => {
                const val = document.getElementById(p + '_opt').value;
                if (!val) {
                    document.getElementById('welfare-section').classList.add('bg-red-50', 'border-red-200');
                    isValid = false;
                    errorMsg += `• 請選擇${p==='dorm'?'住宿':p==='food'?'膳食':'交通'}福利\n`;
                }
            });

            if (!isValid) {
                showError("請填寫所有必填欄位：\n" + errorMsg);
            }
            return isValid;
        }

        // 移除 cleanXML 函數，改為依賴模板中穩定的 Docxtemplater Hashtag 語法。
        function cleanXML(xmlStr) {
             // 替換打勾符號為實心方塊
            xmlStr = xmlStr.replace(/☑/g, '■'); 
            
            // 僅執行最基本的 XML 清除，不進行複雜的標籤修復
            try {
                xmlStr = xmlStr.replace(/<w:(proofErr|gramE|lang|bookmarkStart|bookmarkEnd|rsid[^ >]*)[^>]*\/?>/g, "");
                xmlStr = xmlStr.replace(/<w:del[^>]*>[\s\S]*?<\/w:del>/g, "");
                xmlStr = xmlStr.replace(/<w:ins[^>]*>/g, "").replace(/<\/w:ins>/g, "");
                return xmlStr;
            } catch (e) { console.warn('cleanXML failed', e); return xmlStr; }
        }

        // 【新增】透過統一編號查詢公司資料並自動填入表單
        async function getCompanyInfo() {
            const taxIdInput = document.getElementById('company_tax_id');
            const taxId = taxIdInput.value.trim();

            // API URL: https://data.gcis.nat.gov.tw/od/data/api/5F64D864-61CB-4D0D-8AD9-492047CC1EA6?$format=json&$filter=Business_Accounting_NO eq {Business_Accounting_NO}&$skip={skip}&$top={top}
            
            // 由於瀏覽器 CORS 限制，使用 CORS 代理服務 (corsproxy.io) 來發送請求
            const originalApiURL = `https://data.gcis.nat.gov.tw/od/data/api/5F64D864-61CB-4D0D-8AD9-492047CC1EA6?$format=json&$filter=Business_Accounting_NO eq ${taxId}&$skip=0&$top=1`;
            const apiURL = `https://corsproxy.io/?${encodeURIComponent(originalApiURL)}`;

            const btn = document.getElementById('genBtn');
            const queryBtn = document.getElementById('queryBtn');
            
            // 檢查統編格式 (8 碼)
            if (!taxId || taxId.length !== 8) {
                showMsg("統一編號格式錯誤 (須為 8 碼)");
                // 暫時將 input 標註錯誤樣式
                taxIdInput.classList.add('input-error');
                setTimeout(() => taxIdInput.classList.remove('input-error'), 3000);
                return;
            }
            taxIdInput.classList.remove('input-error');
            
            // 暫存按鈕原始狀態 (用於恢復)
            const originalQueryBtnHtml = queryBtn.innerHTML;
            
            try {
                showMsg("正在查詢公司資料...");
                
                // 禁用按鈕並顯示載入狀態
                btn.disabled = true;
                queryBtn.disabled = true;
                queryBtn.classList.add('bg-gray-400', 'cursor-not-allowed');
                queryBtn.classList.remove('btn-query');
                queryBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> 查詢中...';
                
                // 使用 exponential backoff 處理 API 呼叫 (最多 3 次)
                let response;
                const maxRetries = 3;
                for (let i = 0; i < maxRetries; i++) {
                    try {
                        // 使用代理 URL 進行 fetch 請求
                        response = await fetch(apiURL);
                        if (response.ok) break; 
                    } catch (error) {
                        if (i === maxRetries - 1) throw error; 
                        await new Promise(resolve => setTimeout(resolve, Math.pow(2, i) * 1000)); 
                    }
                }

                if (!response.ok) {
                    throw new Error(`API 請求失敗: HTTP 狀態碼 ${response.status}`);
                }

                const data = await response.json();

                if (!data || data.length === 0) {
                    showMsg(`查無統一編號 ${taxId} 的公司資料。`);
                    // 清空相關欄位
                    document.getElementById('company_name').value = "";
                    document.getElementById('company_rep').value = "";
                    document.getElementById('reg_address').value = "";
                    return;
                }

                // 取得第一個結果
                const company = data[0];

                // 提取所需欄位：Responsible_Name, Company_Name, Company_Location
                const companyName = company.Company_Name || ""; // 機構全銜
                const responsibleName = company.Responsible_Name || ""; // 代表人姓名
                const companyLocation = company.Company_Location || ""; // 公司登記地址

                // 自動填入表單欄位
                document.getElementById('company_name').value = companyName;
                document.getElementById('company_rep').value = responsibleName;
                document.getElementById('reg_address').value = companyLocation;
                
                // 清空實習地點，避免混淆
                document.getElementById('branch_name').value = "";
                document.getElementById('branch_addr').value = "";

                showMsg(`「 ${companyName} 」公司資料已自動填入。`);

            } catch (e) {
                showError(`查詢公司資料時發生錯誤：${e.message || e}`);
                console.error("API Error:", e);
            } finally {
                // 恢復查詢按鈕的狀態
                queryBtn.disabled = false;
                queryBtn.classList.remove('bg-gray-400', 'cursor-not-allowed');
                queryBtn.classList.add('btn-query');
                queryBtn.innerHTML = originalQueryBtnHtml;
                
                // 恢復產生按鈕的狀態
                if (typeof PizZip !== 'undefined' && typeof window.docxtemplater !== 'undefined') {
                     btn.disabled = false;
                     btn.classList.remove('bg-gray-400', 'cursor-not-allowed', 'shadow-none', 'opacity-75');
                     btn.classList.add('btn-generate');
                     btn.innerHTML = '<i class="fa-regular fa-file-word"></i> 產生合約文件 (Word)';
                }
            }
        }

        // 產生文件主流程
        async function generateDoc() {
            if (!validateForm()) return;

            const btn = document.getElementById('genBtn');
            try {
                if (typeof PizZip === 'undefined' || typeof window.docxtemplater === 'undefined' || typeof saveAs === 'undefined') {
                    showError("核心元件未載入，請確認網路連線。");
                    return;
                }
                showMsg("處理中...");
                btn.disabled = true;
                btn.classList.remove('btn-generate'); 
                btn.classList.add('bg-gray-400', 'cursor-not-allowed', 'shadow-none');
                btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> 處理中...';

                const data = {};
                try {
                    data.company_name = (document.getElementById('company_name')?.value || "未填寫");
                    data.company_tax_id = (document.getElementById('company_tax_id')?.value || "");
                    data.company_rep = (document.getElementById('company_rep')?.value || "");
                    data.company_title = (document.getElementById('company_title')?.value || "");
                    const regAddr = document.getElementById('reg_address')?.value || "";
                    data.company_address = regAddr;

                    // 固定欄位直接取值
                    const bname = document.getElementById('branch_name')?.value || "";
                    const baddr = document.getElementById('branch_addr')?.value || "";
                    if (bname && baddr) data.intern_location = `${bname}（${baddr}）`;
                    else if (baddr) data.intern_location = baddr;
                    else data.intern_location = regAddr;

                    const sCount = Number(document.getElementById('student_count').value) || 1;
                    const sList = [];
                    for (let i = 0; i < sCount; i++) {
                        sList.push({
                            name: document.getElementById(`s_name_${i}`)?.value || "",
                            id: document.getElementById(`s_id_${i}`)?.value || ""
                        });
                    }
                    data.student_name = sList[0].name + (sCount > 1 ? " 等" : "");
                    
                    // 核心：準備 Loop 用的 students 陣列
                    const alphabet = ['A', 'B', 'C', 'D', 'E', 'F', 'G', 'H', 'I', 'J', 'K', 'L', 'M', 'N', 'O', 'P', 'Q', 'R', 'S', 'T', 'U', 'V', 'W', 'X', 'Y', 'Z'];
                    // 將學生資訊組裝成 Docxtemplater Hashtag 迴圈需要的格式
                    data.students = sList.filter(s => s.name).map((s, index) => ({
                        letter: alphabet[index] || (index + 1), // 迴圈中的變數 letter
                        name: s.name, // 迴圈中的變數 name
                        id: s.id,
                    }));
                    // 填補原本固定的 s1, s2, s3 欄位 (確保相容舊版模板)
                    data.s1_name = data.students[0]?.name || "";
                    data.s2_name = data.students[1]?.name || "";
                    data.s3_name = data.students[2]?.name || "";


                    data.s_y = document.getElementById('start_y')?.value || "   ";
                    data.s_m = document.getElementById('start_m')?.value || "   ";
                    data.s_d = document.getElementById('start_d')?.value || "   ";
                    data.e_y = document.getElementById('end_y')?.value || "   ";
                    data.e_m = document.getElementById('end_m')?.value || "   ";
                    data.e_d = document.getElementById('end_d')?.value || "   ";

                    data.daily_start = document.getElementById('daily_start')?.value || "";
                    data.daily_end = document.getElementById('daily_end')?.value || "";
                    data.daily_hours = document.getElementById('daily_hours')?.value || "";

                    const type = document.querySelector('input[name="contract_type"]:checked')?.value;
                    data.type_learn_check='□'; data.type_work_check='□';
                    data.chk_pay_none='□'; data.chk_pay_scholar='□'; data.chk_pay_allowance='□';
                    data.pay_learn_amount = ""; data.pay_work_amount = "";

                    if (type === 'learn') {
                        data.type_learn_check = '■'; // 修正: 使用 ■
                        const pOpt = document.querySelector('input[name="pay_opt_learn"]:checked')?.value;
                        if (pOpt === 'none') { data.chk_pay_none = '■'; data.pay_learn_amount = "0"; }
                        else {
                            if (pOpt === 'scholar') data.chk_pay_scholar = '■'; // 修正: 使用 ■
                            else data.chk_pay_allowance = '■'; // 修正: 使用 ■
                            const lam = Number(document.getElementById('learn_amount')?.value || 0);
                            data.pay_learn_amount = lam ? lam.toLocaleString() : "";
                        }
                    } else {
                        data.type_work_check = '■'; // 修正: 使用 ■
                        const wam = Number(document.getElementById('work_amount')?.value || 0);
                        data.pay_work_amount = wam ? wam.toLocaleString() : "";
                    }

                    function setWelfare(prefix) {
                        const opt = document.getElementById(prefix + '_opt')?.value || 'none';
                        data[`chk_${prefix}_none`] = '□'; data[`chk_${prefix}_free`] = '□'; data[`chk_${prefix}_paid`] = '□';
                        if (opt === 'none') data[`chk_${prefix}_none`] = '■'; // 修正: 使用 ■
                        else if (opt === 'free') data[`chk_${prefix}_free`] = '■'; // 修正: 使用 ■
                        else if (prefix === 'trans' && opt === 'subsidy') { // 交通津貼特別處理
                             data.chk_trans_paid = '■'; // 視為付費提供，但描述寫為津貼
                             const val = Number(document.getElementById(prefix + '_cost')?.value || 0);
                             data[`${prefix}_desc`] = val ? val.toLocaleString() : "";
                             data[`${prefix}_cost`] = val ? val.toLocaleString() : "";
                        }
                        else {
                            data[`chk_${prefix}_paid`] = '■'; // 修正: 使用 ■
                            const val = Number(document.getElementById(prefix + '_cost')?.value || 0);
                            data[`${prefix}_desc`] = val ? val.toLocaleString() : "";
                            data[`${prefix}_cost`] = val ? val.toLocaleString() : "";
                        }
                        if (!data[`${prefix}_desc`]) data[`${prefix}_desc`] = "";
                    }
                    setWelfare('dorm'); setWelfare('food'); setWelfare('trans');

                } catch (e) {
                    showError("資料收集錯誤：" + e.message);
                    return; 
                }

                // 自動讀取 template.docx
                let arrayBuffer;
                try {
                    // 檔案名稱使用 template.docx
                    const resp = await fetch('./template.docx'); 
                    if (!resp.ok) throw new Error('找不到 template.docx（請確認檔案是否存在於根目錄）');
                    arrayBuffer = await resp.arrayBuffer();
                } catch (e) {
                    showError("讀取內建範本失敗：" + e.message);
                    return;
                }

                // 解析 zip
                let zip;
                try {
                    zip = new PizZip(arrayBuffer);
                } catch (e) {
                    showError("範本格式錯誤：" + e.message);
                    return;
                }

                // 清洗
                try {
                    const docFile = zip.file("word/document.xml");
                    if (docFile) {
                        const raw = docFile.asText();
                        const cleaned = cleanXML(raw); // 僅做基本清洗
                        zip.file("word/document.xml", cleaned);
                    }
                } catch (e) { console.warn("XML 清洗失敗，可能影響渲染", e); }

                // Render
                try {
                    const Docxtemplater = window.docxtemplater || docxtemplater;
                    const doc = new Docxtemplater(zip, {
                        paragraphLoop: true,
                        linebreaks: true,
                        delimiters: { start: '%%%', end: '%%%' },
                        nullGetter: function(part) { return ""; }
                    });

                    doc.render(data);
                    const out = doc.getZip().generate({
                        type: "blob",
                        mimeType: "application/vnd.openxmlformats-officedocument.wordprocessingml.document"
                    });

                    const fname = `東海大學實習合約_${(data.s1_name || '學生')}.docx`;
                    saveAs(out, fname);
                    showMsg("下載成功！");
                } catch (error) {
                    if (error && error.properties && error.properties.errors) {
                        const msgs = error.properties.errors.map(e => `錯誤: ${e.properties?.explanation}`).join("\n");
                        showError("標籤錯誤：\n" + msgs);
                    } else {
                        showError("產生錯誤：" + (error.message || error));
                    }
                }

            } catch (outer) {
                console.error(outer);
                showError('系統錯誤：' + outer);
            } finally {
                // 無論成功或失敗，都重設按鈕狀態
                btn.disabled = false;
                btn.classList.remove('bg-gray-400', 'cursor-not-allowed', 'shadow-none');
                btn.classList.add('btn-generate');
                btn.innerHTML = '<i class="fa-regular fa-file-word"></i> 產生合約文件 (Word)';
            }
        }

        window.onload = function() {
            renderStudents();

            if (typeof PizZip === 'undefined' || typeof window.docxtemplater === 'undefined') {
                document.getElementById('lib-error').style.display = 'block';
                document.getElementById('missing-lib').innerText = "核心元件";
            } else {
                const btn = document.getElementById('genBtn');
                btn.disabled = false;
                btn.classList.remove('bg-gray-400', 'cursor-not-allowed', 'opacity-75');
                btn.classList.add('btn-generate');
                btn.innerHTML = '<i class="fa-regular fa-file-word"></i> 產生合約文件 (Word)';
            }

            toggleType();
            togglePayInputs();
            toggleCost('dorm');
            toggleCost('food');
            toggleCost('trans');

            // 【變更】移除統編欄位的 change 事件監聽
            // 【新增】統編查詢按鈕的 click 事件監聽
            const queryBtn = document.getElementById('queryBtn');
            if (queryBtn) {
                queryBtn.addEventListener('click', getCompanyInfo);
            }
        };
    </script>
</body>
</html>
