<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>東海大學學生校外實習合約產生系統 (PyScript)</title>
    
    <!-- 1. 引入 PyScript (改用 2022.12.1 穩定版，避開 Plugin 錯誤) -->
    <script src="https://pyscript.net/releases/2022.12.1/pyscript.js"></script>
    <!-- 不引入 pyscript.css，避免樣式干擾，因為我們不需要顯示終端機 -->

    <!-- 2. 其他介面函式庫 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/pizzip@3.1.4/dist/pizzip.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/docxtemplater/3.37.11/docxtemplater.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/1.3.8/FileSaver.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script>
        tailwind.config = { theme: { extend: { colors: { thuBlue: '#002E5D', thuGold: '#C6A87C' } } } }
    </script>
    <style>
        body { background-color: #f3f4f6; font-family: 'Noto Sans TC', sans-serif; padding-bottom: 80px; }
        .input-field { background-color: white; border: 1px solid #d1d5db; border-radius: 0.375rem; padding: 0.5rem; width: 100%; }
        .card { background: white; border-radius: 0.5rem; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); overflow: hidden; margin-bottom: 1.5rem; }
        .card-header { padding: 1rem 1.5rem; border-bottom: 1px solid #e5e7eb; color: #002E5D; font-weight: 700; font-size: 1.125rem; display: flex; align-items: center; }
        .border-top-blue { border-top: 4px solid #002E5D; }
        .border-top-gold { border-top: 4px solid #C6A87C; }
        .hidden { display: none; }
        /* Loading 遮罩 */
        #loading { display: flex; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 9999; align-items: center; justify-content: center; color: white; font-size: 1.2rem; flex-direction: column; }
        /* PyScript 載入狀態 */
        #py-status { margin-top: 10px; font-size: 0.9rem; color: #aaa; }
    </style>
</head>
<body>

    <!-- 全局 Loading 遮罩 -->
    <div id="loading">
        <i class="fa-solid fa-spinner fa-spin fa-3x mb-4 text-thuGold"></i>
        <span>系統初始化中 (正在下載 Python 核心)...</span>
        <span id="py-status">首次載入約需 10 秒，請稍候</span>
    </div>

    <!-- 隱藏的 Python 邏輯區塊 -->
    <py-script>
        import js
        import io
        import zipfile
        import re
        # 2022.12.1 版本不需要 from js import console，直接 print 會導向 console

        def clean_word_xml_py(file_content_bytes):
            try:
                print("Python: 開始清洗 Word XML...")
                
                # 轉換 JS Proxy 到 Python bytes
                try:
                    data_bytes = bytes(file_content_bytes.to_py())
                except:
                    # 舊版相容
                    data_bytes = bytes(file_content_bytes)

                bio_in = io.BytesIO(data_bytes)
                bio_out = io.BytesIO()

                with zipfile.ZipFile(bio_in, 'r') as zin:
                    with zipfile.ZipFile(bio_out, 'w') as zout:
                        for item in zin.infolist():
                            content = zin.read(item.filename)
                            
                            if item.filename == 'word/document.xml':
                                xml_str = content.decode('utf-8')
                                
                                # 1. 移除 Word 校對標記
                                xml_str = re.sub(r'<w:proofErr[^>]*/>', '', xml_str)
                                xml_str = re.sub(r'<w:gramE[^>]*/>', '', xml_str)
                                xml_str = re.sub(r'<w:lang[^>]*/>', '', xml_str)
                                
                                # 2. 移除追蹤修訂
                                xml_str = re.sub(r'<w:del[^>]*>.*?</w:del>', '', xml_str, flags=re.DOTALL)
                                xml_str = re.sub(r'<w:ins[^>]*>', '', xml_str)
                                xml_str = re.sub(r'</w:ins>', '', xml_str)

                                # 3. 終極標籤修復
                                xml_str = re.sub(r'<w:t[^>]*>({)</w:t>.*?<w:t[^>]*>({)</w:t>', '<w:t>{{</w:t>', xml_str, flags=re.DOTALL)
                                xml_str = re.sub(r'<w:t[^>]*>(})</w:t>.*?<w:t[^>]*>(})</w:t>', '<w:t>}}</w:t>', xml_str, flags=re.DOTALL)
                                
                                content = xml_str.encode('utf-8')
                            
                            zout.writestr(item, content)
                
                print("Python: 清洗完成")
                return bio_out.getvalue()
            except Exception as e:
                print(f"Python Error: {str(e)}")
                return None

        # 將 Python 函式暴露給 JS
        js.window.clean_word_xml_py = clean_word_xml_py
        
        # 通知 JS Python 已就緒
        js.window.pythonReady()
    </py-script>

    <!-- Header -->
    <div class="fixed top-0 left-0 w-full h-[70px] bg-thuBlue text-white z-50 flex items-center justify-between px-4 md:px-8 shadow-md">
        <div class="flex items-center gap-3">
            <div class="w-10 h-10 bg-white rounded-full flex items-center justify-center text-thuBlue font-bold text-xl">
                <i class="fa-solid fa-university"></i>
            </div>
            <div>
                <div class="text-lg md:text-xl font-bold tracking-wide">東海大學</div>
                <div class="text-xs text-thuGold opacity-90">學生校外實習合約產生系統</div>
            </div>
        </div>
        <div class="hidden md:block">
            <span class="text-sm bg-thuBlue border border-thuGold px-3 py-1 rounded-full text-thuGold">
                <i class="fa-solid fa-user-tie mr-1"></i> 承辦人員模式
            </span>
        </div>
    </div>

    <!-- 步驟條 -->
    <div class="mt-28 mb-8 px-4 md:px-8 max-w-5xl mx-auto flex justify-between items-center relative">
        <div class="flex flex-col items-center z-10"><div class="w-8 h-8 bg-thuBlue text-white rounded-full flex items-center justify-center font-bold mb-1">1</div><span class="text-xs md:text-sm font-medium">機構資料</span></div>
        <div class="flex-1 h-1 bg-gray-300 mx-2 md:mx-4"></div>
        <div class="flex flex-col items-center z-10"><div class="w-8 h-8 bg-thuBlue text-white rounded-full flex items-center justify-center font-bold mb-1">2</div><span class="text-xs md:text-sm font-medium">學生資料</span></div>
        <div class="flex-1 h-1 bg-gray-300 mx-2 md:mx-4"></div>
        <div class="flex flex-col items-center z-10"><div class="w-8 h-8 bg-thuBlue text-white rounded-full flex items-center justify-center font-bold mb-1">3</div><span class="text-xs md:text-sm font-medium">條件設定</span></div>
    </div>

    <!-- 主要表單 -->
    <main class="max-w-5xl mx-auto px-4">
        <!-- 卡片 1: 機構 -->
        <div class="card border-top-blue">
            <div class="card-header bg-gray-50"><i class="fa-regular fa-building mr-2"></i> 乙方：實習機構資料</div>
            <div class="p-6 grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="md:col-span-2"><label class="text-sm text-gray-500">機構全銜 (法定名稱)</label><input type="text" id="company_name" class="input-field" placeholder="例：國泰世華商業銀行股份有限公司"></div>
                <div><label class="text-sm text-gray-500">統一編號</label><input type="text" id="company_tax_id" class="input-field"></div>
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="text-sm text-gray-500">代表人</label><input type="text" id="company_rep" class="input-field"></div>
                    <div><label class="text-sm text-gray-500">職稱</label><input type="text" id="company_title" class="input-field" value="負責人"></div>
                </div>
                <div class="md:col-span-2"><label class="text-sm text-gray-500">地址</label><input type="text" id="reg_address" class="input-field"></div>
                <div class="md:col-span-2 pt-2"><label class="flex items-center gap-2 text-sm font-bold text-gray-600"><input type="checkbox" id="is_branch" onchange="toggleBranch()"> 實習地點不同 (如分公司)</label><div id="branch_area" class="grid grid-cols-2 gap-4 mt-2 hidden"><input type="text" id="branch_name" class="input-field" placeholder="分公司名稱"><input type="text" id="branch_addr" class="input-field" placeholder="實際地址"></div></div>
            </div>
        </div>

        <!-- 卡片 2: 學生 -->
        <div class="card border-top-blue">
            <div class="card-header flex justify-between"><div><i class="fa-solid fa-user-graduate mr-2"></i> 甲方：學生資料</div><select id="student_count" onchange="renderStudents()" class="border rounded px-2 py-1 text-sm"><option value="1">1人</option><option value="2">2人</option><option value="3">3人</option></select></div>
            <div id="student_container" class="p-6 space-y-4"></div>
        </div>

        <!-- 卡片 3: 條件 -->
        <div class="card border-top-gold">
            <div class="card-header"><i class="fa-solid fa-briefcase mr-2"></i> 條件與待遇</div>
            <div class="p-6 space-y-6">
                <div class="flex gap-4">
                    <label class="flex items-center gap-2 p-3 border rounded hover:bg-blue-50 cursor-pointer w-full"><input type="radio" name="contract_type" value="learn" checked onchange="toggleType()"> 一般型 (學習型)</label>
                    <label class="flex items-center gap-2 p-3 border rounded hover:bg-orange-50 cursor-pointer w-full"><input type="radio" name="contract_type" value="work" onchange="toggleType()"> 工作型 (勞資型)</label>
                </div>
                <div class="grid grid-cols-2 gap-4"><div><span class="text-sm text-gray-500">開始</span><input type="date" id="start_date" class="input-field"></div><div><span class="text-sm text-gray-500">結束</span><input type="date" id="end_date" class="input-field"></div></div>
                <div class="grid grid-cols-3 gap-4"><div><span class="text-sm text-gray-500">開始</span><input type="time" id="daily_start" value="09:00" class="input-field"></div><div><span class="text-sm text-gray-500">結束</span><input type="time" id="daily_end" value="18:00" class="input-field"></div><div><span class="text-sm text-gray-500">時數</span><input type="number" id="daily_hours" value="8" step="0.5" class="input-field"></div></div>
                <div class="border-t pt-4">
                    <div id="panel_learn" class="bg-green-50 p-4 rounded border border-green-200"><div class="text-sm font-bold text-green-800 mb-2">學習型給付</div><div class="flex gap-4 mb-2"><label><input type="radio" name="pay_opt_learn" value="none" checked onchange="togglePayInputs()"> 無</label><label><input type="radio" name="pay_opt_learn" value="scholar" onchange="togglePayInputs()"> 獎學金</label><label><input type="radio" name="pay_opt_learn" value="allowance" onchange="togglePayInputs()"> 津貼</label></div><input type="number" id="learn_amount" placeholder="金額" class="input-field w-48 hidden"></div>
                    <div id="panel_work" class="bg-orange-50 p-4 rounded border border-orange-200 hidden"><div class="text-sm font-bold text-orange-800 mb-2">勞資型薪資</div><input type="number" id="work_amount" placeholder="27470" class="input-field w-48"></div>
                </div>
                <div class="grid grid-cols-3 gap-4 pt-4 border-t">
                    <div><label class="text-sm font-bold">住宿</label><select id="dorm_opt" onchange="toggleCost('dorm')" class="input-field"><option value="none">無</option><option value="free">免費</option><option value="paid">付費</option></select><input id="dorm_cost" type="number" placeholder="金額" class="input-field mt-1 hidden"></div>
                    <div><label class="text-sm font-bold">膳食</label><select id="food_opt" onchange="toggleCost('food')" class="input-field"><option value="none">無</option><option value="free">免費</option><option value="paid">付費</option></select><input id="food_cost" type="number" placeholder="金額" class="input-field mt-1 hidden"></div>
                    <div><label class="text-sm font-bold">交通</label><select id="trans_opt" onchange="toggleCost('trans')" class="input-field"><option value="none">無</option><option value="free">免費</option><option value="paid">付費</option><option value="subsidy">交通津貼</option></select><input id="trans_cost" type="number" placeholder="金額" class="input-field mt-1 hidden"></div>
                </div>
            </div>
        </div>

        <!-- 按鈕 -->
        <div class="pb-10 flex flex-col md:flex-row justify-end items-center gap-4">
            <div class="text-sm text-gray-500 bg-gray-200 p-2 rounded flex items-center gap-2"><span class="font-bold text-xs bg-gray-500 text-white px-1 rounded">DEBUG</span><span>若無反應，手動選取：</span><input type="file" id="manual_template" accept=".docx" class="text-xs"></div>
            <button onclick="generateDoc()" id="genBtn" disabled class="bg-gray-400 text-white px-8 py-3 rounded-md font-bold shadow-lg transition flex items-center gap-2 text-lg w-full md:w-auto justify-center cursor-not-allowed">
                <i class="fa-regular fa-file-word"></i> 系統啟動中...
            </button>
        </div>
    </main>

    <!-- JS -->
    <script>
        window.pythonReady = function() {
            const btn = document.getElementById('genBtn');
            btn.disabled = false;
            btn.classList.remove('bg-gray-400', 'cursor-not-allowed');
            btn.classList.add('bg-thuBlue', 'hover:bg-blue-900');
            btn.innerHTML = '<i class="fa-regular fa-file-word"></i> 產生合約文件 (Word)';
            document.getElementById('loading').style.display = 'none';
        };

        window.onload = function() { renderStudents(); };
        function renderStudents() { const count = document.getElementById('student_count').value; const c = document.getElementById('student_container'); c.innerHTML=''; for(let i=0;i<count;i++){ c.innerHTML += `<div class="p-3 bg-blue-50 border border-blue-100 rounded"><div class="text-sm font-bold text-blue-800 mb-2">學生 ${i+1}</div><div class="grid grid-cols-2 gap-4"><input type="text" id="s_name_${i}" placeholder="姓名" class="input-field"><input type="text" id="s_id_${i}" placeholder="系級/學號" class="input-field"></div></div>`; } }
        function toggleBranch() { document.getElementById('branch_area').classList.toggle('hidden', !document.getElementById('is_branch').checked); }
        function toggleType() { const t = document.querySelector('input[name="contract_type"]:checked').value; document.getElementById('panel_learn').classList.toggle('hidden', t !== 'learn'); document.getElementById('panel_work').classList.toggle('hidden', t === 'learn'); }
        function togglePayInputs() { document.getElementById('learn_amt_box').classList.toggle('hidden', document.querySelector('input[name="pay_opt_learn"]:checked').value === 'none'); }
        function toggleCost(p) { const v = document.getElementById(p+'_opt').value; const i = document.getElementById(p+'_cost'); if(v==='paid'||v==='subsidy') i.classList.remove('hidden'); else i.classList.add('hidden'); }

        async function generateDoc() {
            const btn = document.getElementById('genBtn');
            btn.disabled = true;
            btn.innerText = "正在修復並產生...";

            try {
                const data = {};
                // ... (資料收集邏輯同上，簡化以節省空間)
                data.company_name = document.getElementById('company_name').value || "未填寫";
                data.company_tax_id = document.getElementById('company_tax_id').value;
                data.company_rep = document.getElementById('company_rep').value;
                data.company_title = document.getElementById('company_title').value;
                const regAddr = document.getElementById('reg_address').value;
                data.company_address = document.getElementById('is_branch').checked ? `${regAddr} (實習地點：${document.getElementById('branch_name').value} - ${document.getElementById('branch_addr').value})` : regAddr;
                const sCount = document.getElementById('student_count').value;
                const sList = [];
                for(let i=0;i<sCount;i++) sList.push({name:document.getElementById(`s_name_${i}`).value,id:document.getElementById(`s_id_${i}`).value});
                while(sList.length<3)sList.push({name:"",id:""});
                data.s1_name = sList[0].name; data.s1_id = sList[0].id; data.s2_name = sList[1].name; data.s2_id = sList[1].id; data.s3_name = sList[2].name; data.s3_id = sList[2].id; data.student_name = sList[0].name + (sCount > 1 ? " 等" : "");
                const sDate = new Date(document.getElementById('start_date').value);
                const eDate = new Date(document.getElementById('end_date').value);
                data.s_y = isNaN(sDate) ? "" : sDate.getFullYear()-1911; data.s_m = isNaN(sDate) ? "" : sDate.getMonth()+1; data.s_d = isNaN(sDate) ? "" : sDate.getDate();
                data.e_y = isNaN(eDate) ? "" : eDate.getFullYear()-1911; data.e_m = isNaN(eDate) ? "" : eDate.getMonth()+1; data.e_d = isNaN(eDate) ? "" : eDate.getDate();
                data.daily_start = document.getElementById('daily_start').value;
                data.daily_end = document.getElementById('daily_end').value;
                data.daily_hours = document.getElementById('daily_hours').value;
                const type = document.querySelector('input[name="contract_type"]:checked').value;
                data.type_learn_check = type==='learn'?'☑':'□'; data.type_work_check = type==='work'?'☑':'□';
                data.chk_pay_none='□'; data.chk_pay_scholar='□'; data.chk_pay_allowance='□'; data.pay_learn_amount=""; data.pay_work_amount="";
                if(type==='learn'){
                    const po = document.querySelector('input[name="pay_opt_learn"]:checked').value;
                    if(po==='none'){data.chk_pay_none='☑';data.pay_learn_amount="0";}
                    else{data[po==='scholar'?'chk_pay_scholar':'chk_pay_allowance']='☑';data.pay_learn_amount=Number(document.getElementById('learn_amount').value).toLocaleString();}
                }else{data.type_work_check='☑';data.pay_work_amount=Number(document.getElementById('work_amount').value).toLocaleString();}
                ['dorm','food','trans'].forEach(p=>{
                    const v = document.getElementById(p+'_opt').value;
                    data[`chk_${p}_none`] = v==='none'?'☑':'□'; data[`chk_${p}_free`] = v==='free'?'☑':'□'; data[`chk_${p}_paid`] = (v==='paid'||v==='subsidy')?'☑':'□';
                    if(v==='paid'||v==='subsidy') data[`${p}_cost`] = Number(document.getElementById(p+'_cost').value).toLocaleString();
                });

                let content = null;
                const manualFile = document.getElementById('manual_template').files[0];
                if (manualFile) {
                    content = await manualFile.arrayBuffer();
                } else {
                    const resp = await fetch('./template.docx');
                    if (!resp.ok) throw new Error("找不到 template.docx");
                    content = await resp.arrayBuffer();
                }

                // 呼叫 Python (V13 修改: 確保轉換型別)
                const uint8Arr = new Uint8Array(content);
                const cleanedBytes = window.clean_word_xml_py(uint8Arr);

                if (!cleanedBytes) throw new Error("Python 清洗失敗");

                const cleanedArray = cleanedBytes.toJs(); 
                const zip = new PizZip(cleanedArray);
                
                const doc = new window.docxtemplater(zip, { paragraphLoop: true, linebreaks: true });
                doc.render(data);
                
                const out = doc.getZip().generate({ type: "blob", mimeType: "application/vnd.openxmlformats-officedocument.wordprocessingml.document" });
                saveAs(out, `東海大學實習合約_${data.s1_name}.docx`);
                
                alert("下載成功！");

            } catch (e) {
                console.error(e);
                alert("錯誤：" + e.message);
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="fa-regular fa-file-word"></i> 產生合約文件 (Word)';
            }
        }
    </script>
</body>
</html>
