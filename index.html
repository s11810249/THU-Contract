<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>東海大學學生校外實習文件產生器 (V1.0.56 Debug)</title>

    <!-- 核心函式庫 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/pizzip@3.1.4/dist/pizzip.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/docxtemplater/3.37.11/docxtemplater.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/1.3.8/FileSaver.js"></script>
    <!-- 新增 SheetJS 用於解析 Excel -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- JSZip 用於 ZIP 打包 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>

    <!-- 東海配色 -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        thuBlue: '#002E5D',
                        thuGold: '#C6A87C',
                    },
                    fontFamily: {
                        sans: ['"Noto Sans TC"', 'sans-serif'],
                    }
                }
            }
        }
    </script>

    <style>
        body {
            background-color: #f3f4f6;
            font-family: 'Noto Sans TC', sans-serif;
            padding-bottom: 100px; 
            color: #374151;
            scroll-behavior: smooth;
        }
        
        /* 通用輸入框樣式 */
        .input-field {
            background-color: white;
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            padding: 0.6rem 0.8rem;
            width: 100%;
            font-size: 1rem;
            transition: all 0.2s ease;
        }
        .input-field:focus {
            outline: none;
            border-color: #002E5D;
            box-shadow: 0 0 0 3px rgba(0, 46, 93, 0.1);
        }
        .input-error {
            border-color: #ef4444 !important;
            background-color: #fef2f2 !important;
        }
        
        /* Plan Table Textarea Style for Page 4 */
        .proposal-textarea {
            resize: vertical;
            min-height: 4.5rem; /* 約三行的高度 */
            line-height: 1.25rem;
            padding: 0.5rem 0.75rem;
            font-size: 0.85rem;
        }

        /* 移除數字輸入框的上下箭頭 */
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { 
            -webkit-appearance: none; 
            margin: 0; 
        }
        input[type=number] { -moz-appearance: textfield; }

        /* 日期群組 - 強化置中 */
        .date-group {
            display: flex;
            align-items: center;
            justify-content: center; /* 水平置中 */
            background: white;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            padding: 0.4rem;
            transition: all 0.2s ease;
            overflow: hidden;
            height: 42px; /* 確保與 input-field 相同高度 */
        }
        .date-group:focus-within {
            border-color: #002E5D;
            box-shadow: 0 0 0 3px rgba(0, 46, 93, 0.1);
        }
        .date-input {
            border: none;
            text-align: center !important; /* 文字置中 */
            width: 100%;
            min-width: 2.5rem;
            outline: none;
            font-size: 1rem;
            color: #374151;
            background: transparent;
            padding: 0;
            height: 100%;
        }
        .date-sep { color: #9ca3af; font-weight: bold; padding: 0 0.1rem; user-select: none; flex-shrink: 0; }
        
        /* 修正年級輸入框的樣式，使其與 input-field 等高 */
        .grade-input-group {
            display: flex;
            align-items: center;
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            background-color: white;
            height: 42px; /* 確保與 input-field 相同的高度 */
        }
        .grade-input-group:focus-within {
            outline: none;
            border-color: #002E5D;
            box-shadow: 0 0 0 3px rgba(0, 46, 93, 0.1);
        }
        .grade-input-field {
            border: none;
            padding: 0 0.1rem; /* 調整內邊距 */
            text-align: center !important;
            flex-grow: 1;
            outline: none;
            font-size: 1rem;
            background: transparent;
            height: 100%;
        }
        .grade-suffix {
            color: #374151;
            padding-right: 0.8rem;
            font-size: 1rem;
            font-weight: 500;
            flex-shrink: 0;
        }

        /* 學生刪除按鈕樣式 */
        .delete-student-btn {
            position: absolute; 
            top: -12px; 
            right: -12px;
            width: 32px; 
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 9999px; 
            background-color: #fef2f2; 
            color: #ef4444; 
            transition: all 0.2s ease-out;
            z-index: 10;
            opacity: 0; /* 預設隱藏 */
            cursor: pointer;
        }

        .student-wrapper:hover .delete-student-btn {
            opacity: 1; /* 靠近時顯示 */
            background-color: #ef4444; 
            color: white;
            transform: scale(1.1);
        }


        /* 卡片樣式 */
        .card { 
            background: white; 
            border-radius: 0.75rem; 
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05); 
            border: 1px solid #e5e7eb;
            overflow: hidden; 
            margin-bottom: 2rem; 
            transition: border-color 0.3s;
        }
        .card-header { 
            padding: 1.25rem 2rem; 
            background-color: #ffffff;
            border-bottom: 1px solid #f3f4f6; 
            color: #002E5D; 
            font-weight: 700; 
            font-size: 1.125rem; 
            display: flex; 
            align-items: center;
            justify-content: space-between; 
        }
        .card-header-title {
            display: flex;
            align-items: center;
        }
        .card-header-title::before {
            content: '';
            display: inline-block;
            width: 5px;
            height: 1.2rem;
            background-color: #C6A87C;
            margin-right: 0.75rem;
            border-radius: 2px;
        }
        /* 隱藏 */
        .hidden { display: none; }
        
        /* 狀態/錯誤訊息 */
        #status-bar { display: none; position: fixed; bottom: 80px; right: 20px; background: #333; color: white; padding: 8px 16px; border-radius: 6px; z-index: 9999; box-shadow: 0 4px 12px rgba(0,0,0,0.3); font-size: 0.9rem; }
        #lib-error { display: none; position: fixed; top: 0; left: 0; width: 100%; background: #ef4444; color: white; text-align: center; padding: 10px; z-index: 9999; font-weight: bold; }
        #error-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10000; align-items: center; justify-content: center; }
        #error-content { background: white; padding: 2rem; border-radius: 1rem; max-width: 600px; width: 90%; max-height: 80%; overflow-y: auto; }
        pre { white-space: pre-wrap; word-break: break-word; }

        footer {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background-color: #1f2937;
            color: #9ca3af;
            text-align: center;
            padding: 1rem 0;
            font-size: 0.75rem;
            z-index: 50;
            border-top: 3px solid #C6A87C;
        }
        
        /* 提示框動畫 */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .fade-in { animation: fadeIn 0.3s ease-out; }
        
        /* 查詢按鈕樣式 */
        .btn-query {
            background-color: #C6A87C;
            color: #002E5D;
            font-weight: bold;
            border-radius: 0.375rem;
            padding: 0.6rem 1.25rem;
            transition: all 0.2s ease;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
        }
        .btn-query:hover:not(:disabled) {
            background-color: #b3976e;
            transform: translateY(-1px);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        .btn-query-loading {
            background: linear-gradient(135deg, #002E5D30 0%, #00408030 100%) !important;
            color: #002E5D !important;
            cursor: not-allowed !important;
            transform: none !important;
            box-shadow: none !important;
        }

        /* 頁籤樣式 */
        .tab-button {
            padding: 0.75rem 1.5rem;
            font-weight: 700;
            border-radius: 0.5rem 0.5rem 0 0;
            transition: all 0.3s;
            border-bottom: 3px solid transparent;
            color: #9ca3af; /* 預設文字顏色 */
            background-color: #f3f4f6;
            margin-right: 0.25rem;
            flex-grow: 1; 
            text-align: center;
        }
        .tab-button.active {
            color: #002E5D; /* 啟用文字顏色 */
            background-color: white;
            border-color: #002E5D; /* 啟用底部顏色 */
            box-shadow: 0 -4px 6px -1px rgba(0, 0, 0, 0.05);
        }
        /* 讓頁籤容器的背景延伸到邊緣，實現等寬視覺效果 */
        .tab-container {
            border-bottom: 1px solid #d1d5db;
            background-color: #f3f4f6;
            padding-top: 1rem;
            position: sticky;
            top: 80px;
            z-index: 20;
        }


        /* Page 4: Table Styles */
        .proposal-table th, .proposal-table td {
            padding: 0.75rem 0.5rem;
            vertical-align: top; /* 調整為頂部對齊，配合 textarea */
            font-size: 0.85rem;
            white-space: nowrap; /* 防止標題換行 */
        }
        .proposal-table th {
            text-align: left;
            background-color: #f9fafb;
            color: #374151;
            border-bottom: 2px solid #e5e7eb;
        }
        .proposal-table tr:nth-child(even) {
            background-color: #ffffff;
        }
        .proposal-table tr:nth-child(odd) {
            background-color: #fefefe;
        }
        .non-editable {
            background-color: #e5e7eb !important;
            color: #4b5563;
            font-weight: 500;
            border: 1px solid #d1d5db;
        }
        .text-xs-force {
            font-size: 0.75rem !important;
        }
        
        /* 導航按鈕樣式 */
        .nav-button {
            background-color: #f0f4ff; /* 淺藍色背景 */
            color: #002E5D; /* 東海藍文字 */
            border: none;
            transition: all 0.2s;
            height: 48px; /* 統一高度 */
            font-weight: 600; /* 加粗 */
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
        }
        .nav-button:hover:not(:disabled) {
            background-color: #e3e9ff; /* 懸停時顏色稍深 */
            color: #002E5D;
            transform: translateY(-1px);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        /* 文件產出按鈕樣式 (New style for genContractBtn/genProposalBtn) */
        .btn-generate {
            height: 64px; /* Primary Action Button Height */
            background: linear-gradient(135deg, #002E5D 0%, #004080 100%);
            box-shadow: 0 4px 6px -1px rgba(0, 46, 93, 0.3), 0 2px 4px -1px rgba(0, 46, 93, 0.1);
            transition: all 0.3s ease;
            color: white;
        }
        .btn-generate:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0, 46, 93, 0.3), 0 4px 6px -2px rgba(0, 46, 93, 0.1);
            background: linear-gradient(135deg, #003366 0%, #0055aa 100%);
        }
        .btn-generate:active:not(:disabled) {
            transform: translateY(0);
        }
        .btn-generate:disabled {
            background: #9ca3af;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        /* 卡片式 Radio 樣式 (實習待遇) */
        .pay-option-label {
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 1.5rem;
            border: 1px solid #e5e7eb; /* 修正: 使用 1px 邊框 */
            border-radius: 0.75rem;
            cursor: pointer;
            transition: all 0.2s;
            background-color: white;
            height: 100%;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
        }
        .pay-option-label:hover {
            background-color: #f9fafb; /* gray-50 */
            border-color: #cbd5e1; /* gray-300 */
            transform: translateY(-2px);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
        }
        
        .radio-card-input {
            position: absolute;
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        /* 1. 無 (灰色系) */
        .pay-option-none:has(input:checked) { border-color: #475569; background-color: #f1f5f9; box-shadow: 0 0 0 1px #475569; }
        .pay-option-none .pay-option-icon { color: #94a3b8; }
        .pay-option-none:has(input:checked) .pay-option-icon { color: #475569; }
        .pay-option-none:has(input:checked) .pay-option-text { color: #0f172a; }

        /* 2. 獎學金 (金色系) */
        .pay-option-scholar:has(input:checked) { border-color: #b45309; background-color: #fffbeb; box-shadow: 0 0 0 1px #b45309; }
        .pay-option-scholar .pay-option-icon { color: #d97706; }
        .pay-option-scholar:has(input:checked) .pay-option-icon { color: #b45309; }
        .pay-option-scholar:has(input:checked) .pay-option-text { color: #78350f; }

        /* 3. 實習津貼 (深藍色系 - 改為東海藍) */
        .pay-option-allowance:has(input:checked) { border-color: #002E5D; background-color: #f0f9ff; box-shadow: 0 0 0 1px #002E5D; }
        .pay-option-allowance .pay-option-icon { color: #1e40af; } /* blue-800 */
        .pay-option-allowance:has(input:checked) .pay-option-icon { color: #002E5D; }
        .pay-option-allowance:has(input:checked) .pay-option-text { color: #002E5D; }

        .pay-option-icon {
            font-size: 2rem;
            margin-bottom: 0.5rem;
            transition: color 0.2s;
        }
        .pay-option-text {
            font-weight: bold;
            color: #64748b;
        }

        /* DEBUG 上傳按鈕樣式 */
        .debug-upload-label {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.85rem;
            color: #6b7280;
            cursor: pointer;
            transition: color 0.2s;
            margin-left: 1rem;
        }
        .debug-upload-label:hover {
            color: #002E5D;
        }
        .debug-status {
            font-size: 0.75rem;
            font-weight: bold;
            color: #16a34a;
            margin-left: 0.5rem;
            display: none;
        }
        .debug-status.show {
            display: inline;
        }
    </style>
</head>
<body>

    <div id="lib-error">
        ⚠️ 系統偵測到核心元件未載入成功！可能是網路阻擋了 CDN。<br>
        請嘗試使用手機網路或更換瀏覽器。錯誤元件：<span id="missing-lib"></span>
    </div>

    <div id="status-bar">準備就緒</div>

    <!-- 錯誤訊息彈窗 -->
    <div id="error-modal">
        <div id="error-content">
            <!-- 給予 ID 方便 JS 動態修改標題和顏色 -->
            <h3 id="modal-header-title" class="text-xl font-bold text-red-600 mb-4 flex items-center gap-2">
                <i id="modal-header-icon" class="fa-solid fa-circle-exclamation"></i> 發生錯誤
            </h3>
            <div class="bg-gray-50 p-4 rounded border border-gray-200 mb-6">
                <pre id="error-details" class="text-sm text-gray-800 font-mono"></pre>
            </div>
            <div class="flex justify-end">
                <button id="err-close" class="bg-gray-200 text-gray-700 px-6 py-2 rounded font-bold hover:bg-gray-300 transition">關閉</button>
            </div>
        </div>
    </div>

    <!-- Header (深色背景) -->
    <div class="fixed top-0 left-0 w-full bg-thuBlue z-50 shadow-md">
        <div class="max-w-4xl mx-auto px-4 md:px-8 h-[80px] flex items-center justify-between">
            <div class="flex items-center gap-4">
                <img src="https://www.thu.edu.tw/upload/pagepic_upload/logo_w.svg" alt="THU Logo" class="h-10 w-auto">
                <div class="flex flex-col justify-center text-white">
                    <!-- 標題修改為 文件產生器 -->
                    <div class="text-lg md:text-xl font-bold tracking-wide leading-tight">學生校外實習文件產生器</div>
                    <div class="text-xs text-thuGold opacity-90 font-sans leading-tight mt-0.5">Internship Document Generation System (Debug Mode)</div>
                </div>
            </div>
            
            <!-- 右上角連結區 -->
            <div class="hidden md:flex gap-3 text-sm">
                <a href="https://aca.thu.edu.tw/web/isac/page.php?scid=112&sid=103" target="_blank" class="flex items-center gap-2 px-4 py-2 border border-thuGold text-thuGold rounded-full hover:bg-thuGold hover:text-thuBlue transition-all duration-200 font-medium">
                    <i class="fa-solid fa-link"></i> 實習中心網頁
                </a>
                <a href="https://www.thu.edu.tw/" target="_blank" class="flex items-center gap-2 px-4 py-2 bg-white text-thuBlue rounded-full hover:bg-gray-100 shadow-sm transition-all duration-200 font-medium">
                    <i class="fa-solid fa-house"></i> 東海大學首頁
                </a>
            </div>
        </div>
    </div>

    <!-- 主要表單 -->
    <main class="mx-auto px-4 mb-20 pt-24 max-w-7xl">
        
        <!-- 頁籤導航 (Tab Navigation) -->
        <div class="tab-container max-w-4xl mx-auto">
            <div class="flex border-b border-gray-300 px-0">
                <button class="tab-button active" data-page="page-1" onclick="showPage('page-1')">
                    <i class="fa-solid fa-circle-info mr-2"></i> 1. 使用須知
                </button>
                <button class="tab-button" data-page="page-2" onclick="showPage('page-2')">
                    <i class="fa-solid fa-users mr-2"></i> 2. 實習學生資料
                </button>
                <button class="tab-button" data-page="page-3" onclick="showPage('page-3')">
                    <i class="fa-solid fa-file-contract mr-2"></i> 3. 實習合約內容
                </button>
                <button class="tab-button" data-page="page-4" onclick="showPage('page-4')">
                    <i class="fa-regular fa-file-lines mr-2"></i> 4. 學生實習計畫書
                </button>
            </div>
        </div>


        <form id="contractForm">
            
            <!-- ========== Page 1: 使用須知 ========== -->
            <div id="page-1" class="page-content mt-4">
                <div class="bg-white border border-blue-100 rounded-xl p-8 shadow-sm">
                    <div class="flex items-start gap-4">
                        <div class="w-12 h-12 rounded-full bg-blue-50 flex items-center justify-center text-blue-600 shrink-0">
                            <i class="fa-solid fa-lightbulb text-xl"></i>
                        </div>
                        <div class="flex-1">
                            <h3 class="text-lg font-bold text-gray-800 mb-3">系統操作流程與說明</h3>
                            <ol class="text-base text-gray-600 leading-relaxed list-decimal list-outside ml-4 space-y-3">
                                <li>**請依序完成以下步驟：**
                                    <ul class="list-disc list-outside ml-4 mt-1 space-y-1 text-sm">
                                        <li class="font-bold text-thuBlue">步驟 1 (Page 2)：填寫所有實習學生的基本資料。</li>
                                        <li class="font-bold text-thuBlue">步驟 2 (Page 3)：填寫實習機構、期間、待遇等合約必要資料。</li>
                                        <li class="font-bold text-thuBlue">步驟 3 (Page 4)：針對每位學生，在表格中填寫計畫書所需的課程與老師資料。</li>
                                    </ul>
                                </li>
                                <li>所有資料輸入完畢後，您可以在 **Page 3 (實習合約內容)** 產出合約文件，並在 **Page 4 (學生實習計畫書)** 產出計畫書文件。</li>
                                <li>所有運算皆在您的瀏覽器完成，不會上傳任何個資。</li>
                                <li>如有任何系統反饋，歡迎寄信至 <a href="mailto:s11810249@thu.edu.tw" class="text-blue-600 hover:underline">s11810249@thu.edu.tw</a>！</li>
                            </ol>
                        </div>
                    </div>
                </div>
                
                <!-- 頁面導航 -->
                <div class="flex justify-end mt-6">
                    <button type="button" onclick="showPage('page-2')" class="nav-button w-40 px-6 py-3 rounded-full font-bold flex items-center justify-center gap-2">
                        下一步 <i class="fa-solid fa-arrow-right"></i>
                    </button>
                </div>
            </div>

            <!-- ========== Page 2: 實習學生資料 ========== -->
            <div id="page-2" class="page-content hidden">
                <div class="card">
                    <div class="card-header">
                        <span class="card-header-title mr-4">實習學生資料 (Page 2/4)</span>
                        <div class="flex items-center bg-gray-100 rounded-lg p-1 border border-gray-200">
                            <button type="button" onclick="changeStudentCount(-1)" class="w-8 h-8 flex items-center justify-center rounded-md text-gray-600 hover:bg-white hover:shadow-sm hover:text-thuBlue transition-all">
                                <i class="fa-solid fa-minus"></i>
                            </button>
                            <div class="w-16 text-center text-sm font-bold text-thuBlue" id="student_count_display">1 人</div>
                            <button type="button" onclick="changeStudentCount(1)" class="w-8 h-8 flex items-center justify-center rounded-md text-gray-600 hover:bg-white hover:shadow-sm hover:text-thuBlue transition-all">
                                <i class="fa-solid fa-plus"></i>
                            </button>
                        </div>
                        <input type="hidden" id="student_count" value="1">
                    </div>
                    
                    <div class="px-8 pt-4 flex justify-end">
                         <input type="file" id="upload_excel" accept=".xlsx, .xls" class="hidden" onchange="handleExcelUpload(event)">
                         <div class="flex gap-2">
                             <button type="button" onclick="downloadExcelTemplate()" class="text-sm text-gray-500 hover:text-thuBlue underline mr-2">
                                 <i class="fa-solid fa-download"></i> 下載範本
                             </button>
                             <button type="button" onclick="document.getElementById('upload_excel').click()" class="bg-green-600 text-white px-3 py-1.5 rounded text-sm font-bold hover:bg-green-700 transition flex items-center gap-1">
                                 <i class="fa-solid fa-file-excel"></i> 匯入 Excel
                             </button>
                         </div>
                    </div>
                    
                    <div class="p-8">
                        <div id="student_container" class="space-y-6"></div>
                    </div>
                </div>

                <div class="flex justify-between mt-6">
                    <button type="button" onclick="showPage('page-1')" class="nav-button w-40 px-6 py-3 rounded-full font-bold flex items-center justify-center gap-2">
                        <i class="fa-solid fa-arrow-left"></i> 上一步
                    </button>
                    <button type="button" onclick="showPage('page-3')" class="nav-button w-40 px-6 py-3 rounded-full font-bold flex items-center justify-center gap-2">
                        下一步 <i class="fa-solid fa-arrow-right"></i>
                    </button>
                </div>
            </div>

            <!-- ========== Page 3: 實習合約資料 ========== -->
            <div id="page-3" class="page-content hidden">
                <div class="card">
                    <div class="card-header">
                        <div class="flex items-center">
                             <span class="card-header-title">乙方：實習機構資料 (Page 3/4)</span>
                             <!-- DEBUG: Contract Template Upload -->
                             <label class="debug-upload-label">
                                <i class="fa-solid fa-wrench"></i> 測試合約範本
                                <input type="file" accept=".docx" class="hidden" onchange="handleDebugUpload(event, 'contract')">
                             </label>
                             <span id="debug_contract_status" class="debug-status"><i class="fa-solid fa-check"></i> 已載入</span>
                        </div>
                    </div>
                    
                    <div class="p-8 grid grid-cols-1 md:grid-cols-4 gap-x-6 gap-y-6">
                        <div class="md:col-span-4 mb-2">
                            <span class="text-sm text-red-500 flex items-center">您可輸入統一編號後，點擊查詢按鈕，系統將自動帶入公司名稱、負責人與登記地址。</span>
                        </div>
                        
                        <div class="md:col-span-4 flex flex-col md:flex-row gap-x-6 gap-y-4">
                            <div class="w-full md:w-[65%]">
                                <label class="block text-sm font-bold text-gray-700 mb-2">統一編號</label>
                                <div id="tax_id_input_group" class="flex gap-2 items-center transition-opacity duration-300">
                                    <input type="text" id="company_tax_id" class="input-field flex-grow" placeholder="04231910" maxlength="15">
                                    <button type="button" id="queryBtn" class="btn-query flex items-center gap-2 opacity-50 cursor-not-allowed whitespace-nowrap" disabled>
                                        <i class="fa-solid fa-magnifying-glass"></i> 自動查詢
                                    </button>
                                </div>
                            </div>
                            
                            <div class="w-full md:w-[35%] self-end">
                                <label class="block text-sm font-bold text-gray-700 mb-2 invisible md:visible"></label> 
                                <label for="no_tax_id" class="flex items-center p-3 h-[42px] border-2 rounded-lg cursor-pointer transition-all hover:bg-gray-100 has-[:checked]:border-red-500 has-[:checked]:bg-red-50/50">
                                    <input type="checkbox" id="no_tax_id" onchange="toggleTaxIdFields()" class="w-4 h-4 text-red-600 bg-gray-100 border-gray-300 rounded focus:ring-red-500">
                                    <span class="ml-2 text-base font-medium text-gray-800 select-none whitespace-normal">實習機構未申請設立字號</span>
                                </label>
                            </div>
                        </div>

                        <div class="md:col-span-4">
                            <label class="block text-sm font-bold text-gray-700 mb-2">機構全銜 (法定名稱) <span class="text-red-500">*</span></label>
                            <input type="text" id="company_name" class="input-field" placeholder="例：國泰世華商業銀行股份有限公司">
                        </div>

                        <div class="md:col-span-2">
                            <label class="block text-sm font-bold text-gray-700 mb-2">代表人姓名 <span class="text-red-500">*</span></label>
                            <input type="text" id="company_rep" class="input-field">
                        </div>
                        
                        <div class="md:col-span-2">
                            <label class="block text-sm font-bold text-gray-700 mb-2">代表人職稱 <span class="text-red-500">*</span></label>
                            <input type="text" id="company_title" class="input-field" placeholder="">
                        </div>

                        <div class="md:col-span-4">
                            <label class="block text-sm font-bold text-gray-700 mb-2">公司登記地址 (總公司) <span class="text-red-500">*</span></label>
                            <input type="text" id="reg_address" class="input-field" placeholder="例：臺北市信義區松仁路7號1樓">
                        </div>
                        
                        <div class="md:col-span-4 pt-6 border-t border-gray-200 mt-2">
                            <div class="text-sm font-bold text-thuBlue mb-4 flex items-center gap-2 bg-blue-50 p-2 rounded">
                                <i class="fa-solid fa-location-dot"></i> 
                                實習地點
                            </div>
                            
                            <div class="mb-4 flex items-center">
                                <input type="checkbox" id="is_head_office" class="w-4 h-4 text-thuBlue bg-gray-100 border-gray-300 rounded focus:ring-thuBlue" onchange="toggleBranchFields()">
                                <label for="is_head_office" class="ml-2 text-sm font-medium text-gray-700 select-none">學生於總公司實習 (或實習機構無分公司)</label>
                            </div>
                            
                            <div id="branch_fields_wrapper" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <label class="block text-xs font-bold text-gray-500 mb-2">實習單位/分公司名稱 <span class="text-red-500">*</span></label>
                                    <input type="text" id="branch_name" class="input-field" placeholder="例：淡水分公司">
                                </div>
                                <div>
                                    <label class="block text-xs font-bold text-gray-500 mb-2">實際實習地址 <span class="text-red-500">*</span></label>
                                    <input type="text" id="branch_addr" class="input-field" placeholder="例：新北市淡水區中山路106號">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <span class="card-header-title">實習期間與時間</span>
                    </div>
                    <div class="p-8 space-y-8">
                        <div>
                            <label class="block text-sm font-bold text-gray-700 mb-3">1. 實習期間</label>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <span class="text-xs font-bold text-gray-500 mb-2 block uppercase tracking-wide text-center">實習開始 (民國年/月/日)</span>
                                    <div class="date-group">
                                        <input type="number" id="start_y" class="date-input w-16 text-thuBlue" placeholder="113" oninput="autoJump(this, 3, 'start_m')">
                                        <span class="date-sep">/</span>
                                        <input type="number" id="start_m" class="date-input w-12" placeholder="07" oninput="autoJump(this, 2, 'start_d')">
                                        <span class="date-sep">/</span>
                                        <input type="number" id="start_d" class="date-input w-12" placeholder="01" oninput="autoJump(this, 2, 'end_y')"> 
                                    </div>
                                </div>
                                <div>
                                    <span class="text-xs font-bold text-gray-500 mb-2 block uppercase tracking-wide text-center">實習結束 (民國年/月/日)</span>
                                    <div class="date-group">
                                        <input type="number" id="end_y" class="date-input w-16 text-thuBlue" placeholder="114" oninput="autoJump(this, 3, 'end_m')">
                                        <span class="date-sep">/</span>
                                        <input type="number" id="end_m" class="date-input w-12" placeholder="06" oninput="autoJump(this, 2, 'end_d')">
                                        <span class="date-sep">/</span>
                                        <input type="number" id="end_d" class="date-input w-12" placeholder="30">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="border-t border-gray-200 pt-8">
                            <label class="block text-sm font-bold text-gray-700 mb-3">2. 每日實習時間</label>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 bg-gray-50 p-6 rounded-lg border border-gray-200">
                                <div><span class="text-xs font-bold text-gray-400 uppercase mb-1 block">每日開始</span><input type="time" id="daily_start" value="09:00" class="input-field bg-white border-gray-300"></div>
                                <div><span class="text-xs font-bold text-gray-400 uppercase mb-1 block">每日結束</span><input type="time" id="daily_end" value="18:00" class="input-field bg-white border-gray-300"></div>
                                <div><span class="text-xs font-bold text-gray-400 uppercase mb-1 block">共計(小時)</span><input type="number" id="daily_hours" value="8" step="0.5" class="input-field bg-white border-gray-300"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card" id="card-conditions">
                    <div class="card-header">
                        <span class="card-header-title">實習類型與待遇福利</span>
                    </div>
                    <div class="p-8 space-y-8">
                        <div id="type-section" class="p-4 rounded-lg border border-transparent transition-all">
                            <label class="block text-lg font-bold text-thuBlue mb-3">1. 請選擇實習類型 <span class="text-red-500 text-sm">*必填</span></label>
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                <label class="relative flex items-center p-5 border-2 rounded-xl cursor-pointer transition-all hover:bg-gray-50 has-[:checked]:border-thuBlue has-[:checked]:bg-blue-50/50 has-[:checked]:ring-1 has-[:checked]:ring-thuBlue h-full">
                                    <input type="radio" name="contract_type" value="learn" onchange="toggleType()" class="w-5 h-5 text-thuBlue border-gray-300 focus:ring-thuBlue">
                                    <div class="ml-4">
                                        <i class="fa-solid fa-book-open text-2xl text-thuBlue opacity-30 absolute right-4 top-4"></i>
                                        <span class="block text-base font-bold text-gray-900">一般型 (學習型)</span>
                                        <span class="block text-xs text-gray-500 mt-1">單純學習訓練，無僱傭關係</span>
                                    </div>
                                </label>
                                <label class="relative flex items-center p-5 border-2 rounded-xl cursor-pointer transition-all hover:bg-gray-50 has-[:checked]:border-orange-500 has-[:checked]:bg-orange-50/50 has-[:checked]:ring-1 has-[:checked]:ring-orange-500 h-full">
                                    <input type="radio" name="contract_type" value="work" onchange="toggleType()" class="w-5 h-5 text-orange-600 border-gray-300 focus:ring-orange-500">
                                    <div class="ml-4">
                                        <i class="fa-solid fa-briefcase text-2xl text-orange-600 opacity-30 absolute right-4 top-4"></i>
                                        <span class="block text-base font-bold text-gray-900">工作型 (勞資型)</span>
                                        <span class="block text-xs text-gray-500 mt-1">具僱傭關係，適用勞基法</span>
                                    </div>
                                </label>
                            </div>
                        </div>

                        <div id="pay-section" class="border-t border-gray-200 pt-6 p-4 rounded-lg border border-transparent transition-all">
                            <label class="block text-lg font-bold text-thuBlue mb-3">2. 實習待遇與給付 <span class="text-red-500 text-sm">*必填</span></label>
                            <div id="panel_initial" class="flex items-center justify-center p-8 bg-yellow-50 rounded-xl border-2 border-dashed border-yellow-200 text-yellow-700 font-bold shadow-sm">
                                <i class="fa-solid fa-arrow-up mr-2 animate-bounce"></i> 請先選擇上方「實習類型」以解鎖此區塊
                            </div>
                            <div id="panel_learn" class="bg-green-50 p-6 rounded-xl border border-green-200 hidden fade-in">
                                <span class="text-[10px] font-black text-green-700 bg-green-200 px-2 py-1 rounded uppercase tracking-wider mb-4 inline-block">學習型</span>
                                <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-6">
                                    <label class="pay-option-label pay-option-none">
                                        <input type="radio" name="pay_opt_learn" value="none" onchange="togglePayInputs()" class="radio-card-input">
                                        <i class="fa-regular fa-circle-xmark pay-option-icon"></i>
                                        <span class="pay-option-text text-sm">無</span>
                                    </label>
                                    <label class="pay-option-label pay-option-scholar">
                                        <input type="radio" name="pay_opt_learn" value="scholar" onchange="togglePayInputs()" class="radio-card-input">
                                        <i class="fa-solid fa-graduation-cap pay-option-icon"></i>
                                        <span class="pay-option-text text-sm">獎學金</span>
                                    </label>
                                    <label class="pay-option-label pay-option-allowance">
                                        <input type="radio" name="pay_opt_learn" value="allowance" onchange="togglePayInputs()" class="radio-card-input">
                                        <i class="fa-solid fa-hand-holding-dollar pay-option-icon"></i>
                                        <span class="pay-option-text text-sm">實習津貼</span>
                                    </label>
                                </div>
                                <div id="learn_amt_box" class="hidden transition-all">
                                    <label class="block text-xs font-bold text-green-800 mb-2 uppercase">每月給付總額</label>
                                    <div class="relative w-full md:w-64">
                                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none text-gray-500 font-bold">NT$</div>
                                        <input type="number" id="learn_amount" placeholder="0" class="input-field pl-12 pr-8 text-right border-green-300 focus:border-green-600 focus:ring-green-600 font-mono text-lg">
                                        <div class="absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none text-gray-500 font-bold">元</div>
                                    </div>
                                </div>
                            </div>
                            <div id="panel_work" class="bg-orange-50 p-6 rounded-xl border border-orange-200 hidden flex flex-col gap-6 fade-in">
                                <span class="text-[10px] font-black text-orange-700 bg-orange-200 px-2 py-1 rounded uppercase tracking-wider w-fit">勞資型</span>
                                <div>
                                    <label class="block text-xs font-bold text-orange-800 mb-2 uppercase">薪資金額 (月薪)</label>
                                    <div class="relative w-full md:w-64">
                                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none text-gray-500 font-bold">NT$</div>
                                        <input type="number" id="work_amount" placeholder="27470" class="input-field pl-12 pr-8 text-right border-orange-300 focus:border-orange-500 focus:ring-orange-500 font-mono text-lg">
                                        <div class="absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none text-gray-500 font-bold">元</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div id="welfare-section" class="border-t border-gray-200 pt-6 p-4 rounded-lg border border-transparent transition-all">
                            <label class="block text-lg font-bold text-thuBlue mb-3">3. 福利項目 <span class="text-red-500 text-sm">*必填</span></label>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                                <div>
                                    <label class="text-sm font-bold text-gray-600 mb-1 block">住宿</label>
                                    <select id="dorm_opt" onchange="toggleCost('dorm')" class="input-field mb-2">
                                        <option value="" disabled selected>請選擇</option>
                                        <option value="none">無</option>
                                        <option value="free">免費提供</option>
                                        <option value="paid">付費提供</option>
                                    </select>
                                    <div id="dorm_cost_wrapper" class="hidden relative">
                                        <input id="dorm_cost" type="number" placeholder="0" class="input-field pl-10 pr-8 text-right mt-1 font-mono">
                                    </div>
                                </div>
                                <div>
                                    <label class="text-sm font-bold text-gray-600 mb-1 block">膳食</label>
                                    <select id="food_opt" onchange="toggleCost('food')" class="input-field mb-2">
                                        <option value="" disabled selected>請選擇</option>
                                        <option value="none">無</option>
                                        <option value="free">免費提供</option>
                                        <option value="paid">付費提供</option>
                                    </select>
                                    <div id="food_cost_wrapper" class="hidden relative">
                                        <input id="food_cost" type="number" placeholder="0" class="input-field pl-10 pr-8 text-right mt-1 font-mono">
                                    </div>
                                </div>
                                <div>
                                    <label class="text-sm font-bold text-gray-600 mb-1 block">交通</label>
                                    <select id="trans_opt" onchange="toggleCost('trans')" class="input-field mb-2">
                                        <option value="" disabled selected>請選擇</option>
                                        <option value="none">無</option>
                                        <option value="free">免費提供</option>
                                        <option value="paid">付費提供</option>
                                        <option value="subsidy">交通津貼</option>
                                    </select>
                                    <div id="trans_cost_wrapper" class="hidden relative">
                                        <input id="trans_cost" type="number" placeholder="0" class="input-field pl-10 pr-8 text-right mt-1 font-mono">
                                    </div>
                                </div>
                            </div>
                        </div>

                    </div>
                </div>

                <div class="flex justify-between items-center mt-12">
                    <button type="button" onclick="showPage('page-2')" class="nav-button w-40 px-6 py-3 rounded-full font-bold flex items-center justify-center gap-2">
                        <i class="fa-solid fa-arrow-left"></i> 上一步
                    </button>
                    <button type="button" onclick="generateDoc()" id="genContractBtn" disabled class="btn-generate w-64 px-6 py-5 rounded-full font-bold text-lg flex items-center justify-center gap-3 opacity-75 cursor-not-allowed">
                        <span class="animate-pulse">系統載入中...</span>
                    </button>
                </div>
            </div>

            <!-- ========== Page 4: 實習計畫書 ========== -->
            <div id="page-4" class="page-content hidden">
                <div class="card">
                    <div class="card-header">
                        <div class="flex items-center">
                            <span class="card-header-title">學生實習計畫書 (Page 4/4)</span>
                             <!-- DEBUG: Proposal Template Upload -->
                             <label class="debug-upload-label">
                                <i class="fa-solid fa-wrench"></i> 測試計畫書範本
                                <input type="file" accept=".docx" class="hidden" onchange="handleDebugUpload(event, 'proposal')">
                             </label>
                             <span id="debug_proposal_status" class="debug-status"><i class="fa-solid fa-check"></i> 已載入</span>
                        </div>
                        <div class="text-xs font-medium text-gray-500">
                            學生人數：<span id="proposal_student_count">1</span> 人
                        </div>
                    </div>
                    
                    <div class="p-4 overflow-x-auto">
                        <table class="w-full proposal-table border-collapse">
                            <thead>
                                <tr>
                                    <th class="w-12 text-center">
                                        <input type="checkbox" id="select_all_proposals" onclick="toggleSelectAll(this)" class="w-4 h-4 text-thuBlue bg-gray-100 border-gray-300 rounded focus:ring-thuBlue">
                                    </th>
                                    <th class="w-28">姓名 / 學號</th>
                                    <th class="w-24">系所 / 年級</th>
                                    <th class="w-36">輔導老師 <span class="text-red-500">*</span></th>
                                    <th class="w-72">課程名稱 <span class="text-red-500">*</span></th>
                                    <th class="w-24">學期 <span class="text-red-500">*</span></th>
                                    <th class="w-16">學分 <span class="text-red-500">*</span></th>
                                    <th class="w-40">實習類別 <span class="text-red-500">*</span></th>
                                    <th class="w-24">時數說明</th>
                                    <th class="w-24 text-center">操作</th>
                                </tr>
                            </thead>
                            <tbody id="proposal_table_body"></tbody>
                        </table>
                    </div>
                    <div id="proposal_empty_msg" class="p-8 text-center text-gray-500 hidden">
                        請先返回「實習學生資料」頁面填寫學生人數。
                    </div>
                </div>
                
                <div class="flex flex-col md:flex-row justify-between items-center mt-12 gap-4">
                    <button type="button" onclick="showPage('page-3')" class="nav-button w-40 px-6 py-3 rounded-full font-bold flex items-center justify-center gap-2">
                        <i class="fa-solid fa-arrow-left"></i> 上一步
                    </button>
                    
                    <button type="button" onclick="downloadSelectedProposals()" id="bulkDownloadBtn" class="btn-generate w-full md:w-80 px-6 py-5 rounded-full font-bold text-lg flex items-center justify-center gap-3">
                        <i class="fa-solid fa-file-zipper"></i> 打包下載選取計畫書 (ZIP)
                    </button>

                    <button type="button" onclick="generateProposalDoc()" id="genProposalBtn" class="btn-generate w-64 px-6 py-5 rounded-full font-bold text-lg flex items-center justify-center gap-3 hidden">
                        <i class="fa-regular fa-file-word"></i> 產生實習計畫書 (Word)
                    </button>
                </div>
            </div>
        </form>
    </main>

    <footer>
        <div class="container mx-auto px-4">
            <div class="flex flex-col items-center justify-center gap-1">
                <p class="font-bold text-white tracking-wide text-[10px]">&copy; 2025 東海大學實習與學生成就中心 Internship and Student Achievement Center, Tunghai University. All Rights Reserved.</p>
                <p class="text-[9px] text-gray-500">
                    系統版本 V1.0.56 (Debug Mode) | 網頁製作：張博堯 | Powered by Google Gemini
                </p>
            </div>
        </div>
    </footer>

    <!-- JS 邏輯 -->
    <script>
        let studentDataState = [];
        
        // --- 核心工具：清洗 XML (解決 ReferenceError 問題) ---
        function cleanXML(xml) {
            if (!xml) return "";
            const pattern = /%%%[^%]+%%%/g;
            return xml.replace(pattern, function(match) {
                return match.replace(/<\/?[^>]+(>|$)/g, "");
            });
        }

        // --- DEBUG: 上傳測試範本 ---
        let debugContractBuffer = null;
        let debugProposalBuffer = null;

        function handleDebugUpload(event, type) {
            const file = event.target.files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                if(type === 'contract') {
                    debugContractBuffer = e.target.result;
                    document.getElementById('debug_contract_status').classList.add('show');
                } else {
                    debugProposalBuffer = e.target.result;
                    document.getElementById('debug_proposal_status').classList.add('show');
                }
                showMsg("測試範本載入成功，請進行文件產出");
            };
            reader.readAsArrayBuffer(file);
        }
        
        // 取得範本 (優先使用 Debug)
        async function getTemplateBuffer(type) {
            if (type === 'contract' && debugContractBuffer) return debugContractBuffer;
            if (type === 'proposal' && debugProposalBuffer) return debugProposalBuffer;

            const url = type === 'contract' ? './template.docx' : './template_plan.docx';
            const resp = await fetch(url);
            if (!resp.ok) throw new Error(`找不到 ${url}（請確認檔案是否存在於根目錄）`);
            return await resp.arrayBuffer();
        }

        function autoJump(current, maxLen, nextId) {
            if (current.value.length >= maxLen) {
                const next = document.getElementById(nextId);
                if (next) next.focus();
            }
        }

        function showMsg(msg) {
            const el = document.getElementById('status-bar');
            el.innerText = msg;
            el.style.display = 'block';
            setTimeout(() => { el.style.display = 'none'; }, 4000);
        }

        function showModal(title, message, style = 'error') { 
            const modal = document.getElementById('error-modal');
            const content = document.getElementById('error-details');
            const header = document.getElementById('modal-header-title');
            const icon = document.getElementById('modal-header-icon');

            header.classList.remove('text-red-600', 'text-yellow-600', 'text-blue-600', 'text-gray-600');
            
            let iconClass = 'fa-solid ';
            if (style === 'error') {
                header.classList.add('text-red-600');
                iconClass += 'fa-circle-exclamation';
            } else if (style === 'info') {
                header.classList.add('text-blue-600');
                iconClass += 'fa-circle-info';
            } else if (style === 'warning') {
                header.classList.add('text-yellow-600');
                iconClass += 'fa-triangle-exclamation';
            } else { 
                header.classList.add('text-gray-600');
                iconClass += 'fa-circle-info';
            }

            if (icon) icon.className = iconClass;
            if (header) header.innerHTML = `<i class="${iconClass}"></i> ${title}`;
            
            content.textContent = message;
            modal.style.display = 'flex';
        }

        function showError(details) {
            showModal('發生錯誤', details, 'error');
        }

        function showQueryInfo(message) {
            showModal('提示', message, 'warning');
        }

        document.getElementById('err-close').addEventListener('click', () => {
            document.getElementById('error-modal').style.display = 'none';
        });

        function showPage(pageId) {
            const pages = document.querySelectorAll('.page-content');
            const tabs = document.querySelectorAll('.tab-button');
            pages.forEach(page => page.classList.add('hidden'));
            tabs.forEach(tab => tab.classList.remove('active'));
            document.getElementById(pageId).classList.remove('hidden');
            document.querySelector(`[data-page="${pageId}"]`).classList.add('active');
            if (pageId === 'page-4') {
                collectStudentDataFromPage2();
                renderProposalTable();
            }
        }
        
        function collectStudentDataFromPage2() {
            const sCount = Number(document.getElementById('student_count').value) || 1;
            const tempStudentData = [];
            for (let i = 0; i < sCount; i++) {
                const existingState = studentDataState.find(s => s.index === i) || {};
                const gradeInput = document.getElementById(`s_grade_${i}`)?.value || "";
                const gradeText = gradeInput.trim() ? `${gradeInput}年級` : "";

                tempStudentData.push({
                    index: i,
                    name: document.getElementById(`s_name_${i}`)?.value || "",
                    dept: document.getElementById(`s_dept_${i}`)?.value || "",
                    grade: gradeText,
                    raw_grade: gradeInput,
                    id: document.getElementById(`s_id_${i}`)?.value || "",
                    isSelected: existingState.isSelected === undefined ? true : existingState.isSelected,
                    teacher_name: existingState.teacher_name || "",
                    course_name: existingState.course_name || "",
                    semester: existingState.semester || "",
                    credits: existingState.credits || "",
                    hours_exceeded_desc: existingState.hours_exceeded_desc || "",
                    intern_type_select: existingState.intern_type_select || "" 
                });
            }
            studentDataState = tempStudentData;
        }

        function renderStudents() {
            const count = Number(document.getElementById('student_count').value) || 1;
            const c = document.getElementById('student_container');
            collectStudentDataFromPage2();
            while (c.children.length > count) c.removeChild(c.lastChild);

            const currentChildren = c.children.length;
            if (count > currentChildren) {
                for (let i = currentChildren; i < count; i++) {
                    const wrapper = document.createElement('div');
                    wrapper.className = "student-wrapper p-5 bg-gray-50 rounded-lg border border-gray-200 mb-4 relative fade-in";
                    wrapper.setAttribute('data-index', i);
                    
                    wrapper.innerHTML = `
                        <div class="absolute -top-3 -left-2 bg-white border border-gray-200 px-3 py-1 rounded text-xs font-bold text-thuBlue shadow-sm">
                            學生 ${i+1}
                        </div>
                        <button type="button" onclick="deleteStudent(${i})" class="delete-student-btn" aria-label="刪除學生 ${i+1}">
                            <i class="fa-solid fa-xmark text-sm"></i>
                        </button>
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-x-5 gap-y-4 mt-2">
                            <div>
                                <label class="block text-xs font-bold text-gray-500 uppercase mb-1">姓名 <span class="text-red-500">*</span></label>
                                <input type="text" id="s_name_${i}" class="input-field" oninput="collectStudentDataFromPage2()" value="${studentDataState[i]?.name || ''}">
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-gray-500 uppercase mb-1">學號 <span class="text-red-500">*</span></label>
                                <input type="text" id="s_id_${i}" class="input-field" placeholder="例：S1181000" oninput="collectStudentDataFromPage2()" value="${studentDataState[i]?.id || ''}">
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-gray-500 uppercase mb-1">系所 <span class="text-red-500">*</span></label>
                                <input type="text" id="s_dept_${i}" class="input-field" placeholder="例：法律系" oninput="collectStudentDataFromPage2()" value="${studentDataState[i]?.dept || ''}">
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-gray-500 uppercase mb-1">年級 <span class="text-red-500">*</span></label>
                                <div class="grade-input-group w-full">
                                    <input type="text" id="s_grade_${i}" class="grade-input-field" placeholder="例：四" oninput="collectStudentDataFromPage2()" value="${studentDataState[i]?.raw_grade || ''}">
                                    <span class="grade-suffix">年級</span>
                                </div>
                            </div>
                        </div>
                    `;
                    c.appendChild(wrapper);
                }
            } 
            
            const currentWrappers = c.querySelectorAll('.student-wrapper');
            currentWrappers.forEach((wrapper, index) => {
                wrapper.setAttribute('data-index', index);
                const titleEl = wrapper.querySelector('.absolute.-top-3.-left-2');
                if (titleEl) titleEl.innerHTML = `學生 ${index + 1}`;
                const deleteBtn = wrapper.querySelector('.delete-student-btn');
                if (deleteBtn) {
                    deleteBtn.setAttribute('onclick', `deleteStudent(${index})`);
                    deleteBtn.setAttribute('aria-label', `刪除學生 ${index + 1}`);
                }
                document.getElementById(`s_name_${index}`).value = studentDataState[index]?.name || '';
                document.getElementById(`s_id_${index}`).value = studentDataState[index]?.id || '';
                document.getElementById(`s_dept_${index}`).value = studentDataState[index]?.dept || '';
                document.getElementById(`s_grade_${index}`).value = studentDataState[index]?.raw_grade || '';
            });
            collectStudentDataFromPage2();
        }

        function changeStudentCount(delta) {
            const input = document.getElementById('student_count');
            let val = parseInt(input.value) || 1;
            val += delta;
            if (val < 1) val = 1;
            input.value = val;
            document.getElementById('student_count_display').innerText = val + " 人";
            renderStudents();
            renderProposalTable();
        }
        
        function deleteStudent(indexToDelete) {
            let currentCount = Number(document.getElementById('student_count').value);
            if (currentCount <= 1) {
                showModal("無法刪除", "至少需要保留一位學生。", 'warning');
                return;
            }
            studentDataState.splice(indexToDelete, 1);
            currentCount -= 1;
            document.getElementById('student_count').value = currentCount;
            document.getElementById('student_count_display').innerText = currentCount + " 人";
            renderStudents();
            renderProposalTable();
        }

        function downloadExcelTemplate() {
            const data = [['姓名', '學號', '系所', '年級'], ['王小明', 'S1181000', '法律系', '四'], ['陳小華', 'S1181001', '社會系', '三']];
            const ws = XLSX.utils.aoa_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "學生名單");
            XLSX.writeFile(wb, "學生名單範本.xlsx");
        }

        function handleExcelUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, {type: 'array'});
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, {header: 1});
                    if (jsonData.length > 0) jsonData.shift();
                    
                    const validStudents = jsonData.filter(row => row.length > 0 && row[0]).map(row => ({
                        name: row[0] || "", id: row[1] || "", dept: row[2] || "", grade: row[3] || ""
                    }));

                    if (validStudents.length === 0) {
                        showError("Excel 檔案中沒有有效的學生資料。");
                        return;
                    }
                    document.getElementById('student_count').value = validStudents.length;
                    document.getElementById('student_count_display').innerText = validStudents.length + " 人";
                    renderStudents();
                    validStudents.forEach((s, i) => {
                        const nameInput = document.getElementById(`s_name_${i}`);
                        const idInput = document.getElementById(`s_id_${i}`);
                        const deptInput = document.getElementById(`s_dept_${i}`);
                        const gradeInput = document.getElementById(`s_grade_${i}`);
                        if(nameInput) nameInput.value = s.name;
                        if(idInput) idInput.value = s.id;
                        if(deptInput) deptInput.value = s.dept;
                        if(gradeInput) gradeInput.value = s.grade;
                    });
                    collectStudentDataFromPage2();
                    renderProposalTable();
                    showMsg(`成功匯入 ${validStudents.length} 筆學生資料！`);
                    event.target.value = '';
                } catch (error) {
                    showError("Excel 解析失敗，請確認格式是否正確。\n" + error.message);
                }
            };
            reader.readAsArrayBuffer(file);
        }
        
        function togglePayInputs() { 
            try {
                const box = document.getElementById('learn_amt_box');
                const sel = document.querySelector('input[name="pay_opt_learn"]:checked');
                const v = sel ? sel.value : 'none';
                if (box) box.classList.toggle('hidden', v === 'none');
            } catch (e) { console.warn(e); }
        }

        function toggleType() {
            const tEl = document.querySelector('input[name="contract_type"]:checked');
            const t = tEl ? tEl.value : null;
            const panelInit = document.getElementById('panel_initial');
            const panelLearn = document.getElementById('panel_learn');
            const panelWork = document.getElementById('panel_work');
            
            if (t === 'learn') {
                panelInit.classList.add('hidden'); panelLearn.classList.remove('hidden'); panelWork.classList.add('hidden');
            } else if (t === 'work') {
                panelInit.classList.add('hidden'); panelLearn.classList.add('hidden'); panelWork.classList.remove('hidden');
            } else {
                panelInit.classList.remove('hidden'); panelLearn.classList.add('hidden'); panelWork.classList.add('hidden');
            }
            togglePayInputs();
        }

        function toggleCost(prefix) { 
            try {
                const optEl = document.getElementById(prefix + '_opt');
                const wrapperEl = document.getElementById(prefix + '_cost_wrapper');
                const v = optEl ? optEl.value : 'none';
                if (v === 'paid' || v === 'subsidy') wrapperEl.classList.remove('hidden');
                else wrapperEl.classList.add('hidden');
            } catch (e) { console.warn(e); }
        }

        function toggleBranchFields() {
            const isHeadOffice = document.getElementById('is_head_office').checked;
            const wrapper = document.getElementById('branch_fields_wrapper');
            const branchName = document.getElementById('branch_name');
            const branchAddr = document.getElementById('branch_addr');
            if (isHeadOffice) {
                wrapper.classList.add('opacity-50', 'pointer-events-none');
                branchName.disabled = true; branchAddr.disabled = true;
                branchName.value = ''; branchAddr.value = '';
                branchName.classList.remove('input-error'); branchAddr.classList.remove('input-error');
            } else {
                wrapper.classList.remove('opacity-50', 'pointer-events-none');
                branchName.disabled = false; branchAddr.disabled = false;
            }
        }

        function toggleTaxIdFields() {
            const noTaxIdChecked = document.getElementById('no_tax_id').checked;
            const taxIdInput = document.getElementById('company_tax_id');
            const queryBtn = document.getElementById('queryBtn');
            const inputGroup = document.getElementById('tax_id_input_group');
            if (noTaxIdChecked) {
                inputGroup.classList.add('opacity-50', 'pointer-events-none');
                taxIdInput.disabled = true; queryBtn.disabled = true; taxIdInput.value = '';
            } else {
                inputGroup.classList.remove('opacity-50', 'pointer-events-none');
                taxIdInput.disabled = false; updateQueryButtonState(); 
            }
        }

        function toggleStudentSelection(index) {
            if (studentDataState[index]) studentDataState[index].isSelected = !studentDataState[index].isSelected;
            updateSelectAllCheckbox();
        }

        function toggleSelectAll(checkbox) {
            const isChecked = checkbox.checked;
            studentDataState = studentDataState.map(s => ({ ...s, isSelected: isChecked }));
            renderProposalTable(false);
        }

        function updateSelectAllCheckbox() {
            const selectAll = document.getElementById('select_all_proposals');
            if (!selectAll) return;
            const totalStudents = studentDataState.length;
            const selectedStudents = studentDataState.filter(s => s.isSelected).length;
            if (totalStudents === 0) { selectAll.checked = false; selectAll.indeterminate = false; }
            else if (selectedStudents === totalStudents) { selectAll.checked = true; selectAll.indeterminate = false; }
            else if (selectedStudents > 0) { selectAll.checked = false; selectAll.indeterminate = true; }
            else { selectAll.checked = false; selectAll.indeterminate = false; }
        }

        function renderProposalTable(restoreSelection = true) {
            const tableBody = document.getElementById('proposal_table_body');
            const studentCountDisplay = document.getElementById('proposal_student_count');
            const emptyMsg = document.getElementById('proposal_empty_msg');
            collectStudentDataFromPage2();
            const students = studentDataState;
            const count = students.length;
            studentCountDisplay.textContent = count;
            tableBody.innerHTML = '';

            if (count === 0 || students.every(s => !s.name.trim() && !s.id.trim())) {
                emptyMsg.classList.remove('hidden');
                document.getElementById('select_all_proposals').disabled = true;
                return;
            }
            emptyMsg.classList.add('hidden');
            document.getElementById('select_all_proposals').disabled = false;

            students.forEach((s, i) => {
                const tr = document.createElement('tr');
                tr.id = `proposal_row_${i}`;
                tr.className = "border-b border-gray-100 hover:bg-yellow-50/50 transition";
                const isSelected = students[i].isSelected;

                tr.innerHTML = `
                    <td class="text-center">
                        <input type="checkbox" data-index="${i}" onchange="toggleStudentSelection(${i})" class="proposal-select-checkbox w-4 h-4 text-thuBlue bg-gray-100 border-gray-300 rounded focus:ring-thuBlue" ${isSelected ? 'checked' : ''}>
                    </td>
                    <td class="text-center font-bold text-xs-force">
                        <div class="font-bold">${s.name}</div>
                        <div class="text-gray-500">${s.id}</div>
                    </td>
                    <td class="text-xs-force">
                        <div>${s.dept}</div>
                        <div class="text-gray-500">${s.grade}</div>
                    </td>
                    <td class="p-0 py-1"><input type="text" id="p_teacher_name_${i}" data-field="teacher_name" class="input-field p-1 text-sm h-8" value="${s.teacher_name}" placeholder="姓名"></td>
                    <td class="p-0 py-1">
                        <textarea id="p_course_name_${i}" data-field="course_name" class="input-field proposal-textarea text-sm" placeholder="課程名稱 (可換行填寫)">${s.course_name}</textarea>
                    </td>
                    <td class="p-0 py-1"><input type="text" id="p_semester_${i}" data-field="semester" class="input-field p-1 text-sm h-8" value="${s.semester}" placeholder="113-1"></td>
                    <td class="p-0 py-1"><input type="number" id="p_credits_${i}" data-field="credits" class="input-field p-1 text-sm h-8" value="${s.credits}" placeholder="3"></td>
                    <td>
                        <select id="p_intern_type_select_${i}" data-field="intern_type_select" class="input-field text-xs-force h-8 p-1">
                            <option value="" disabled selected>請選擇</option>
                            <option value="full" ${s.intern_type_select === 'full' ? 'selected' : ''}>整學年</option>
                            <option value="sem" ${s.intern_type_select === 'sem' ? 'selected' : ''}>整學期</option>
                            <option value="winter" ${s.intern_type_select === 'winter' ? 'selected' : ''}>寒假實習</option>
                            <option value="summer" ${s.intern_type_select === 'summer' ? 'selected' : ''}>暑假實習</option>
                            <option value="term" ${s.intern_type_select === 'term' ? 'selected' : ''}>學期期間實習</option>
                        </select>
                        <div class="text-red-500 font-bold text-xs-force mt-1" id="p_type_error_${i}"></div>
                    </td>
                    <td class="p-0 py-1">
                        <textarea id="p_hours_exceeded_desc_${i}" data-field="hours_exceeded_desc" class="input-field proposal-textarea text-sm" placeholder="選填">${s.hours_exceeded_desc}</textarea>
                    </td>
                    <td class="text-center">
                        <button type="button" onclick="downloadIndividualProposal(${i})" class="bg-thuGold text-thuBlue text-xs font-bold px-3 py-1.5 rounded hover:bg-thuGold/80 transition shadow-sm">
                            <i class="fa-solid fa-download"></i> 下載
                        </button>
                    </td>
                `;
                tableBody.appendChild(tr);

                document.getElementById(`p_teacher_name_${i}`)?.addEventListener('input', updateProposalDataState);
                document.getElementById(`p_course_name_${i}`)?.addEventListener('input', updateProposalDataState);
                document.getElementById(`p_semester_${i}`)?.addEventListener('input', updateProposalDataState);
                document.getElementById(`p_credits_${i}`)?.addEventListener('input', updateProposalDataState);
                document.getElementById(`p_intern_type_select_${i}`)?.addEventListener('change', updateProposalDataState);
                document.getElementById(`p_hours_exceeded_desc_${i}`)?.addEventListener('input', updateProposalDataState);
            });
            updateSelectAllCheckbox();
        }

        function updateProposalDataState() {
            studentDataState.forEach((s, i) => {
                const row = document.getElementById(`proposal_row_${i}`);
                if (!row) return;
                ['teacher_name', 'semester', 'credits'].forEach(f => {
                    const input = document.getElementById(`p_${f}_${i}`);
                    if (input) s[f] = input.value;
                });
                ['course_name', 'hours_exceeded_desc'].forEach(f => {
                    const textarea = document.getElementById(`p_${f}_${i}`);
                    if (textarea) s[f] = textarea.value;
                });
                const selectEl = document.getElementById(`p_intern_type_select_${i}`);
                if (selectEl) s.intern_type_select = selectEl.value;
            });
        }
        
        function updateQueryButtonState() {
            const taxIdInput = document.getElementById('company_tax_id');
            const queryBtn = document.getElementById('queryBtn');
            const noTaxIdChecked = document.getElementById('no_tax_id').checked;
            if (noTaxIdChecked) {
                 queryBtn.disabled = true; queryBtn.classList.add('opacity-50', 'cursor-not-allowed'); return;
            }
            const taxId = taxIdInput.value.trim();
            const isTaxId = /^\d{8}$/.test(taxId);
            if (isTaxId) {
                queryBtn.disabled = false; queryBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            } else {
                queryBtn.disabled = true; queryBtn.classList.add('opacity-50', 'cursor-not-allowed');
            }
        }

        function validateForm(isProposal = false) {
            let isValid = true;
            let errorMsg = "";
            document.querySelectorAll('.bg-red-50').forEach(el => el.classList.remove('bg-red-50', 'border-red-200'));
            document.querySelectorAll('.input-error').forEach(el => el.classList.remove('input-error'));
            document.querySelectorAll('.text-red-500.font-bold.text-xs-force').forEach(el => el.textContent = '');
            
            const students = studentDataState;
            let studentErrorCount = 0;
            
            students.forEach((s, i) => {
                const prefix = `s_`;
                const fields = [{ id: `${prefix}name_${i}`, name: '姓名' }, { id: `${prefix}id_${i}`, name: '學號' }, { id: `${prefix}dept_${i}`, name: '系所' }, { id: `${prefix}grade_${i}`, name: '年級' }];
                fields.forEach(field => {
                    const el = document.getElementById(field.id);
                    let value = el ? el.value.trim() : ''; 
                    if (!value) { el?.classList.add('input-error'); isValid = false; studentErrorCount++; }
                });
            });

            if (studentErrorCount > 0) errorMsg += `• 實習學生資料 (Page 2) 共有 ${studentErrorCount} 個必填欄位未填寫。\n`;

            if (!isProposal) {
                const requiredFields = [{ id: 'company_name', name: '機構全銜' }, { id: 'company_rep', name: '代表人姓名' }, { id: 'company_title', name: '代表人職稱' }, { id: 'reg_address', name: '公司登記地址' }];
                requiredFields.forEach(field => {
                    const el = document.getElementById(field.id);
                    if (!el || !el.value.trim()) { el.classList.add('input-error'); isValid = false; errorMsg += `• 請填寫 ${field.name}\n`; }
                });

                if (!document.getElementById('is_head_office').checked) {
                    const branchFields = [{ id: 'branch_name', name: '實習單位/分公司名稱' }, { id: 'branch_addr', name: '實際實習地址' }];
                    branchFields.forEach(field => {
                        const el = document.getElementById(field.id);
                        if (!el || !el.value.trim()) { el.classList.add('input-error'); isValid = false; errorMsg += `• 請填寫 ${field.name}\n`; }
                    });
                }
                const dateFields = ['start_y', 'start_m', 'start_d', 'end_y', 'end_m', 'end_d'];
                dateFields.forEach(id => {
                    const el = document.getElementById(id);
                    if (!el || !el.value.trim()) { el.classList.add('input-error'); isValid = false; errorMsg += `• 請填寫完整的實習期間\n`; }
                });
                
                const contractType = document.querySelector('input[name="contract_type"]:checked');
                if (!contractType) {
                    document.getElementById('type-section').classList.add('bg-red-50', 'border-red-200'); isValid = false; errorMsg += "• 請選擇實習類型\n";
                } else {
                    if (contractType.value === 'learn') {
                        const payOpt = document.querySelector('input[name="pay_opt_learn"]:checked');
                        if (!payOpt) {
                            document.getElementById('pay-section').classList.add('bg-red-50', 'border-red-200'); isValid = false; errorMsg += "• 請選擇學習型給付項目\n";
                        } else if (payOpt.value !== 'none') {
                            const amt = document.getElementById('learn_amount');
                            if (!amt.value || Number(amt.value) <= 0) { amt.classList.add('input-error'); isValid = false; errorMsg += "• 請輸入獎學金/津貼金額 (須大於 0)\n"; }
                        }
                    } else if (contractType.value === 'work') {
                        const amt = document.getElementById('work_amount');
                        if (!amt.value || Number(amt.value) <= 0) { amt.classList.add('input-error'); isValid = false; errorMsg += "• 請輸入薪資金額 (須大於 0)\n"; }
                    }
                }
                ['dorm', 'food', 'trans'].forEach(p => {
                    const val = document.getElementById(p + '_opt').value;
                    if (!val) { document.getElementById('welfare-section').classList.add('bg-red-50', 'border-red-200'); isValid = false; errorMsg += `• 請選擇${p==='dorm'?'住宿':p==='food'?'膳食':'交通'}福利\n`; }
                });
            }

            if (isProposal && students.length > 0 && studentErrorCount === 0) {
                let proposalErrorCount = 0;
                const selectedStudents = students.filter(s => s.isSelected);
                selectedStudents.forEach((s, i) => {
                    const fields = ['teacher_name', 'course_name', 'semester', 'credits'];
                    let studentHasError = false;
                    fields.forEach(field => {
                        const input = document.getElementById(`p_${field}_${s.index}`);
                        if (!input || !input.value.trim()) { input?.classList.add('input-error'); studentHasError = true; }
                    });
                    const selectEl = document.getElementById(`p_intern_type_select_${s.index}`);
                    if (!selectEl || !selectEl.value.trim()) {
                        selectEl?.classList.add('input-error'); document.getElementById(`p_type_error_${s.index}`).textContent = '請選擇'; studentHasError = true;
                    } else { document.getElementById(`p_type_error_${s.index}`).textContent = ''; }
                    if (studentHasError) { proposalErrorCount++; isValid = false; }
                });
                if (proposalErrorCount > 0) errorMsg += `• 學生實習計畫書 (Page 4) 共有 ${proposalErrorCount} 位選取的學生的必填欄位未填寫。\n`;
            }

            if (!isValid) showError("請修正以下錯誤：\n" + errorMsg);
            return isValid;
        }

        async function getCompanyInfo() {
            const taxIdInput = document.getElementById('company_tax_id');
            const taxId = taxIdInput.value.trim();
            const originalApiURL = `https://data.gcis.nat.gov.tw/od/data/api/5F64D864-61CB-4D0D-8AD9-492047CC1EA6?$format=json&$filter=Business_Accounting_NO eq ${taxId}&$skip=0&$top=1`;
            const apiURL = `https://corsproxy.io/?${encodeURIComponent(originalApiURL)}`;
            const queryBtn = document.getElementById('queryBtn');
            const originalQueryBtnHtml = queryBtn.innerHTML;

            try {
                queryBtn.disabled = true; queryBtn.classList.add('btn-query-loading');
                queryBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> 查詢中...';
                let response; const maxRetries = 3; const timeoutDuration = 10000;
                for (let i = 0; i < maxRetries; i++) {
                    try {
                        const controller = new AbortController();
                        const timeoutId = setTimeout(() => controller.abort(), timeoutDuration);
                        response = await fetch(apiURL, { signal: controller.signal });
                        clearTimeout(timeoutId);
                        if (response.ok) break; 
                    } catch (error) { if (i === maxRetries - 1) throw new Error("API_NETWORK_ERROR"); await new Promise(resolve => setTimeout(resolve, Math.pow(2, i) * 1000)); }
                }

                if (!response || !response.ok) throw new Error("API_REQUEST_FAILED");
                const contentType = response.headers.get("content-type");
                if (!contentType || !contentType.includes("application/json")) throw new Error("API_CONTENT_ERROR");
                const data = await response.json();
                if (!data || data.length === 0) throw new Error("NO_DATA_FOUND");

                const company = data[0];
                document.getElementById('company_name').value = company.Company_Name || "";
                document.getElementById('company_rep').value = company.Responsible_Name || "";
                document.getElementById('reg_address').value = company.Company_Location || "";
                document.getElementById('branch_name').value = ""; document.getElementById('branch_addr').value = "";
                document.getElementById('no_tax_id').checked = false; toggleTaxIdFields(); 
                showMsg(`「 ${company.Company_Name} 」公司資料已自動填入。`);

            } catch (e) {
                if (e.name === 'AbortError' || e.message.includes('Failed to fetch') || e.message.includes('NO_DATA_FOUND')) {
                    showQueryInfo("查無資料，請手動填入相關欄位。");
                    document.getElementById('company_name').value = ""; document.getElementById('company_rep').value = ""; document.getElementById('reg_address').value = "";
                } else {
                    showError(`非預期錯誤：${e.message || e}`);
                }
            } finally {
                queryBtn.classList.remove('btn-query-loading'); queryBtn.innerHTML = originalQueryBtnHtml; updateQueryButtonState();
            }
        }

        async function generateDoc() {
            if (!validateForm(false)) return;
            const btn = document.getElementById('genContractBtn');
            try {
                if (typeof PizZip === 'undefined' || typeof window.docxtemplater === 'undefined' || typeof saveAs === 'undefined') { showError("核心元件未載入"); return; }
                showMsg("處理中..."); btn.disabled = true; btn.classList.remove('btn-generate'); btn.classList.add('bg-gray-400', 'cursor-not-allowed'); btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> 處理中...';
                collectStudentDataFromPage2(); updateProposalDataState();

                const data = {};
                data.company_name = (document.getElementById('company_name')?.value || "未填寫");
                data.company_rep = (document.getElementById('company_rep')?.value || "");
                data.company_title = (document.getElementById('company_title')?.value || "");
                const regAddr = document.getElementById('reg_address')?.value || "";
                data.company_address = regAddr;
                const noTaxIdChecked = document.getElementById('no_tax_id').checked;
                data.company_tax_id = noTaxIdChecked ? "實習機構未申請設立字號" : (document.getElementById('company_tax_id')?.value || "").trim();
                const isHeadOffice = document.getElementById('is_head_office').checked;
                const bname = isHeadOffice ? "" : document.getElementById('branch_name')?.value || "";
                const baddr = isHeadOffice ? "" : document.getElementById('branch_addr')?.value || "";
                data.intern_location = (bname && baddr) ? `${bname}（${baddr}）` : (baddr || regAddr);

                data.s_y = document.getElementById('start_y')?.value || "   "; data.s_m = document.getElementById('start_m')?.value || "   "; data.s_d = document.getElementById('start_d')?.value || "   ";
                data.e_y = document.getElementById('end_y')?.value || "   "; data.e_m = document.getElementById('end_m')?.value || "   "; data.e_d = document.getElementById('end_d')?.value || "   ";
                data.daily_start = document.getElementById('daily_start')?.value || ""; data.daily_end = document.getElementById('daily_end')?.value || ""; data.daily_hours = document.getElementById('daily_hours')?.value || "";

                const type = document.querySelector('input[name="contract_type"]:checked')?.value;
                data.type_learn_check='□'; data.type_work_check='□'; data.chk_pay_none='□'; data.chk_pay_scholar='□'; data.chk_pay_allowance='□'; data.pay_learn_amount = ""; data.pay_work_amount = "";

                if (type === 'learn') {
                    data.type_learn_check = '■'; const pOpt = document.querySelector('input[name="pay_opt_learn"]:checked')?.value;
                    if (pOpt === 'none') { data.chk_pay_none = '■'; data.pay_learn_amount = "0"; }
                    else {
                        if (pOpt === 'scholar') data.chk_pay_scholar = '■'; else data.chk_pay_allowance = '■';
                        const lam = Number(document.getElementById('learn_amount')?.value || 0); data.pay_learn_amount = lam ? lam.toLocaleString() : "";
                    }
                } else {
                    data.type_work_check = '■'; const wam = Number(document.getElementById('work_amount')?.value || 0); data.pay_work_amount = wam ? wam.toLocaleString() : "";
                }

                function setWelfare(prefix) {
                    const opt = document.getElementById(prefix + '_opt')?.value || 'none';
                    data[`chk_${prefix}_none`] = '□'; data[`chk_${prefix}_free`] = '□'; data[`chk_${prefix}_paid`] = '□';
                    if (opt === 'none') data[`chk_${prefix}_none`] = '■'; else if (opt === 'free') data[`chk_${prefix}_free`] = '■';
                    else if (prefix === 'trans' && opt === 'subsidy') {
                         data.chk_trans_paid = '■'; const val = Number(document.getElementById(prefix + '_cost')?.value || 0);
                         data[`${prefix}_desc`] = val ? val.toLocaleString() : ""; data[`${prefix}_cost`] = val ? val.toLocaleString() : "";
                    } else {
                        data[`chk_${prefix}_paid`] = '■'; const val = Number(document.getElementById(prefix + '_cost')?.value || 0);
                        data[`${prefix}_desc`] = val ? val.toLocaleString() : ""; data[`${prefix}_cost`] = val ? val.toLocaleString() : "";
                    }
                    if (!data[`${prefix}_desc`]) data[`${prefix}_desc`] = "";
                }
                setWelfare('dorm'); setWelfare('food'); setWelfare('trans');

                const sList = studentDataState.filter(s => s.name.trim());
                data.student_name = sList[0]?.name + (sList.length > 1 ? " 等" : "");
                const alphabet = ['A', 'B', 'C', 'D', 'E', 'F', 'G', 'H', 'I', 'J', 'K', 'L', 'M', 'N', 'O', 'P', 'Q', 'R', 'S', 'T', 'U', 'V', 'W', 'X', 'Y', 'Z'];
                data.students = sList.map((s, index) => ({
                    letter: alphabet[index] || (index + 1), name: s.name, dept: s.dept, grade: s.grade, raw_grade: s.raw_grade, id: s.id,
                    teacher_name: s.teacher_name || "", course_name: s.course_name || "", semester: s.semester || "", credits: s.credits || "", hours_exceeded_desc: s.hours_exceeded_desc || "",
                    intern_type_full: s.intern_type_select === 'full' ? '■' : '□', intern_type_sem: s.intern_type_select === 'sem' ? '■' : '□',
                    intern_type_winter: s.intern_type_select === 'winter' ? '■' : '□', intern_type_summer: s.intern_type_select === 'summer' ? '■' : '□', intern_type_term: s.intern_type_select === 'term' ? '■' : '□',
                }));
                data.s1_name = data.students[0]?.name || "";

                const arrayBuffer = await getTemplateBuffer('contract');
                let zip = new PizZip(arrayBuffer);
                const docFile = zip.file("word/document.xml");
                if (docFile) zip.file("word/document.xml", cleanXML(docFile.asText()));

                const Docxtemplater = window.docxtemplater || docxtemplater;
                const doc = new Docxtemplater(zip, { paragraphLoop: true, linebreaks: true, delimiters: { start: '%%%', end: '%%%' }, nullGetter: function(part) { return ""; } });
                doc.render(data);
                const out = doc.getZip().generate({ type: "blob", mimeType: "application/vnd.openxmlformats-officedocument.wordprocessingml.document" });
                saveAs(out, `東海大學實習合約_${(data.s1_name || '學生')}.docx`);
                showMsg("下載成功！");

            } catch (error) {
                if (error && error.properties && error.properties.errors) {
                    const msgs = error.properties.errors.map(e => `錯誤: ${e.properties?.explanation}`).join("\n"); showError("標籤錯誤：" + msgs);
                } else { showError("產生錯誤：" + (error.message || error)); }
            } finally {
                btn.disabled = false; btn.classList.remove('bg-gray-400', 'cursor-not-allowed'); btn.classList.add('btn-generate'); btn.innerHTML = '<i class="fa-regular fa-file-word"></i> 產生合約文件 (Word)';
            }
        }
        
        async function generateProposalDoc() {
             showModal("提示", "建議使用「打包下載」功能，可以一次下載所有選取學生的個別計畫書。", 'info');
        }
        
        async function downloadIndividualProposal(index) {
            if (!validateForm(true)) return;
            const student = studentDataState[index];
            if (!student || !student.name.trim()) { showModal("錯誤", "無法下載，該學生資料不完整或不存在。", 'error'); return; }
            await generateProposalFile(student);
        }

        async function downloadSelectedProposals() {
            if (!validateForm(true)) return;
            const selectedStudents = studentDataState.filter(s => s.isSelected && s.name.trim());
            if (selectedStudents.length === 0) { showModal("提示", "請至少選取一位學生。", 'warning'); return; }
            if (typeof JSZip === 'undefined') { showError("核心元件未載入"); return; }

            const zip = new JSZip();
            const bulkDownloadBtn = document.getElementById('bulkDownloadBtn');
            const originalBtnHtml = bulkDownloadBtn.innerHTML;
            bulkDownloadBtn.disabled = true; bulkDownloadBtn.innerHTML = `<i class="fa-solid fa-spinner fa-spin"></i> 正在打包 (${selectedStudents.length} 份)...`; showMsg("正在打包計畫書...");

            try {
                const arrayBuffer = await getTemplateBuffer('proposal');
                const companyName = document.getElementById('company_name')?.value || "未填寫";
                const regAddr = document.getElementById('reg_address')?.value || "";
                const branchName = document.getElementById('branch_name')?.value || "";
                const isHeadOffice = document.getElementById('is_head_office')?.checked;
                let planLoc = companyName; if (!isHeadOffice && branchName) planLoc = `${companyName} (${branchName})`;

                const s_y = document.getElementById('start_y')?.value || ""; const s_m = document.getElementById('start_m')?.value || ""; const s_d = document.getElementById('start_d')?.value || "";
                const e_y = document.getElementById('end_y')?.value || ""; const e_m = document.getElementById('end_m')?.value || ""; const e_d = document.getElementById('end_d')?.value || "";

                const commonData = {
                    company_name: companyName, company_address: regAddr, plan_intern_location: planLoc,
                    s_y, s_m, s_d, e_y, e_m, e_d,
                    company_tax_id: document.getElementById('no_tax_id').checked ? "實習機構未申請設立字號" : (document.getElementById('company_tax_id')?.value || "未填寫"),
                    company_rep: document.getElementById('company_rep')?.value || "未填寫", company_title: document.getElementById('company_title')?.value || "未填寫",
                };

                const Docxtemplater = window.docxtemplater || docxtemplater;

                for (const student of selectedStudents) {
                    const data = { ...commonData, students: [{...student, letter: 'A'}], student_name: student.name, s1_name: student.name, id: student.id, dept: student.dept, grade: student.grade, teacher_name: student.teacher_name, course_name: student.course_name, semester: student.semester, credits: student.credits, hours_exceeded_desc: student.hours_exceeded_desc, intern_type_full: student.intern_type_select === 'full' ? '■' : '□', intern_type_sem: student.intern_type_select === 'sem' ? '■' : '□', intern_type_winter: student.intern_type_select === 'winter' ? '■' : '□', intern_type_summer: student.intern_type_select === 'summer' ? '■' : '□', intern_type_term: student.intern_type_select === 'term' ? '■' : '□', };

                    let docZip = new PizZip(arrayBuffer.slice(0));
                    const docFile = docZip.file("word/document.xml");
                    if (docFile) docZip.file("word/document.xml", cleanXML(docFile.asText()));

                    const doc = new Docxtemplater(docZip, { paragraphLoop: true, linebreaks: true, delimiters: { start: '%%%', end: '%%%' }, nullGetter: function(part) { return ""; } });
                    doc.render(data);
                    const out = doc.getZip().generate({ type: "nodebuffer" });
                    zip.file(`實習計畫書_${student.name}.docx`, out);
                }

                zip.generateAsync({ type: "blob" }).then(function(content) { saveAs(content, "學生實習計畫書_打包.zip"); showMsg(`成功打包 ${selectedStudents.length} 份計畫書。`); });

            } catch (error) {
                if (error && error.properties && error.properties.errors) {
                     const msgs = error.properties.errors.map(e => `錯誤: ${e.properties?.explanation}`).join("\n"); showError("打包計畫書時標籤錯誤：" + msgs);
                } else { showError("打包計畫書時發生錯誤，請檢查範本或學生資料。" + (error.message || error)); }
            } finally {
                bulkDownloadBtn.disabled = false; bulkDownloadBtn.innerHTML = originalBtnHtml;
            }
        }

        async function generateProposalFile(studentData) {
            const tempBtn = document.getElementById('bulkDownloadBtn') || document.getElementById('genProposalBtn');
            const originalBtnHtml = tempBtn ? tempBtn.innerHTML : '';
            if(tempBtn) { tempBtn.disabled = true; tempBtn.innerHTML = `<i class="fa-solid fa-spinner fa-spin"></i> 正在生成 ${studentData.name}...`; }

            try {
                const arrayBuffer = await getTemplateBuffer('proposal');
                const companyName = document.getElementById('company_name')?.value || "未填寫";
                const regAddr = document.getElementById('reg_address')?.value || "";
                const branchName = document.getElementById('branch_name')?.value || "";
                const isHeadOffice = document.getElementById('is_head_office')?.checked;
                let planLoc = companyName; if (!isHeadOffice && branchName) planLoc = `${companyName} (${branchName})`;
                
                const s_y = document.getElementById('start_y')?.value || ""; const s_m = document.getElementById('start_m')?.value || ""; const s_d = document.getElementById('start_d')?.value || "";
                const e_y = document.getElementById('end_y')?.value || ""; const e_m = document.getElementById('end_m')?.value || ""; const e_d = document.getElementById('end_d')?.value || "";

                const data = {
                    company_name: companyName, company_address: regAddr, plan_intern_location: planLoc,
                    s_y, s_m, s_d, e_y, e_m, e_d,
                    students: [studentData], student_name: studentData.name, s1_name: studentData.name, id: studentData.id, dept: studentData.dept, grade: studentData.grade,
                    teacher_name: studentData.teacher_name, course_name: studentData.course_name, semester: studentData.semester, credits: studentData.credits, hours_exceeded_desc: studentData.hours_exceeded_desc,
                    intern_type_full: studentData.intern_type_select === 'full' ? '■' : '□', intern_type_sem: studentData.intern_type_select === 'sem' ? '■' : '□', intern_type_winter: studentData.intern_type_select === 'winter' ? '■' : '□', intern_type_summer: studentData.intern_type_select === 'summer' ? '■' : '□', intern_type_term: studentData.intern_type_select === 'term' ? '■' : '□',
                };
                
                let docZip = new PizZip(arrayBuffer);
                const docFile = docZip.file("word/document.xml");
                if (docFile) docZip.file("word/document.xml", cleanXML(docFile.asText()));

                const Docxtemplater = window.docxtemplater || docxtemplater;
                const doc = new Docxtemplater(docZip, { paragraphLoop: true, linebreaks: true, delimiters: { start: '%%%', end: '%%%' }, nullGetter: function(part) { return ""; } });
                doc.render(data);
                const out = doc.getZip().generate({ type: "blob", mimeType: "application/vnd.openxmlformats-officedocument.wordprocessingml.document" });
                saveAs(out, `實習計畫書_${studentData.name}.docx`);
                showMsg(`成功生成 ${studentData.name} 的計畫書。`);

            } catch (error) {
                if (error && error.properties && error.properties.errors) {
                    const msgs = error.properties.errors.map(e => `錯誤: ${e.properties?.explanation}`).join("\n"); showError("計畫書標籤錯誤：" + msgs);
                } else { showError("生成個別計畫書錯誤：" + (error.message || error)); }
            } finally {
                if(tempBtn) { tempBtn.disabled = false; tempBtn.innerHTML = originalBtnHtml; }
            }
        }

        window.onload = function() {
            renderStudents();
            if (typeof PizZip === 'undefined' || typeof window.docxtemplater === 'undefined') {
                document.getElementById('lib-error').style.display = 'block'; document.getElementById('missing-lib').innerText = "核心元件";
            } else {
                const btn = document.getElementById('genContractBtn'); btn.disabled = false; btn.classList.remove('bg-gray-400', 'cursor-not-allowed', 'opacity-75'); btn.classList.add('btn-generate'); btn.innerHTML = '<i class="fa-regular fa-file-word"></i> 產生合約文件 (Word)';
                const btn2 = document.getElementById('genProposalBtn'); const bulkBtn = document.getElementById('bulkDownloadBtn');
                btn2.disabled = false; btn2.classList.add('btn-generate'); btn2.innerHTML = '<i class="fa-regular fa-file-word"></i> 產生實習計畫書 (Word)';
                bulkBtn.disabled = false; bulkBtn.classList.add('btn-generate');
            }
            toggleType(); togglePayInputs(); toggleCost('dorm'); toggleCost('food'); toggleCost('trans');
            document.getElementById('is_head_office').checked = false; toggleBranchFields(); 
            const taxIdInput = document.getElementById('company_tax_id'); if (taxIdInput) taxIdInput.addEventListener('input', updateQueryButtonState);
            document.getElementById('no_tax_id').checked = false; toggleTaxIdFields(); 
            const queryBtn = document.getElementById('queryBtn'); if (queryBtn) queryBtn.addEventListener('click', getCompanyInfo);
            showPage('page-1');
            document.getElementById('student_container').addEventListener('input', collectStudentDataFromPage2);
        };
    </script>
</body>
</html>
