<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>æ±æµ·å¤§å­¸å­¸ç”Ÿæ ¡å¤–å¯¦ç¿’åˆç´„æ›¸ç”¢ç”Ÿç³»çµ± (V1.0.0)</title>

    <!-- æ ¸å¿ƒå‡½å¼åº« -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/pizzip@3.1.4/dist/pizzip.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/docxtemplater/3.37.11/docxtemplater.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/1.3.8/FileSaver.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>

    <!-- æ±æµ·é…è‰² -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        thuBlue: '#002E5D',
                        thuGold: '#C6A87C',
                    },
                    fontFamily: {
                        sans: ['"Noto Sans TC"', 'sans-serif'],
                    }
                }
            }
        }
    </script>

    <style>
        body {
            background-color: #f3f4f6;
            font-family: 'Noto Sans TC', sans-serif;
            padding-bottom: 100px; 
        }
        
        .input-field {
            background-color: white;
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            padding: 0.5rem;
            width: 100%;
            font-size: 1rem;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        .input-field:focus {
            outline: none;
            border-color: #002E5D;
            box-shadow: 0 0 0 3px rgba(0, 46, 93, 0.1);
        }

        /* æ°‘åœ‹æ—¥æœŸå°ˆç”¨æ¨£å¼ & ç§»é™¤ä¸Šä¸‹ç®­é ­ */
        .date-group {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            background: white;
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            padding: 0.5rem;
        }
        .date-group:focus-within {
            border-color: #002E5D;
            box-shadow: 0 0 0 3px rgba(0, 46, 93, 0.1);
        }
        .date-input {
            border: none;
            text-align: center;
            width: 100%;
            outline: none;
            font-size: 1rem;
            color: #374151;
            /* ç§»é™¤èƒŒæ™¯è‰²ä»¥èå…¥ group */
            background: transparent; 
        }
        /* ç§»é™¤ Chrome, Safari, Edge, Opera çš„ä¸Šä¸‹ç®­é ­ */
        .date-input::-webkit-outer-spin-button,
        .date-input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        /* ç§»é™¤ Firefox çš„ä¸Šä¸‹ç®­é ­ */
        .date-input[type=number] {
            -moz-appearance: textfield;
        }

        .date-sep {
            color: #9ca3af;
            font-weight: bold;
            user-select: none;
        }

        .card { background: white; border-radius: 0.5rem; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); overflow: hidden; margin-bottom: 1.5rem; }
        .card-header { padding: 1rem 1.5rem; border-bottom: 1px solid #e5e7eb; color: #002E5D; font-weight: 700; font-size: 1.125rem; display: flex; align-items: center; }
        .border-top-blue { border-top: 4px solid #002E5D; }
        .border-top-gold { border-top: 4px solid #C6A87C; }
        .hidden { display: none; }
        
        #status-bar { display: none; position: fixed; bottom: 80px; right: 20px; background: #333; color: white; padding: 8px 16px; border-radius: 6px; z-index: 9999; box-shadow: 0 4px 12px rgba(0,0,0,0.3); font-size: 0.9rem; }
        #lib-error { display: none; position: fixed; top: 0; left: 0; width: 100%; background: #ef4444; color: white; text-align: center; padding: 10px; z-index: 9999; font-weight: bold; }
        #error-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10000; align-items: center; justify-content: center; }
        #error-content { background: white; padding: 20px; border-radius: 8px; max-width: 80%; max-height: 80%; overflow-y: auto; }
        pre { white-space: pre-wrap; word-break: break-word; }

        footer {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background-color: #1f2937;
            color: #9ca3af;
            text-align: center;
            padding: 0.8rem 0;
            font-size: 0.75rem;
            z-index: 50;
            border-top: 3px solid #C6A87C;
            box-shadow: 0 -4px 6px -1px rgba(0, 0, 0, 0.1);
        }
    </style>
</head>
<body>

    <div id="lib-error">
        âš ï¸ ç³»çµ±åµæ¸¬åˆ°æ ¸å¿ƒå…ƒä»¶æœªè¼‰å…¥æˆåŠŸï¼å¯èƒ½æ˜¯ç¶²è·¯é˜»æ“‹äº† CDNã€‚<br>
        è«‹å˜—è©¦ä½¿ç”¨æ‰‹æ©Ÿç¶²è·¯æˆ–æ›´æ›ç€è¦½å™¨ã€‚éŒ¯èª¤å…ƒä»¶ï¼š<span id="missing-lib"></span>
    </div>

    <div id="status-bar">æº–å‚™å°±ç·’</div>

    <!-- éŒ¯èª¤è¨Šæ¯å½ˆçª— -->
    <div id="error-modal">
        <div id="error-content">
            <h3 class="text-lg font-bold text-red-600 mb-2">ç™¼ç”ŸéŒ¯èª¤</h3>
            <pre id="error-details" class="text-sm bg-gray-100 p-2 rounded"></pre>
            <button id="err-close" class="mt-4 bg-thuBlue text-white px-4 py-2 rounded hover:bg-blue-800 transition">é—œé–‰</button>
        </div>
    </div>

    <!-- Header -->
    <div class="fixed top-0 left-0 w-full h-auto md:h-[80px] bg-thuBlue text-white z-50 flex flex-col md:flex-row items-center justify-between px-4 md:px-8 shadow-md py-2 md:py-0">
        <div class="flex items-center gap-3 mb-2 md:mb-0">
            <div class="w-12 h-12 bg-white rounded-full flex items-center justify-center text-thuBlue font-bold text-2xl shrink-0">
                <i class="fa-solid fa-university"></i>
            </div>
            <div class="flex flex-col justify-center">
                <div class="text-lg md:text-xl font-bold tracking-wide leading-tight">æ±æµ·å¤§å­¸ | å¯¦ç¿’èˆ‡å­¸ç”Ÿæˆå°±ä¸­å¿ƒ</div>
                <div class="text-xs text-thuGold opacity-90 font-sans leading-tight">å­¸ç”Ÿæ ¡å¤–å¯¦ç¿’åˆç´„æ›¸ç”¢ç”Ÿç³»çµ±</div>
            </div>
        </div>
        
        <!-- å³ä¸Šè§’é€£çµå€ -->
        <div class="flex gap-3 text-sm">
            <a href="https://aca.thu.edu.tw/web/isac/page.php?scid=112&sid=103" target="_blank" class="flex items-center gap-1 px-3 py-1.5 border border-thuGold text-thuGold rounded hover:bg-thuGold hover:text-thuBlue transition-colors duration-200 text-xs md:text-sm">
                <i class="fa-solid fa-link"></i> å¯¦ç¿’ä¸­å¿ƒç¶²é 
            </a>
            <a href="https://www.thu.edu.tw/" target="_blank" class="flex items-center gap-1 px-3 py-1.5 bg-thuGold text-thuBlue font-bold rounded hover:bg-yellow-500 transition-colors duration-200 text-xs md:text-sm">
                <i class="fa-solid fa-house"></i> æ±æµ·å¤§å­¸é¦–é 
            </a>
        </div>
    </div>

    <!-- æ­¥é©Ÿæ¢ -->
    <div class="mt-36 md:mt-28 mb-6 px-4 md:px-8 max-w-5xl mx-auto flex justify-between items-center relative">
        <div class="flex flex-col items-center z-10"><div class="w-8 h-8 bg-thuBlue text-white rounded-full flex items-center justify-center font-bold mb-1 shadow-md">1</div><span class="text-xs md:text-sm font-medium text-gray-600">æ©Ÿæ§‹è³‡æ–™</span></div>
        <div class="flex-1 h-1 bg-gray-300 mx-2 md:mx-4 rounded"></div>
        <div class="flex flex-col items-center z-10"><div class="w-8 h-8 bg-thuBlue text-white rounded-full flex items-center justify-center font-bold mb-1 shadow-md">2</div><span class="text-xs md:text-sm font-medium text-gray-600">å­¸ç”Ÿè³‡æ–™</span></div>
        <div class="flex-1 h-1 bg-gray-300 mx-2 md:mx-4 rounded"></div>
        <div class="flex flex-col items-center z-10"><div class="w-8 h-8 bg-thuBlue text-white rounded-full flex items-center justify-center font-bold mb-1 shadow-md">3</div><span class="text-xs md:text-sm font-medium text-gray-600">æ¢ä»¶è¨­å®š</span></div>
    </div>

    <!-- ä¸»è¦è¡¨å–® -->
    <main class="max-w-5xl mx-auto px-4">
        
        <!-- ä½¿ç”¨é ˆçŸ¥ -->
        <div class="bg-blue-50 border-l-4 border-blue-400 p-4 mb-6 rounded shadow-sm">
            <div class="flex">
                <div class="ml-1 w-full">
                    <p class="text-sm text-blue-700 font-bold text-lg mb-1">
                        ğŸ“‹ ä½¿ç”¨é ˆçŸ¥
                    </p>
                    <div class="text-sm text-blue-800 pl-2 border-l-2 border-blue-200 min-h-[20px]">
                        <!-- å…§å®¹ç•™ç™½ -->
                    </div>
                </div>
            </div>
        </div>

        <!-- å¡ç‰‡ 1: æ©Ÿæ§‹è³‡æ–™ -->
        <div class="card border-top-blue">
            <div class="card-header bg-gray-50"><i class="fa-regular fa-building mr-2"></i> ä¹™æ–¹ï¼šå¯¦ç¿’æ©Ÿæ§‹è³‡æ–™</div>
            <div class="p-6 grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="md:col-span-2">
                    <label class="text-sm font-medium text-gray-700 mb-1 block">æ©Ÿæ§‹å…¨éŠœ (æ³•å®šåç¨±)</label>
                    <input type="text" id="company_name" class="input-field" placeholder="ä¾‹ï¼šåœ‹æ³°ä¸–è¯å•†æ¥­éŠ€è¡Œè‚¡ä»½æœ‰é™å…¬å¸">
                </div>
                <div>
                    <label class="text-sm font-medium text-gray-700 mb-1 block">çµ±ä¸€ç·¨è™Ÿ</label>
                    <input type="text" id="company_tax_id" class="input-field">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="text-sm font-medium text-gray-700 mb-1 block">ä»£è¡¨äººå§“å</label>
                        <input type="text" id="company_rep" class="input-field">
                    </div>
                    <div>
                        <label class="text-sm font-medium text-gray-700 mb-1 block">ä»£è¡¨äººè·ç¨±</label>
                        <!-- ç§»é™¤ value="è² è²¬äºº" -->
                        <input type="text" id="company_title" class="input-field" placeholder="">
                    </div>
                </div>
                <div class="md:col-span-2">
                    <label class="text-sm font-medium text-gray-700 mb-1 block">å…¬å¸ç™»è¨˜åœ°å€ (ç¸½å…¬å¸)</label>
                    <input type="text" id="reg_address" class="input-field" placeholder="ä¾‹ï¼šè‡ºåŒ—å¸‚ä¿¡ç¾©å€æ¾ä»è·¯7è™Ÿ1æ¨“">
                </div>
                
                <!-- åˆ†å…¬å¸ -->
                <div class="md:col-span-2 pt-2">
                    <label class="flex items-center gap-2 text-sm font-bold text-gray-600 cursor-pointer select-none">
                        <input type="checkbox" id="is_branch" onchange="toggleBranch()" class="w-4 h-4 text-thuBlue rounded focus:ring-thuBlue cursor-pointer"> 
                        <span>å¯¦ç¿’åœ°é»èˆ‡ç™»è¨˜åœ°å€ä¸åŒ (å¦‚æ´¾é§åˆ†å…¬å¸)</span>
                    </label>
                    <div id="branch_area" class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-3 hidden bg-gray-50 p-4 rounded border border-gray-200">
                        <div>
                            <label class="text-sm text-gray-500 mb-1 block">å¯¦ç¿’å–®ä½/åˆ†å…¬å¸åç¨±</label>
                            <input type="text" id="branch_name" class="input-field" placeholder="ä¾‹ï¼šæ·¡æ°´åˆ†å…¬å¸">
                        </div>
                        <div>
                            <label class="text-sm text-gray-500 mb-1 block">å¯¦éš›å¯¦ç¿’åœ°å€</label>
                            <input type="text" id="branch_addr" class="input-field" placeholder="ä¾‹ï¼šæ–°åŒ—å¸‚æ·¡æ°´å€ä¸­å±±è·¯106è™Ÿ">
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- å¡ç‰‡ 2: å­¸ç”Ÿè³‡æ–™ -->
        <div class="card border-top-blue">
            <div class="card-header bg-gray-50 flex justify-between">
                <div><i class="fa-solid fa-user-graduate mr-2"></i> ç”²æ–¹ï¼šå¯¦ç¿’å­¸ç”Ÿè³‡æ–™</div>
                <select id="student_count" onchange="renderStudents()" class="border border-gray-300 rounded px-3 py-1 text-sm bg-white hover:border-thuBlue focus:ring-2 focus:ring-thuBlue focus:outline-none transition-colors cursor-pointer">
                    <option value="1">1 ä½å­¸ç”Ÿ</option>
                    <option value="2">2 ä½å­¸ç”Ÿ</option>
                    <option value="3">3 ä½å­¸ç”Ÿ</option>
                </select>
            </div>
            <div id="student_container" class="p-6 space-y-4"></div>
        </div>

        <!-- å¡ç‰‡ 3: å¯¦ç¿’æ¢ä»¶ -->
        <div class="card border-top-gold">
            <div class="card-header bg-gray-50"><i class="fa-solid fa-briefcase mr-2"></i> å¯¦ç¿’æ¢ä»¶è¨­å®š</div>
            <div class="p-6 space-y-6">
                <!-- é¡å‹ -->
                <div>
                    <label class="block text-lg font-bold text-thuBlue mb-3">1. è«‹é¸æ“‡å¯¦ç¿’é¡å‹</label>
                    <div class="flex flex-col sm:flex-row gap-4">
                        <label class="flex items-center gap-2 p-4 border-2 rounded-lg hover:bg-blue-50 cursor-pointer w-full transition-colors has-[:checked]:border-thuBlue has-[:checked]:bg-blue-50">
                            <input type="radio" name="contract_type" value="learn" checked onchange="toggleType()" class="w-5 h-5 text-thuBlue focus:ring-thuBlue">
                            <span class="font-bold text-gray-700">ä¸€èˆ¬å‹ (å­¸ç¿’å‹)</span>
                        </label>
                        <label class="flex items-center gap-2 p-4 border-2 rounded-lg hover:bg-orange-50 cursor-pointer w-full transition-colors has-[:checked]:border-orange-500 has-[:checked]:bg-orange-50">
                            <input type="radio" name="contract_type" value="work" onchange="toggleType()" class="w-5 h-5 text-orange-600 focus:ring-orange-500">
                            <span class="font-bold text-gray-700">å·¥ä½œå‹ (å‹è³‡å‹)</span>
                        </label>
                    </div>
                </div>

                <!-- æ—¥æœŸ (æ”¹ç‚ºæ°‘åœ‹å¹´æ‹†åˆ†è¼¸å…¥ + è‡ªå‹•è·³è½‰) -->
                <div>
                    <label class="block text-lg font-bold text-thuBlue mb-3">2. å¯¦ç¿’æœŸé–“</label>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <!-- é–‹å§‹æ™‚é–“ -->
                        <div>
                            <span class="text-sm text-gray-500 mb-1 block">å¯¦ç¿’é–‹å§‹æ™‚é–“ (æ°‘åœ‹å¹´/æœˆ/æ—¥)</span>
                            <div class="date-group">
                                <!-- æ·»åŠ  oninput äº‹ä»¶è™•ç†è‡ªå‹•è·³è½‰ -->
                                <input type="number" id="start_y" class="date-input w-20" placeholder="113" oninput="autoJump(this, 3, 'start_m')">
                                <span class="date-sep">/</span>
                                <input type="number" id="start_m" class="date-input w-16" placeholder="07" oninput="autoJump(this, 2, 'start_d')">
                                <span class="date-sep">/</span>
                                <input type="number" id="start_d" class="date-input w-16" placeholder="01" oninput="autoJump(this, 2, 'end_y')"> 
                                <!-- è·³åˆ°çµæŸå¹´ä»½ -->
                            </div>
                        </div>
                        <!-- çµæŸæ™‚é–“ -->
                        <div>
                            <span class="text-sm text-gray-500 mb-1 block">å¯¦ç¿’çµæŸæ™‚é–“ (æ°‘åœ‹å¹´/æœˆ/æ—¥)</span>
                            <div class="date-group">
                                <input type="number" id="end_y" class="date-input w-20" placeholder="114" oninput="autoJump(this, 3, 'end_m')">
                                <span class="date-sep">/</span>
                                <input type="number" id="end_m" class="date-input w-16" placeholder="06" oninput="autoJump(this, 2, 'end_d')">
                                <span class="date-sep">/</span>
                                <input type="number" id="end_d" class="date-input w-16" placeholder="30">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- æ™‚é–“ -->
                <div>
                    <label class="block text-lg font-bold text-thuBlue mb-3">3. æ¯æ—¥å¯¦ç¿’æ™‚é–“</label>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 bg-gray-50 p-4 rounded-lg border border-gray-200">
                        <div><span class="text-sm text-gray-500 mb-1 block">æ¯æ—¥é–‹å§‹</span><input type="time" id="daily_start" value="09:00" class="input-field font-sans"></div>
                        <div><span class="text-sm text-gray-500 mb-1 block">æ¯æ—¥çµæŸ</span><input type="time" id="daily_end" value="18:00" class="input-field font-sans"></div>
                        <div><span class="text-sm text-gray-500 mb-1 block">å…±è¨ˆ(å°æ™‚)</span><input type="number" id="daily_hours" value="8" step="0.5" class="input-field font-sans"></div>
                    </div>
                </div>

                <!-- å¾…é‡ -->
                <div class="border-t border-gray-200 pt-6">
                    <label class="block text-lg font-bold text-thuBlue mb-3">4. å¯¦ç¿’å¾…é‡èˆ‡çµ¦ä»˜</label>
                    
                    <div id="panel_learn" class="bg-green-50 p-5 rounded-lg border border-green-200">
                        <span class="text-xs font-bold text-white bg-green-600 px-2 py-1 rounded mb-3 inline-block shadow-sm">å­¸ç¿’å‹é©ç”¨</span>
                        <div class="flex flex-wrap gap-6 mb-3">
                            <label class="flex items-center gap-2 cursor-pointer hover:text-green-700"><input type="radio" name="pay_opt_learn" value="none" checked onchange="togglePayInputs()" class="text-green-600 focus:ring-green-500"> ç„¡</label>
                            <label class="flex items-center gap-2 cursor-pointer hover:text-green-700"><input type="radio" name="pay_opt_learn" value="scholar" onchange="togglePayInputs()" class="text-green-600 focus:ring-green-500"> çå­¸é‡‘</label>
                            <label class="flex items-center gap-2 cursor-pointer hover:text-green-700"><input type="radio" name="pay_opt_learn" value="allowance" onchange="togglePayInputs()" class="text-green-600 focus:ring-green-500"> å¯¦ç¿’æ´¥è²¼</label>
                        </div>
                        <div id="learn_amt_box" class="hidden transition-all">
                            <input type="number" id="learn_amount" placeholder="è«‹è¼¸å…¥æ¯æœˆé‡‘é¡ (æ–°å°å¹£)" class="input-field w-full md:w-64">
                        </div>
                    </div>

                    <div id="panel_work" class="bg-orange-50 p-5 rounded-lg border border-orange-200 hidden">
                        <span class="text-xs font-bold text-white bg-orange-600 px-2 py-1 rounded mb-3 inline-block shadow-sm">å‹è³‡å‹é©ç”¨</span>
                        <div class="mt-2">
                            <label class="block text-sm text-orange-800 font-bold mb-1">è–ªè³‡é‡‘é¡ (ä¸å¾—ä½æ–¼åŸºæœ¬å·¥è³‡)</label>
                            <input type="number" id="work_amount" placeholder="27470" class="input-field w-full md:w-64">
                        </div>
                    </div>
                </div>

                <!-- ç¦åˆ© -->
                <div class="border-t border-gray-200 pt-6">
                    <label class="block text-lg font-bold text-thuBlue mb-3">5. ç¦åˆ©é …ç›®</label>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div>
                            <label class="text-sm font-medium text-gray-700 mb-1 block">ä½å®¿</label>
                            <select id="dorm_opt" onchange="toggleCost('dorm')" class="input-field mb-2">
                                <option value="none">ç„¡</option>
                                <option value="free">å…è²»æä¾›</option>
                                <option value="paid">ä»˜è²»æä¾›</option>
                            </select>
                            <input id="dorm_cost" type="number" placeholder="é‡‘é¡ (å…ƒ/æœˆ)" class="input-field mt-1 hidden">
                        </div>
                        <div>
                            <label class="text-sm font-medium text-gray-700 mb-1 block">è†³é£Ÿ</label>
                            <select id="food_opt" onchange="toggleCost('food')" class="input-field mb-2">
                                <option value="none">ç„¡</option>
                                <option value="free">å…è²»æä¾›</option>
                                <option value="paid">ä»˜è²»æä¾›</option>
                            </select>
                            <input id="food_cost" type="number" placeholder="é‡‘é¡ (å…ƒ/é¤)" class="input-field mt-1 hidden">
                        </div>
                        <div>
                            <label class="text-sm font-medium text-gray-700 mb-1 block">äº¤é€š</label>
                            <select id="trans_opt" onchange="toggleCost('trans')" class="input-field mb-2">
                                <option value="none">ç„¡</option>
                                <option value="free">å…è²»æä¾›</option>
                                <option value="paid">ä»˜è²»æä¾›</option>
                                <option value="subsidy">äº¤é€šæ´¥è²¼</option>
                            </select>
                            <input id="trans_cost" type="number" placeholder="é‡‘é¡ (å…ƒ/æœˆ)" class="input-field mt-1 hidden">
                        </div>
                    </div>
                </div>

            </div>
        </div>

        <!-- åº•éƒ¨æ“ä½œå€ -->
        <div class="pb-8 flex justify-center md:justify-end items-center gap-4">
            <button onclick="generateDoc()" id="genBtn" disabled class="bg-gray-400 text-white px-10 py-4 rounded-lg font-bold shadow-lg transition hover:bg-blue-900 hover:shadow-xl transform hover:-translate-y-0.5 flex items-center gap-2 text-lg">
                <i class="fa-regular fa-file-word"></i> ç”¢ç”Ÿåˆç´„æ–‡ä»¶ (Word)
            </button>
        </div>
    </main>

    <!-- é å°¾ç‰ˆæ¬Šå®£å‘Š -->
    <footer>
        <div class="container mx-auto px-4">
            <div class="flex flex-col items-center justify-center">
                <p class="font-bold text-white mb-1 tracking-wide text-sm">&copy; 2025 æ±æµ·å¤§å­¸ Tunghai University. All Rights Reserved. | ç³»çµ±ç‰ˆæœ¬ V1.0.0</p>
                <p class="text-xs text-gray-500">
                    æœ¬ç³»çµ±åƒ…ä¾›ç”¢å‡ºæœ¬æ ¡å­¸ç”Ÿæ ¡å¤–å¯¦ç¿’åˆç´„ç›®çš„ä½¿ç”¨ã€‚åˆç´„å…§å®¹ç‚ºå…¬ç‰ˆæ ¼å¼ï¼Œè«‹ä¾å¯¦éš›æƒ…æ³ä¿®æ­£ã€‚æœ¬å·¥å…·ä¸æœƒå„²å­˜æˆ–ä¿ç•™ä»»ä½•å€‹äººè³‡æ–™ã€‚
                </p>
            </div>
        </div>
    </footer>

    <!-- JS é‚è¼¯ -->
    <script>
        // è‡ªå‹•è·³è½‰å‡½å¼
        function autoJump(current, maxLen, nextId) {
            if (current.value.length >= maxLen) {
                const next = document.getElementById(nextId);
                if (next) {
                    next.focus();
                }
            }
        }

        // UI Helper Functions
        function showMsg(msg) {
            const el = document.getElementById('status-bar');
            el.innerText = msg;
            el.style.display = 'block';
            setTimeout(() => { el.style.display = 'none'; }, 4000);
        }
        function showError(details) {
            const modal = document.getElementById('error-modal');
            const content = document.getElementById('error-details');
            content.textContent = details;
            modal.style.display = 'flex';
        }
        document.getElementById('err-close').addEventListener('click', () => {
            document.getElementById('error-modal').style.display = 'none';
        });

        // æ¸²æŸ“å­¸ç”Ÿæ¬„ä½
        function renderStudents() {
            const count = Number(document.getElementById('student_count').value) || 1;
            const c = document.getElementById('student_container');
            c.innerHTML = '';
            for (let i = 0; i < count; i++) {
                const wrapper = document.createElement('div');
                wrapper.className = "p-4 bg-blue-50 border border-blue-100 rounded-lg mb-3";
                wrapper.innerHTML = `
                    <div class="text-sm font-bold text-blue-800 mb-2 flex items-center gap-2">
                        <i class="fa-solid fa-user text-blue-400"></i> å­¸ç”Ÿ ${i+1}
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <input type="text" id="s_name_${i}" placeholder="å§“å" class="input-field">
                        </div>
                        <div>
                            <input type="text" id="s_id_${i}" placeholder="ç³»ç´š/å­¸è™Ÿ" class="input-field">
                        </div>
                    </div>
                `;
                c.appendChild(wrapper);
            }
        }

        function toggleBranch() {
            const checked = document.getElementById('is_branch').checked;
            const area = document.getElementById('branch_area');
            if (area) area.classList.toggle('hidden', !checked);
        }

        function toggleType() {
            const tEl = document.querySelector('input[name="contract_type"]:checked');
            const t = tEl ? tEl.value : 'learn';
            const panelLearn = document.getElementById('panel_learn');
            const panelWork = document.getElementById('panel_work');
            if (panelLearn) panelLearn.classList.toggle('hidden', t !== 'learn');
            if (panelWork) panelWork.classList.toggle('hidden', t === 'learn');
            togglePayInputs();
        }

        function togglePayInputs() {
            try {
                const box = document.getElementById('learn_amt_box');
                const sel = document.querySelector('input[name="pay_opt_learn"]:checked');
                const v = sel ? sel.value : 'none';
                if (box) box.classList.toggle('hidden', v === 'none');
            } catch (e) { console.warn(e); }
        }

        function toggleCost(prefix) {
            try {
                const optEl = document.getElementById(prefix + '_opt');
                const inputEl = document.getElementById(prefix + '_cost');
                const v = optEl ? optEl.value : 'none';
                if (!inputEl) return;
                if (v === 'paid' || v === 'subsidy') inputEl.classList.remove('hidden');
                else inputEl.classList.add('hidden');
            } catch (e) { console.warn(e); }
        }

        // XML æ¸…æ´—å¼•æ“
        function cleanXML(xmlStr) {
            try {
                xmlStr = xmlStr.replace(/<w:(proofErr|gramE|lang|bookmarkStart|bookmarkEnd|rsid[^ >]*)[^>]*\/?>/g, "");
                xmlStr = xmlStr.replace(/<w:del[^>]*>[\s\S]*?<\/w:del>/g, "");
                xmlStr = xmlStr.replace(/<w:ins[^>]*>/g, "").replace(/<\/w:ins>/g, "");
                xmlStr = xmlStr.replace(/<w:r[^>]*>\s*<w:t[^>]*\/>\s*<\/w:r>/g, "");
                // ä¿®å¾© %%%
                xmlStr = xmlStr.replace(/%\s*(<\/w:t>[\s\S]*?<w:t[^>]*>)\s*%\s*(<\/w:t>[\s\S]*?<w:t[^>]*>)\s*%/g, "%%%$2");
                // ä¿®å¾© {{ }}
                xmlStr = xmlStr.replace(/{\s*(<\/w:t>[\s\S]*?<w:t[^>]*>)\s*{/g, "{{");
                xmlStr = xmlStr.replace(/}\s*(<\/w:t>[\s\S]*?<w:t[^>]*>)\s*}/g, "}}");
                return xmlStr;
            } catch (e) {
                console.warn('cleanXML failed', e);
                return xmlStr;
            }
        }

        // ç”¢ç”Ÿæ–‡ä»¶ä¸»æµç¨‹
        async function generateDoc() {
            const btn = document.getElementById('genBtn');
            try {
                if (typeof PizZip === 'undefined') {
                    alert("æ ¸å¿ƒå…ƒä»¶æœªè¼‰å…¥ (PizZip)ã€‚è«‹ç¢ºèª CDN å¯ç”¨æˆ–æ”¹ç”¨å…¶ä»–ç¶²è·¯ã€‚");
                    return;
                }
                showMsg("è™•ç†ä¸­...");
                btn.disabled = true;
                btn.classList.remove('bg-thuBlue'); btn.classList.add('bg-gray-400');

                // æ”¶é›†è³‡æ–™
                const data = {};
                try {
                    // å…¬å¸åŸºæœ¬è³‡æ–™
                    data.company_name = (document.getElementById('company_name')?.value || "æœªå¡«å¯«");
                    data.company_tax_id = (document.getElementById('company_tax_id')?.value || "");
                    data.company_rep = (document.getElementById('company_rep')?.value || "");
                    data.company_title = (document.getElementById('company_title')?.value || "");
                    
                    // åœ°å€é‚è¼¯ä¿®æ­£:
                    const regAddr = document.getElementById('reg_address')?.value || "";
                    data.company_address = regAddr;

                    // è¨­å®šç¬¬ä¸ƒæ¢å¯¦ç¿’åœ°é»
                    if (document.getElementById('is_branch')?.checked) {
                        const bname = document.getElementById('branch_name')?.value || "";
                        const baddr = document.getElementById('branch_addr')?.value || "";
                        // æ ¼å¼ï¼šåˆ†å…¬å¸åç¨±ï¼ˆåˆ†å…¬å¸åœ°å€ï¼‰
                        if (bname && baddr) {
                            data.intern_location = `${bname}ï¼ˆ${baddr}ï¼‰`;
                        } else if (baddr) {
                            data.intern_location = baddr;
                        } else {
                            data.intern_location = regAddr; 
                        }
                    } else {
                        data.intern_location = regAddr;
                    }

                    // students
                    const sCount = Number(document.getElementById('student_count')?.value || 1);
                    const sList = [];
                    for (let i = 0; i < sCount; i++) {
                        sList.push({
                            name: document.getElementById(`s_name_${i}`)?.value || "",
                            id: document.getElementById(`s_id_${i}`)?.value || ""
                        });
                    }
                    while (sList.length < 3) sList.push({name: "", id: ""});
                    data.s1_name = sList[0].name; data.s1_id = sList[0].id;
                    data.s2_name = sList[1].name; data.s2_id = sList[1].id;
                    data.s3_name = sList[2].name; data.s3_id = sList[2].id;
                    data.student_name = sList[0].name + (sCount > 1 ? " ç­‰" : "");

                    // dates (æ”¹ç‚ºç›´æ¥è®€å–æ°‘åœ‹å¹´æ¬„ä½)
                    data.s_y = document.getElementById('start_y')?.value || "";
                    data.s_m = document.getElementById('start_m')?.value || "";
                    data.s_d = document.getElementById('start_d')?.value || "";
                    
                    data.e_y = document.getElementById('end_y')?.value || "";
                    data.e_m = document.getElementById('end_m')?.value || "";
                    data.e_d = document.getElementById('end_d')?.value || "";

                    data.daily_start = document.getElementById('daily_start')?.value || "";
                    data.daily_end = document.getElementById('daily_end')?.value || "";
                    data.daily_hours = document.getElementById('daily_hours')?.value || "";

                    const type = document.querySelector('input[name="contract_type"]:checked')?.value || 'learn';
                    data.type_learn_check='â–¡'; data.type_work_check='â–¡';
                    data.chk_pay_none='â–¡'; data.chk_pay_scholar='â–¡'; data.chk_pay_allowance='â–¡';
                    data.pay_learn_amount = ""; data.pay_work_amount = "";

                    if (type === 'learn') {
                        data.type_learn_check = 'â˜‘';
                        const pOpt = document.querySelector('input[name="pay_opt_learn"]:checked')?.value || 'none';
                        if (pOpt === 'none') { data.chk_pay_none = 'â˜‘'; data.pay_learn_amount = "0"; }
                        else {
                            if (pOpt === 'scholar') data.chk_pay_scholar = 'â˜‘';
                            else data.chk_pay_allowance = 'â˜‘';
                            const lam = Number(document.getElementById('learn_amount')?.value || 0);
                            data.pay_learn_amount = lam ? lam.toLocaleString() : "";
                            data.learn_amount_raw = lam || "";
                        }
                    } else {
                        data.type_work_check = 'â˜‘';
                        const wam = Number(document.getElementById('work_amount')?.value || 0);
                        data.pay_work_amount = wam ? wam.toLocaleString() : "";
                    }

                    // ç¦åˆ©
                    function setWelfare(prefix) {
                        const opt = document.getElementById(prefix + '_opt')?.value || 'none';
                        data[`chk_${prefix}_none`] = 'â–¡'; data[`chk_${prefix}_free`] = 'â–¡'; data[`chk_${prefix}_paid`] = 'â–¡';
                        if (opt === 'none') data[`chk_${prefix}_none`] = 'â˜‘';
                        else if (opt === 'free') data[`chk_${prefix}_free`] = 'â˜‘';
                        else {
                            data[`chk_${prefix}_paid`] = 'â˜‘';
                            const val = Number(document.getElementById(prefix + '_cost')?.value || 0);
                            data[`${prefix}_desc`] = val ? val.toLocaleString() : "";
                            data[`${prefix}_cost`] = val ? val.toLocaleString() : "";
                        }
                        if (!data[`${prefix}_desc`]) data[`${prefix}_desc`] = "";
                    }
                    setWelfare('dorm'); setWelfare('food'); setWelfare('trans');

                } catch (e) {
                    showMsg("è³‡æ–™æ”¶é›†ç™¼ç”ŸéŒ¯èª¤ï¼š" + (e.message || e));
                    console.error(e);
                    btn.disabled = false;
                    btn.classList.add('bg-thuBlue');
                    return;
                }

                // è‡ªå‹•è®€å– github ä¸Šçš„ template.docx
                let arrayBuffer;
                try {
                    const resp = await fetch('./template.docx');
                    if (!resp.ok) throw new Error('ç„¡æ³•è®€å–å…§å»ºç¯„æœ¬ (template.docx)ï¼Œè«‹ç¢ºèªæª”æ¡ˆæ˜¯å¦å­˜åœ¨ã€‚');
                    arrayBuffer = await resp.arrayBuffer();
                } catch (e) {
                    showError("è®€å–å…§å»ºç¯„æœ¬å¤±æ•—ï¼š" + e.message);
                    btn.disabled = false;
                    btn.classList.add('bg-thuBlue');
                    return;
                }

                // è§£æ zip
                let zip;
                try {
                    zip = new PizZip(arrayBuffer);
                } catch (e) {
                    showError("ç¯„æœ¬ç„¡æ³•è§£æç‚º zipï¼ˆtemplate.docx å¯èƒ½ä¸æ˜¯æœ‰æ•ˆçš„ docx æª”ï¼‰ï¼š" + e.message);
                    btn.disabled = false;
                    btn.classList.add('bg-thuBlue');
                    return;
                }

                // æ¸…æ´— document.xml
                try {
                    const docFile = zip.file("word/document.xml");
                    if (docFile) {
                        const raw = docFile.asText();
                        const cleaned = cleanXML(raw);
                        zip.file("word/document.xml", cleaned);
                    }
                } catch (e) {
                    console.warn('document.xml æ¸…æ´—å¤±æ•—ï¼Œå°‡å˜—è©¦ç¹¼çºŒã€‚', e);
                }

                // ä½¿ç”¨ docxtemplater render
                try {
                    const Docxtemplater = window.docxtemplater || docxtemplater;
                    const doc = new Docxtemplater(zip, {
                        paragraphLoop: true,
                        linebreaks: true,
                        delimiters: { start: '%%%', end: '%%%' },
                        nullGetter: function(part) { return ""; }
                    });

                    doc.render(data);
                    const out = doc.getZip().generate({
                        type: "blob",
                        mimeType: "application/vnd.openxmlformats-officedocument.wordprocessingml.document"
                    });

                    const fname = `æ±æµ·å¤§å­¸å¯¦ç¿’åˆç´„_${(data.s1_name || 'å­¸ç”Ÿ')}.docx`;
                    saveAs(out, fname);
                    showMsg("ä¸‹è¼‰æˆåŠŸï¼");
                } catch (error) {
                    if (error && error.properties && error.properties.errors) {
                        const msgs = error.properties.errors.map(e => {
                            const errId = e.properties?.id || "unknown";
                            const errExpl = e.properties?.explanation || JSON.stringify(e);
                            return `éŒ¯èª¤é¡å‹: ${errId}\nèªªæ˜: ${errExpl}`;
                        }).join("\n\n");
                        showError("ç¯„æœ¬æ¨™ç±¤éŒ¯èª¤ (Multi Error)ï¼š\n" + msgs);
                    } else {
                        showError("ç”¢ç”Ÿæ–‡ä»¶æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š" + (error.message || error));
                    }
                    console.error(error);
                }

            } catch (outer) {
                console.error('generateDoc outer error', outer);
                showError('æœªé æœŸéŒ¯èª¤ï¼š' + (outer.message || outer));
            } finally {
                btn.disabled = false;
                btn.classList.remove('bg-gray-400');
                btn.classList.add('bg-thuBlue');
            }
        }

        window.onload = function() {
            renderStudents();

            // æª¢æŸ¥å‡½å¼åº«æ˜¯å¦å·²è¼‰å…¥
            const missing = [];
            if (typeof PizZip === 'undefined') missing.push('PizZip');
            if (typeof window.docxtemplater === 'undefined' && typeof docxtemplater === 'undefined') missing.push('Docxtemplater');
            if (typeof saveAs === 'undefined') missing.push('FileSaver.saveAs');

            if (missing.length > 0) {
                document.getElementById('lib-error').style.display = 'block';
                document.getElementById('missing-lib').innerText = missing.join(', ');
                // ä¿ç•™æŒ‰éˆ• disabledï¼Œä»¥å…è§¸ç™¼éŒ¯èª¤ï¼›ä½†ä¹Ÿå…è¨±æ‰‹å‹•è¼‰å…¥ç¯„æœ¬
            } else {
                const btn = document.getElementById('genBtn');
                btn.disabled = false;
                btn.classList.remove('bg-gray-400', 'cursor-not-allowed');
                btn.classList.add('bg-thuBlue', 'hover:bg-blue-900');
                btn.innerHTML = '<i class="fa-regular fa-file-word"></i> ç”¢ç”Ÿåˆç´„æ–‡ä»¶ (Word)';
            }

            toggleType();
            togglePayInputs();
            toggleCost('dorm');
            toggleCost('food');
            toggleCost('trans');
        };
    </script>
</body>
</html>
