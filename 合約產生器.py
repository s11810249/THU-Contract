# -*- coding: utf-8 -*-
"""åˆç´„ç”¢ç”Ÿå™¨

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1AbDIg7N9-2UysC5N90zAo84uv5G23v_i
"""

import streamlit as st
from docxtpl import DocxTemplate
import io
from datetime import datetime

# --- 1. é é¢è¨­å®š ---
st.set_page_config(page_title="æ±æµ·å¤§å­¸å¯¦ç¿’åˆç´„ç”¢ç”Ÿç³»çµ±", page_icon="ğŸ“", layout="centered")

st.markdown("""
    <style>
    .main-header {
        color: #002E5D;
        font-weight: bold;
        text-align: center;
        padding-bottom: 20px;
        border-bottom: 3px solid #C6A87C;
        margin-bottom: 20px;
    }
    .section-card {
        background-color: #f8f9fa;
        padding: 20px;
        border-radius: 10px;
        border-left: 5px solid #002E5D;
        margin-bottom: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .stButton>button {
        width: 100%;
        background-color: #002E5D;
        color: white;
        font-weight: bold;
    }
    </style>
""", unsafe_allow_html=True)

st.markdown("<h1 class='main-header'>ğŸ“ æ±æµ·å¤§å­¸å­¸ç”Ÿæ ¡å¤–å¯¦ç¿’åˆç´„ç”¢ç”Ÿç³»çµ±</h1>", unsafe_allow_html=True)

# æº–å‚™è³‡æ–™å®¹å™¨
context = {}

# --- 2. å¯¦ç¿’æ©Ÿæ§‹è³‡æ–™å€ ---
st.markdown("<div class='section-card'><h3>ğŸ¢ ä¹™æ–¹ï¼šå¯¦ç¿’æ©Ÿæ§‹è³‡æ–™</h3>", unsafe_allow_html=True)
col_c1, col_c2 = st.columns(2)
with col_c1:
    company_name = st.text_input("æ©Ÿæ§‹å…¨éŠœ (æ³•å®šåç¨±)", placeholder="ä¾‹ï¼šåœ‹æ³°ä¸–è¯å•†æ¥­éŠ€è¡Œè‚¡ä»½æœ‰é™å…¬å¸")
    company_rep = st.text_input("ä»£è¡¨äººå§“å")
    company_title = st.text_input("ä»£è¡¨äººè·ç¨±", value="è² è²¬äºº") # æ–°å¢æ¬„ä½
with col_c2:
    company_tax_id = st.text_input("çµ±ä¸€ç·¨è™Ÿ")

st.markdown("---")
reg_address = st.text_input("å…¬å¸ç™»è¨˜åœ°å€")
is_branch = st.checkbox("å¯¦ç¿’åœ°é»èˆ‡ç™»è¨˜åœ°å€ä¸åŒ (å¦‚æ´¾é§åˆ†å…¬å¸)")

if is_branch:
    branch_name = st.text_input("å¯¦ç¿’å–®ä½/åˆ†å…¬å¸åç¨±", placeholder="ä¾‹ï¼šè¥¿å±¯åˆ†å…¬å¸")
    branch_address = st.text_input("å¯¦éš›å¯¦ç¿’åœ°å€")
    final_address = f"{reg_address} (å¯¦ç¿’åœ°é»ï¼š{branch_name} - {branch_address})"
else:
    final_address = reg_address
st.markdown("</div>", unsafe_allow_html=True)

# --- 3. å­¸ç”Ÿè³‡æ–™å€ (å¤šäººè™•ç†é‚è¼¯) ---
st.markdown("<div class='section-card'><h3>ğŸ§‘â€ğŸ“ ç”²æ–¹ï¼šå­¸ç”Ÿè³‡æ–™</h3>", unsafe_allow_html=True)

# è®“ä½¿ç”¨è€…é¸æ“‡äººæ•¸
student_count = st.number_input("æœ¬åˆç´„åŒ…å«å¹¾ä½å­¸ç”Ÿï¼Ÿ", min_value=1, max_value=3, value=1)
student_list = []

for i in range(student_count):
    st.markdown(f"**å­¸ç”Ÿ {i+1}**")
    col_s1, col_s2 = st.columns(2)
    with col_s1:
        s_name = st.text_input(f"å§“å ({i+1})", key=f"s_name_{i}")
    with col_s2:
        s_id = st.text_input(f"ç³»ç´š/å­¸è™Ÿ ({i+1})", key=f"s_id_{i}")
    student_list.append({'name': s_name, 'id': s_id})

# è£œé½Š 3 äººç©ºä½ (é˜²å‘†ï¼Œé¿å… Word è®Šæ•¸å ±éŒ¯)
while len(student_list) < 3:
    student_list.append({'name': "", 'id': ""})

st.markdown("</div>", unsafe_allow_html=True)

# --- 4. å¯¦ç¿’æ¢ä»¶èˆ‡å¾…é‡ (æ ¸å¿ƒé‚è¼¯) ---
st.markdown("<div class='section-card'><h3>ğŸ“ å¯¦ç¿’æ¢ä»¶èˆ‡å¾…é‡</h3>", unsafe_allow_html=True)

contract_type = st.radio("å¯¦ç¿’é¡å‹ï¼š", ("ä¸€èˆ¬å‹ (å­¸ç¿’å‹)", "å·¥ä½œå‹ (å‹è³‡å‹)"), horizontal=True)

# æ—¥æœŸè™•ç†
col_d1, col_d2 = st.columns(2)
with col_d1:
    s_date = st.date_input("é–‹å§‹æ—¥æœŸ")
    s_y, s_m, s_d = s_date.year - 1911, s_date.month, s_date.day
with col_d2:
    e_date = st.date_input("çµæŸæ—¥æœŸ")
    e_y, e_m, e_d = e_date.year - 1911, e_date.month, e_date.day

# æ™‚é–“è™•ç†
col_t1, col_t2, col_t3 = st.columns(3)
with col_t1:
    daily_start = st.time_input("æ¯æ—¥é–‹å§‹", value=datetime.strptime("09:00", "%H:%M"))
with col_t2:
    daily_end = st.time_input("æ¯æ—¥çµæŸ", value=datetime.strptime("18:00", "%H:%M"))
with col_t3:
    daily_hours = st.number_input("æ¯æ—¥æ™‚æ•¸", value=8.0, step=0.5)

st.markdown("---")

# ç¬¬å…«æ¢ï¼šå¾…é‡é‚è¼¯ (Checkbox Logic)
# é è¨­å…¨ç©º
context.update({
    'type_learn_check': 'â–¡', 'type_work_check': 'â–¡',
    'chk_pay_none': 'â–¡', 'chk_pay_scholar': 'â–¡', 'chk_pay_allowance': 'â–¡',
    'pay_learn_amount': "", 'pay_work_amount': ""
})

if contract_type == "ä¸€èˆ¬å‹ (å­¸ç¿’å‹)":
    context['type_learn_check'] = 'â˜‘'
    st.success("âœ… å­¸ç¿’å‹ï¼šè«‹è¨­å®šçµ¦ä»˜é …ç›®")

    pay_opt = st.radio("çµ¦ä»˜é …ç›®", ["ç„¡", "çå­¸é‡‘", "å¯¦ç¿’æ´¥è²¼"], horizontal=True)

    if pay_opt == "ç„¡":
        context['chk_pay_none'] = 'â˜‘'
        context['pay_learn_amount'] = "0"
    elif pay_opt == "çå­¸é‡‘":
        context['chk_pay_scholar'] = 'â˜‘'
        amt = st.number_input("çå­¸é‡‘ç¸½é¡", min_value=0, step=1000)
        context['pay_learn_amount'] = f"{amt:,}"
    else: # å¯¦ç¿’æ´¥è²¼
        context['chk_pay_allowance'] = 'â˜‘'
        amt = st.number_input("æ´¥è²¼ç¸½é¡", min_value=0, step=1000)
        context['pay_learn_amount'] = f"{amt:,}"

else: # å‹è³‡å‹
    context['type_work_check'] = 'â˜‘'
    st.warning("âš ï¸ å‹è³‡å‹ï¼šè«‹è¨­å®šè–ªè³‡")
    pay_work_amt = st.number_input("æœˆè–ªé‡‘é¡", min_value=27470, step=100)
    context['pay_work_amount'] = f"{pay_work_amt:,}"

st.markdown("</div>", unsafe_allow_html=True)

# --- 5. ç¦åˆ© (ç¬¬åæ¢) ---
st.markdown("<div class='section-card'><h3>ğŸ ç¦åˆ©é …ç›®</h3>", unsafe_allow_html=True)

def welfare_logic(label, key_prefix, unit):
    """è™•ç†ç¦åˆ©çš„å‹¾é¸é‚è¼¯ Helper Function"""
    opt = st.selectbox(label, ["ç„¡", "å…è²»æä¾›", "ä»˜è²»æä¾›"], key=key_prefix)
    cost = ""

    # é è¨­å…¨ç©º
    checks = {f'chk_{key_prefix}_none': 'â–¡', f'chk_{key_prefix}_free': 'â–¡', f'chk_{key_prefix}_paid': 'â–¡'}

    if opt == "ç„¡":
        checks[f'chk_{key_prefix}_none'] = 'â˜‘'
    elif opt == "å…è²»æä¾›":
        checks[f'chk_{key_prefix}_free'] = 'â˜‘'
    else: # ä»˜è²»æä¾›
        checks[f'chk_{key_prefix}_paid'] = 'â˜‘'
        val = st.number_input(f"{label}è²»ç”¨ ({unit})", min_value=0, step=100, key=f"{key_prefix}_cost")
        cost = f"{val:,}"

    return checks, cost

col_w1, col_w2, col_w3 = st.columns(3)

with col_w1:
    dorm_checks, dorm_cost = welfare_logic("ä½å®¿", "dorm", "å…ƒ/æœˆ")
with col_w2:
    food_checks, food_cost = welfare_logic("è†³é£Ÿ", "food", "å…ƒ/é¤")
with col_w3:
    # äº¤é€šæ¯”è¼ƒç‰¹åˆ¥ï¼Œæœ‰ã€Œäº¤é€šæ´¥è²¼ã€é¸é …ï¼Œé€™è£¡ç°¡åŒ–ç‚ºèˆ‡åˆç´„ä¸€è‡´çš„ä¸‰é¸é …ï¼Œæˆ–éœ€ç‰¹è¦è™•ç†
    trans_opt = st.selectbox("äº¤é€š", ["ç„¡", "å…è²»æä¾›", "ä»˜è²»æä¾›"], key="trans")
    trans_cost = ""
    trans_checks = {'chk_trans_none': 'â–¡', 'chk_trans_free': 'â–¡', 'chk_trans_paid': 'â–¡'}

    if trans_opt == "ç„¡":
        trans_checks['chk_trans_none'] = 'â˜‘'
    elif trans_opt == "å…è²»æä¾›":
        trans_checks['chk_trans_free'] = 'â˜‘'
    else:
        trans_checks['chk_trans_paid'] = 'â˜‘'
        val = st.number_input("äº¤é€šè²»ç”¨ ({å…ƒ/æœˆ})", min_value=0, step=100, key="trans_cost_input")
        trans_cost = f"{val:,}"

# å°‡ç¦åˆ©è®Šæ•¸å¯«å…¥ context
context.update(dorm_checks)
context.update({'dorm_cost': dorm_cost})
context.update(food_checks)
context.update({'food_cost': food_cost})
context.update(trans_checks)
context.update({'trans_cost': trans_cost})

st.markdown("</div>", unsafe_allow_html=True)

# --- 6. ç”¢ç”ŸæŒ‰éˆ• ---
if st.button("ğŸš€ ç”¢ç”Ÿåˆç´„æ–‡ä»¶ (Word)"):
    if not company_name or not student_list[0]['name']:
        st.error("âŒ æ©Ÿæ§‹åç¨±èˆ‡ç¬¬ä¸€ä½å­¸ç”Ÿå§“åç‚ºå¿…å¡«")
    else:
        # å¡«å…¥åŸºæœ¬è³‡æ–™
        context.update({
            'company_name': company_name,
            'company_tax_id': company_tax_id,
            'company_rep': company_rep,
            'company_title': company_title,
            'company_address': final_address,

            # å­¸ç”Ÿè³‡æ–™ (å¡«å…¥ s1, s2, s3)
            's1_name': student_list[0]['name'], 's1_id': student_list[0]['id'],
            's2_name': student_list[1]['name'], 's2_id': student_list[1]['id'],
            's3_name': student_list[2]['name'], 's3_id': student_list[2]['id'],
            # ç‚ºäº†ç«‹åˆç´„æ›¸äººé‚£ä¸€æ¬„ (é€šå¸¸åªåˆ—ç¬¬ä¸€ä½æˆ–å…¨åˆ—ï¼Œé€™è£¡é è¨­å…¨åˆ—)
            'student_name': student_list[0]['name'] + (" ç­‰" if student_count > 1 else ""),

            # æ—¥æœŸæ™‚é–“
            's_y': s_y, 's_m': s_m, 's_d': s_d,
            'e_y': e_y, 'e_m': e_m, 'e_d': e_d,
            'daily_start': daily_start.strftime("%H:%M"),
            'daily_end': daily_end.strftime("%H:%M"),
            'daily_hours': daily_hours,
        })

        try:
            doc = DocxTemplate("template.docx")
            doc.render(context)
            bio = io.BytesIO()
            doc.save(bio)

            file_name = f"æ±æµ·å¤§å­¸å¯¦ç¿’åˆç´„_{student_list[0]['name']}_{company_name}.docx"
            st.download_button("ğŸ“¥ ä¸‹è¼‰åˆç´„", bio.getvalue(), file_name, "application/vnd.openxmlformats-officedocument.wordprocessingml.document")
            st.success("âœ… æª”æ¡ˆå·²å»ºç«‹ï¼")

        except Exception as e:
            st.error(f"âŒ éŒ¯èª¤ï¼š{e} (è«‹ç¢ºèª template.docx æ˜¯å¦å­˜åœ¨ä¸”æ¨™ç±¤æ­£ç¢º)")